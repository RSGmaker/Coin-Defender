Bridge.assembly("CoinDefender",function(){"use strict";Bridge.define("BNTest.GameMode",{statics:{teamBattle:null,deathMatch:null,gameModes:null,config:{init:function(){Bridge.ready(this.init)}},getGameModesOfType:function(type){return new(System.Collections.Generic.List$1(BNTest.GameMode))(System.Linq.Enumerable.from(BNTest.GameMode.gameModes).where(function(G){return G.getModeType()===type}))},getGameModeByName:function(name){var ret=new(System.Collections.Generic.List$1(BNTest.GameMode))(System.Linq.Enumerable.from(BNTest.GameMode.gameModes).where(function(G){return Bridge.referenceEquals(G.getName(),name)}));return ret.getCount()>0?ret.getItem(0):null},init:function(){BNTest.GameMode.teamBattle==null&&(BNTest.GameMode.gameModes=new(System.Collections.Generic.List$1(BNTest.GameMode)),BNTest.GameMode.teamBattle=new BNTest.GameMode("Team Battle"),BNTest.GameMode.teamBattle.setDescription("2 teams battle with limited lives\nuntil only 1 team remains."),BNTest.GameMode.deathMatch=new BNTest.GameMode("Death Match"),BNTest.GameMode.deathMatch.setDescription("A free for all match with\nlimited lives."),BNTest.GameMode.deathMatch.setTeams(!1))}},$entryPoint:!0,config:{properties:{Teams:!1,StartingLives:0,Survival:!1,AllowOnlinePlay:!1,AllowCharacterSelect:!1,NumberOfPlayers:0,RespawnTime:0,Name:null,ModeType:0,unlocked:!1,Description:null}},ctor:function(name){this.$initialize();this.setTeams(!0);this.setStartingLives(3);this.setSurvival(!0);this.setAllowOnlinePlay(!0);this.setAllowCharacterSelect(!0);this.setNumberOfPlayers(6);this.setRespawnTime(390);this.setName(name);this.setModeType(BNTest.GameMode.ModeTypes.Skirmish);this.setDescription(System.String.concat("Missing description for ",name));this.setunlocked(!0);BNTest.GameMode.gameModes.add(this)}});Bridge.define("BNTest.EntityBehavior",{enabled:!0,framesPerTick:0,entity:null,config:{properties:{BehaviorName:null}},ctor:function(entity){if(this.$initialize(),this.entity=entity,Bridge.referenceEquals(this.getBehaviorName(),"")||this.getBehaviorName()==null){var test=Bridge.getType(this),s=Bridge.Reflection.getTypeFullName(Bridge.getType(this)).split(".");this.setBehaviorName(s[s.length-1|0])}},update:function(){},draw:function(){},sendCustomEvent:function(evt,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.I=this.entity.ID;D.D=evt;D.T=this.getBehaviorName();this.entity.game.sendEvent("CBE",D,triggerflush)},customEvent:function(){}});Bridge.define("BNTest.AnimationLoader",{statics:{directory:"",_throttleRequests:!1,spritesheetdata:'[{"name":"Sakuya_Blink0","x":1122,"y":645,"width":96,"height":128},{"name":"Sakuya_Idle0","x":1122,"y":516,"width":96,"height":128},{"name":"Sakuya_Jump0","x":388,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk0","x":194,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk1","x":97,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk2","x":0,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk3","x":1025,"y":903,"width":96,"height":128},{"name":"SakuyaArm0","x":1122,"y":1065,"width":16,"height":81},{"name":"Sakuyabullet0","x":1067,"y":1146,"width":40,"height":20},{"name":"Starbullet0","x":945,"y":855,"width":32,"height":32},{"name":"Tile0","x":1122,"y":872,"width":48,"height":48},{"name":"Tile1","x":1067,"y":1048,"width":48,"height":48},{"name":"Tile2","x":1122,"y":774,"width":48,"height":48},{"name":"Tile3","x":1122,"y":823,"width":48,"height":48},{"name":"Tile4","x":970,"y":919,"width":48,"height":48},{"name":"Tile5","x":970,"y":968,"width":48,"height":48},{"name":"Tile6","x":1067,"y":1097,"width":48,"height":48},{"name":"Tombstone0","x":940,"y":790,"width":48,"height":64},{"name":"Yinyangorb0","x":875,"y":790,"width":64,"height":64},{"name":"Cirno_Blink0","x":873,"y":919,"width":96,"height":128},{"name":"Cirno_Idle0","x":1025,"y":0,"width":96,"height":128},{"name":"Cirno_Jump0","x":1025,"y":129,"width":96,"height":128},{"name":"Cirno_Walk0","x":1025,"y":258,"width":96,"height":128},{"name":"Cirno_Walk1","x":1025,"y":387,"width":96,"height":128},{"name":"Cirno_Walk2","x":1025,"y":516,"width":96,"height":128},{"name":"Cirno_Walk3","x":1025,"y":645,"width":96,"height":128},{"name":"CirnoArm0","x":1122,"y":921,"width":16,"height":61},{"name":"Flame0","x":516,"y":790,"width":128,"height":128},{"name":"Flame1","x":387,"y":790,"width":128,"height":128},{"name":"Flame2","x":258,"y":790,"width":128,"height":128},{"name":"Flame3","x":129,"y":790,"width":128,"height":128},{"name":"Flame4","x":645,"y":790,"width":128,"height":128},{"name":"Flame5","x":0,"y":790,"width":128,"height":128},{"name":"LFairy2","x":875,"y":855,"width":36,"height":34},{"name":"Light0","x":774,"y":790,"width":100,"height":100},{"name":"Lightorbbullet","x":912,"y":855,"width":32,"height":32},{"name":"Marisa_Blink0","x":776,"y":1048,"width":96,"height":128},{"name":"Marisa_Idle0","x":873,"y":1048,"width":96,"height":128},{"name":"Marisa_Jump0","x":970,"y":1048,"width":96,"height":128},{"name":"Marisa_Walk0","x":1122,"y":0,"width":96,"height":128},{"name":"Marisa_Walk1","x":1122,"y":129,"width":96,"height":128},{"name":"Marisa_Walk2","x":1122,"y":258,"width":96,"height":128},{"name":"Marisa_Walk3","x":582,"y":1048,"width":96,"height":128},{"name":"MarisaArm0","x":1006,"y":790,"width":16,"height":61},{"name":"Marisabullet0","x":0,"y":769,"width":200,"height":20},{"name":"Reimu_Blink0","x":679,"y":919,"width":96,"height":128},{"name":"Reimu_Idle0","x":582,"y":919,"width":96,"height":128},{"name":"Reimu_Jump0","x":485,"y":919,"width":96,"height":128},{"name":"Reimu_Walk0","x":388,"y":919,"width":96,"height":128},{"name":"Reimu_Walk1","x":291,"y":919,"width":96,"height":128},{"name":"Reimu_Walk2","x":194,"y":919,"width":96,"height":128},{"name":"Reimu_Walk3","x":97,"y":919,"width":96,"height":128},{"name":"ReimuArm0","x":1122,"y":983,"width":16,"height":81},{"name":"Reisen_Blink0","x":0,"y":919,"width":96,"height":128},{"name":"Reisen_Idle0","x":1122,"y":387,"width":96,"height":128},{"name":"Reisen_Jump0","x":776,"y":919,"width":96,"height":128},{"name":"Reisen_Walk0","x":679,"y":1048,"width":96,"height":128},{"name":"Reisen_Walk1","x":485,"y":1048,"width":96,"height":128},{"name":"Reisen_Walk2","x":1025,"y":774,"width":96,"height":128},{"name":"Reisen_Walk3","x":291,"y":1048,"width":96,"height":128},{"name":"ReisenArm0","x":989,"y":790,"width":16,"height":61},{"name":"Reisenbullet0","x":970,"y":1017,"width":32,"height":20},{"name":"BG0","x":0,"y":0,"width":1024,"height":768}]',__this:null,get_this:function(){return BNTest.AnimationLoader.__this==null&&(BNTest.AnimationLoader.__this=new BNTest.AnimationLoader),BNTest.AnimationLoader.__this},init:function(){BNTest.AnimationLoader.__this==null&&(BNTest.AnimationLoader.__this=new BNTest.AnimationLoader)},getPixels:function(image){var tmp=document.createElement("canvas"),g;return tmp.width=image.width,tmp.height=image.height,g=BNTest.Helper.getContext(tmp),g.drawImage(image,0,0),g.getImageData(0,0,tmp.width,tmp.height).data},flipImage:function(I){var outer=document.createElement("canvas"),C=document.createElement("canvas"),g=C.getContext("2d"),ID,ret;return g.scale(-1,1),g.drawImage(I,I.width,0),g=outer.getContext("2d"),g.drawImage(C,0,0),ID=g.getImageData(0,0,I.width,I.height),ret=new Image,ret.src=g.canvas.toDataURL(),ret},preLoad:function(paths){BNTest.HelperExtensions.forEach(String,paths,$_.BNTest.AnimationLoader.f1)},get:function(path){return BNTest.AnimationLoader.__this.getAnimation(path)}},zip:null,zipPath:"",baseZipPath:"",_data:null,_callbacks:null,_loading:null,spritesheet:null,spritesheetimage:null,queued:null,ready:!1,ctor:function(){this.$initialize();this._data=new(System.Collections.Generic.Dictionary$2(String,System.Collections.Generic.List$1(HTMLImageElement)));this._loading=new(System.Collections.Generic.List$1(String));this.queued=new(System.Collections.Generic.List$1(String));this._callbacks=new(System.Collections.Generic.Dictionary$2(String,System.Collections.Generic.List$1(Function)));return},queueEmpty:function(){return this._loading.getCount()===0},queueSize:function(){return this._loading.getCount()},onReady:function(){this.ready=!0;BNTest.HelperExtensions.forEach(String,this.queued.toArray(),Bridge.fn.bind(this,$_.BNTest.AnimationLoader.f2))},downloadFile:function(path,responseType){responseType===void 0&&(responseType=2);var X=new XMLHttpRequest;return(X.responseType=responseType,X.open("GET",path,!1),X.status===200||X.status===304)?X:null},_LoadAnimation:function(list,path,img){var I,self,index,file;if(img===void 0&&(img=null),img!=null)if(img.width>0)list.add(img);else return;I=new Image;self=BNTest.AnimationLoader.get_this();I.onload=function(){self._LoadAnimation(list,path,I)};I.onerror=function(){self._Finish(path)};index=list.getCount();file=System.String.concat(System.String.concat(System.String.concat(path,"_"),index),".png");console.log(System.String.concat("Now loading:",file));I.src=file},isLoading:function(path){return path=System.String.concat(BNTest.AnimationLoader.directory,path),this._loading.contains(path)},isIdle:function(){return this._loading.getCount()<=0&&this.queued.getCount()<=0},_Finish:function(path){var self=BNTest.AnimationLoader.get_this(),L=self._loading,A;L.contains(path)?(this._data.get(path).getCount()>0?console.log(System.String.concat("finish:",path)):console.log(System.String.concat("Could not load:",path)),L.remove(path)):console.log(System.String.concat("Could not load:",path));BNTest.AnimationLoader._throttleRequests&&L.getCount()>0&&(console.log(System.String.concat("Now resuming:",L.getItem(0))),Bridge.global.setTimeout(function(){self._LoadAnimation(self._data.get(L.getItem(0)),L.getItem(0))}));self._callbacks.containsKey(path)&&(A=self._callbacks.get(path),A!=null&&BNTest.HelperExtensions.forEach(Function,A,function(C){C(path)}))},asyncGet:function(path,callback,callImmediatelyIfAvailable){var R,P,L;return(callImmediatelyIfAvailable===void 0&&(callImmediatelyIfAvailable=!1),R=BNTest.AnimationLoader.get(path),P=System.String.concat(BNTest.AnimationLoader.directory,path),R==null||R.getCount()<=0)?(this._callbacks.containsKey(P)?L=this._callbacks.get(P):(L=new(System.Collections.Generic.List$1(Function)),this._callbacks.set(P,L)),L.add(callback),!0):(callImmediatelyIfAvailable&&callback(P),!1)},asyncGet$1:function(paths,callback){for(var total=paths.length,i=0;i<paths.length;)(function(){this.asyncGet(paths[i],function(){total=total-1|0;total===0&&callback()},!0);i=i+1|0}).call(this);return total>0},_GetAnimation:function(L,path){var flip=!1,loc=path,self;path.lastIndexOf(String.fromCharCode(70))===(path.length-1|0)&&(flip=!0,loc=System.String.remove(loc,path.length-1|0));!BNTest.AnimationLoader._throttleRequests||this._loading.getCount()<=0?(console.log(System.String.concat("Starting:",loc)),self=BNTest.AnimationLoader.get_this(),Bridge.global.setTimeout(function(){self._LoadAnimation(L,loc)})):BNTest.AnimationLoader._throttleRequests&&console.log(System.String.concat("adding to queue:",loc));this._loading.add(path)},_GetAnimationFromSpriteSheet:function(path){var frame,p,rect;if(!this.ready){this.queued.contains(path)||this.queued.add(path);return}console.log(System.String.concat("loading from spritesheet:",path));for(var L=this._data.get(path),frames=this.spritesheet,i=0,tmp=document.createElement("canvas"),g=BNTest.Helper.getContext(tmp);i<frames.length;)frame=frames[i],p=System.String.concat(BNTest.AnimationLoader.directory,frame.name),System.String.startsWith(p,path)&&(rect=frame,tmp.width=rect.width,tmp.height=rect.height,g.drawImage(this.spritesheetimage,-rect.x,-rect.y),L.add(tmp),console.log(System.String.concat("added from spritesheet:",p)),tmp=document.createElement("canvas"),g=BNTest.Helper.getContext(tmp)),i=i+1|0;console.log(System.String.concat("finished loading from spritesheet:",path));this.queued.contains(path)&&this.queued.remove(path)},loadAnimationFromZip:function(path){var ret=new(System.Collections.Generic.List$1(HTMLImageElement)),P,f,i;try{for(P=path,System.String.indexOf(P,this.baseZipPath)===0&&(P=P.substr(this.baseZipPath.length+1|0)),f=System.String.concat(System.String.concat(this.zipPath,"://"),P),i=0;;){var ipath=System.String.concat(System.String.concat(System.String.concat(f,"_"),i),".png"),img=this.zip.loadImage(ipath),N=new Image;N.src=img;ret.add(N);i=i+1|0}}catch($e1){$e1=System.Exception.create($e1)}return ret.getCount()>0?(console.log(System.String.concat(System.String.concat('Loaded animation "',path),'" from zip file.')),ret):null},setZip:function(zipPath){this.zipPath=zipPath;this.baseZipPath=System.String.replaceAll(zipPath,".zip","");this.zip=new ZipLoader(zipPath)},getAnimation:function(path){var R,L;return path=System.String.concat(BNTest.AnimationLoader.directory,path),this._data.containsKey(path)?this._data.get(path):this.zip!=null&&(R=this.loadAnimationFromZip(path),R!=null)?(this._data.set(path,R),R):(L=new(System.Collections.Generic.List$1(HTMLImageElement)),this._data.set(path,L),this._GetAnimation(L,path),L)}});var $_={};Bridge.ns("BNTest.AnimationLoader",$_);Bridge.apply($_.BNTest.AnimationLoader,{f1:function(path){BNTest.AnimationLoader.__this.getAnimation(path)},f2:function(Q){this._GetAnimationFromSpriteSheet(Q)}});Bridge.define("BNTest.App",{statics:{div:null,canvas:null,guiCanvas:null,gui:null,targetAspect:0,screenBounds:null,_lSize:-1,_lHeight:-1,gameName:"Coin Defender",gameVersion:"0.4",IC:null,DEBUG:!1,update:function(){BNTest.KeyboardManager.update();BNTest.App.updateWindow()},updateWindow:function(){var H=window.innerHeight,size=Math.ceil(H*(1/BNTest.App.targetAspect));H!==BNTest.App._lHeight&&(BNTest.App.canvas.style.width="100%",BNTest.App.guiCanvas.style.width="100%",BNTest.App.div.style.width=System.String.concat(System.Double.format(size,"G"),"px"),BNTest.App.div.style.position="relative",BNTest.App.div.style.left=System.String.concat(System.Double.format((Bridge.Int.div(window.innerWidth,2)|0)-size/2,"G"),"px"),BNTest.App._lHeight=H)},initCube:function(canvas){var cube=new BNTest.Cube;BNTest.App.initSettings(cube);cube.canvas=canvas;cube.gl=BNTest.App.create3DContext(cube.canvas);cube.gl!=null?(cube.initShaders(),cube.initBuffers(),cube.initTexture(),cube.tick(),document.addEventListener("keydown",Bridge.fn.bind(cube,cube.handleKeyDown)),document.addEventListener("keyup",Bridge.fn.bind(cube,cube.handleKeyUp))):BNTest.App.showError(cube.canvas,'<b>Either the browser doesn\'t support WebGL or it is disabled.<br>Please follow <a href="http://get.webgl.com">Get WebGL<\/a>.<\/b>')},showError:function(canvas,message){canvas.parentElement.replaceChild(Bridge.merge(document.createElement("p"),{innerHTML:message}),canvas)},initSettings:function(cube){var useSettings=document.getElementById("settings");useSettings!=null&&useSettings.checked&&(cube.useBlending=document.getElementById("blending").checked,cube.alpha=parseFloat(document.getElementById("alpha").value),cube.useLighting=document.getElementById("lighting").checked,cube.ambientR=parseFloat(document.getElementById("ambientR").value),cube.ambientG=parseFloat(document.getElementById("ambientG").value),cube.ambientB=parseFloat(document.getElementById("ambientB").value),cube.lightDirectionX=parseFloat(document.getElementById("lightDirectionX").value),cube.lightDirectionY=parseFloat(document.getElementById("lightDirectionY").value),cube.lightDirectionZ=parseFloat(document.getElementById("lightDirectionZ").value),cube.directionalR=parseFloat(document.getElementById("directionalR").value),cube.directionalG=parseFloat(document.getElementById("directionalG").value),cube.directionalB=parseFloat(document.getElementById("directionalB").value),cube.textureImageSrc="crate.gif")},create3DContext:function(canvas){for(var context=null,name,$t=Bridge.getEnumerator(["webgl","experimental-webgl","webkit-3d","moz-webgl"]);$t.moveNext();){name=$t.getCurrent();try{context=canvas.getContext(name)}catch($e1){$e1=System.Exception.create($e1)}if(context!=null)break}return context}},$main:function(){var button=Bridge.merge(document.createElement("button"),{innerHTML:"Click Me",onclick:$_.BNTest.App.f1}),Canv,GD,smooth;document.body.style.cssText="overflow: hidden;margin: 0;padding: 0;";document.title=System.String.concat(System.String.concat(System.String.concat(BNTest.App.gameName," "),BNTest.App.gameVersion)," by:RSGmaker");BNTest.WGMatrix.init();BNTest.App.IC=new BNTest.InputController("KeyboardMouse");BNTest.App.div=document.createElement("div");Canv=document.createElement("canvas");BNTest.App.canvas=Canv;BNTest.App.targetAspect=.75;Canv.width=1024;Canv.height=Bridge.Int.clip32(Canv.width*BNTest.App.targetAspect);BNTest.App.screenBounds=new BNTest.Rectangle(0,0,Canv.width,Canv.height);BNTest.App.div.appendChild(Canv);document.body.appendChild(BNTest.App.div);BNTest.App.guiCanvas=document.createElement("canvas");BNTest.App.guiCanvas.width=Canv.width;BNTest.App.guiCanvas.height=Canv.height;BNTest.App.guiCanvas.style.position="absolute";BNTest.App.guiCanvas.style.left="0px";BNTest.App.guiCanvas.style.top="0px";BNTest.App.gui=BNTest.Helper.getContext(BNTest.App.guiCanvas);BNTest.App.div.appendChild(BNTest.App.guiCanvas);BNTest.KeyboardManager.init();GD=new BNTest.GLDemo;GD.start(BNTest.App.canvas);smooth=!0}});Bridge.ns("BNTest.App",$_);Bridge.apply($_.BNTest.App,{f1:function(){Bridge.Console.log("Success!")}});Bridge.define("BNTest.Audio",{_AM:null,_audio:null,_hasPlayed:!1,_blast:null,_loop:!1,onPlay:null,onStop:null,lasttime:0,config:{properties:{ID:null}},ctor:function(audio,ID,AudioManager){var self,maxvoices,voices;for(this.$initialize(),this._audio=audio,this.setID(ID),self=this,this._AM=AudioManager,this.setAudio(),this._blast=new(System.Collections.Generic.List$1(HTMLAudioElement)),maxvoices=6,voices=1;voices<maxvoices;)this._blast.add(Bridge.cast(this._audio.cloneNode(),HTMLAudioElement)),voices=voices+1|0},getIsPlaying:function(){return!(!this._hasPlayed||this._audio.paused||this._audio.currentTime===0)},setIsPlaying:function(value){value?this.play():this.pause()},getLoop:function(){return this._loop},setLoop:function(value){this._loop=value},getCurrentTime:function(){return this._audio.currentTime},setCurrentTime:function(value){this._audio.currentTime=value},getVolume:function(){return this._audio.volume},setVolume:function(value){this._audio.volume=value},play:function(){return this.getIsPlaying()?!1:(this.lasttime=this.getCurrentTime(),this._audio.play(),this._hasPlayed=!0,!0)},pause:function(){return this.getIsPlaying()?(this._audio.pause(),!0):!1},stop:function(){return this.getIsPlaying()?(this._audio.pause(),this._audio.currentTime=0,!0):!1},setAudio:function(){var self=this;this._audio.onplay=function(){self._OnPlay()};this._audio.onpause=function(){self._OnStop()};this._audio.onended=function(){self._OnEnd()};this._audio.ontimeupdate=function(){self._OnUpdate()}},blast:function(volume){var i,A;if(volume===void 0&&(volume=1),this.getIsPlaying())for(i=0;i<this._blast.getCount();)A=this._blast.getItem(i),(A.paused||A.currentTime<.1||A.played.length===0)&&(A.paused||A.currentTime===0||A.played.length===0)&&(A.volume=volume,A.play(),i=this._blast.getCount()),i=i+1|0;else this.setVolume(volume),this.play()},_OnPlay:function(){this._AM.onPlay(this);if(this.onPlay)this.onPlay(this)},_OnStop:function(){this._AM.onStop(this);if(this.onStop)this.onStop(this)},_OnEnd:function(){this._loop?(this.setCurrentTime(0),this.play()):this._OnStop()},_OnUpdate:function(){return}});Bridge.define("BNTest.AudioManager",{statics:{directory:"",__this:null,get_this:function(){return BNTest.AudioManager.__this==null&&(BNTest.AudioManager.__this=new BNTest.AudioManager),BNTest.AudioManager.__this},init:function(){BNTest.AudioManager.__this==null&&(BNTest.AudioManager.__this=new BNTest.AudioManager)}},data:null,playing:null,ctor:function(){this.$initialize();this.data=new(System.Collections.Generic.Dictionary$2(String,BNTest.Audio));this.playing=new(System.Collections.Generic.List$1(BNTest.Audio))},get:function(path){var AE,A;return path=System.String.concat(BNTest.AudioManager.directory,path),this.data.containsKey(path)?this.data.get(path):(AE=new Audio(path),console.log(System.String.concat("AM:",path)),A=new BNTest.Audio(AE,path,this),this.data.add(path,A),A)},play:function(path,loop){loop===void 0&&(loop=!1);var A=this.get(path);return A.setLoop(loop),A.play(),A},blast:function(path,volume){volume===void 0&&(volume=1);var A=this.get(path);A.blast(volume)},stop:function(path){var A=this.get(path);A.stop()},pause:function(path){var A=this.get(path);A.pause()},onPlay:function(audio){this.playing.contains(audio)||this.playing.add(audio)},onStop:function(audio){this.playing.contains(audio)&&this.playing.remove(audio)},stopAllFromDirectory:function(directory){directory=System.String.concat(BNTest.AudioManager.directory,directory);BNTest.HelperExtensions.forEach(BNTest.Audio,this.data.getValues(),function(A){System.String.startsWith(A.getID(),directory)&&A.stop()})}});Bridge.define("BNTest.Entity",{model:null,alive:!0,visible:!0,speed:null,game:null,lastBB:null,_behaviors:null,_behaviorTicks:null,zOrder:0,ID:null,hideHitbox:!1,solid:!0,obstruction:!1,groundFriction:1,platform:!1,customBoundingBox:null,world:null,team:-1,BB:null,behaviorsUpdated:!1,config:{init:function(){this.speed=new BNTest.GLVec3.ctor;this.BB=new BNTest.BoundingBox.ctor}},ctor:function(world){this.$initialize();this.world=world;this.ID=BNTest.Helper.getRandomString();this.game=world.game;this.lastBB=this.model!=null?this.getBoundingBox():new BNTest.BoundingBox.ctor},getHspeed:function(){return this.speed.x},setHspeed:function(value){this.speed.x=value},getVspeed:function(){return this.speed.y},setVspeed:function(value){this.speed.y=value},getZspeed:function(){return this.speed.z},setZspeed:function(value){this.speed.z=value},getPosition:function(){return this.model.offset},setPosition:function(value){this.model.offset=value},getx:function(){return this.model.offset.x},setx:function(value){this.model.offset.x=value},gety:function(){return this.model.offset.y},sety:function(value){this.model.offset.y=value},getz:function(){return this.model.offset.z},setz:function(value){this.model.offset.z=value},getScale:function(){return this.model.scale},setScale:function(value){this.model.scale=value},getHandledLocally:function(){return this.game.hoster},getHitbox:function(){return this.lastBB==null?this.getHitbox():this.lastBB},getBoundingBox:function(){return this.customBoundingBox!=null?(this.BB.copyFrom(this.customBoundingBox),this.BB.add(this.model.offset),this.BB):this.model.getBoundingBox()},addBehavior:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(BNTest.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32)));this._behaviors.add(behavior);this._behaviorTicks.add(0)},removeBehavior:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(BNTest.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32)));this._behaviors.contains(behavior)&&(this._behaviorTicks.removeAt(this._behaviors.indexOf(behavior)),this._behaviors.remove(behavior))},removeBehavior$1:function(T){var $t,L,behavior;if(this._behaviors!=null){for(L=new(System.Collections.Generic.List$1(BNTest.EntityBehavior))(System.Linq.Enumerable.from(this._behaviors).where(function(behavior){return Bridge.is(behavior,T)})),$t=Bridge.getEnumerator(L);$t.moveNext();)behavior=$t.getCurrent(),this.removeBehavior(behavior);return}},getBehavior:function(T){var i,ln,B,ret;if(this._behaviors==null)return Bridge.getDefaultValue(T);for(i=0,ln=this._behaviors.getCount();i<ln;){if(B=this._behaviors.getItem(i),Bridge.is(B,T))return B;i=i+1|0}return ret=null,Bridge.getDefaultValue(T)},getBehavior$1:function(T,func){for(var i=0,ln=this._behaviors.getCount(),B;i<ln;){if(B=this._behaviors.getItem(i),Bridge.is(B,T)&&func(B))return B;i=i+1|0}return null},getTeamColor:function(){return Bridge.is(this,BNTest.ICombatant)?this.game.gamePlaySettings.gameMode.getTeams()?this.game.getTeamColor(this.team):Bridge.referenceEquals(this,this.game.localplayer.character)?this.game.getTeamColor(1):this.game.getTeamColor(2):new BNTest.GLColor},sameTeam:function(combatant){return this==combatant?!0:this.team===combatant.team?this.game.gamePlaySettings.gameMode.getTeams()?!0:this.team===0:!1},getBehaviorFromName:function(Name){var i,ln,B;if(this._behaviors==null)return null;try{for(i=0,ln=this._behaviors.getCount();i<ln;){if(B=this._behaviors.getItem(i),Bridge.referenceEquals(B.getBehaviorName(),Name))return B;i=i+1|0}}catch($e1){$e1=System.Exception.create($e1);Bridge.Console.log(System.String.concat(System.String.concat("Behavior ",Name)," was not found."))}return null},customEvent:function(){},sendCustomEvent:function(evt,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.I=this.ID;D.D=evt;this.game.sendEvent("CE",D,triggerflush)},playSound:function(sound){this.game.playSoundEffect(this.getCenter(),sound)},getCenter:function(){return this.lastBB.getCenter()},rotateTest:function(M,val,speed,maxmod){val===void 0&&(val="x");speed===void 0&&(speed=1);maxmod===void 0&&(maxmod=1);M.Dir==null&&(M.Dir=1);M.Max==null&&(M.Max=45);M.Spd==null&&(M.Spd=1.5);var max=M.Max,spd=M.Spd;speed!==1&&(spd*=speed);maxmod!==1&&(max*=maxmod);M.rotation[val]=M.rotation[val]+spd*M.Dir;Math.abs(M.rotation[val])>=max&&(M.Dir=-M.Dir)},cacheBoundingBox:function(){this.customBoundingBox=null;this.customBoundingBox=BNTest.BoundingBox.op_Subtraction(this.getBoundingBox(),this.getPosition())},updateBehaviors:function(){var $t,i,behavior;if(this._behaviors!=null&&!this.behaviorsUpdated){for(i=0;i<this._behaviors.getCount();)behavior=this._behaviors.getItem(i),behavior.enabled&&Bridge.identity(this._behaviorTicks.getItem(i),($t=this._behaviorTicks.getItem(i)+1|0,this._behaviorTicks.setItem(i,$t),$t))>=behavior.framesPerTick&&(this._behaviorTicks.setItem(i,0),behavior.update()),i=i+1|0;this.behaviorsUpdated=!0}},update:function(){if(this.model.offset.x+=this.speed.x,this.model.offset.y+=this.speed.y,this.model.offset.z+=this.speed.z,this.updateBehaviors(),this.lastBB=this.getBoundingBox(),this.behaviorsUpdated=!1,this.model!=null){var cam=this.world.cam,dist=cam.roughDistance(this.lastBB.getCenter());this.model.inView=dist<=BNTest.World.viewDistance}},refreshBehaviorTick:function(T){var B=this.getBehavior(T);B!=null&&this._behaviorTicks.setItem(this._behaviors.indexOf(B),B.framesPerTick)},draw:function(gl){var $t,behavior;if(this._behaviors!=null)for($t=Bridge.getEnumerator(this._behaviors);$t.moveNext();)behavior=$t.getCurrent(),behavior.draw(gl)},onRemove:function(){}});Bridge.define("BNTest.IWeaponBehavior",{$kind:"interface"});Bridge.define("BNTest.BoundingBox",{statics:{op_Addition:function(B,V){return new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Addition(B.min,V),BNTest.GLVec3.op_Addition(B.max,V))},op_Subtraction:function(B,V){return new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Subtraction(B.min,V),BNTest.GLVec3.op_Subtraction(B.max,V))},op_Multiply:function(B,V){var A=B.getCenter(),S=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply(B.getSize(),V),.5);return new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Subtraction(A,S),BNTest.GLVec3.op_Addition(A,S))},op_Multiply$1:function(B,Scale){var V=new BNTest.GLVec3.ctor(Scale,Scale,Scale),A=B.getCenter(),S=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply(B.getSize(),V),.5);return new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Subtraction(A,S),BNTest.GLVec3.op_Addition(A,S))}},min:null,max:null,$ctor1:function(Min,Max){this.$initialize();this.min=BNTest.GLVec3.min(Min,Max);this.max=BNTest.GLVec3.max(Min,Max)},ctor:function(){this.$initialize();this.min=new BNTest.GLVec3.ctor;this.max=new BNTest.GLVec3.ctor},$ctor2:function(size){this.$initialize();var hsize=size/2;this.min=new BNTest.GLVec3.ctor(-hsize,-hsize,-hsize);this.max=new BNTest.GLVec3.ctor(hsize,hsize,hsize)},getPosition:function(){return this.min},setPosition:function(value){var X=this.max.x-this.min.x,Y=this.max.y-this.min.y,Z=this.max.z-this.min.z;this.min=value;this.max.x=this.min.x+X;this.max.y=this.min.y+Y;this.max.z=this.min.z+Z},getEmpty:function(){return this.min.equals(this.max)},getSize:function(){return BNTest.GLVec3.op_Subtraction(this.max,this.min)},setSize:function(value){this.max=BNTest.GLVec3.op_Subtraction(value,this.min)},getLeft:function(){return this.min.x},getTop:function(){return this.min.y},getBack:function(){return this.min.z},getRight:function(){return this.max.x},getBottom:function(){return this.max.y},getFront:function(){return this.max.z},getCenter:function(){return BNTest.GLVec3.op_Addition(this.min,BNTest.GLVec3.op_Multiply$1(this.getSize(),.5))},copyFrom:function(B){var BM=B.min;this.min.x=BM.x;this.min.y=BM.y;this.min.z=BM.z;BM=B.max;this.max.x=BM.x;this.max.y=BM.y;this.max.z=BM.z},add:function(offset){this.min.x+=offset.x;this.min.y+=offset.y;this.min.z+=offset.z;this.max.x+=offset.x;this.max.y+=offset.y;this.max.z+=offset.z},toString:function(){return System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat("{Pos:",this.min.toString()),"}"),"{Size:"),this.getSize().toString()),"}")},clone:function(){return new BNTest.BoundingBox.$ctor1(this.min.clone(),this.max.clone())},intersection$3:function(list){return System.Linq.Enumerable.from(list).where(Bridge.fn.bind(this,$_.BNTest.BoundingBox.f1)).toList(BNTest.BoundingBox)},intersection:function(list){for(var ret=System.Array.init(0,null),i=0,B;i<list.length;)B=list[i],B.lastBB.intersection$2(this)&&ret.push(B),i=i+1|0;return ret},intersection$1:function(list){for(var ret=System.Array.init(0,null),L=list.items,i=0,B;i<L.length;)B=L[i],B.lastBB.intersection$2(this)&&ret.push(B),i=i+1|0;return ret},intersection$2:function(b){return this.max.x>=b.min.x&&this.min.x<=b.max.x&&this.max.y>=b.min.y&&this.min.y<=b.max.y&&!!(this.max.z>=b.min.z&this.min.z<=b.max.z)},contains:function(V){return BNTest.GLVec3.op_LessThanOrEqual(this.min,V)&&BNTest.GLVec3.op_GreaterThanOrEqual(this.max,V)}});Bridge.ns("BNTest.BoundingBox",$_);Bridge.apply($_.BNTest.BoundingBox,{f1:function(B){return this.intersection$2(B)}});Bridge.define("BNTest.Cube",{canvas:null,gl:null,program:null,texture:null,useBlending:!0,alpha:1,useLighting:!0,ambientR:.4,ambientG:.4,ambientB:.4,lightDirectionX:0,lightDirectionY:0,lightDirectionZ:-1,directionalR:.25,directionalG:.25,directionalB:.25,textureImageSrc:"crate.gif",mvMatrix:null,mvMatrixStack:null,pMatrix:null,vertexPositionAttribute:0,vertexNormalAttribute:0,textureCoordAttribute:0,vertexColorAttribute:0,pMatrixUniform:null,mvMatrixUniform:null,nMatrixUniform:null,samplerUniform:null,useLightingUniform:null,ambientColorUniform:null,lightingDirectionUniform:null,directionalColorUniform:null,alphaUniform:null,cubeVertexPositionBuffer:null,cubeVertexNormalBuffer:null,cubeVertexTextureCoordBuffer:null,cubeVertexIndexBuffer:null,cubeVertexColorBuffer:null,xRotation:0,xSpeed:15,yRotation:0,ySpeed:-15,z:-5,currentlyPressedKeys:null,lastTime:0,config:{init:function(){this.mvMatrix=mat4.create();this.mvMatrixStack=[];this.pMatrix=mat4.create();this.currentlyPressedKeys=[]}},getShader:function(gl,id){var shaderScript=document.getElementById(id),str,k,shader;if(shaderScript==null)return null;for(str="",k=shaderScript.firstChild;k!=null;)k.nodeType===3&&(str=System.String.concat(str,k.textContent)),k=k.nextSibling;if(Bridge.referenceEquals(shaderScript.type,"x-shader/x-fragment"))shader=gl.createShader(gl.FRAGMENT_SHADER);else if(Bridge.referenceEquals(shaderScript.type,"x-shader/x-vertex"))shader=gl.createShader(gl.VERTEX_SHADER);else return null;return(gl.shaderSource(shader,str),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))?(Bridge.global.alert(gl.getShaderInfoLog(shader)),null):shader},initShaders:function(){var fragmentShader=this.getShader(this.gl,"shader-fs"),vertexShader=this.getShader(this.gl,"shader-vs"),shaderProgram=this.gl.createProgram();Bridge.is(shaderProgram,System.Int32)&&Bridge.global.alert("Could not initialise program");this.gl.attachShader(shaderProgram,vertexShader);this.gl.attachShader(shaderProgram,fragmentShader);this.gl.linkProgram(shaderProgram);this.gl.getProgramParameter(shaderProgram,this.gl.LINK_STATUS)||Bridge.global.alert("Could not initialise shaders");this.gl.useProgram(shaderProgram);this.vertexPositionAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexPosition");this.vertexNormalAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexNormal");this.textureCoordAttribute=this.gl.getAttribLocation(shaderProgram,"aTextureCoord");this.vertexColorAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(this.vertexPositionAttribute);this.gl.enableVertexAttribArray(this.vertexNormalAttribute);this.gl.enableVertexAttribArray(this.textureCoordAttribute);this.pMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uPMatrix");this.mvMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uMVMatrix");this.nMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uNMatrix");this.samplerUniform=this.gl.getUniformLocation(shaderProgram,"uSampler");this.useLightingUniform=this.gl.getUniformLocation(shaderProgram,"uUseLighting");this.ambientColorUniform=this.gl.getUniformLocation(shaderProgram,"uAmbientColor");this.lightingDirectionUniform=this.gl.getUniformLocation(shaderProgram,"uLightingDirection");this.directionalColorUniform=this.gl.getUniformLocation(shaderProgram,"uDirectionalColor");this.alphaUniform=this.gl.getUniformLocation(shaderProgram,"uAlpha");this.program=shaderProgram},handleLoadedTexture:function(image){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null)},initTexture:function(){this.texture=this.gl.createTexture();var textureImageElement=new Image;textureImageElement.onload=Bridge.fn.bind(this,function(){this.handleLoadedTexture(textureImageElement)});textureImageElement.src=this.textureImageSrc},setMatrixUniforms:function(){this.gl.uniformMatrix4fv(this.pMatrixUniform,!1,this.pMatrix);this.gl.uniformMatrix4fv(this.mvMatrixUniform,!1,this.mvMatrix);var normalMatrix=mat3.create();mat4.toInverseMat3(this.mvMatrix,normalMatrix);mat3.transpose(normalMatrix);this.gl.uniformMatrix3fv(this.nMatrixUniform,!1,normalMatrix)},degToRad:function(degrees){return degrees*Math.PI/180},handleKeyDown:function(e){this.currentlyPressedKeys[e.keyCode]=!0},handleKeyUp:function(e){this.currentlyPressedKeys[e.keyCode]=!1},handleKeys:function(){this.currentlyPressedKeys[81]&&(this.z-=.05);this.currentlyPressedKeys[69]&&(this.z+=.05);this.currentlyPressedKeys[65]&&(this.ySpeed=this.ySpeed-1|0);this.currentlyPressedKeys[68]&&(this.ySpeed=this.ySpeed+1|0);this.currentlyPressedKeys[87]&&(this.xSpeed=this.xSpeed-1|0);this.currentlyPressedKeys[83]&&(this.xSpeed=this.xSpeed+1|0)},initBuffers:function(){var vertices,vertexNormals,textureCoords,cubeVertexIndices;this.cubeVertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer);vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertices),this.gl.STATIC_DRAW);this.cubeVertexColorBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexColorBuffer);for(var vcolor=System.Array.init((Bridge.Int.div(vertices.length,3)|0)*4|0,0),i=0;(i+3|0)<vcolor.length;)vcolor[i]=1,vcolor[i+1|0]=1,vcolor[i+2|0]=1,vcolor[i+3|0]=1,i=i+4|0;this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vcolor),this.gl.STATIC_DRAW);this.cubeVertexNormalBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer);vertexNormals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertexNormals),this.gl.STATIC_DRAW);this.cubeVertexTextureCoordBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(textureCoords),this.gl.STATIC_DRAW);this.cubeVertexIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);cubeVertexIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(cubeVertexIndices),this.gl.STATIC_DRAW)},drawCube:function(){if(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer),this.gl.vertexAttribPointer(this.vertexPositionAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer),this.gl.vertexAttribPointer(this.vertexNormalAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer),this.gl.vertexAttribPointer(this.textureCoordAttribute,2,this.gl.FLOAT,!1,0,0),this.ambientR=1,this.ambientG=1,this.ambientB=1,this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.uniform1i(this.samplerUniform,0),this.useBlending?(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this.gl.enable(this.gl.BLEND),this.gl.disable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,this.alpha)):(this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,1)),this.gl.uniform1i(this.useLightingUniform,this.useLighting),this.useLighting){this.gl.uniform3f(this.ambientColorUniform,this.ambientR,this.ambientG,this.ambientB);var lightingDirection=[this.lightDirectionX,this.lightDirectionY,this.lightDirectionZ],adjustedLD=vec3.create();vec3.normalize(lightingDirection,adjustedLD);vec3.scale(adjustedLD,-1);this.gl.uniform3fv(this.lightingDirectionUniform,adjustedLD);this.gl.uniform3f(this.directionalColorUniform,this.directionalR,this.directionalG,this.directionalB)}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);this.setMatrixUniforms();this.gl.drawElements(this.gl.TRIANGLES,36,this.gl.UNSIGNED_SHORT,0)},drawScene:function(){this.gl.viewport(0,0,this.canvas.width,this.canvas.height);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);mat4.perspective(45,this.canvas.width/this.canvas.height,.1,100,this.pMatrix);mat4.identity(this.mvMatrix);mat4.translate(this.mvMatrix,[0,0,this.z]);mat4.rotate(this.mvMatrix,this.degToRad(this.xRotation),[1,0,0]);mat4.rotate(this.mvMatrix,this.degToRad(this.yRotation),[0,1,0]);this.drawCube();mat4.translate(this.mvMatrix,[2,0,0]);this.drawCube()},animate:function(){var timeNow=(new Date).getTime(),elapsed;this.lastTime!==0&&(elapsed=timeNow-this.lastTime,this.xRotation+=this.xSpeed*elapsed/1e3,this.yRotation+=this.ySpeed*elapsed/1e3);this.lastTime=timeNow},tick:function(){BNTest.App.initSettings(this);this.handleKeys();this.drawScene();this.animate();Bridge.global.setTimeout(Bridge.fn.bind(this,this.tick),20)}});Bridge.define("BNTest.GameMode.ModeTypes",{$kind:"enum",statics:{Skirmish:0,Challenge:1,CallengeCoop:2}});Bridge.define("BNTest.GamePad",{connected:!1,axes:null,buttons:null,id:null,index:System.Int64(0),ctor:function(pad){var length,i;for(this.$initialize(),this.id=pad.id,this.index=System.Int64(pad.index),this.connected=pad.connected,this.axes=pad.axes,length=pad.buttons.length,this.buttons=System.Array.init(length,null),i=0;i<length;)this.buttons[i]=pad.buttons[i],i=i+1|0},update:function(){for(var i=0;i<this.buttons.length;)this.buttons[i].tapped=!1,i=i+1|0},combineData:function(pad){Bridge.referenceEquals(this.id,pad.id)&&(this.connected=pad.connected,this.axes=pad.axes,this.combineButtonData(pad.buttons))},combineButtonData:function(buttons){var Lb=buttons,i;for(this.buttons=buttons,i=0;i<buttons.length;)buttons[i].pressed&&!Lb[i].pressed&&(buttons[i].tapped=!0),i=i+1|0}});Bridge.define("BNTest.GamePadButton",{tapped:!1,pressed:!1,value:0,ctor:function(button){this.$initialize();this.pressed=button.pressed;this.value=button.value;this.tapped=!1}});Bridge.define("BNTest.GamePadManager",{statics:{_this:null},keyboard:null,gamepads:null,tempgamepads:null,ctor:function(){this.$initialize();this.gamepads=new(System.Collections.Generic.List$1(BNTest.GamePad));this.update()},getactiveGamepads:function(){return new(System.Collections.Generic.List$1(BNTest.GamePad))(System.Linq.Enumerable.from(this.gamepads).where($_.BNTest.GamePadManager.f1))},callBackTest:function(){Bridge.global.alert("Callback!")},getPad:function(id){var L=new(System.Collections.Generic.List$1(BNTest.GamePad))(System.Linq.Enumerable.from(this.gamepads).where(function(gamepad){return Bridge.referenceEquals(gamepad.id,id)}));return L.getCount()>0?L.getItem(0):null},update:function(){for(var i=0,pads,pad;i<this.gamepads.getCount();)this.gamepads.getItem(i).update(),i=i+1|0;for(i=0,this.tempgamepads=navigator.getGamepads()||navigator.webkitGetGamepads()||[],pads=new(System.Collections.Generic.List$1(BNTest.GamePad));i<this.tempgamepads.length;)this.tempgamepads[i]!=null&&(pad=new BNTest.GamePad(this.tempgamepads[i]),this._Update(pad),pads.add(pad)),i=i+1|0;for(i=0;i<pads.getCount();){for(var id=pads.getItem(i).id,j=0,ok=!0;j<this.gamepads.getCount();)Bridge.referenceEquals(this.gamepads.getItem(j).id,id)&&(ok=!1),j=j+1|0;ok&&this.gamepads.add(pads.getItem(i));i=i+1|0}},_Update:function(pad){for(var i=0,P;i<this.gamepads.getCount();)P=this.gamepads.getItem(i),Bridge.referenceEquals(P.id,pad.id)&&P.combineData(pad),i=i+1|0}});Bridge.ns("BNTest.GamePadManager",$_);Bridge.apply($_.BNTest.GamePadManager,{f1:function(gamepad){return gamepad.connected}});Bridge.define("BNTest.GamePlaySettings",{online:!1,myCharacter:"Reisen",gameMode:null,myTeam:1,blueNPCs:3,redNPCs:2,roomID:"",hostNPOut:null,computerAIModifier:1,ctor:function(){this.$initialize();this.gameMode=BNTest.GameMode.deathMatch}});Bridge.define("BNTest.GLColor",{statics:{white:null,config:{init:function(){this.white=new BNTest.GLColor(1,1,1)}},fromArgb:function(a,r,g,b){return new BNTest.GLColor(a/255,r/255,g/255,b/255)},colorFromAhsb:function(a,h,s,b){if(0===s)return BNTest.GLColor.createShade(b/255);var fMax,fMid,fMin,iSextant,iMax,iMid,iMin;.5<b?(fMax=b-b*s+s,fMin=b+b*s-s):(fMax=b+b*s,fMin=b-b*s);iSextant=Bridge.Int.clip32(Math.floor(h/60));300<=h&&(h-=360);h/=60;h-=2*Math.floor((iSextant+1)%6/2);fMid=0==iSextant%2?h*(fMax-fMin)+fMin:fMin-h*(fMax-fMin);iMax=System.Convert.toInt32(fMax*255);iMid=System.Convert.toInt32(fMid*255);iMin=System.Convert.toInt32(fMin*255);switch(iSextant){case 1:return BNTest.GLColor.fromArgb(a,iMid,iMax,iMin);case 2:return BNTest.GLColor.fromArgb(a,iMin,iMax,iMid);case 3:return BNTest.GLColor.fromArgb(a,iMin,iMid,iMax);case 4:return BNTest.GLColor.fromArgb(a,iMid,iMin,iMax);case 5:return BNTest.GLColor.fromArgb(a,iMax,iMin,iMid);default:return BNTest.GLColor.fromArgb(a,iMax,iMid,iMin)}},randomB:function(RMn,GMn,BMn,RMx,GMx,BMx){return RMn===void 0&&(RMn=0),GMn===void 0&&(GMn=0),BMn===void 0&&(BMn=0),RMx===void 0&&(RMx=1),GMx===void 0&&(GMx=1),BMx===void 0&&(BMx=1),new BNTest.GLColor(RMn+Math.random()*(RMx-RMn),GMn+Math.random()*(GMx-GMn),BMn+Math.random()*(BMx-BMn))},random$1:function(max){return new BNTest.GLColor(Math.random()*max,Math.random()*max,Math.random()*max,1)},random:function(){return new BNTest.GLColor(Math.random(),Math.random(),Math.random(),1)},random2:function(){return new BNTest.GLColor(Math.random(),Math.random(),Math.random(),Math.random())},createShade:function(Value){return new BNTest.GLColor(Value,Value,Value,1)},op_Addition:function(C1,C2){var R=BNTest.MathHelper.clamp(C1.r+C2.r),G=BNTest.MathHelper.clamp(C1.g+C2.g),B=BNTest.MathHelper.clamp(C1.b+C2.b);return new BNTest.GLColor(R,G,B,C1.a)},op_Subtraction:function(C1,C2){var R=BNTest.MathHelper.clamp(C1.r-C2.r),G=BNTest.MathHelper.clamp(C1.g-C2.g),B=BNTest.MathHelper.clamp(C1.b-C2.b);return new BNTest.GLColor(R,G,B,C1.a)},op_Multiply:function(C,brightness){return new BNTest.GLColor(C.r*brightness,C.g*brightness,C.b*brightness)}},a:0,r:0,g:0,b:0,ctor:function(R,G,B,A){R===void 0&&(R=0);G===void 0&&(G=0);B===void 0&&(B=0);A===void 0&&(A=1);this.$initialize();this.r=R;this.g=G;this.b=B;this.a=A},getRoughLength:function(){return Math.abs(this.r)+Math.abs(this.g)+Math.abs(this.b)},equals:function(o){var C=o;return C.r===this.r&&C.g===this.g&&C.b===this.b&&C.a===this.a},similar:function(C){if(this.equals(C))return!0;var R=Math.abs(this.r-C.r),G=Math.abs(this.g-C.g),B=Math.abs(this.b-C.b);return R+G+B<=.0075},toARGB:function(){var R=Bridge.Int.clip32(this.r*255),G=Bridge.Int.clip32(this.g*255),B=Bridge.Int.clip32(this.b*255),A=Bridge.Int.clip32(this.a*255);return((Bridge.Int.clip32(this.r*255)+(Bridge.Int.clip32(this.g*255)<<8)|0)+(Bridge.Int.clip32(this.b*255)<<16)|0)+(Bridge.Int.clip32(this.a*255)<<24)|0},fromArgb:function(ARGB){var R=(ARGB&255)/255,G=(ARGB>>8&255)/255,B=(ARGB>>16&255)/255,A=(ARGB>>24&255)/255;return new BNTest.GLColor(R,G,B,A)},setAhsb:function(h,s,b){var C=BNTest.GLColor.colorFromAhsb(255,h,s,b);this.r=C.r;this.g=C.g;this.b=C.b},copy:function(C){this.a=C.a;this.r=C.r;this.g=C.g;this.b=C.b}});Bridge.define("BNTest.GLDemo",{statics:{allowAlpha:!0,VK_Enter:13,_this:null,missingTime:0,lastTime:0,updated:!0,doDrawScene:function(elapsedTime){requestAnimationFrame(BNTest.GLDemo.doDrawScene);BNTest.GLDemo.lastTime===0&&(BNTest.GLDemo.lastTime=elapsedTime);var T=elapsedTime-BNTest.GLDemo.lastTime;BNTest.GLDemo._this.paused||(BNTest.GLDemo._this.totaltime+=T);BNTest.GLDemo.missingTime+=T;BNTest.GLDemo.missingTime>48&&(BNTest.GLDemo.missingTime=35);BNTest.GLDemo.updated&&(BNTest.GLDemo._this.drawScene(elapsedTime),BNTest.GLDemo.updated=!1);BNTest.GLDemo._this.update(elapsedTime);BNTest.GLDemo.missingTime-=16.6667;BNTest.GLDemo.updated=!0;BNTest.GLDemo.missingTime>=16.6667&&(BNTest.GLDemo._this.update(elapsedTime),BNTest.GLDemo.missingTime-=16.6667,BNTest.GLDemo.updated=!0);BNTest.GLDemo.lastTime=elapsedTime},test:function(self){self._test()}},canvas:null,gl:null,shaderProgram:null,cubeVerticesBuffer:null,cubeVerticesColorBuffer:null,cubeVerticesIndexBuffer:null,vertexPositionAttribute:0,vertexColorAttribute:0,localplayer:null,boss:null,netPlayNeedsFlush:!1,cameracontrols:!1,matrixNeedsFlush:!0,vertexTextureCoordAttribute:0,samplerUniform:null,alphaUniform:null,colorUniform:null,world:null,camera:null,foliage:null,hoster:!0,fogActive:!1,cameraDist:300,lastCameraDist:0,lastZnear:0,bGMVolume:.4,bGMMute:!1,gamePlaySettings:null,currentAlpha:1,alphalist:null,cubeRotation:0,cubeXOffset:0,cubeYOffset:0,cubeZOffset:0,lastCubeUpdateTime:0,theDepthFunc:0,xIncValue:0,yIncValue:0,zIncValue:0,mouseAngle:0,loadProgress:0,maxLoadProgress:0,maxLoadQueue:0,model:null,perspectiveMatrix:null,mvMatrix:null,matrix:null,depthTest:!1,entities:null,players:null,online:!1,frame:0,music:null,VTS:null,TS:null,LTS:null,BTS:null,radar:null,ended:!0,gameover:!1,started:!1,totaltime:0,lastsong:"",titleRunning:!1,titlescreen:!0,defaultBulletSpeedRate:.65,bulletSpeedRate:1,wavetime:3,wave:0,enemyList:null,smooth:!0,lastModelName:"rahmoo",lastModel:null,nPCSpawntime:0,dNPCSpawntime:7500,nextSpawn:0,nPCs:0,maxWaveDelay:150,waveDelay:0,paused:!1,latencyM:100,dlatency:0,tflat:null,mvMatrixStack:null,pUniform:null,mvUniform:null,config:{init:function(){this.alphalist=[];this.matrix=new BNTest.WGMatrix;this.entities=new(System.Collections.Generic.List$1(BNTest.Entity));this.players=new(System.Collections.Generic.List$1(BNTest.Player));this.VTS=new BNTest.TextSprite;this.TS=new BNTest.TextSprite;this.LTS=new BNTest.TextSprite;this.BTS=new BNTest.TextSprite;this.radar=new BNTest.Sprite;this.tflat=System.Array.init(16,0);this.mvMatrixStack=[]}},start:function(canvas){var path,f,isFirefox,self,character,PC,box,c,F,B,BS,V,tree,fi;if(this.canvas=canvas,this.VTS.setText(System.String.concat("Version:",BNTest.App.gameVersion)),this.VTS.setFontSize(16),this.VTS.setTextColor("#FFFFFF"),this.VTS.setShadowBlur(5),this.VTS.setShadowOffset(new BNTest.Vector2(3,3)),this.VTS.setShadowColor("#000000"),this.radar.spriteBuffer.width=(this.radar.spriteBuffer.height=150,150),BNTest.AnimationLoader.init(),BNTest.AudioManager.init(),BNTest.AnimationLoader.directory="Assets/Images/",BNTest.AudioManager.directory="Assets/Audio/",path="Assets/Images.zip",f=System.String.concat(path,"://rahmoo_0.png"),console.log(System.String.concat("test zip path:",f)),isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,isFirefox?this.bGMVolume*=.75:BNTest.AnimationLoader.get_this().setZip("Assets/Images.zip"),BNTest.App.DEBUG&&(this.bGMMute=!0),this.initWebGL(canvas),this.playMusic("titlescreen",.6),BNTest.GLDemo._this=this,this.gl!=null){this.gl.clearColor(0,0,0,1);this.gl.clearColor(.5,.5,.5,1);this.gl.clearDepth(1);BNTest.GLDemo.allowAlpha?(this.depthTest=!0,this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)):(this.depthTest=!0,this.gl.enable(this.gl.DEPTH_TEST),this.setDepthFunc(this.gl.LEQUAL));this.initShaders();this.initBuffers();Bridge.global.requestAnimationFrame(BNTest.GLDemo.doDrawScene);self=this;this.camera=new BNTest.Model(self);this.camera.rotation.x=40;this.world=new BNTest.World(self);this.camera.children.add(this.world.model);this.foliage=new BNTest.Foliage(this.world);this.generateFloor();this.world.add(this.foliage);this.gamePlaySettings=new BNTest.GamePlaySettings;this.gamePlaySettings.gameMode=BNTest.GameMode.teamBattle;this.localplayer=new BNTest.Player(!0,!1);character="reimu";PC=new BNTest.PlayerCharacter(this.world,this.localplayer,character);this.localplayer.character=PC;PC.getPosition().y=-15e3;PC.setCoins(1e3);PC.defense=5;PC.visible=!1;PC.setHitboxSize(PC.getHitboxSize()*.35);this.world.add(PC);box=new BNTest.DonationBox(this.world);this.world.add(box);c=new BNTest.Coin(this.world);c.solid=!1;c.setPosition(new BNTest.GLVec3.ctor(50,1e4,50));c.getBehavior(BNTest.LifeSpan).HP=1;c.model.setVisible(!1);this.world.add(c);F=this.foliage;this.world.add(F);B=this.world.model.getBoundingBox();BS=B.getSize();BS.y=0;var max=40,i=max,RND=new System.Random.ctor,FC=[new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,0,1),new BNTest.GLColor(0,0,1)],shrub=new BNTest.GLColor(0,.6,.1),rng=800,rng2=rng+rng|0,range=new BNTest.GLVec3.ctor(rng2,-5,rng2),hrange=new BNTest.GLVec3.ctor(rng,-15,rng);for(box.lastBB=BNTest.BoundingBox.op_Addition(new BNTest.BoundingBox.$ctor2(40),box.model.offset);i>0;){for(V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V,!0)&&(tree=new BNTest.Tree(this.world),tree.setPosition(new BNTest.GLVec3.ctor(V.x,tree.getPosition().y,V.z)),this.world.add(tree),tree.cacheBoundingBox(),tree.lastBB=BNTest.BoundingBox.op_Addition(tree.customBoundingBox,tree.getPosition()),F.absorbModel$1(tree.model)),fi=7;fi>0;)V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V)&&(V.y=7,F.addFlower(V,BNTest.HelperExtensions.pick(BNTest.GLColor,FC),null,2+Math.random()*3)),fi=fi-1|0;for(fi=3,fi=2;fi>0;)V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V)&&(V.y=8,F.addPatch(V,shrub,15+Bridge.Int.clip32(Math.random()*15)|0,.1+Math.random()*.2,2.5+Math.random()*2.5)),fi=fi-1|0;i=i-1|0}BNTest.AnimationLoader.get_this().asyncGet$1(["object/mushroom"],Bridge.fn.bind(this,function(){var $t,OVM=BNTest.VoxelMap.fromImages$1("object/mushroom"),pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),C=new BNTest.GLColor,C2=new BNTest.GLColor(1,1,1),V1,VM,mod,msh;for(pal.set(new BNTest.GLColor(1,0,0),C),pal.set(new BNTest.GLColor(1,1,1),C2),i=max*2|0;i>0;)V1=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V1)&&(V1.y=4,C2.a=C2.r=C2.g=C2.b=1,C.setAhsb(Math.random(),Math.random(),Math.random()),Math.random()<.5&&C2.copy(C),VM=OVM.clone(),VM.applyPalette(pal),VM.addNoise(.1*Math.random()),mod=new BNTest.Model(this),msh=new BNTest.Mesh(this),msh.addVoxelMap(VM,!0),mod.meshes.add(msh),mod.offset=V1,mod.rotation.y=Math.random()*360,mod.scale.y*=.75+Math.random()*.7,mod.scale.x=($t=mod.scale.y*(.75+Math.random()*.7),mod.scale.z=$t,$t),this.foliage.absorbModel$1(mod)),i=i-1|0}))}},playMusic:function(song,volume){(volume===void 0&&(volume=1),Bridge.referenceEquals(song,this.lastsong))||(this.music!=null&&this.music.stop(),this.music=BNTest.AudioManager.get_this().play(System.String.concat(System.String.concat("BGM/",song),".ogg"),!0),this.bGMMute?this.music.setVolume(0):this.music.setVolume(BNTest.MathHelper.clamp(this.bGMVolume)*BNTest.MathHelper.clamp(volume)),this.lastsong=song)},safeForFoliage:function(V,solid){var Bnds,VL;return(solid===void 0&&(solid=!1),Bnds=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Subtraction(V,BNTest.GLVec3.createUniform(-25)),BNTest.GLVec3.op_Addition(V,BNTest.GLVec3.createUniform(80))),this.world.findSolidCollision(Bnds).length<=0&&(!solid||(VL=V.getRoughLength(),VL>=250||Math.abs(V.z-60)>150)))?!0:!1},setBarriers:function(box,thickness){thickness===void 0&&(thickness=1);var size=box.getSize(),B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(size.x,size.y,thickness));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,0)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(size.x,size.y,thickness));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,size.z)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(thickness,size.y,size.z));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(size.x,0,0)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(thickness,size.y,size.z));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,0)));this.world.add(B)},addNPC:function(){var Char="suika",NPC;this.nPCs>=this.enemyList.length||(Char=this.enemyList[this.nPCs],NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0,!0),Char),this.setNPC(NPC),this.world.add(NPC),this.nPCs=this.nPCs+1|0)},setNPC:function(NPC){var mindist=250,range=500-mindist,dist=mindist+Math.random()*range,V=BNTest.Vector2.op_Multiply(BNTest.Vector2.fromRadian(6.28*Math.random()),dist);NPC.setx(V.x);NPC.sety(-500);NPC.setz(V.y);NPC.speed=new BNTest.GLVec3.ctor;NPC.setHP(100)},generateFloor:function(){var self=this,FVM=BNTest.VoxelMap.gen(80,2,0,!0,!1,!0),msh=new BNTest.Mesh(self),floor,B;msh.addVoxelMap(FVM,!1,!1,!0);floor=new BNTest.Entity(this.world);floor.model=new BNTest.Model(self);for(var $final=floor,V,size=2,x=-size|0,z=-size|0;x<=size;){while(z<=size)floor=new BNTest.Entity(this.world),floor.model=new BNTest.Model(self),floor.sety(10),floor.getScale().x=4,floor.getScale().y=floor.getScale().x,floor.getScale().z=floor.getScale().x,V=BNTest.GLVec3.op_Multiply$1(new BNTest.GLVec3.ctor(40,0,40),floor.getScale().x),floor.setx(-V.x),floor.setz(-V.z),floor.setx(floor.getx()+V.x*(x*2|0)),floor.setz(floor.getz()+V.z*(z*2|0)),floor.model.meshes.add(msh.clone()),floor.cacheBoundingBox(),this.world.add(floor),this.foliage.absorbModel(floor),z=z+1|0;z=-size|0;x=x+1|0}B=this.world.model.getBoundingBox();B.min.y-=100;this.setBarriers(B,5)},setDepthFunc:function(DF){this.gl.depthFunc(DF);this.theDepthFunc=DF},setDepthTest:function(active){this.depthTest!==active&&(this.depthTest=active,active?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST))},nextWave:function(skip){var basetime,DB,L,D,NPC,T;if(skip===void 0&&(skip=10),this.boss=null,this.localplayer.character.setHP(100),this.wave=this.wave+1|0,this.clearEntities(),this.bulletSpeedRate=this.defaultBulletSpeedRate+this.wave*.022,this.bulletSpeedRate=Math.min(this.bulletSpeedRate,2.5),this.waveDelay=this.maxWaveDelay,this.totaltime=0,this.nPCs=0,this.nextSpawn=-((this.nPCSpawntime-1)*(Bridge.Int.div(skip,2)|0)),this.started=!0,basetime=.5,DB=System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.DonationBox).toArray()[0],DB.maxHP=DB.defaultMaxHP,this.nPCSpawntime=this.dNPCSpawntime,this.enemyList=System.Array.init(0,null),L=this.enemyList,D=1,this.wave===1)BNTest.Helper.addMultiple(String,L,"suika",15),BNTest.Helper.addMultiple(String,L,"cirno",1),BNTest.Helper.addMultiple(String,L,"suika",6),DB.maxHP=DB.maxHP*2|0,D=1.2;else if(this.wave===2)BNTest.Helper.addMultiple(String,L,"suika",13),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"suika",8);else if(this.wave===3)BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"cirno",4),BNTest.Helper.addMultiple(String,L,"suika",10);else if(this.wave===4)BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"cirno",4),BNTest.Helper.addMultiple(String,L,"suika",10);else if(this.wave===5)BNTest.Helper.addMultiple(String,L,"suika",8),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"cirno",3),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"suika",4),BNTest.Helper.addMultiple(String,L,"cirno",2),BNTest.Helper.addMultiple(String,L,"suika",3);else if(this.wave===6)BNTest.Helper.addMultiple(String,L,"suika",10),D=.8,BNTest.Helper.addMultiple(String,L,"sakuya",3),BNTest.Helper.addMultiple(String,L,"suika",8);else if(this.wave===7)BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"sakuya",1),BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sakuya",2);else if(this.wave===8)D=.9,BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",5),BNTest.Helper.addMultiple(String,L,"suika",6);else if(this.wave===9)D=.81,BNTest.Helper.addMultiple(String,L,"cirno",27),basetime=.25;else if(this.wave===11)D=.85,BNTest.Helper.addMultiple(String,L,"cirno",3),BNTest.Helper.addMultiple(String,L,"suika",4),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",3),BNTest.Helper.addMultiple(String,L,"suika",14);else if(this.wave===12)D=.9,BNTest.Helper.addMultiple(String,L,"sanae",4),BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"aya",1),BNTest.Helper.addMultiple(String,L,"suika",6),BNTest.Helper.addMultiple(String,L,"aya",1),BNTest.Helper.addMultiple(String,L,"suika",4);else if(this.wave===13)D=.35,BNTest.Helper.addMultiple(String,L,"suika",50);else if(this.wave===14)BNTest.Helper.addMultiple(String,L,"suika",10),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"suika",2),BNTest.Helper.addMultiple(String,L,"youmu",1),BNTest.Helper.addMultiple(String,L,"suika",5),BNTest.Helper.addMultiple(String,L,"youmu",1),BNTest.Helper.addMultiple(String,L,"suika",7);else if(this.wave===18)BNTest.Helper.addMultiple(String,L,"suika",10),BNTest.Helper.addMultiple(String,L,"reisen",2),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"suika",3),BNTest.Helper.addMultiple(String,L,"sakuya",1),BNTest.Helper.addMultiple(String,L,"reisen",1),BNTest.Helper.addMultiple(String,L,"suika",6);else if(this.wave>0&&this.wave%10==0){for(var bosses=["koishi","marisa","tenshi"],Char="",i=Bridge.Int.div(this.wave-10|0,10)|0;i>=bosses.length;)i=i-bosses.length|0;Char=bosses[i];NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0),Char);NPC.defense=12+(Bridge.Int.div(this.wave,3)|0)|0;this.setNPC(NPC);this.world.add(NPC);this.boss=NPC;BNTest.Helper.addMultiple(String,L,"sanae",1);BNTest.Helper.addMultiple(String,L,"cirno",1);BNTest.Helper.addMultiple(String,L,"suika",15)}L.length===0&&this.doRandomWave();this.nPCSpawntime*=D;T=this.nPCSpawntime/1e3;T/=60;T*=.5;this.wavetime=(this.enemyList.length-skip|0)*T+basetime},doRandomWave:function(){var difficulty=this.wave*.1,max=Math.min(50,20+difficulty),pool=System.Array.init(0,null),RND,i;for(BNTest.Helper.addMultiple(String,pool,"suika",60),BNTest.Helper.addMultiple(String,pool,"cirno",12),BNTest.Helper.addMultiple(String,pool,"sanae",Bridge.Int.clip32(10+difficulty*2)),BNTest.Helper.addMultiple(String,pool,"sakuya",Bridge.Int.clip32(4+difficulty*1.6)),BNTest.Helper.addMultiple(String,pool,"aya",Bridge.Int.clip32(2+difficulty*1.3)),BNTest.Helper.addMultiple(String,pool,"youmu",Bridge.Int.clip32(2+difficulty*1.1)),this.wave>20&&BNTest.Helper.addMultiple(String,pool,"reisen",Bridge.Int.clip32(2+difficulty*1.1)),RND=new System.Random.ctor,i=0;i<max;)this.enemyList.push(BNTest.HelperExtensions.pick(String,pool,RND)),i=i+1|0},updateControls:function(){var $t,$t1,x,y,cid,o;BNTest.App.DEBUG&&this.updateDebug();BNTest.KeyboardManager.get_this().tappedButtons.contains(77)&&(this.music.getVolume()===0?(this.music.setVolume(this.bGMVolume),this.bGMMute=!1):(this.music.setVolume(0),this.bGMMute=!0));BNTest.KeyboardManager.get_this().tappedButtons.contains(BNTest.GLDemo.VK_Enter)&&BNTest.AnimationLoader.get_this().isIdle()&&(this.ended?(this.gameover&&(this.localplayer.lives=3,this.localplayer.character.setCoins(1e3),this.wave=0),BNTest.App.guiCanvas.style.opacity="0.85",this.titleRunning=!1,this.titlescreen=!1,this.world.add(this.localplayer.character),this.localplayer.character.setPosition(new BNTest.GLVec3.ctor(0,-15,0)),this.world.model.rotation.y=0,this.gameover=!1,this.ended=!1,this.playMusic("music"),this.localplayer.character.respawnPosition=this.localplayer.character.getPosition().clone(),this.nextWave(),this.clearEntities()):this.paused=!this.paused);BNTest.KeyboardManager.get_this().tappedButtons.contains(48)&&(this.radar.visible=!this.radar.visible);BNTest.KeyboardManager.get_this().pressedButtons.contains(219)&&(this.frame&3)==0&&(this.radar.spriteBuffer.height=($t=Math.min(this.radar.spriteBuffer.width+3|0,500),this.radar.spriteBuffer.width=$t,$t));BNTest.KeyboardManager.get_this().pressedButtons.contains(221)&&(this.frame&3)==0&&(this.radar.spriteBuffer.height=($t1=Math.max(this.radar.spriteBuffer.width-3|0,15),this.radar.spriteBuffer.width=$t1,$t1));var PC=this.localplayer.character,threshhold=.7,C=PC.controller;BNTest.App.IC!=null&&(x=BNTest.App.IC.getState(0),y=BNTest.App.IC.getState(1),C[0]=x<=-threshhold,C[1]=x>=threshhold,C[2]=y<=-threshhold,C[3]=y>=threshhold,cid=BNTest.App.IC.getMapControllerID$1(5),(Bridge.referenceEquals(cid,"Keyboard")||Bridge.referenceEquals(cid,"Mouse"))&&(C[4]=BNTest.App.IC.getPressed(2),C[5]=BNTest.App.IC.getPressed(3),C[6]=BNTest.App.IC.getPressed(4)),C[4]=BNTest.App.IC.getPressed(2),C[5]=BNTest.App.IC.getPressed(3),C[6]=BNTest.App.IC.getPressed(4),o={})},rotateTest:function(M,val){val===void 0&&(val="x");M.Dir==null&&(M.Dir=1);M.Max==null&&(M.Max=45);M.Spd==null&&(M.Spd=1.5);var max=System.Nullable.getValue(Bridge.cast(M.Max,System.Double)),spd=System.Nullable.getValue(Bridge.cast(M.Spd,System.Double));M.rotation[val]=System.Nullable.getValue(Bridge.cast(M.rotation[val],System.Double))+spd*System.Nullable.getValue(Bridge.cast(M.Dir,System.Double));Math.abs(System.Nullable.getValue(Bridge.cast(M.rotation[val],System.Double)))>=max&&(M.Dir=-System.Nullable.getValue(Bridge.cast(M.Dir,System.Double)))},initWebGL:function(canvas){this.gl=null;try{this.gl=canvas.getContext("experimental-webgl")}catch(e){e=System.Exception.create(e)}this.gl==null&&Bridge.global.alert("Unable to initialize WebGL. Your browser may not support it.")},initBuffers:function(){var vertices,colors,generatedColors,j,c,i,cubeVertexIndices;for(this.cubeVerticesBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVerticesBuffer),vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertices),this.gl.STATIC_DRAW),colors=[[1,1,1,1],[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[1,0,1,1]],generatedColors=[],j=0;j<6;j=j+1|0)for(c=colors[j],i=0;i<4;i=i+1|0)generatedColors=generatedColors.concat(c);this.cubeVerticesColorBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVerticesColorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(generatedColors),this.gl.STATIC_DRAW);this.cubeVerticesIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer);cubeVertexIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(cubeVertexIndices),this.gl.STATIC_DRAW)},getVoxelCombo:function(assets){var A,VM;if(assets==null||assets.length===0)return null;for(var ret=null,i=0,ok=!0;i<assets.length;)A=BNTest.AnimationLoader.get(assets[i]),A!=null&&A.getCount()>0&&ok?(VM=BNTest.VoxelMap.fromImages(A),ret==null?ret=VM:VM!=null?ret.combine(VM):(ret=null,ok=!1)):ok=!1,i=i+1|0;return ret},attack:function(target,source){if(target.BNTest$ICombatant$onDamaged(source,source.BNTest$IHarmfulEntity$gettouchDamage()),target.playSound("hit"),target.BNTest$ICombatant$getHP()<=0&&target.getHandledLocally()){var D={};D.I=target.ID;D.A=source.BNTest$IHarmfulEntity$getAttacker().ID;D.S=source.ID;this.sendEvent("Kill",D)}},update:function(){if(!this.paused){if(this.waveDelay>0)this.totaltime=0,this.waveDelay=this.waveDelay-1|0;else if(this.totaltime>this.nextSpawn&&!this.ended&&BNTest.AnimationLoader.get_this().isIdle()){this.nextSpawn+=this.nPCSpawntime;for(var i=2;i>0;)this.addNPC(),i=i-1|0}this.world.update()}},updateDebug:function(){if(BNTest.KeyboardManager.get_this().tappedButtons.contains(70)&&(this.fogActive=!this.fogActive,this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),this.fogActive)),BNTest.KeyboardManager.get_this().tappedButtons.contains(82)&&(BNTest.KeyboardManager.allowRightClick=!BNTest.KeyboardManager.allowRightClick),BNTest.KeyboardManager.get_this().tappedButtons.contains(67)&&(this.cameracontrols=!this.cameracontrols),BNTest.KeyboardManager.get_this().tappedButtons.contains(66)&&BNTest.AnimationLoader.get_this().isIdle()&&!this.ended&&this.boss==null){var NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0),"koishi");NPC.defense=15+this.wave|0;this.setNPC(NPC);this.world.add(NPC);this.boss=NPC}BNTest.KeyboardManager.get_this().tappedButtons.contains(78)&&!this.ended&&(this.localplayer.character.setCoins(this.localplayer.character.getCoins()+50|0),this.waveDelay=0,this.wavetime=0,this.nextWave())},drawGauge:function(g,position,size,border,progress,color,drawborder){drawborder===void 0&&(drawborder=!0);drawborder&&(g.globalAlpha=.6,g.fillStyle="#000000",g.fillRect(position.x,position.y,size.x,size.y));g.fillStyle=color;g.globalAlpha=1;g.fillRect(Bridge.Int.clip32(position.x)+border|0,Bridge.Int.clip32(position.y)+border|0,(size.x-(border+border|0))*progress,Bridge.Int.clip32(size.y)-(border+border|0)|0);g.globalAlpha=.5;var grd=g.createLinearGradient(0,0,0,size.y);grd.addColorStop(0,color);grd.addColorStop(.4,"white");grd.addColorStop(1,color);g.fillStyle=grd;g.fillRect(Bridge.Int.clip32(position.x)+border|0,Bridge.Int.clip32(position.y)+border|0,(size.x-(border+border|0))*progress,Bridge.Int.clip32(size.y)-(border+border|0)|0);g.globalAlpha=1},drawScene:function(){var self=this,V,walking,spd,D,fog,testest,test2,currentTime,delta;this.gl.clearDepth(1);this.frame=this.frame+1|0;V=BNTest.Vector2.op_Subtraction(BNTest.KeyboardManager.get_this().cMouse,new BNTest.Vector2(BNTest.App.canvas.width>>1,BNTest.App.canvas.height>>1));V.x*=.75;this.mouseAngle=V.toAngle();this.updateControls();walking=!1;this.world!=null&&(this.cameracontrols&&(BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(0)&&(this.cameraDist*=1.01),BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(1)&&(this.camera.rotation.z+=2),BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(2)&&(this.cameraDist*=.99),BNTest.KeyboardManager.get_this().mouseDelta!==0&&(this.cameraDist*=1+BNTest.KeyboardManager.get_this().mouseDelta*.05)),this.model!=null&&this.world.setOffset(BNTest.GLVec3.op_Multiply$1(this.model.offset,-1)),spd=.8,D=new BNTest.GLVec3.ctor);BNTest.App.update();this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.setPerspective();this.loadIdentity();this.mvTranslate([0,0,-this.cameraDist]);this.fogActive&&(fog=.55,fog/=this.cameraDist,fog=fog*fog*1.44,this.gl.uniform1f(this.gl.getUniformLocation(this.shaderProgram,"uFogDensity"),fog));this.mvPushMatrix();this.mvScale(new BNTest.GLVec3.ctor(1,-1,1));this.cameracontrols&&(this.cubeRotation=-(BNTest.KeyboardManager.get_this().cMouse.x-512)*.4,this.camera.rotation.y=this.cubeRotation,this.cubeRotation=(BNTest.KeyboardManager.get_this().cMouse.y-384)*.4,this.camera.rotation.x=this.cubeRotation);this.mvTranslate([this.cubeXOffset,this.cubeYOffset,this.cubeZOffset]);this.matrixNeedsFlush=!0;this.titlescreen&&!this.titleRunning&&BNTest.AnimationLoader.get_this().isIdle()&&this.doTitle();this.camera!=null&&this.camera.render();testest=new BNTest.WGMatrix;testest.mvTranslate([100,200,300]);testest.mvScale(new BNTest.GLVec3.ctor(10,10,10));test2=new BNTest.WGMatrix;test2.setPositionThenScale(new BNTest.GLVec3.ctor(100,200,300),new BNTest.GLVec3.ctor(10,10,10));this.titlescreen?(this.world.setOffset(new BNTest.GLVec3.ctor(0,15,0)),this.world.model.rotation.y+=.1):this.localplayer!=null&&this.world.setOffset(BNTest.GLVec3.op_Multiply$1(this.localplayer.character.model.offset,-1));this.started||BNTest.AnimationLoader.get_this().queueEmpty();this.mvPopMatrix();currentTime=(new Date).getTime();this.lastCubeUpdateTime!=null&&this.lastCubeUpdateTime>0&&(delta=currentTime-this.lastCubeUpdateTime,this.cubeRotation+=30*delta/1e3);this.updateGui();this.lastCubeUpdateTime=currentTime},setPerspective:function(znearRate){var ZN,znear,zfar,flat,A;(znearRate===void 0&&(znearRate=.325),ZN=this.cameraDist*znearRate,this.perspectiveMatrix==null||this.cameraDist!==this.lastCameraDist||ZN!==this.lastZnear)&&(znear=.1,zfar=1e4,znear=ZN,this.perspectiveMatrix=makePerspective(45,640/480,znear,zfar),flat=this.tflat,this.flatten$1(this.perspectiveMatrix,flat),A=new Float32Array(flat),this.gl.uniformMatrix4fv(this.pUniform,!1,A),this.lastZnear=ZN)},clearEntities:function(coins){coins===void 0&&(coins=!1);BNTest.HelperExtensions.forEach(BNTest.Entity,this.world.entities,function(E){(Bridge.is(E,BNTest.PlayerCharacter)&&Bridge.cast(E,BNTest.PlayerCharacter).me.CPU||coins&&Bridge.is(E,BNTest.Coin)||Bridge.is(E,BNTest.Projectile))&&(E.alive=!1)});this.boss=null},doTitle:function(){var i,Char,NPC,W;for(this.titleRunning=!0,this.paused=!1,this.world.remove(this.localplayer.character),this.localplayer.character.visible=!1,i=0;i<30;)Char="suika",NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0,!0),Char),this.setNPC(NPC),this.world.add(NPC),this.nPCs=this.nPCs+1|0,NPC.getBehavior(BNTest.NavigatorAI).canJump=!1,NPC.getBehavior(BNTest.AimedWandering).enabled=!1,W=NPC.getBehavior(BNTest.WanderAI),W.framesPerTick=15+Bridge.Int.clip32(Math.random()*20)|0,W.range*=2,W.chance=.6,i=i+1|0;this.playMusic("titlescreen",.6)},updateGui:function(){var tt=Bridge.Int.clip32(this.totaltime*.001),max=this.wavetime*60,tim=Bridge.Int.clip32(max-tt),done=tim<0&&!this.ended,pad,gui,QS,loaded,A,V,L,hsz,off,T,TX,TY;this.boss!=null&&(done=this.boss.getHP()<=0||this.boss.respawnTime>0);done&&this.nextWave();(this.localplayer.character.getCoins()<=0||this.localplayer.lives<0||BNTest.KeyboardManager.get_this().pressedButtons.contains(27))&&!this.gameover&&(this.gameover=!0,BNTest.KeyboardManager.get_this().pressedButtons.contains(27),this.ended=!0,this.clearEntities(!0),this.totaltime=0,this.titlescreen=!0,BNTest.App.guiCanvas.style.opacity="1",this.localplayer.character.respawnTime>0&&(this.localplayer.character.respawnTime=0));tim=Math.max(0,tim);var s=tim%60,m=(Bridge.Int.div(tim,60)|0)%60,time=System.String.concat(System.String.concat(System.String.alignString(System.String.concat("",m),2,48),":"),System.String.alignString(System.String.concat("",s),2,48));if(tim<11&&(time=System.String.concat("",s)),pad=50,this.ended?time=BNTest.AnimationLoader.get_this().isIdle()?this.gameover?tt<20?this.localplayer.character.getCoins()<=0?"No more coins, Game Over!":this.localplayer.lives<0?"No more lives, Game Over!":"Game ended":"Press Enter to restart":"Press Enter to start":"Assets are being loaded, please wait...":this.boss!=null&&(time=System.String.concat(System.String.concat(String.fromCharCode(this.boss.char.charCodeAt(0)).toUpperCase(),this.boss.char.substr(1)),":")),pad=66-(time.length>>1)|0,gui=BNTest.App.gui,gui.clearRect(0,0,1024,1024),this.titlescreen&&(gui.fillStyle="#220077",gui.globalAlpha=.5,gui.fillRect(0,0,1024,1024),gui.globalAlpha=1,QS=BNTest.AnimationLoader.get_this().queueSize(),this.maxLoadQueue=Math.max(this.maxLoadQueue,QS),QS>0&&(loaded=this.maxLoadQueue-QS|0,this.maxLoadProgress=loaded/this.maxLoadQueue,this.loadProgress=BNTest.MathHelper.lerp(this.loadProgress,this.maxLoadProgress,.07),this.loadProgress=Math.min(this.loadProgress,this.maxLoadQueue,1),this.drawGauge(gui,new BNTest.Vector2(350,42),new BNTest.Vector2(320,24),2,this.loadProgress,"#00DD00"))),gui.lineWidth=3,this.started&&(this.drawGauge(gui,new BNTest.Vector2(2,2),new BNTest.Vector2(220,32),3,Math.max(0,this.localplayer.character.getHP()/100),"#00DD00"),this.boss!=null&&this.drawGauge(gui,new BNTest.Vector2(350,42),new BNTest.Vector2(320,24),2,Math.max(0,this.boss.getHP()/100),"#00DD00"),!this.ended&&this.radar.visible)){var rg=this.radar.getGraphics(),rsz=this.radar.spriteBuffer.width,hrsz=Bridge.Int.div(rsz,2)|0;rg.clearRect(0,0,rsz,rsz);rg.globalAlpha=.6;rg.beginPath();rg.arc(hrsz,hrsz,hrsz,0,2*Math.PI,!1);rg.fillStyle="#005500";rg.fill();rg.lineWidth=3;rg.strokeStyle="#002200";rg.stroke();rg.globalAlpha=1;for(var i=0,LE=this.world.entities,ln=LE.getCount(),P=this.localplayer.character.getPosition().toVector2(),scale=.1,Y=this.localplayer.character.gety(),team=this.localplayer.character.team;i<ln;){var E=LE.getItem(i),D=E,color="#00FF00",ok=!1,sz=5,MY=50;D.me&&(ok=!0,Bridge.referenceEquals(D.team,team)||(color="#FF0000"));A=E.getAttacker;A?(A=E.getAttacker(),A&&A.me&&(ok=!0,sz=3,MY=8,Bridge.referenceEquals(A.team,team)||(color="#FF0000"))):E.value?(ok=!0,color="#FFFF00"):E.defaultMaxHP&&(ok=!0,color="#00FFFF",sz=9);ok&&(E.model!=null&&(E.model.alpha<.15||!E.model.getVisible())&&(ok=!1),Math.abs(E.getPosition().y-Y)>MY&&(ok=!1),Bridge.referenceEquals(E,this.localplayer.character)&&(color="#FFFFFF",ok=!0,sz=sz+2|0),ok&&(V=BNTest.Vector2.op_Subtraction(E.getPosition().toVector2(),P),V.x*=scale,V.y*=scale,rg.fillStyle=color,L=V.getLength(),L>hrsz&&(V=V.normalize(hrsz),L=hrsz),L<=hrsz&&(hsz=sz>>1,rg.fillRect(V.x+hrsz-hsz,V.y+hrsz-hsz,sz,sz))));i=i+1|0}gui.globalAlpha=.9;off=40;this.radar.position=new BNTest.Vector2(1023-off/BNTest.App.targetAspect-rsz,off);this.radar.draw(gui);gui.globalAlpha=1}this.TS.setTextColor("#FFFFFF");this.TS.setShadowOffset(new BNTest.Vector2(3,3));this.TS.setFontSize(26);this.TS.setShadowBlur(5);this.TS.setShadowColor("#000000");T=System.String.concat(System.String.alignString("",-pad,32),time);this.started&&(T=System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(T,"\n"),"Coins:"),this.localplayer.character.getCoins()),"\nLives:"),Math.max(this.localplayer.lives,0))," Wave:"),this.wave));this.TS.setText(T);this.TS.position=new BNTest.Vector2(2,-4);this.TS.draw(gui);var C="#FFFFFF",fs=60,SB=7,SC="#000000";T="";TX=300;TY=150;this.titlescreen?(fs=fs+10|0,C="#FF0000",T=BNTest.App.gameName,this.LTS.alpha=1,SC="#FFFFFF",TX=TX-20|0,SB=8,this.BTS.setTextColor("#FFFFFF"),this.BTS.setFontSize(18),this.BTS.setText(System.String.concat(System.String.alignString("Graphics and Code by:RSGmaker",-100,32),"Touhou Project is owned by ZUN")),this.BTS.position=new BNTest.Vector2(50,720),this.BTS.setShadowOffset(new BNTest.Vector2(3,3)),this.BTS.setShadowBlur(3),this.BTS.setShadowColor("#000000"),this.BTS.draw(gui),this.VTS.position=new BNTest.Vector2(763,98+this.LTS.position.y),this.VTS.draw(gui)):this.paused?(this.LTS.alpha=1,C="#EEEE88",T="Paused",fs=fs+10|0,TX=TX+65|0,TY=TY+25|0,SB=8):this.waveDelay>0&&(T=System.String.concat("Wave ",this.wave),fs=120-Bridge.Int.clip32(this.waveDelay*.35)|0,this.LTS.alpha=this.waveDelay*.005,fs<1&&(fs=1));Bridge.referenceEquals(T,"")||(this.LTS.setShadowOffset(new BNTest.Vector2(3,3)),this.LTS.setShadowBlur(SB),this.LTS.setShadowColor(SC),this.LTS.setFontSize(fs),this.LTS.setTextColor(C),this.LTS.position=new BNTest.Vector2(TX,TY),this.LTS.setText(T),this.LTS.draw(gui))},getTeamColor:function(){return new BNTest.GLColor},playSoundEffect:function(position,sound){var vol=1,maxLength=1600,dist;if(position!=null&&(dist=BNTest.GLVec3.op_Subtraction(this.world.cam,position).getRoughLength(),dist-=450,dist>0)){if(dist>=maxLength)return;vol=1-dist/maxLength}BNTest.AudioManager.get_this().blast(System.String.concat(System.String.concat("SFX/",sound),".ogg"),vol)},sendEvent:function(type,data,flush){var D,NU;flush===void 0&&(flush=!1);D={};D.E=type;D.D=data;NU=null;this.online;this.processEvent(D,NU,0);flush&&(this.netPlayNeedsFlush=!0)},processEvent:function(msg,user,latency){var LP=new(System.Collections.Generic.List$1(BNTest.Player))(System.Linq.Enumerable.from(this.players).where(function(player){return user!=null&&Bridge.referenceEquals(player.networkID,user.userID)})),P=null,D=msg.D,hascharacter=!0,evt,entity,attacker,PC;if(LP.getCount()<=0?P!=null||user!=null||this.online?user.getIsMe()?(this.localplayer.networkID=user.userID,P=this.localplayer):hascharacter=!1:P=this.localplayer:P=LP.getItem(0),evt=msg.E,user==null||user.getIsMe()||(this.dlatency+=latency,this.dlatency*=1-1/this.latencyM),Bridge.referenceEquals(evt,"Kill")&&(entity=this.entityFromID(D.I),entity!=null&&entity.getHP()<=0&&(attacker=this.entityFromID(D.A),entity.BNTest$ICombatant$onDeath(this.entityFromID(D.S)),attacker!=null&&Bridge.is(attacker,BNTest.PlayerCharacter)))){PC=attacker;PC.me.score=PC.me.score+entity.BNTest$ICombatant$getPointsForKilling()|0;PC.onKill(entity)}},entityFromID:function(ID){var LE=System.Linq.Enumerable.from(this.world.entities).where(function(E){return Bridge.referenceEquals(E.ID,ID)}).toList(BNTest.Entity);return LE.getCount()>0?LE.getItem(0):null},initShaders:function(){var fragmentShader=this.getShader(this.gl,"Bshader-fs"),vertexShader=this.getShader(this.gl,"Bshader-vs"),G,img,texture,self;this.shaderProgram=this.gl.createProgram();this.gl.attachShader(this.shaderProgram,vertexShader);this.gl.attachShader(this.shaderProgram,fragmentShader);this.gl.linkProgram(this.shaderProgram);this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS)==null&&Bridge.global.alert(System.String.concat("Unable to initialize the shader program: ",this.gl.getProgramInfoLog(this.shaderProgram)));this.gl.useProgram(this.shaderProgram);this.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(this.vertexPositionAttribute);this.vertexColorAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(this.vertexColorAttribute);this.vertexTextureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord");this.samplerUniform=this.gl.getUniformLocation(this.shaderProgram,"uSampler");this.enableTextures();this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),!1);this.gl.uniform1f(this.gl.getUniformLocation(this.shaderProgram,"uFogDensity"),.01);this.alphaUniform=this.gl.getUniformLocation(this.shaderProgram,"uAlpha");this.colorUniform=this.gl.getUniformLocation(this.shaderProgram,"uPColor");this.pUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");this.mvUniform=this.gl.getUniformLocation(this.shaderProgram,"uMVMatrix");this.fogActive=!0;this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),this.fogActive);this.gl.uniform1f(this.alphaUniform,1);var CV=document.createElement("canvas"),sz=32,hsz=Bridge.Int.div(sz,2)|0;CV.width=sz;CV.height=sz;G=BNTest.Helper.getContext(CV);G.fillStyle="#FF00FF";G.fillRect(0,0,sz,sz);G.fillStyle="#00FFFF";G.fillRect(0,0,hsz,hsz);G.fillRect(hsz,hsz,hsz,hsz);img=new Image;img.src=CV.toDataURL();texture=this.gl.createTexture();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,img);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0);self=this;this.disableTextures();BNTest.Mesh.init(this.vertexPositionAttribute,this.vertexColorAttribute,this.vertexTextureCoordAttribute)},pushAlpha:function(alpha){this.alphalist.push(this.currentAlpha);alpha=Math.min(Math.max(alpha,0),1);this.currentAlpha*=alpha;this.gl.uniform1f(this.alphaUniform,this.currentAlpha)},popAlpha:function(){var alpha=this.alphalist.pop();this.currentAlpha=alpha;this.gl.uniform1f(this.alphaUniform,this.currentAlpha)},setTexture:function(texture){this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0)},enableTextures:function(){this.gl.enableVertexAttribArray(this.vertexTextureCoordAttribute);this.gl.uniform4f(this.colorUniform,0,0,0,0);BNTest.Mesh.texture=!0},disableTextures:function(){this.gl.disableVertexAttribArray(this.vertexTextureCoordAttribute);this.gl.uniform4f(this.colorUniform,1,1,1,1);BNTest.Mesh.texture=!1},setColor:function(color){this.gl.uniform4f(this.colorUniform,color.r,color.g,color.b,color.a)},resetColor:function(){BNTest.Mesh.texture?this.gl.uniform4f(this.colorUniform,0,0,0,0):this.gl.uniform4f(this.colorUniform,1,1,1,1)},_test:function(){var timg=BNTest.AnimationLoader.get("test").getItem(0),img=new Image,texture;img.src=timg.src;texture=this.gl.createTexture();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,img);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0)},getShader:function(gl,id){var shaderScript=document.getElementById(id),theSource,currentChild,shader,st;if(shaderScript==null)return null;for(theSource="",currentChild=shaderScript.firstChild;currentChild!=null;)currentChild.nodeType===3&&(theSource=System.String.concat(theSource,currentChild.textContent)),currentChild=currentChild.nextSibling;if(st=shaderScript.type,Bridge.referenceEquals(st,"x-shader/x-fragment"))shader=gl.createShader(gl.FRAGMENT_SHADER);else if(Bridge.referenceEquals(st,"x-shader/x-vertex"))shader=gl.createShader(gl.VERTEX_SHADER);else return null;return(gl.shaderSource(shader,theSource),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)==null)?(Bridge.global.alert(System.String.concat("An error occurred compiling the shaders: ",gl.getShaderInfoLog(shader))),null):shader},loadIdentity:function(){this.mvMatrix=Matrix.I(4);this.matrix.mvMatrix=this.mvMatrix;this.matrix.mvMatrixStack=System.Array.init(0,null)},multMatrix:function(m,flush){flush===void 0&&(flush=!1);this.matrix.multiplyMatrix$1(m);this.matrixNeedsFlush=!0},mvTranslate:function(v){this.matrix.mvTranslate(v)},flushMatrix:function(){var flat,A;this.matrixNeedsFlush&&(this.matrixNeedsFlush=!1,flat=this.tflat,this.flatten$1(this.mvMatrix,flat),A=new Float32Array(flat),this.gl.uniformMatrix4fv(this.mvUniform,!1,A))},flatten:function(matrix){var M=matrix.elements;return[M[0][0],M[1][0],M[2][0],M[3][0],M[0][1],M[1][1],M[2][1],M[3][1],M[0][2],M[1][2],M[2][2],M[3][2],M[0][3],M[1][3],M[2][3],M[3][3]]},flatten$1:function(matrix,OUT){var M=matrix.elements,O=OUT,A=M[0],B=M[1],C=M[2],D=M[3];O[0]=A[0];O[1]=B[0];O[2]=C[0];O[3]=D[0];O[4]=A[1];O[5]=B[1];O[6]=C[1];O[7]=D[1];O[8]=A[2];O[9]=B[2];O[10]=C[2];O[11]=D[2];O[12]=A[3];O[13]=B[3];O[14]=C[3];O[15]=D[3]},mvPushMatrix:function(m){m===void 0&&(m=null);this.matrixNeedsFlush=!0;this.matrix.mvPushMatrix();return},mvPopMatrix:function(){return this.matrixNeedsFlush=!0,this.matrix.mvPopMatrix()},mvScale:function(Scale){this.matrix.mvScale(Scale);return}});Bridge.define("BNTest.GLVec3",{statics:{getOne:function(){return new BNTest.GLVec3.ctor(1,1,1)},mean:function(L){var V,i,V2;for(L===void 0&&(L=[]),V=new BNTest.GLVec3.ctor,i=0;i<L.length;)V2=L[i],V.x+=V2.x,V.y+=V2.y,V.z+=V2.z,i=i+1|0;return V.x/=L.length,V.y/=L.length,V.z/=L.length,V},lerp:function(V1,V2,D){return new BNTest.GLVec3.ctor(BNTest.MathHelper.lerp(V1.x,V2.x,D),BNTest.MathHelper.lerp(V1.y,V2.y,D),BNTest.MathHelper.lerp(V1.z,V2.z,D))},transform:function(V,M,inv){return inv===void 0&&(inv=!1),BNTest.GLVec3.transformB(V.toVec3(),M.mvMatrix,inv)},transformB:function(a,m,inv){inv===void 0&&(inv=!1);var ret=System.Array.init(3,0),OM=m,me=m.elements;m=inv?BNTest.WGMatrix.flatten(m):BNTest.WGMatrix.flattenB(m);var x=a[0],y=a[1],z=a[2];return ret[0]=m[0]*x+m[4]*y+m[8]*z+m[12],ret[1]=m[1]*x+m[5]*y+m[9]*z+m[13],ret[2]=m[2]*x+m[6]*y+m[10]*z+m[14],new BNTest.GLVec3.ctor(ret[0],ret[1],ret[2])},random:function(length,RND){return RND===void 0&&(RND=null),RND==null&&(RND=new System.Random.ctor),new BNTest.GLVec3.ctor(RND.nextDouble()*length.x,RND.nextDouble()*length.y,RND.nextDouble()*length.z)},createUniform:function(D){return new BNTest.GLVec3.ctor(D,D,D)},min:function(V1,V2){return new BNTest.GLVec3.ctor(Math.min(V1.x,V2.x),Math.min(V1.y,V2.y),Math.min(V1.z,V2.z))},max:function(V1,V2){return new BNTest.GLVec3.ctor(Math.max(V1.x,V2.x),Math.max(V1.y,V2.y),Math.max(V1.z,V2.z))},floor:function(V){return new BNTest.GLVec3.ctor(Math.floor(V.x),Math.floor(V.y),Math.floor(V.z))},getCenter:function(V1,V2){var X=V1.x+(V2.x-V1.x)*.5,Y=V1.y+(V2.y-V1.y)*.5,Z=V1.z+(V2.z-V1.z)*.5;return new BNTest.GLVec3.ctor(X,Y,Z)},op_Addition$1:function(V1,Vec2){return new BNTest.GLVec3.ctor(V1.x+Vec2.x,V1.y,V1.z+Vec2.y)},op_Addition:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x+V2.x,V1.y+V2.y,V1.z+V2.z)},op_Subtraction:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x-V2.x,V1.y-V2.y,V1.z-V2.z)},op_UnaryNegation:function(V){return new BNTest.GLVec3.ctor(-V.x,-V.y,-V.z)},op_Multiply:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x*V2.x,V1.y*V2.y,V1.z*V2.z)},op_Multiply$1:function(V1,scale){return new BNTest.GLVec3.ctor(V1.x*scale,V1.y*scale,V1.z*scale)},op_Division:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x/V2.x,V1.y/V2.y,V1.z/V2.z)},op_Division$1:function(V1,scale){return new BNTest.GLVec3.ctor(V1.x/scale,V1.y/scale,V1.z/scale)},op_LessThan:function(V1,V2){return V1.x<V2.x&&V1.y<V2.y&&V1.z<V2.z},op_GreaterThan:function(V1,V2){return V1.x>V2.x&&V1.y>V2.y&&V1.z>V2.z},op_LessThanOrEqual:function(V1,V2){return V1.x<=V2.x&&V1.y<=V2.y&&V1.z<=V2.z},op_GreaterThanOrEqual:function(V1,V2){return V1.x>=V2.x&&V1.y>=V2.y&&V1.z>=V2.z}},x:0,y:0,z:0,$ctor1:function(vec3){this.$initialize();this.x=vec3[0];this.y=vec3[1];this.z=vec3[2]},ctor:function(X,Y,Z){X===void 0&&(X=0);Y===void 0&&(Y=0);Z===void 0&&(Z=0);this.$initialize();this.x=X;this.y=Y;this.z=Z},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},getEstimatedLength:function(){var A=Math.abs(this.x),B=Math.abs(this.y),C=Math.abs(this.z),M=Math.max(A,B,C),D=.34;return(A===M&&B===M||B===M&&C===M||A===M&&C===M)&&(D+=.15,M=-1),A!==M&&(A*=D),B!==M&&(B*=D),C!==M&&(C*=D),A+B+C},getRoughLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},syncCopy:function(V,dimension){dimension===void 0&&(dimension=0);var X=this.x,Y=this.y,Z=this.z;return dimension===0?X=V.x:dimension===1?Y=V.y:dimension===2&&(Z=V.z),new BNTest.GLVec3.ctor(X,Y,Z)},roughDistance:function(V){return Math.abs(this.x-V.x)+Math.abs(this.y-V.y)+Math.abs(this.z-V.z)},toVec3:function(){var ret=System.Array.init(3,0);return ret[0]=this.x,ret[1]=this.y,ret[2]=this.z,ret},normalize:function(length){length===void 0&&(length=1);var D=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)/length,V=new BNTest.GLVec3.ctor;return V.x=this.x/D,V.y=this.y/D,V.z=this.z/D,V},equals:function(o){return o!=null&&o.x===this.x&&o.y===this.y&&o.z===this.z},toVector2:function(){return new BNTest.Vector2(this.x,this.z)},clone:function(){return new BNTest.GLVec3.ctor(this.x,this.y,this.z)},toString:function(){return System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat("X:",System.Double.format(this.x,"G"))," Y:"),System.Double.format(this.y,"G"))," Z:"),System.Double.format(this.z,"G"))}});Bridge.define("BNTest.Helper",{statics:{_namespaces:null,config:{init:function(){this._namespaces=new(System.Collections.Generic.Dictionary$2(String,Object))}},getRandomString:function(){return(Math.random()*(new Date).getTime()).toString(36)},getType:function(FullName){var name=FullName,s,i,obj;if(Bridge.referenceEquals(name,"")||name==null||!System.String.contains(name,"."))return null;for(s=name.split("."),i=1,BNTest.Helper._namespaces.containsKey(s[0])?obj=BNTest.Helper._namespaces.get(s[0]):(obj=eval(s[0]),BNTest.Helper._namespaces.set(s[0],obj));i<s.length;){if(!obj)return null;obj=obj[s[i]];i=i+1|0}return obj},addMultiple:function(T,array,item,number){while(number>0)array.push(item),number=number-1|0},cloneCanvas:function(C){var ret=document.createElement("canvas"),g;return ret.width=C.width,ret.height=C.height,g=ret.getContext("2d"),g.drawImage(C,0,0),ret},getContext:function(C){return C.getContext("2d")},getField:function(target,fieldName){var O=target,s;if(BNTest.Helper.has(O,fieldName))return O[fieldName];if(O[System.String.concat("get",fieldName)])return O[System.String.concat("get",fieldName)]();s="";try{s=System.String.concat(System.String.concat(System.String.concat('Helper get field: Field "',fieldName),'" was not in ')+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat(System.String.concat(System.String.concat('Helper get field: Field "',fieldName),'" was not in ')+target,".")}return console.log(s),null},has:function(target,fieldName){return typeof target[fieldName]!="undefined"},reloadPage:function(){window.location.href=window.location.href},setField:function(target,fieldName,data){var O=target,s;if(BNTest.Helper.has(O,fieldName)){O[fieldName]=data;return}if(O[System.String.concat("set",fieldName)]){O[System.String.concat("set",fieldName)](data);return}s="";try{s=System.String.concat(System.String.concat(System.String.concat('Helper set field: Field "',fieldName),'" was not in ')+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat(System.String.concat(System.String.concat('Helper set field: Field "',fieldName),'" was not in ')+target,".")}console.log(s)},copyFields:function(source,target,Fields){var i,f;for(Fields===void 0&&(Fields=null),Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[i],BNTest.Helper.setField(target,f,BNTest.Helper.getField(source,f)),i=i+1|0},keyCodeToString:function(keycode){var codenames=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];return keycode>=0&&keycode<codenames.length?codenames[keycode]:String.fromCharCode(keycode)},makeShallowCopy:function(source,fieldNames){var target,Fields,i,f;for(fieldNames===void 0&&(fieldNames=null),target={},Fields=fieldNames,Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[i],target[f]=BNTest.Helper.getField(source,f),i=i+1|0;return target}}});Bridge.define("BNTest.HelperExtensions",{statics:{pick:function(T,list,RND){var $t,L,item;for(RND===void 0&&(RND=null),RND==null&&(RND=new System.Random.ctor),L=new(System.Collections.Generic.List$1(T)),$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),L.add(item);return L.getItem(RND.next$1(L.getCount()))},forEach:function(T,list,action){for(var item,$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),action(item)},forEach$1:function(T,list,methodName){for(var item,A,$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),A=item[methodName],A()},addIfNew:function(T,list,item){list.contains(item)||list.add(item)},removeAll:function(T,list,predicate){for(var i=0,item;i<list.getCount();)item=list.getItem(i),predicate(item)&&(list.remove(item),i=i-1|0),i=i+1|0},pushIfNew:function(T,list,val){System.Array.contains(list,val,T)||list.push(val)},pushRange:function(T,list,val){val===void 0&&(val=[]);for(var i=0;i<val.length;)list.push(val[i]),i=i+1|0}}});Bridge.define("BNTest.ICombatant",{$kind:"interface"});Bridge.define("BNTest.IHarmfulEntity",{$kind:"interface"});Bridge.define("BNTest.InputController",{statics:{numberOfActions:8,GM:null},inputMapping:null,config:{properties:{id:null}},ctor:function(id){id===void 0&&(id="Keyboard");this.$initialize();this.setid(id);this.inputMapping=new(System.Collections.Generic.List$1(BNTest.InputMap));Bridge.referenceEquals(id,"Keyboard")?this.initkeyboard():Bridge.referenceEquals(id,"KeyboardMouse")?(this.setid("Keyboard"),this.initkeyboardmouse()):this.initgamepad();BNTest.InputController.GM==null&&(BNTest.GamePadManager._this==null&&(BNTest.GamePadManager._this=new BNTest.GamePadManager),BNTest.InputController.GM=BNTest.GamePadManager._this)},copyMap:function(){for(var fields=["map","antimap","name","axis","controllerID"],ret=System.Array.init(this.inputMapping.getCount(),null),i=0;i<ret.length;)ret[i]=BNTest.Helper.makeShallowCopy(this.inputMapping.getItem(i),fields),i=i+1|0;return ret},copyFromMap:function(Map){for(var fields=["map","antimap","name","axis","controllerID"],i=0,IM;i<Map.length;)i>=this.inputMapping.getCount()&&this.inputMapping.add(new BNTest.InputMap.ctor),IM=this.inputMapping.getItem(i),BNTest.Helper.copyFields(Map[i],IM,fields),i=i+1|0},initkeyboardmouse:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=68,map.antimap=65),i===1&&(map.map=83,map.antimap=87),i===2&&(map.map=32),i===3&&(map.map=0,map.controllerID="Mouse"),i===4&&(map.map=2,map.controllerID="Mouse"),i===5&&(map.map=13),this.inputMapping.add(map),i=i+1|0},initkeyboard:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=68,map.antimap=65),i===1&&(map.map=83,map.antimap=87),i===2&&(map.map=32),i===3&&(map.map=90),i===4&&(map.map=88),i===5&&(map.map=13),this.inputMapping.add(map),i=i+1|0},initgamepad:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=0,map.axis=!0),i===1&&(map.map=1,map.axis=!0),i>1&&(map.map=i-2|0),this.inputMapping.add(map),i=i+1|0},getState:function(action,map){map===void 0&&(map=null);map==null&&(map=this.inputMapping.getItem(action));var TID=this.getid();return Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),Bridge.referenceEquals(TID,"Keyboard")?this.getKeyboardMapState(map):Bridge.referenceEquals(TID,"Mouse")?this.getMouseMapState(map):this.getGamepadMapState(map)},getPressed:function(action,map){return map===void 0&&(map=null),this.getState(action,map)>=.7},findAnyPressedGamePadInput:function(){var ret=new BNTest.InputMap.ctor,L=BNTest.GamePadManager._this.getactiveGamepads();return(BNTest.HelperExtensions.forEach(BNTest.GamePad,L,function(G){var GB,tmp,i;if(ret.map===-1)if(ret.controllerID=G.id,GB=System.Linq.Enumerable.from(G.buttons).where($_.BNTest.InputController.f1).toArray(),GB.length>0)ret.axis=!1,tmp=GB[0],ret.map=new(System.Collections.Generic.List$1(BNTest.GamePadButton))(G.buttons).indexOf(tmp);else for(i=0;i<G.axes.length&&ret.map===-1;)Math.abs(G.axes[i])>.7&&Math.abs(G.axes[i])<2&&(ret.axis=!0,ret.map=i,G.axes[i]<0&&(ret.name="anti",ret.antimap=i)),i=i+1|0}),ret.map!==-1)?ret:null},getMapControllerID:function(map){return Bridge.referenceEquals(map.controllerID,"")?this.getid():map.controllerID},getMapControllerID$1:function(action){return this.getMapControllerID(this.inputMapping.getItem(action))},getGamepadMapState:function(map){var TID=this.getid(),P;return(Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),P=BNTest.GamePadManager._this.getPad(TID),P==null||!P.connected)?0:map.axis?P.axes[map.map]:P.buttons[map.map].pressed?1:map.antimap>=0&&P.buttons[map.antimap].pressed?-1:0},getKeyboardMapState:function(map){var L=BNTest.KeyboardManager.get_this().pressedButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0},getMouseMapState:function(map){var L=BNTest.KeyboardManager.get_this().pressedMouseButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0}});Bridge.ns("BNTest.InputController",$_);Bridge.apply($_.BNTest.InputController,{f1:function(B){return B.pressed}});Bridge.define("BNTest.InputControllerManager",{statics:{__this:null,get_this:function(){return BNTest.InputControllerManager.__this==null&&(BNTest.InputControllerManager.__this=new BNTest.InputControllerManager),BNTest.InputControllerManager.__this},init:function(){BNTest.InputControllerManager.__this==null&&(BNTest.InputControllerManager.__this=new BNTest.InputControllerManager)}},controllers:null,ctor:function(){this.$initialize();this.controllers=new(System.Collections.Generic.List$1(BNTest.InputController));this.controllers.add(new BNTest.InputController);for(var gamepads=BNTest.GamePadManager._this.getactiveGamepads(),i=0;i<gamepads.getCount();)this.controllers.add(new BNTest.InputController(gamepads.getItem(i).id)),i=i+1|0}});Bridge.define("BNTest.InputMap",{map:-1,antimap:-1,name:"",axis:!1,controllerID:"",ctor:function(){this.$initialize();this.axis=!1},$ctor1:function(map,antimap,axis){antimap===void 0&&(antimap=-1);axis===void 0&&(axis=!1);this.$initialize();this.map=map;this.antimap=antimap;this.axis=axis}});Bridge.define("BNTest.KeyboardManager",{statics:{allowRightClick:!1,__this:null,get_this:function(){return BNTest.KeyboardManager.__this==null&&(BNTest.KeyboardManager.__this=new BNTest.KeyboardManager),BNTest.KeyboardManager.__this},init:function(){BNTest.KeyboardManager.__this==null&&(BNTest.KeyboardManager.__this=new BNTest.KeyboardManager)},update:function(){BNTest.KeyboardManager.__this.tappedButtons.clear();BNTest.KeyboardManager.__this.tappedMouseButtons.clear();BNTest.KeyboardManager.__this.mouseDelta=0},neverinBounds:function(){return BNTest.KeyboardManager.allowRightClick||!BNTest.App.screenBounds.containsPoint$1(BNTest.KeyboardManager.get_this().cMouse.x,BNTest.KeyboardManager.get_this().cMouse.y)},onKeyDown:function(evt){var keyCode=evt.keyCode;return(BNTest.KeyboardManager.__this.pressedButtons.contains(keyCode)||(BNTest.KeyboardManager.__this.pressedButtons.add(keyCode),BNTest.KeyboardManager.__this.tappedButtons.add(keyCode)),keyCode>=37&&keyCode<=40||keyCode===32||keyCode===112)?!1:!0},onKeyUp:function(evt){var keyCode=evt.keyCode;BNTest.KeyboardManager.__this.pressedButtons.contains(keyCode)&&BNTest.KeyboardManager.__this.pressedButtons.remove(keyCode)},onMouseDown:function(evt){var btn=evt.button;return BNTest.KeyboardManager.__this.pressedMouseButtons.contains(btn)||(BNTest.KeyboardManager.__this.pressedMouseButtons.add(btn),BNTest.KeyboardManager.__this.tappedMouseButtons.add(btn)),btn<1},onMouseUp:function(evt){var btn=evt.button;return BNTest.KeyboardManager.__this.pressedMouseButtons.contains(btn)&&BNTest.KeyboardManager.__this.pressedMouseButtons.remove(btn),btn<1},onMouseWheel:function(evt){return BNTest.KeyboardManager.get_this().mouseDelta+=evt.detail,!0},onMouseMove:function(evt){BNTest.KeyboardManager.get_this().mousePosition=new BNTest.Vector2(evt.clientX,evt.clientY);var left=System.Single.parse(System.String.replaceAll(BNTest.App.div.style.left,"px","")),x=evt.clientX-left,y=evt.clientY,scale=BNTest.App.canvas.width/System.Single.parse(System.String.replaceAll(BNTest.App.div.style.width,"px",""));BNTest.KeyboardManager.get_this().cMouse=new BNTest.Vector2(x*scale,y*scale)}},pressedButtons:null,tappedButtons:null,pressedMouseButtons:null,tappedMouseButtons:null,mousePosition:null,cMouse:null,mouseDelta:0,config:{init:function(){this.mousePosition=new BNTest.Vector2;this.cMouse=new BNTest.Vector2}},ctor:function(){var KD,KU,MM,MD,MU,MW,NB;this.$initialize();this.pressedButtons=new(System.Collections.Generic.List$1(System.Int32));this.tappedButtons=new(System.Collections.Generic.List$1(System.Int32));this.pressedMouseButtons=new(System.Collections.Generic.List$1(System.Int32));this.tappedMouseButtons=new(System.Collections.Generic.List$1(System.Int32));KD=BNTest.KeyboardManager.onKeyDown;document.onkeydown=KD;KU=BNTest.KeyboardManager.onKeyUp;document.onkeyup=KU;MM=BNTest.KeyboardManager.onMouseMove;document.onmousemove=MM;MD=BNTest.KeyboardManager.onMouseDown;document.onmousedown=MD;MU=BNTest.KeyboardManager.onMouseUp;document.onmouseup=MU;MW=BNTest.KeyboardManager.onMouseWheel;document.onmousewheel=MW;document.onDomMouseScroll=MW;window.addEventListener("mousewheel",$_.BNTest.KeyboardManager.f1);window.addEventListener("DOMMouseScroll",$_.BNTest.KeyboardManager.f1);document.onmousewheel=$_.BNTest.KeyboardManager.f1;NB=BNTest.KeyboardManager.neverinBounds;document.oncontextmenu=NB}});Bridge.ns("BNTest.KeyboardManager",$_);Bridge.apply($_.BNTest.KeyboardManager,{f1:function(M){BNTest.KeyboardManager.onMouseWheel(M)}});Bridge.define("BNTest.MathHelper",{statics:{PI:3.14159274,PI2:6.28318548,PIOver2:1.57079637,distanceBetweenPoints:function(A,B){return BNTest.MathHelper.distanceBetweenPoints$1(A.x,A.y,B.x,B.y)},distanceBetweenPoints$1:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))},clamp$1:function(value,min,max){return Math.min(max,Math.max(min,value))},clamp:function(value,min,max){return min===void 0&&(min=0),max===void 0&&(max=1),Math.min(max,Math.max(min,value))},lerp$1:function(value1,value2,amount){return value1+(value2-value1)*amount},lerp:function(D1,D2,lerp){return lerp=BNTest.MathHelper.clamp(lerp),D1*(1-lerp)+D2*lerp},degreesToRadians:function(degrees){return degrees*.0174532924},radiansToDegrees:function(radians){return radians*57.29578},getAngle:function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)},roughDistanceBetweenPoints:function(a,b){return BNTest.Vector2.op_Subtraction(a,b).getRoughLength()},magnitudeOfRectangle:function(R){return R.width+R.height},wrapRadians:function(radian){while(radian<-3.14159274)radian+=BNTest.MathHelper.PI2;while(radian>=BNTest.MathHelper.PI)radian-=BNTest.MathHelper.PI2;return radian},radianToVector:function(radian){return new BNTest.Vector2(Math.cos(radian),Math.sin(radian))},within:function(val,min,max){return val>=min&&val<=max},mean:function(val){val===void 0&&(val=[]);for(var ret=0,i=0;i<val.length;)ret+=val[i],i=i+1|0;return ret/val.length}}});Bridge.define("BNTest.Mesh",{statics:{texture:!0,allowInterpolation:!0,config:{properties:{vertexPositionAttribute:0,vertexColorAttribute:0,vertexTextureCoord:0}},init:function(vertexPositionAttribute,vertexColorAttribute,vertexTextureCoord){BNTest.Mesh.setvertexPositionAttribute(vertexPositionAttribute);BNTest.Mesh.setvertexColorAttribute(vertexColorAttribute);BNTest.Mesh.setvertexTextureCoord(vertexTextureCoord);console.log("position:"+vertexPositionAttribute);console.log("color:"+vertexColorAttribute)},pushColor:function(array,C){BNTest.Mesh.pushValue(array,[C.r,C.g,C.b,C.a])},pushValue:function(array,values){values===void 0&&(values=[]);for(var i=0,v=0;i<values.length;)v=values[i],array.push(v),i=i+1|0}},cubeVerticesBuffer:null,cubeVerticesColorBuffer:null,cubeVerticesIndexBuffer:null,cubeVerticesTextureCoordBuffer:null,verticies:null,colors:null,indices:null,textureCoords:null,needsUpdate:!0,hasBuffer:!1,offset:null,rotation:null,scale:null,min:null,max:null,transformation:null,transformed:!1,QV3:0,qV3Set:!1,config:{properties:{gl:null,GD:null},init:function(){this.verticies=[];this.colors=[];this.indices=[];this.textureCoords=[];this.offset=new BNTest.GLVec3.ctor;this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1);this.min=new BNTest.GLVec3.ctor(System.Double.max,System.Double.max,System.Double.max);this.max=new BNTest.GLVec3.ctor(System.Double.min,System.Double.min,System.Double.min)}},ctor:function(GD){this.$initialize();this.setgl(GD.gl);this.setGD(GD);this.transformation=new BNTest.WGMatrix},getSize:function(){return BNTest.GLVec3.op_Subtraction(this.max,this.min)},flattenGeometry:function(){this.updateTranformation();this.morphGeometry(this.transformation);this.resetTransformation()},resetTransformation:function(){this.transformation.clear();this.offset=new BNTest.GLVec3.ctor;this.scale=BNTest.GLVec3.getOne();this.rotation=new BNTest.GLVec3.ctor},morphGeometry:function(M){var V,i;if(this.verticies.length>0)for(V=this.verticies,this.needsUpdate=!0,i=0;i<V.length;)this.transformVert(i,M),i=i+3|0},transformVert:function(index,M){var i=index,V=this.verticies,T1=new BNTest.GLVec3.ctor(V[Bridge.identity(i,i=i+1|0)],V[Bridge.identity(i,i=i+1|0)],V[Bridge.identity(i,i=i+1|0)]),T=BNTest.GLVec3.transform(T1,M,!0);i=index;V[Bridge.identity(i,i=i+1|0)]=T.x;V[Bridge.identity(i,i=i+1|0)]=T.y;V[Bridge.identity(i,i=i+1|0)]=T.z},render:function(){if(!(this.indices.length<=0)&&(this.needsUpdate&&this.update(),this.cubeVerticesBuffer!=null)){var G=this.getgl();G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesBuffer);G.vertexAttribPointer(BNTest.Mesh.getvertexPositionAttribute(),3,G.FLOAT,!1,0,0);G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesColorBuffer);G.vertexAttribPointer(BNTest.Mesh.getvertexColorAttribute(),4,G.FLOAT,!1,0,0);BNTest.Mesh.texture&&(G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesTextureCoordBuffer),G.vertexAttribPointer(BNTest.Mesh.getvertexTextureCoord(),2,G.FLOAT,!1,0,0));G.bindBuffer(G.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer);this.draw()}},replaceAllColors:function(NewColor){for(var N=System.Array.init(0,0),i=0;i<this.colors.length;)N.push(NewColor.r),N.push(NewColor.g),N.push(NewColor.b),N.push(NewColor.a),i=i+4|0;this.colors=N;this.needsUpdate=!0},combine:function(M,respectOffsets){var offset,i,P,N;if(respectOffsets===void 0&&(respectOffsets=!1),M.indices.length>0){if(offset=Bridge.Int.div(this.verticies.length,3)|0,i=0,respectOffsets)for(P=BNTest.GLVec3.op_Subtraction(M.offset,this.offset),i=0;i<M.verticies.length;)N=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(M.verticies[Bridge.identity(i,i=i+1|0)],M.verticies[Bridge.identity(i,i=i+1|0)],M.verticies[Bridge.identity(i,i=i+1|0)]),P),this.updateMinMax(N),this.verticies.push(N.x),this.verticies.push(N.y),this.verticies.push(N.z);else this.updateMinMax$2(M.verticies),BNTest.HelperExtensions.pushRange(System.Double,this.verticies,M.verticies);for(BNTest.HelperExtensions.pushRange(System.Double,this.colors,M.colors),BNTest.HelperExtensions.pushRange(System.Double,this.textureCoords,M.textureCoords),i=0;i<M.indices.length;)this.indices.push(M.indices[i]+offset|0),i=i+1|0;this.needsUpdate=!0}},updateTranformation:function(){if(this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0,this.transformed){this.transformation.clear();var M=this.transformation,scaled=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1),offseted=this.offset.getRoughLength()!==0;scaled&&(offseted?M.setPositionThenScale(this.offset,this.scale):M.mvScale(this.scale));this.rotation.getRoughLength()!==0&&(this.rotation.y!==0&&M.rotateY(this.rotation.y*.01745329251),this.rotation.x!==0&&M.rotateX(this.rotation.x*.01745329251),this.rotation.z!==0&&M.rotateZ(this.rotation.z*.01745329251));!scaled&&offseted&&M.setTranslation(this.offset)}},draw:function(){var G;this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0;this.transformed&&(this.updateTranformation(),this.getGD().mvPushMatrix(),this.getGD().multMatrix(this.transformation.mvMatrix,!0));G=this.getgl();this.getGD().flushMatrix();G.drawElements(G.TRIANGLES,this.indices.length,G.UNSIGNED_SHORT,0);this.transformed&&this.getGD().mvPopMatrix();return},update:function(){var G,colors,generatedColors;this.needsUpdate&&(this.hasBuffer&&this.clearBuffers(),G=this.getgl(),this.cubeVerticesBuffer=G.createBuffer(),G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesBuffer),G.bufferData(G.ARRAY_BUFFER,new Float32Array(this.verticies),G.STATIC_DRAW),colors=this.colors,generatedColors=colors,this.cubeVerticesColorBuffer=G.createBuffer(),G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesColorBuffer),G.bufferData(G.ARRAY_BUFFER,new Float32Array(generatedColors),G.STATIC_DRAW),this.cubeVerticesIndexBuffer=G.createBuffer(),G.bindBuffer(G.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer),G.bufferData(G.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),G.STATIC_DRAW),this.cubeVerticesTextureCoordBuffer=G.createBuffer(),G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesTextureCoordBuffer),G.bufferData(G.ARRAY_BUFFER,new Float32Array(this.textureCoords),G.STATIC_DRAW),this.needsUpdate=!1)},getVerticies:function(){for(var ret=System.Array.init(0,null),i=0,X,Y,Z;i<this.verticies.length;)X=this.verticies[i],i=i+1|0,Y=this.verticies[i],i=i+1|0,Z=this.verticies[i],i=i+1|0,ret.push(new BNTest.GLVec3.ctor(X,Y,Z));return ret},setVerticies:function(V){this.verticies=System.Array.init(0,0);for(var i=0;i<V.length;)this.verticies.push(V[i].x),this.verticies.push(V[i].y),this.verticies.push(V[i].z),i=i+1|0},smoothen:function(strength){var NV;strength===void 0&&(strength=.35);for(var list=System.Array.init(0,null),i=0,L=this.getVerticies();i<L.length;){for(var V=L[i],k=0,R=System.Array.init(0,null);k<L.length;)NV=L[k],!NV.equals(V)&&BNTest.GLVec3.op_Subtraction(NV,V).getRoughLength()<3&&R.push(NV),k=k+1|0;R.push(V);list.push(BNTest.GLVec3.lerp(V,BNTest.GLVec3.mean(R),strength));i=i+1|0}this.setVerticies(list)},applyPalette:function(palette){var Keys=System.Linq.Enumerable.from(palette.getKeys()).toList(BNTest.GLColor),Vals=System.Linq.Enumerable.from(palette.getValues()).toList(BNTest.GLColor),C,k,t,ind;if(!(Keys.getCount()<=0))for(var kln=Keys.getCount(),key,i=0,ln=this.colors.length,LC=null,VC=null;i<ln;){if(C=new BNTest.GLColor(this.colors[i],this.colors[i+1|0],this.colors[i+2|0],this.colors[i+3|0]),key=null,LC!=null&&C.equals(LC)){VC!=null&&(this.colors[i]=VC.r,this.colors[i+1|0]=VC.g,this.colors[i+2|0]=VC.b,this.colors[i+3|0]=VC.a);i=i+4|0;continue}if(C!=null&&C.a>0){for(k=0;k<kln;)t=Keys.getItem(k),t.similar(C)&&(key=t,k=ln),k=k+1|0;key!=null?(ind=Keys.indexOf(key),ind>=0?(VC=Vals.getItem(ind),this.colors[i]=VC.r,this.colors[i+1|0]=VC.g,this.colors[i+2|0]=VC.b,this.colors[i+3|0]=VC.a):VC=null):VC=null}i=i+4|0;LC=C}},clone:function(shallow){var M,i;return shallow===void 0&&(shallow=!1),M=new BNTest.Mesh(this.getGD()),shallow?(M.verticies=this.verticies,M.colors=this.colors,M.indices=this.indices,M.textureCoords=this.textureCoords,M.needsUpdate=this.needsUpdate,M.cubeVerticesBuffer=this.cubeVerticesBuffer,M.cubeVerticesColorBuffer=this.cubeVerticesColorBuffer,M.cubeVerticesIndexBuffer=this.cubeVerticesIndexBuffer,M.cubeVerticesTextureCoordBuffer=this.cubeVerticesTextureCoordBuffer,M.min=this.min,M.max=this.max,M.offset=this.offset,M.rotation=this.rotation,M.scale=this.scale):(i=0,M.verticies=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.verticies,this.verticies),M.colors=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.colors,this.colors),M.indices=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Int32,M.indices,this.indices),M.textureCoords=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.textureCoords,this.textureCoords),M.needsUpdate=!0,M.min=this.min.clone(),M.max=this.max.clone(),M.offset=this.offset.clone(),M.rotation=this.rotation.clone(),M.scale=this.scale.clone()),M},unloadBuffers:function(){this.hasBuffer&&(this.clearBuffers(),this.needsUpdate=!0)},clearBuffers:function(){this.hasBuffer&&(this.getgl().deleteBuffer(this.cubeVerticesBuffer),this.getgl().deleteBuffer(this.cubeVerticesColorBuffer),this.getgl().deleteBuffer(this.cubeVerticesIndexBuffer),this.getgl().deleteBuffer(this.cubeVerticesTextureCoordBuffer),this.hasBuffer=!1)},addTextureRect:function(times){for(times===void 0&&(times=1);times>0;)times=times-1|0,this.textureCoords.push(0,0,0,1,1,0,1,1)},addVoxelMap:function(VM,interpolate,center,toplayeronly){var C,interpolation,sides;interpolate===void 0&&(interpolate=!1);center===void 0&&(center=!0);toplayeronly===void 0&&(toplayeronly=!1);interpolate&&!BNTest.Mesh.allowInterpolation&&(interpolate=!1);var Map=VM.map,X=0,Y=0,Z=0,SV=new BNTest.GLVec3.ctor(0,0,0);center&&(SV=BNTest.GLVec3.op_Addition(SV,new BNTest.GLVec3.ctor((-System.Array.getLength(Map,0)|0)/2,(-System.Array.getLength(Map,1)|0)/2,(-System.Array.getLength(Map,2)|0)/2)));var V=BNTest.GLVec3.op_Addition(SV,new BNTest.GLVec3.ctor),VB=new BNTest.GLVec3.ctor(1,1,1),MX=System.Array.getLength(Map,0),MY=System.Array.getLength(Map,1),MZ=System.Array.getLength(Map,2);for(this.qV3Set=!0,this.QV3=Bridge.Int.div(this.verticies.length,3)|0;X<MX;){while(Y<MY){while(Z<MZ)C=Map.get([X,Y,Z]),VM.valid(C)&&(toplayeronly?this.addRectangle(V,BNTest.GLVec3.op_Addition(V,new BNTest.GLVec3.ctor(1,0,1)),C):(interpolation=null,interpolate&&(interpolation=VM.getValidQuadrants(X,Y,Z)),sides=VM.getInvisibleSides(X,Y,Z),this.addCube2(V,BNTest.GLVec3.op_Addition(V,VB),C,sides,interpolation))),V.z+=1,Z=Z+1|0;V.z=SV.z;V.y+=1;Z=0;Y=Y+1|0}V.z=SV.z;V.y=SV.y;V.x+=1;Y=0;Z=0;X=X+1|0}this.qV3Set=!1},addVert:function(V,C){BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);BNTest.Mesh.pushValue(this.indices,[Bridge.Int.div(this.indices.length,3)|0]);this.needsUpdate=!0},addCube1:function(Min,Max,C){var GV=System.Array.init(8,null);GV[0]=new BNTest.GLVec3.ctor(Min.x,Min.y,Min.z);GV[1]=new BNTest.GLVec3.ctor(Max.x,Min.y,Min.z);GV[2]=new BNTest.GLVec3.ctor(Min.x,Max.y,Min.z);GV[3]=new BNTest.GLVec3.ctor(Max.x,Max.y,Min.z);GV[4]=new BNTest.GLVec3.ctor(Min.x,Min.y,Max.z);GV[5]=new BNTest.GLVec3.ctor(Max.x,Min.y,Max.z);GV[6]=new BNTest.GLVec3.ctor(Min.x,Max.y,Max.z);GV[7]=new BNTest.GLVec3.ctor(Max.x,Max.y,Max.z);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[1],GV[2],GV[3],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[4],GV[5],GV[6],GV[7],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[2],GV[4],GV[6],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[1],GV[3],GV[5],GV[7],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[1],GV[4],GV[5],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[2],GV[3],GV[6],GV[7],C)},addCube2:function(Min,Max,C,invisible,interpolation){var GV;if(interpolation===void 0&&(interpolation=null),invisible==null&&(invisible=System.Array.init(6,!1)),GV=System.Array.init(8,null),GV[0]=new BNTest.GLVec3.ctor(Min.x,Min.y,Min.z),GV[1]=new BNTest.GLVec3.ctor(Max.x,Min.y,Min.z),GV[2]=new BNTest.GLVec3.ctor(Min.x,Max.y,Min.z),GV[3]=new BNTest.GLVec3.ctor(Max.x,Max.y,Min.z),GV[4]=new BNTest.GLVec3.ctor(Min.x,Min.y,Max.z),GV[5]=new BNTest.GLVec3.ctor(Max.x,Min.y,Max.z),GV[6]=new BNTest.GLVec3.ctor(Min.x,Max.y,Max.z),GV[7]=new BNTest.GLVec3.ctor(Max.x,Max.y,Max.z),interpolation!=null)for(var center=BNTest.GLVec3.getCenter(Min,Max),i=0,GVL=GV.length;i<GVL;)interpolation[i]||(GV[i]=BNTest.GLVec3.getCenter(GV[i],center)),i=i+1|0;this.qV3Set||(this.QV3=Bridge.Int.div(this.verticies.length,3)|0);invisible[0]||this.quickAddRectangle(GV[0],GV[1],GV[2],GV[3],C);invisible[1]||this.quickAddRectangle(GV[4],GV[5],GV[6],GV[7],C);invisible[2]||this.quickAddRectangle(GV[0],GV[2],GV[4],GV[6],C);invisible[3]||this.quickAddRectangle(GV[1],GV[3],GV[5],GV[7],C);invisible[4]||this.quickAddRectangle(GV[0],GV[1],GV[4],GV[5],C);invisible[5]||this.quickAddRectangle(GV[2],GV[3],GV[6],GV[7],C)},addCube:function(Min,Max,C){this.addCube1(Min,Max,C);return},addRectangle:function(Min,Max,C){var V1=Min,V2=new BNTest.GLVec3.ctor(Max.x,Min.y,Min.z),V3=new BNTest.GLVec3.ctor(Min.x,Max.y,Max.z),V4=Max;this.addRectangle$1(V1,V2,V3,V4,C)},addRectangle$1:function(V1,V2,V3,V4,C){var ind=Bridge.Int.div(this.verticies.length,3)|0,V;V=V1;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V2;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V3;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V4;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);this.updateMinMax$1([V1,V2,V3,V4]);BNTest.Mesh.pushValue(this.indices,[ind,ind+1|0,ind+2|0,ind+3|0,ind+1|0,ind+2|0]);BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]);this.needsUpdate=!0},updateMinMax$1:function(V){V===void 0&&(V=[]);for(var i=0;i<V.length;)this.updateMinMax(V[i]),i=i+1|0},updateMinMax$2:function(V){var i,N;for(V===void 0&&(V=[]),i=0;i<V.length;)N=new BNTest.GLVec3.ctor(V[i],V[i+1|0],V[i+2|0]),this.updateMinMax(N),i=i+3|0},updateMinMax:function(V){this.min=BNTest.GLVec3.min(this.min,V);this.max=BNTest.GLVec3.max(this.max,V)},quickAddRectangle:function(V1,V2,V3,V4,C){var ind=this.QV3,V;V=V1;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V2;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V3;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V4;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);this.updateMinMax$1([V1,V2,V3,V4]);BNTest.Mesh.pushValue(this.indices,[ind,ind+1|0,ind+2|0,ind+3|0,ind+1|0,ind+2|0]);BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]);this.QV3=this.QV3+4|0;this.needsUpdate=!0}});Bridge.define("BNTest.Model",{meshes:null,children:null,offset:null,rotation:null,scale:null,transformation:null,transformed:!1,inView:!0,forceRender:!1,customBoundingBox:null,alpha:1,color:null,bleedThrough:!1,znearRate:-1,config:{properties:{gl:null,GD:null,Visible:!0},init:function(){this.offset=new BNTest.GLVec3.ctor;this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1);this.color=new BNTest.GLColor(1,1,1)}},ctor:function(GD){this.$initialize();this.setGD(GD);this.setgl(GD.gl);this.meshes=new(System.Collections.Generic.List$1(BNTest.Mesh));this.children=new(System.Collections.Generic.List$1(BNTest.Model));this.transformation=new BNTest.WGMatrix},getBoundingBox:function(){var O,B;if(this.customBoundingBox!=null)return BNTest.BoundingBox.op_Addition(this.customBoundingBox,this.offset);O=this.offset;this.offset=new BNTest.GLVec3.ctor;this.updateTransform();this.offset=O;for(var Min=new BNTest.GLVec3.ctor(System.Double.max,System.Double.max,System.Double.max),Max=new BNTest.GLVec3.ctor(System.Double.min,System.Double.min,System.Double.min),T=this.transformation,i=0,ln=this.meshes.getCount();i<ln;){var Mmn=BNTest.GLVec3.transform(this.meshes.getItem(i).min,T),Mmx=BNTest.GLVec3.transform(this.meshes.getItem(i).max,T),tmp=new BNTest.BoundingBox.$ctor1(this.meshes.getItem(i).min,this.meshes.getItem(i).max);Min=BNTest.GLVec3.min(Min,Mmn);Max=BNTest.GLVec3.max(Max,Mmx);i=i+1|0}for(i=0,ln=this.children.getCount();i<ln;)B=this.children.getItem(i).getBoundingBox(),Min=BNTest.GLVec3.min(Min,B.min),Max=BNTest.GLVec3.max(Max,B.max),i=i+1|0;return new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Addition(Min,this.offset),BNTest.GLVec3.op_Addition(Max,this.offset))},clear:function(){this.unloadBuffers();this.meshes=new(System.Collections.Generic.List$1(BNTest.Mesh));this.children=new(System.Collections.Generic.List$1(BNTest.Model));this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1)},unloadBuffers:function(){BNTest.HelperExtensions.forEach(BNTest.Mesh,this.meshes,$_.BNTest.Model.f1);BNTest.HelperExtensions.forEach(BNTest.Model,this.children,$_.BNTest.Model.f2)},updateTransform:function(){if(this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0,this.transformed){this.transformation.clear();var M=this.transformation,scaled=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1),offseted=this.offset.getRoughLength()!==0;scaled&&(offseted?M.setPositionThenScale(this.offset,this.scale):M.mvScale(this.scale));this.rotation.getRoughLength()!==0&&(this.rotation.y!==0&&M.rotateY(this.rotation.y*.01745329251),this.rotation.x!==0&&M.rotateX(this.rotation.x*.01745329251),this.rotation.z!==0&&M.rotateZ(this.rotation.z*.01745329251));!scaled&&offseted&&M.setTranslation(this.offset)}},clone:function(){var ret=new BNTest.Model(this.getGD());return ret.copyFrom(this),ret},copyFrom:function(source,shallow){shallow===void 0&&(shallow=!1);var M=source;shallow?(this.meshes=M.meshes,this.children=M.children):(BNTest.HelperExtensions.forEach(BNTest.Mesh,M.meshes,Bridge.fn.bind(this,$_.BNTest.Model.f3)),BNTest.HelperExtensions.forEach(BNTest.Model,M.children,Bridge.fn.bind(this,$_.BNTest.Model.f4)));this.bleedThrough=M.bleedThrough;this.color=M.color;this.alpha=M.alpha;this.scale=M.scale},smoothen:function(){for(var i=0;i<this.meshes.getCount();)this.meshes.getItem(i).smoothen(),i=i+1|0;for(i=0;i<this.children.getCount();)this.children.getItem(i).smoothen(),i=i+1|0},render:function(){var col,i,ln;if(this.updateTransform(),this.getVisible()&&(this.inView||this.forceRender)){for(this.transformed&&(this.getGD().mvPushMatrix(),this.getGD().multMatrix(this.transformation.mvMatrix,!0)),this.alpha<1&&this.getGD().pushAlpha(this.alpha),col=!this.color.equals(BNTest.GLColor.white),col&&this.getGD().setColor(this.color),this.bleedThrough&&this.getGD().setDepthTest(!1),this.znearRate>0&&this.getGD().setPerspective(this.znearRate),i=0,ln=this.meshes.getCount();i<ln;)this.meshes.getItem(i).render(),i=i+1|0;for(ln=this.children.getCount();i<ln;)this.children.getItem(i).render(),i=i+1|0;this.znearRate>0&&this.getGD().setPerspective();this.bleedThrough&&this.getGD().setDepthTest(!0);col&&this.getGD().resetColor();this.alpha<1&&this.getGD().popAlpha();this.transformed&&this.getGD().mvPopMatrix()}}});Bridge.ns("BNTest.Model",$_);Bridge.apply($_.BNTest.Model,{f1:function(M){M.unloadBuffers()},f2:function(C){C.unloadBuffers()},f3:function(msh){this.meshes.add(msh.clone())},f4:function(mdl){this.children.add(mdl.clone())}});Bridge.define("BNTest.ModelCache",{statics:{__this:null,config:{init:function(){this.__this=new BNTest.ModelCache}},get_this:function(){return BNTest.ModelCache.__this}},data:null,config:{init:function(){this.data=new(System.Collections.Generic.Dictionary$2(String,BNTest.Model))}},get:function(modelName,clone){return(clone===void 0&&(clone=!0),this.data.containsKey(modelName))?clone?this.data.get(modelName).clone():this.data.get(modelName):null},set:function(modelName,mesh){var M=new BNTest.Model(mesh.getGD());M.meshes.add(mesh.clone());this.data.set(modelName,M)},set$1:function(modelName,model){this.data.set(modelName,model.clone())}});Bridge.define("BNTest.NetPlay",{statics:{room_prefix:null,_this:null,config:{init:function(){this.room_prefix=System.String.concat(System.String.concat("RSG_NetPlay_TouhouVoxelBattles",System.String.replaceAll(BNTest.App.gameVersion,".","_")),"_")}}},channel:null,onOpen:null,onClose:null,onError:null,onMessage:null,onLeave:null,data:null,me:null,config:{properties:{users:null,roomID:null}},ctor:function(roomID,userName){userName===void 0&&(userName=null);this.$initialize();this.setroomID(System.String.concat(BNTest.NetPlay.room_prefix,roomID));this.data=new(System.Collections.Generic.List$1(Object));this.setusers(new(System.Collections.Generic.List$1(BNTest.NetPlayUser)));BNTest.NetPlay._this=this;userName!=null&&(userName=System.String.replaceAll(System.String.replaceAll(System.String.replaceAll(System.String.replaceAll(userName,".","")," ",""),"/",""),"-",""),userName=System.String.concat(System.String.concat(System.String.concat("User-",userName),"-"),Bridge.Int.clip32(Math.random())*1e5|0));this.init(userName)},getHoster:function(){return this.channel.isNewSessionOpened},init:function(userName){var self,extras,ch;userName===void 0&&(userName=null);self=this;extras={};extras.firebase="intense-torch-6778";userName!=null&&(extras.userid=userName);Bridge.Console.log(System.String.concat("NetPlay room:",this.getroomID()));this.channel=new DataChannel(self.roomID,extras);ch=this.channel;ch.onopen=function(userId){self._onOpen(userId)};ch.onleave=function(userId){self._onLeave(userId)};ch.onclose=function(evt){self._onClose(evt)};ch.onerror=function(evt){self._onError(evt)};ch.onmessage=function(message,userId,latency){self._onMessage(message,userId,latency)};ch.connect();this.me=new BNTest.NetPlayUser(this.channel.userid,!0);this.getusers().add(this.me)},close:function(){this.channel.leave()},_onOpen:function(userID){var user=this.getUserByName(userID,!0);if(user.connected=!0,this.onOpen)this.onOpen(user)},_onClose:function(evt){if(this.onClose)this.onClose(evt)},_onError:function(evt){if(Bridge.Console.log(System.String.concat("DataChannel error:",evt)),this.onError)this.onError(evt)},_onMessage:function(message,userID,latency){var user=this.getUserByName(userID,!0),L,i;if(user.messagePosted(),this.onMessage)for(L=message,i=0;i<L.length;){this.onMessage(L[i],user,latency);i=i+1|0}},_onLeave:function(userID){var user=this.getUserByName(userID,!0);if(user!=null&&(user.connected=!1,this.getusers().remove(user)),this.onLeave)this.onLeave(user)},send:function(message){this.data.add(message)},flush:function(){this.data.getCount()>0&&(this.channel.send(this.data.toArray()),this.data.clear())},addUser:function(userID){this.getUserByName(userID,!0)},getUserByName:function(userID,autoCreate){var L,ret;return(autoCreate===void 0&&(autoCreate=!1),L=new(System.Collections.Generic.List$1(BNTest.NetPlayUser))(System.Linq.Enumerable.from(this.getusers()).where(function(user){return Bridge.referenceEquals(user.userID,userID)})),L.getCount()>0)?L.getItem(0):autoCreate?(ret=new BNTest.NetPlayUser(userID),this.getusers().add(ret),ret):null}});Bridge.define("BNTest.NetPlayUser",{userID:null,connected:!1,_isMe:!1,config:{init:function(){this.lastMessagePost=new Date(-864e13)}},ctor:function(userID,isMe){isMe===void 0&&(isMe=!1);this.$initialize();this.userID=userID;this.connected=!0;this.lastMessagePost=new Date;this._isMe=isMe},getIsMe:function(){return this._isMe},gettimeSinceLastMessage:function(){return Bridge.Date.subdd(new Date,this.lastMessagePost)},messagePosted:function(){this.lastMessagePost=new Date},getName:function(){var parts=this.userID.split("-");return parts.length>2&&Bridge.referenceEquals(parts[0],"User")?parts[1]:""}});Bridge.define("BNTest.Octree",{children:null,nodeSize:0,nodeDepth:1,ctor:function(NodeSize,NodeDepth){this.$initialize();this.children=new(System.Collections.Generic.List$1(BNTest.OctreeNode));var sz=NodeSize;for(this.nodeDepth=NodeDepth;NodeDepth>0;)sz=sz+sz|0,NodeDepth=NodeDepth-1|0;this.nodeSize=sz},generateNode:function(X,Y,Z){var ret=new BNTest.OctreeNode,P=new BNTest.GLVec3.ctor(X*this.nodeSize|0,Y*this.nodeSize|0,Z*this.nodeSize|0);return ret.box=new BNTest.BoundingBox.$ctor1(P,BNTest.GLVec3.op_Addition(P,BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.getOne(),this.nodeSize))),ret.makeSubdivisions$1(this.nodeDepth),this.children.add(ret),ret},getChild:function(Position){var B=new BNTest.BoundingBox.$ctor1(Position,BNTest.GLVec3.op_Addition(Position,BNTest.GLVec3.getOne())),L=System.Linq.Enumerable.from(this.children).where(function(ON){return ON.box.intersection$2(B)}).toList(BNTest.OctreeNode),P;return L.getCount()>0?L.getItem(0):(P=BNTest.GLVec3.floor(BNTest.GLVec3.op_Division$1(Position,this.nodeSize)),this.generateNode(Bridge.Int.clip32(P.x),Bridge.Int.clip32(P.y),Bridge.Int.clip32(P.z)))},getNodes:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ret.addRange(ON.getNodes(collision))}),ret},getAllNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},getBottomMostNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},clear:function(){var L=this.getBottomMostNodes();BNTest.HelperExtensions.forEach(BNTest.OctreeNode,L,$_.BNTest.Octree.f1)},update:function(entitiesToPlace){this.clear();BNTest.HelperExtensions.forEach(BNTest.Entity,entitiesToPlace,Bridge.fn.bind(this,$_.BNTest.Octree.f2))},placeEntity:function(E){var L=this.getNodes(E.lastBB),N;L.getCount()===0&&(N=this.getChild(E.lastBB.min),BNTest.HelperExtensions.forEach(BNTest.OctreeNode,N.children,function(ON){L.addRange(ON.getNodes(E.lastBB))}));BNTest.HelperExtensions.forEach(BNTest.OctreeNode,L,function(ON){BNTest.HelperExtensions.addIfNew(BNTest.Entity,ON.entities,E)})}});Bridge.ns("BNTest.Octree",$_);Bridge.apply($_.BNTest.Octree,{f1:function(ON){ON.entities.clear()},f2:function(E){this.placeEntity(E)}});Bridge.define("BNTest.OctreeNode",{box:null,children:null,entities:null,config:{init:function(){this.entities=new(System.Collections.Generic.List$1(BNTest.Entity))}},makeSubdivisions$1:function(depth){depth>0&&(depth=depth-1|0,this.makeSubdivisions(),depth>0&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ON.makeSubdivisions$1(depth-1|0)}))},makeSubdivisions:function(){var B,Sz,ON;this.children==null&&this.box!=null&&(this.children=new(System.Collections.Generic.List$1(BNTest.OctreeNode)),B=this.box.clone(),B.setSize(BNTest.GLVec3.op_Multiply$1(B.getSize(),.5)),Sz=B.getSize(),ON=null,ON=new BNTest.OctreeNode,ON.box=B.clone(),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,0,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(0,0,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,0,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(0,Sz.y,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,Sz.z)),this.children.add(ON))},findCollisions:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.Entity)),N=this.getNodes(collision);return BNTest.HelperExtensions.forEach(BNTest.OctreeNode,N,function(ON){BNTest.HelperExtensions.forEach(BNTest.Entity,ON.entities,function(E){E.lastBB.intersection$2(collision)&&BNTest.HelperExtensions.addIfNew(BNTest.Entity,ret,E)})}),ret},getAllNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return ret.add(this),this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},getBottomMostNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null?BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}):ret.add(this),ret},getNodes:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return(this.box==null||this.box.intersection$2(collision))&&(this.children==null?ret.add(this):BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ret.addRange(ON.getNodes(collision))})),ret}});Bridge.define("BNTest.Player",{ID:0,character:null,networkID:null,score:0,CPU:!1,lives:3,minion:!1,config:{properties:{local:!1}},ctor:function(local,CPU,minion){minion===void 0&&(minion=!1);this.$initialize();this.setlocal(local);this.CPU=CPU;this.minion=minion}});Bridge.define("BNTest.Rectangle",{x:0,y:0,width:0,height:0,ctor:function(x,y,width,height){x===void 0&&(x=0);y===void 0&&(y=0);width===void 0&&(width=0);height===void 0&&(height=0);this.$initialize();this.x=x;this.y=y;this.width=width;this.height=height},getleft:function(){return this.x},setleft:function(value){this.x=value},gettop:function(){return this.y},settop:function(value){this.y=value},getright:function(){return this.x+this.width},setright:function(value){this.width=value-this.x},getbottom:function(){return this.y+this.height},setbottom:function(value){this.height=value-this.y},getpoints:function(){var ret=System.Array.init(8,0),i=0;return ret[Bridge.identity(i,i=i+1|0)]=this.x,ret[Bridge.identity(i,i=i+1|0)]=this.y,ret[Bridge.identity(i,i=i+1|0)]=this.getright(),ret[Bridge.identity(i,i=i+1|0)]=this.y,ret[Bridge.identity(i,i=i+1|0)]=this.getright(),ret[Bridge.identity(i,i=i+1|0)]=this.getbottom(),ret[Bridge.identity(i,i=i+1|0)]=this.x,ret[Bridge.identity(i,i=i+1|0)]=this.getbottom(),ret},getCenter:function(){return new BNTest.Vector2(this.getleft()+this.width/2,this.gettop()+this.height/2)},getMin:function(){return new BNTest.Vector2(this.x,this.y)},setMin:function(value){BNTest.Vector2.op_Equality(value,null)||(this.x=value.x,this.y=value.y)},getMax:function(){return new BNTest.Vector2(this.getright(),this.getbottom())},setMax:function(value){BNTest.Vector2.op_Equality(value,null)||(this.setright(value.x),this.setbottom(value.y))},containsPoint$1:function(x,y){return x>=this.x&&y>=this.y&&x<=this.getright()&&y<=this.getbottom()?!0:!1},containsPoint:function(point){return point.x>=this.x&&point.y>=this.y&&point.x<=this.getright()&&point.y<=this.getbottom()?!0:!1},intersects:function(R){for(var p=R.getpoints(),contain=!1,outside=!1,i=0;i<p.length;)this.containsPoint$1(p[Bridge.identity(i,i=i+1|0)],p[Bridge.identity(i,i=i+1|0)])?contain=!0:outside=!0;return contain&&outside?!0:R.getleft()<this.getleft()&&R.getright()>this.getright()&&(this.gettop()<=R.gettop()&&this.getbottom()>=R.gettop()||this.gettop()<=R.getbottom()&&this.getbottom()>=R.getbottom())?!0:R.gettop()<this.gettop()&&R.getbottom()>this.getbottom()&&(this.getleft()<=R.getleft()&&this.getright()>=R.getleft()||this.getleft()<=R.getright()&&this.getright()>=R.getright())?!0:!1},isTouching:function(R){if(R==null)return!1;for(var p=R.getpoints(),i=0;i<p.length;)if(this.containsPoint$1(p[Bridge.identity(i,i=i+1|0)],p[Bridge.identity(i,i=i+1|0)]))return!0;return this.intersects(R)?!0:!1}});Bridge.define("BNTest.Sprite",{position:null,spriteBuffer:null,visible:!0,spriteGraphics:null,ctor:function(){this.$initialize();this.spriteBuffer=document.createElement("canvas");this.spriteGraphics=this.spriteBuffer.getContext("2d");this.position=new BNTest.Vector2},getSize:function(){return new BNTest.Vector2(this.spriteBuffer.width,this.spriteBuffer.height)},setSize:function(value){BNTest.Vector2.op_Equality(value,null)&&(value=new BNTest.Vector2);this.spriteBuffer.width=Bridge.Int.clip32(value.x);this.spriteBuffer.height=Bridge.Int.clip32(value.y)},getGraphics:function(){return this.spriteGraphics},onFrame:function(){},draw:function(g){this.visible&&g.drawImage(this.spriteBuffer,this.position.x,this.position.y)},getBounds:function(){return new BNTest.Rectangle(this.position.x,this.position.y,this.spriteBuffer.width,this.spriteBuffer.height)}});Bridge.define("BNTest.TextureLoader",{statics:{createTexture:function(gl,img){var texture=gl.createTexture();return gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),texture}},gl:null,textures:null,images:null,loading:null,config:{init:function(){this.textures=new(System.Collections.Generic.Dictionary$2(HTMLImageElement,Bridge.WebGL.WebGLTexture));this.images=new(System.Collections.Generic.Dictionary$2(String,HTMLImageElement));this.loading=new(System.Collections.Generic.List$1(HTMLImageElement))}},get$1:function(path,callback){if(this.images.containsKey(path)&&!this.loading.contains(this.images.get(path)))callback(this.get(this.images.get(path)));else{var I=this.getImage(path);I.onload=Bridge.fn.bind(this,function(E){this.loading.remove(E.currentTarget);callback(this.get(I))})}},get:function(image){if(this.textures.containsKey(image))return this.textures.get(image);var ret=BNTest.TextureLoader.createTexture(this.gl,image);return this.textures.set(image,ret),ret},getImage:function(path){if(this.images.containsKey(path))return this.images.get(path);var ret=new Image;return ret.src=path,this.images.set(path,ret),this.loading.add(ret),ret.onload=Bridge.fn.bind(this,$_.BNTest.TextureLoader.f1),ret}});Bridge.ns("BNTest.TextureLoader",$_);Bridge.apply($_.BNTest.TextureLoader,{f1:function(E){this.loading.remove(E.currentTarget)}});Bridge.define("BNTest.Vector2",{statics:{getEmpty:function(){return new BNTest.Vector2},fromRadian:function(radian){return BNTest.MathHelper.radianToVector(radian)},op_Equality:function(A,B){var OA=A,OB=B;return(OA==null||OB==null)&&(OA!=null||OB!=null)?!1:OA==null&&OB==null?!0:A.x===B.x&&A.y===B.y},op_Inequality:function(A,B){return!BNTest.Vector2.op_Equality(A,B)},op_Multiply:function(A,scale){return new BNTest.Vector2(A.x*scale,A.y*scale)},op_Division:function(A,scale){return new BNTest.Vector2(A.x/scale,A.y/scale)},op_Addition:function(A,B){return new BNTest.Vector2(A.x+B.x,A.y+B.y)},op_Subtraction:function(A,B){return new BNTest.Vector2(A.x-B.x,A.y-B.y)}},x:0,y:0,ctor:function(x,y){x===void 0&&(x=0);y===void 0&&(y=0);this.$initialize();this.x=x;this.y=y},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},getEstimatedLength:function(){var A=Math.abs(this.x),B=Math.abs(this.y),tmp;return B>A&&(tmp=A,A=B,B=tmp),B*=.34,A+B},getRoughLength:function(){return Math.abs(this.x)+Math.abs(this.y)},roughNormalize:function(length){length===void 0&&(length=1);var D=this.getLength()/length;return new BNTest.Vector2(this.x/D,this.y/D)},normalize:function(length){length===void 0&&(length=1);var distance=Math.sqrt(this.x*this.x+this.y*this.y),V=new BNTest.Vector2;return V.x=this.x/distance,V.y=this.y/distance,V.x*=length,V.y*=length,V},toCardinal:function(){var x=this.x,y=this.y,A=Math.abs(this.x),B=Math.abs(this.y);return B>A?x=0:A>B&&(y=0),new BNTest.Vector2(x,y)},equals:function(o){if(Bridge.is(o,BNTest.Vector2)){var B=Bridge.cast(o,BNTest.Vector2);return BNTest.Vector2.op_Inequality(this,B)&&BNTest.Vector2.op_Equality(B,null)?!1:B.x===this.x&&B.y===this.y}return Bridge.equals(this,o)},toAngle:function(){return BNTest.MathHelper.wrapRadians(BNTest.MathHelper.getAngle(new BNTest.Vector2,this))},clone:function(){return new BNTest.Vector2(this.x,this.y)},rotate:function(radian){var angle=this.toAngle()+radian;return BNTest.Vector2.fromRadian(angle).normalize(this.getLength())}});Bridge.define("BNTest.VoxelMap",{statics:{maps:null,config:{init:function(){this.maps=new(System.Collections.Generic.Dictionary$2(String,BNTest.VoxelMap))}},generateTree:function(size,color,smoothness){var S,E;smoothness===void 0&&(smoothness=.95);var hsz=Bridge.Int.div(size,2)|0,hhsz=Bridge.Int.div(hsz,2)|0,VM=new BNTest.VoxelMap;return VM.map=System.Array.create(null,null,hsz,size,hsz),S=new BNTest.GLVec3.ctor(hhsz-1|0,size-1|0,hhsz),E=S.clone(),E.y=0,VM.drawMessyGrowLine(S,E,1,BNTest.GLVec3.op_Subtraction(E,S).normalize(10),color,(Bridge.Int.div(hhsz,4)|0)-1|0,smoothness,!0),VM.grow(Bridge.Int.clip32(S.x),Bridge.Int.clip32(S.y),Bridge.Int.clip32(S.z),color,Bridge.Int.clip32(hhsz/3.5)-1|0,smoothness,!0,!1),VM.outline(color,!0,1),VM},generateRock:function(size,color,smoothness){smoothness===void 0&&(smoothness=.9);var hsz=Bridge.Int.div(size,2)|0,VM=new BNTest.VoxelMap;return VM.map=System.Array.create(null,null,size,hsz,size),VM.drawPyramid(0,0,0,hsz,color),VM},fromAnimationCombo:function(animations){animations===void 0&&(animations=[]);for(var S=animations[0],i=1;i<animations.length;)S=System.String.concat(System.String.concat(S,"|"),animations[i]),i=i+1|0;return BNTest.VoxelMap.fromImages$1(S)},fromImages$1:function(animation){var VM,A;if(BNTest.VoxelMap.maps.containsKey(animation))return BNTest.VoxelMap.maps.get(animation).clone();if(System.String.contains(animation,"|")){for(var An=animation.split("|"),i=0,ret=null;i<An.length;)VM=BNTest.VoxelMap.fromImages$1(An[i]),ret==null?ret=VM:ret.combine(VM),i=i+1|0;return ret}return A=BNTest.VoxelMap.fromImages(BNTest.AnimationLoader.get(animation)),BNTest.VoxelMap.maps.set(animation,A),A.clone()},fromImages:function(images){var ret=new BNTest.VoxelMap,ln=images.getCount(),i;for(ret.map=System.Array.create(null,null,images.getItem(0).width,images.getItem(0).height,ln),i=0;i<ln;)ret.importImageLayer(images.getItem(i),i),i=i+1|0;return ret},gen:function(size,sizey,sizez,holes,transparent,bottomsolid,winter){size===void 0&&(size=2);sizey===void 0&&(sizey=0);sizez===void 0&&(sizez=0);holes===void 0&&(holes=!0);transparent===void 0&&(transparent=!0);bottomsolid===void 0&&(bottomsolid=!1);winter===void 0&&(winter=!1);sizey===0&&(sizey=size);sizez===0&&(sizez=size);var ret=new BNTest.VoxelMap;return ret.map=System.Array.create(null,null,size,sizey,sizez),ret.randomize(holes,transparent,bottomsolid,winter),ret},sameSize:function(A,B){return System.Array.getLength(A.map,0)===System.Array.getLength(B.map,0)&&System.Array.getLength(A.map,1)===System.Array.getLength(B.map,1)&&System.Array.getLength(A.map,2)===System.Array.getLength(B.map,2)?!0:!1},getMaxSize:function(A,B){return[Math.max(System.Array.getLength(A.map,0),System.Array.getLength(B.map,0)),Math.max(System.Array.getLength(A.map,1),System.Array.getLength(B.map,1)),Math.max(System.Array.getLength(A.map,2),System.Array.getLength(B.map,2))]}},map:null,getVoxel:function(X,Y,Z){return X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)?this.map.get([X,Y,Z]):null},inBounds:function(X,Y,Z){return X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)?!0:!1},randomize:function(holes,transparent,bottomsolid,winter){var C,ok;holes===void 0&&(holes=!0);transparent===void 0&&(transparent=!0);bottomsolid===void 0&&(bottomsolid=!1);winter===void 0&&(winter=!1);for(var X=0,Y=0,Z=0;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))C=null,C=winter?BNTest.GLColor.randomB(.77,.82,.87,.87,.92,1):BNTest.GLColor.randomB(0,.6,.1,.3,.9,.4),ok=Y<(System.Array.getLength(this.map,1)-1|0)||!bottomsolid,Math.random()<.3&&holes&&ok?C.a=0:Math.random()<.4&&transparent&&ok&&(C.a=.5),this.map.set([X,Y,Z],C),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},setColor:function(color){for(var X=0,Y=0,Z=0;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))this.valid(this.map.get([X,Y,Z]))&&this.map.set([X,Y,Z],color),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},flipX:function(){for(var N=System.Array.create(null,null,System.Array.getLength(this.map,0),System.Array.getLength(this.map,1),System.Array.getLength(this.map,2)),X=0,Y=0,Z=0;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))N.set([System.Array.getLength(this.map,0)-(X+1|0)|0,Y,Z],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}this.map=N},flatten:function(){for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,1,MZ),X=0,Y=0,Z=0;X<MX;){while(Y<MY){while(Z<MZ)N.set([X,0,Z],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}this.map=N},addStripes:function(strength,coverage,verticalStride){var C;coverage===void 0&&(coverage=1);verticalStride===void 0&&(verticalStride=0);for(var X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),m2=strength+strength;X<MX;){while(Y<MY){while(Z<MZ)C=this.map.get([X,Y,Z]),this.valid(C)&&((X&1)>0||(Z&1)>0||verticalStride>0&&((Y+X|0)+Z|0)%verticalStride==0)&&(coverage>=1||Math.random()>coverage)&&(C=BNTest.GLColor.op_Multiply(C,1-strength),this.map.set([X,Y,Z],C)),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},addNoise:function(strength,coverage){var C;coverage===void 0&&(coverage=1);for(var X=0,Y=0,Z=0,m2=strength+strength,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2);X<MX;){while(Y<MY){while(Z<MZ)C=this.map.get([X,Y,Z]),this.valid(C)&&(coverage>=1||Math.random()>coverage)&&(C=BNTest.GLColor.op_Addition(C,new BNTest.GLColor(-strength+m2*Math.random(),-strength+m2*Math.random(),-strength+m2*Math.random())),this.map.set([X,Y,Z],C)),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},drawGrowLine:function(start,end,color,Depth,chance,corners){var i;chance===void 0&&(chance=1);corners===void 0&&(corners=!1);var V=start.clone(),spd=BNTest.GLVec3.op_Subtraction(end,start),len=spd.getLength();for(spd=spd.normalize(1),i=0;i<len;)this.grow(Bridge.Int.clip32(V.x),Bridge.Int.clip32(V.y),Bridge.Int.clip32(V.z),color,Depth,chance,corners),V=BNTest.GLVec3.op_Addition(V,spd),i=i+1|0},drawLine:function(start,end,color){for(var V=start.clone(),spd=BNTest.GLVec3.op_Subtraction(end,start),len=spd.getLength(),spd=spd.normalize(1),i=0;i<len;)this.setVoxel(V,color),V=BNTest.GLVec3.op_Addition(V,spd),i=i+1|0},addHoles:function(chance){for(var X=0,Y=0,Z=0,C;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))C=this.map.get([X,Y,Z]),Math.random()<chance&&this.map.set([X,Y,Z],null),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},drawMessyGrowLine:function(start,generalDestination,maxSegmentLength,momentum,color,Depth,chance,corners){var LL;chance===void 0&&(chance=1);corners===void 0&&(corners=!1);for(var V=start.clone(),dist=BNTest.GLVec3.op_Subtraction(generalDestination,start),len=dist.getLength(),total=len*1.1,i=0,msl2=maxSegmentLength+maxSegmentLength,hsz=BNTest.GLVec3.createUniform(msl2),tries=0;i<total&&tries<20;){var line=new BNTest.GLVec3.ctor(-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength();tries=tries+1|0;ND<len&&(tries=0,momentum!=null&&(line=BNTest.GLVec3.op_Addition(line,momentum),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength()),LL=line.getLength(),this.drawGrowLine(V,N,color,Depth,chance,corners),V=N,len=ND,i+=LL)}},drawMessyLine:function(start,generalDestination,maxSegmentLength,momentum,color){for(var V=start.clone(),dist=BNTest.GLVec3.op_Subtraction(generalDestination,start),len=dist.getLength(),total=len,i=0,msl2=maxSegmentLength+maxSegmentLength,hsz=BNTest.GLVec3.createUniform(msl2),tries=0,LL;i<total&&tries<20;){var line=new BNTest.GLVec3.ctor(-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength();tries=tries+1|0;ND<len&&(tries=0,LL=line.getLength(),momentum!=null&&(line=BNTest.GLVec3.op_Addition(line,momentum),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength()),this.drawLine(V,N,color),V=N,len=ND,i+=LL)}},drawPyramid:function(X,Y,Z,size,color){for(var XX=X,YY=Y+(size-1|0)|0,ZZ=Z;size>0;)this.fill$1(XX,YY,ZZ,size,1,size,color),XX=XX+1|0,ZZ=ZZ+1|0,YY=YY-1|0,size=size-2|0},grow:function(X,Y,Z,color,Depth,chance,first,corners){(chance===void 0&&(chance=1),first===void 0&&(first=!0),corners===void 0&&(corners=!1),this.inBounds(X,Y,Z))&&(this.setVoxel$1(X,Y,Z,color),Depth=Depth-1|0,(first||chance>=1||Math.random()<chance)&&Depth>0&&(this.grow(X-1|0,Y,Z,color,Depth,chance,!1,corners),this.grow(X,Y-1|0,Z,color,Depth,chance,!1,corners),this.grow(X,Y,Z-1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y,Z,color,Depth,chance,!1,corners),this.grow(X,Y+1|0,Z,color,Depth,chance,!1,corners),this.grow(X,Y,Z+1|0,color,Depth,chance,!1,corners),corners&&(this.grow(X-1|0,Y-1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y-1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y-1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y-1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y+1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y+1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y+1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y+1|0,Z+1|0,color,Depth,chance,!1,corners))))},outline:function(C,smooth,chance){var min,max,CT,adj,col;C===void 0&&(C=null);smooth===void 0&&(smooth=!1);chance===void 0&&(chance=1);min=1;max=1e3;smooth&&(min=2);for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,MY,MZ),X=0,Y=0,Z=0;X<MX;){while(Y<MY){while(Z<MZ)CT=this.map.get([X,Y,Z]),this.valid(CT)||(adj=this.adjacentVoxels(X,Y,Z),adj>=min&&adj<=max&&(chance>=1||Math.random()>chance)&&(col=C,C==null&&(col=this.findAdjacentVoxel(X,Y,Z)),CT=col)),N.set([X,Y,Z],CT),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}this.map=N},adjacentVoxels:function(X,Y,Z){var i=0,C=this.getVoxel(X-1|0,Y,Z);return this.valid(C)&&(i=i+1|0),C=this.getVoxel(X+1|0,Y,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y-1|0,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y+1|0,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y,Z-1|0),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y,Z+1|0),this.valid(C)&&(i=i+1|0),i},findAdjacentVoxel:function(X,Y,Z){var C=this.getVoxel(X-1|0,Y,Z);return this.valid(C)?C:(C=this.getVoxel(X+1|0,Y,Z),this.valid(C))?C:(C=this.getVoxel(X,Y-1|0,Z),this.valid(C))?C:(C=this.getVoxel(X,Y+1|0,Z),this.valid(C))?C:(C=this.getVoxel(X,Y,Z-1|0),this.valid(C))?C:(C=this.getVoxel(X,Y,Z+1|0),this.valid(C))?C:null},clone:function(){for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,MY,MZ),X=0,Y=0,Z=0,VM;X<MX;){while(Y<MY){while(Z<MZ)N.set([X,Y,Z],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;X=X+1|0}return VM=new BNTest.VoxelMap,VM.map=N,VM},importImageLayer:function(image,z){z===void 0&&(z=0);for(var X=0,Y=0,i=0,P=BNTest.AnimationLoader.getPixels(image),H=image.height,W=image.width,A=0,R=0,G=0,B=0;Y<H;){while(X<W)R=P[Bridge.identity(i,i=i+1|0)]/255,G=P[Bridge.identity(i,i=i+1|0)]/255,B=P[Bridge.identity(i,i=i+1|0)]/255,A=P[Bridge.identity(i,i=i+1|0)]/255,this.map.set([X,Y,z],new BNTest.GLColor(R,G,B,A)),X=X+1|0;X=0;Y=Y+1|0}},valid:function(C){return C!=null&&C.a>0},opaque:function(C){return BNTest.GLDemo.allowAlpha?C!=null&&C.a>=1:this.valid(C)},getInvisibleSides:function(X,Y,Z){var ret=System.Array.init(6,!1);return ret[0]=this.opaque(this.getVoxel(X,Y,Z-1|0)),ret[1]=this.opaque(this.getVoxel(X,Y,Z+1|0)),ret[2]=this.opaque(this.getVoxel(X-1|0,Y,Z)),ret[3]=this.opaque(this.getVoxel(X+1|0,Y,Z)),ret[4]=this.opaque(this.getVoxel(X,Y-1|0,Z)),ret[5]=this.opaque(this.getVoxel(X,Y+1|0,Z)),ret},applyPalette:function(palette){var Keys=System.Linq.Enumerable.from(palette.getKeys()).toList(BNTest.GLColor),Vals=System.Linq.Enumerable.from(palette.getValues()).toList(BNTest.GLColor),C,t,ind;if(!(Keys.getCount()<=0))for(var X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),key=null,i=0,ln=Keys.getCount();X<MX;){while(Y<MY){while(Z<MZ){if(C=this.map.get([X,Y,Z]),C!=null&&C.a>0){for(key=null,i=0;i<ln;)t=Keys.getItem(i),t.similar(C)&&(key=t,i=ln),i=i+1|0;key!=null&&(ind=Keys.indexOf(key),ind>=0&&this.map.set([X,Y,Z],Vals.getItem(ind)))}Z=Z+1|0}Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},swapYZ:function(){for(var N=System.Array.create(null,null,System.Array.getLength(this.map,0),System.Array.getLength(this.map,2),System.Array.getLength(this.map,1)),X=0,Y=0,Z=0;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))N.set([X,Z,Y],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;X=X+1|0}this.map=N},getPalette:function(){for(var ret=new(System.Collections.Generic.List$1(BNTest.GLColor)),X=0,Y=0,Z=0,C;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))C=this.map.get([X,Y,Z]),C!=null&&(ret.contains(C)||ret.add(C)),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}return ret.toArray()},resize:function(NewDimensions){var NX=NewDimensions[0],NY=NewDimensions[1],NZ=NewDimensions[2],MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),OV;if(MX<NX||MY<NY||MZ<NZ){for(var NM=System.Array.create(null,null,NX,NY,NZ),XOffset=(NX-MX|0)>>1,YOffset=(NY-MY|0)>>1,ZOffset=(NZ-MZ|0)>>1,X=0,Y=0,Z=0;X<NX;){while(Y<NY){while(Z<NZ)OV=this.getVoxel(X-XOffset|0,Y-YOffset|0,Z-ZOffset|0),NM.set([X,Y,Z],OV),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}return this.map=NM,!0}return!1},fill:function(box,C){var sz=box.getSize();this.fill$1(Bridge.Int.clip32(box.min.x),Bridge.Int.clip32(box.min.y),Bridge.Int.clip32(box.min.z),Bridge.Int.clip32(sz.x),Bridge.Int.clip32(sz.y),Bridge.Int.clip32(sz.z),C)},fill$1:function(X,Y,Z,Width,Height,Depth,C){for(var SX=X,SY=Y,SZ=Z,X2=SX+Width|0,Y2=SY+Height|0,Z2=SZ+Depth|0;X<X2;){while(Y<Y2){while(Z<Z2)this.setVoxel$1(X,Y,Z,C),Z=Z+1|0;Z=SZ;Y=Y+1|0}Y=SY;X=X+1|0}},setVoxel:function(V,C){return this.setVoxel$1(Bridge.Int.clip32(V.x),Bridge.Int.clip32(V.y),Bridge.Int.clip32(V.z),C)},setVoxel$1:function(X,Y,Z,C){return X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)&&!Bridge.referenceEquals(this.map.get([X,Y,Z]),C)?(this.map.set([X,Y,Z],C),!0):!1},combine:function(VM,XOffset,YOffset,ZOffset){var ND,OV,V;XOffset===void 0&&(XOffset=0);YOffset===void 0&&(YOffset=0);ZOffset===void 0&&(ZOffset=0);BNTest.VoxelMap.sameSize(this,VM)||(ND=BNTest.VoxelMap.getMaxSize(this,VM),this.resize(ND),VM.resize(ND));for(var X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2);X<MX;){while(Y<MY){while(Z<MZ)OV=this.getVoxel(X+XOffset|0,Y+XOffset|0,Z+ZOffset|0),V=VM.getVoxel(X,Y,Z),(OV==null||V!=null&&V.a>=OV.a)&&this.setVoxel$1(X+XOffset|0,Y+XOffset|0,Z+ZOffset|0,V),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},getValidQuadrants:function(X,Y,Z){var ret=System.Array.init(8,!1);return ret[0]=this.isValidQuadrants(X,Y,Z,!1,!1,!1),ret[1]=this.isValidQuadrants(X,Y,Z,!0,!1,!1),ret[2]=this.isValidQuadrants(X,Y,Z,!1,!0,!1),ret[3]=this.isValidQuadrants(X,Y,Z,!0,!0,!1),ret[4]=this.isValidQuadrants(X,Y,Z,!1,!1,!0),ret[5]=this.isValidQuadrants(X,Y,Z,!0,!1,!0),ret[6]=this.isValidQuadrants(X,Y,Z,!1,!0,!0),ret[7]=this.isValidQuadrants(X,Y,Z,!0,!0,!0),System.Array.contains(ret,!0,Boolean)||(ret=[!0,!0,!0,!0,!0,!0,!0,!0]),ret},isValidQuadrants:function(X,Y,Z,sx,sy,sz){var TX=X-1|0,TY,TZ;sx&&(TX=TX+1|0);TY=Y-1|0;sy&&(TY=TY+1|0);TZ=Z-1|0;sz&&(TZ=TZ+1|0);for(var XX=0,YY=0,ZZ=0;XX<2;){while(YY<2){while(ZZ<2){var FX=TX+XX|0,FY=TY+YY|0,FZ=TZ+ZZ|0;if(!(FX===X&&FY===Y&&FZ===Z)&&this.valid(this.getVoxel(FX,FY,FZ)))return!0;ZZ=ZZ+1|0}ZZ=0;YY=YY+1|0}YY=0;XX=XX+1|0}return!1}});Bridge.define("BNTest.WGMatrix",{statics:{tmatrix:null,tbmatrix:null,t2matrix:null,tmatobj:null,init:function(){var c,m;BNTest.WGMatrix.tmatrix==null&&(c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),BNTest.WGMatrix.tmatrix=c,c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),BNTest.WGMatrix.tbmatrix=c,c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),m={},m.elements=c,BNTest.WGMatrix.tmatobj=m,BNTest.WGMatrix.t2matrix=c)},flatten:function(matrix){var M=matrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return[A[0],B[0],C[0],D[0],A[1],B[1],C[1],D[1],A[2],B[2],C[2],D[2],A[3],B[3],C[3],D[3]]},flattenB:function(matrix){var M=matrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return[A[0],A[1],A[2],A[3],B[0],B[1],B[2],B[3],C[0],C[1],C[2],C[3],D[0],D[1],D[2],D[3]]},copyFrom:function(source,destination){var a=source.elements,b=destination.elements,t=b[0],t2=a[0];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[1];t2=a[1];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[2];t2=a[2];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[3];t2=a[3];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3]},copyFromInverted:function(source,destination){var M=source,b=destination,A=M[0],B=M[1],C=M[2],D=M[3],t=b[0];t[0]=A[0];t[1]=B[0];t[2]=C[0];t[3]=D[0];t=b[1];t[0]=A[1];t[1]=B[1];t[2]=C[1];t[3]=D[1];t=b[2];t[0]=A[2];t[1]=B[2];t[2]=C[2];t[3]=D[2];t=b[3];t[0]=A[3];t[1]=B[3];t[2]=C[3];t[3]=D[3]},multMatrix:function(matrix1,matrix2){var a=matrix1.elements,i,j;BNTest.WGMatrix.copyFromInverted(matrix2.elements,BNTest.WGMatrix.tbmatrix);var b=BNTest.WGMatrix.tbmatrix,c=BNTest.WGMatrix.tmatrix,ci,ai,bj;for(i=0;i<3;i=i+1|0){ci=c[i];ai=a[i];var ai0=ai[0],ai1=ai[1],ai2=ai[2],ai3=ai[3];for(j=0;j<4;j=j+1|0)bj=b[j],ci[j]=ai0*bj[0]+ai1*bj[1]+ai2*bj[2]+ai3*bj[3]}matrix1.elements=c;BNTest.WGMatrix.tmatrix=a},oldMultMatrix:function(matrix1,matrix2){for(var j,a=matrix1.elements,b=matrix2.elements,c=BNTest.WGMatrix.tmatrix,ci,ai,i=0;i<3;i=i+1|0){ci=c[i];ai=a[i];var ai0=ai[0],ai1=ai[1],ai2=ai[2],ai3=ai[3];for(j=0;j<4;j=j+1|0)ci[j]=ai0*b[0][j]+ai1*b[1][j]+ai2*b[2][j]+ai3*b[3][j]}matrix1.elements=c;BNTest.WGMatrix.tmatrix=a},clear:function(matrix){var $t,$t1,$t2,$t3,$t4,$t5,$t6,$t7,$t8,$t9,$t10,$t11,D=matrix;D[0][1]=($t=($t1=($t2=($t3=($t4=($t5=($t6=($t7=($t8=($t9=(D[3][2]=0,0),D[3][1]=$t9,$t9),D[3][0]=$t8,$t8),D[2][3]=$t7,$t7),D[2][1]=$t6,$t6),D[2][0]=$t5,$t5),D[1][3]=$t4,$t4),D[1][2]=$t3,$t3),D[1][0]=$t2,$t2),D[0][3]=$t1,$t1),D[0][2]=$t,$t);D[0][0]=($t10=($t11=(D[3][3]=1,1),D[2][2]=$t11,$t11),D[1][1]=$t10,$t10)}},mvMatrix:null,identity:!0,mvMatrixStack:null,config:{init:function(){this.mvMatrixStack=System.Array.init(0,null)}},ctor:function(){this.$initialize();this.mvMatrix=Matrix.I(4)},loadIdentity:function(){this.clear()},newIdentity:function(){var c=System.Array.init(4,null);c[0]=System.Array.init(4,0);c[1]=System.Array.init(4,0);c[2]=System.Array.init(4,0);c[3]=System.Array.init(4,0);this.mvMatrix.elements=c;this.clear()},isIdentity:function(){var M=this.mvMatrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return A[0]===1&&B[1]===1&&C[2]===1&&A[1]===0&&A[2]===0&&A[3]===0&&B[0]===0&&B[2]===0&&B[3]===0&&C[0]===0&&C[1]===0&&C[3]===0&&D[0]===0&&D[1]===0&&D[2]===0},getMatrix:function(){var M=this.mvMatrix.elements,b=System.Array.init(4,null);return b[0]=[M[0][0],M[0][1],M[0][2],M[0][3]],b[1]=[M[1][0],M[1][1],M[1][2],M[1][3]],b[2]=[M[2][0],M[2][1],M[2][2],M[2][3]],b[3]=[M[3][0],M[3][1],M[3][2],M[3][3]],b},multiplyMatrix:function(matrix){if(this.identity&&!matrix.identity){this.copyFrom(matrix);this.identity=!1;return}(this.identity||!matrix.identity)&&(BNTest.WGMatrix.multMatrix(this.mvMatrix,matrix.mvMatrix),this.identity&&(this.identity=this.isIdentity()))},multiplyMatrix$1:function(matrix){this.identity?this.copyFrom$1(matrix):BNTest.WGMatrix.multMatrix(this.mvMatrix,matrix);this.identity&&(this.identity=this.isIdentity())},copyFrom:function(source){BNTest.WGMatrix.copyFrom(source.mvMatrix,this.mvMatrix)},copyFrom$1:function(source){BNTest.WGMatrix.copyFrom(source,this.mvMatrix)},mvTranslate:function(v){var D=BNTest.WGMatrix.t2matrix;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);BNTest.WGMatrix.t2matrix[0][3]=v[0];BNTest.WGMatrix.t2matrix[1][3]=v[1];BNTest.WGMatrix.t2matrix[2][3]=v[2];this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},mvPushMatrix:function(){this.mvMatrixStack.push(this.getMatrix())},mvPopMatrix:function(){var D=this.mvMatrixStack.pop();return this.mvMatrix.elements=D,this.identity=this.isIdentity(),this.mvMatrix},equals:function(o){if(Bridge.is(o,BNTest.WGMatrix)){for(var D=this.mvMatrix,D2=o.mvMatrix,i=0;i<16;){if(D[i]!==D2[i])return!1;i=i+1|0}return!0}return Bridge.equals(this,o)},clear:function(){var D=this.mvMatrix.elements;D[0]=[1,0,0,0];D[1]=[0,1,0,0];D[2]=[0,0,1,0];D[3]=[0,0,0,1];this.identity=!0},setTranslation:function(V){var D=this.mvMatrix.elements;D[0][3]=V.x;D[1][3]=V.y;D[2][3]=V.z},setPositionThenScale:function(Position,Scale){var D=this.mvMatrix.elements,A=D[0],B=D[1],C=D[2];A[0]=Scale.x;B[1]=Scale.y;C[2]=Scale.z;A[3]=Position.x;B[3]=Position.y;C[3]=Position.z;this.identity=this.isIdentity()},setScale:function(S){var D=this.mvMatrix.elements;D[0][0]=S.x;D[1][1]=S.y;D[2][2]=S.z},getTranslation:function(){var D=this.mvMatrix;return new BNTest.GLVec3.ctor(D[12],D[13],D[14])},clone:function(){var ret=new BNTest.WGMatrix;return ret.copyFrom(this),ret},mvScale:function(Scale){var s=Scale,m=BNTest.WGMatrix.tmatobj;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);BNTest.WGMatrix.t2matrix[0][0]=s.x;BNTest.WGMatrix.t2matrix[1][1]=s.y;BNTest.WGMatrix.t2matrix[2][2]=s.z;this.multiplyMatrix$1(m)},mvRotate:function(angle,Direction){this.mvRotate$1(angle,[Direction.x,Direction.y,Direction.z])},mvRotate$1:function(angle,v){var inRadians=angle*.01745329251,m=Matrix.Rotation(inRadians,$V([v[0],v[1],v[2]])).ensure4x4();this.multiplyMatrix$1(m)},rotateX:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[1][1]=C;D[1][2]=S;D[2][1]=-S;D[2][2]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},rotateY:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[0][0]=C;D[0][2]=-S;D[2][0]=S;D[2][2]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},rotateZ:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[0][0]=C;D[0][1]=S;D[1][0]=-S;D[1][1]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)}});Bridge.define("BNTest.World",{statics:{viewDistance:100,blank:null,config:{init:function(){this.blank=new(System.Collections.Generic.List$1(BNTest.Entity))}}},model:null,game:null,entities:null,octree:null,cam:null,config:{init:function(){this.cam=new BNTest.GLVec3.ctor}},ctor:function(Game){this.$initialize();this.game=Game;this.model=new BNTest.Model(Game);this.entities=new(System.Collections.Generic.List$1(BNTest.Entity));this.octree=new BNTest.Octree(50,4)},getOffset:function(){return this.model.offset},setOffset:function(value){this.model.offset=value},add:function(E){Bridge.referenceEquals(E.world,this)||E.world==null||E.world.remove(E);this.entities.contains(E)||this.entities.add(E);E.model!=null&&this.add$1(E.model);E.world=this},add$1:function(M){M==null||this.model.children.contains(M)||this.model.children.add(M)},remove:function(E){this.entities.contains(E)&&this.entities.remove(E);E.model!=null&&this.remove$1(E.model);E.world=null},remove$1:function(M){M!=null&&this.model.children.contains(M)&&(M.unloadBuffers(),this.model.children.remove(M))},bringToFront:function(M){this.model.children.contains(M)&&(this.model.children.remove(M),this.model.children.add(M))},sendToBack:function(M){this.model.children.contains(M)&&(this.model.children.remove(M),this.model.children.insert(0,M))},update:function(){var i,E;for(BNTest.World.viewDistance=this.game.cameraDist*4,this.cam=BNTest.GLVec3.op_UnaryNegation(this.getOffset()),i=0;i<this.entities.getCount();)E=this.entities.getItem(i),E.update(),E.alive||(this.remove(E),i=i-1|0),i=i+1|0;this.updateCollisions()},findObstructionCollision:function(box,exclusion){var E;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],(E.solid||E.obstruction)&&E!=exclusion&&E.lastBB!=null&&!E.lastBB.getEmpty()&&E.lastBB.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findObstructionCollision$1:function(Position,exclusion){var E;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],(E.solid||E.obstruction)&&E!=exclusion&&E.lastBB!=null&&!E.lastBB.getEmpty()&&E.lastBB.contains(Position)&&ret.push(E),i=i+1|0;return ret},findSolidCollision:function(box,exclusion){var E;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],E.solid&&E!=exclusion&&E.lastBB!=null&&!E.lastBB.getEmpty()&&E.lastBB.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findSolidCollision$2:function(Position,exclusion){var E;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],E.solid&&E!=exclusion&&E.lastBB!=null&&!E.lastBB.getEmpty()&&E.lastBB.contains(Position)&&ret.push(E),i=i+1|0;return ret},findSolidCollision$1:function(entity){return entity.lastBB==null?[]:this.findSolidCollision(entity.lastBB)},updateCollisions:function(){this.updateAttackCollisions()},updateAttackCollisions:function(){for(var i=0,LHE=System.Array.init(0,null),LC=System.Array.init(0,null),ln=this.entities.getCount(),E,li,jli,C,CE,CB;i<ln;)E=this.entities.getItem(i),E.getTargetPriority&&LC.push(E),E.gettouchDamage&&LHE.push(E),i=i+1|0;for(i=0,li=LHE.length,jli=LC.length;i<li;){for(var ji=0,HE=LHE[i],THE=HE,B=THE.lastBB;ji<jli;)C=LC[ji],HE.BNTest$IHarmfulEntity$getAttacker().sameTeam(C)||(CE=C,CB=CE.lastBB,B.intersection$2(CB)&&HE.BNTest$IHarmfulEntity$ontouchDamage(C)&&this.game.attack(C,HE)),ji=ji+1|0;i=i+1|0}}});Bridge.define("BNTest.AimedWandering",{inherits:[BNTest.EntityBehavior],target:null,target2:null,focus:.95,range:120,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},update:function(){var N=this.entity.getBehavior(BNTest.NavigatorAI),T,V,Nrelative;if(N==null&&(N=new BNTest.NavigatorAI(this.entity),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),T=this.target2,T==null&&this.target!=null&&this.target.getPosition()!=null&&(T=this.target.getPosition()),T!=null){for(var relative=BNTest.GLVec3.op_Subtraction(this.entity.getPosition(),T),dist=relative.getRoughLength(),maxrange=this.range,mr2=maxrange+maxrange,ok=!1;!ok;)V=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(-maxrange+Math.random()*mr2,0,-maxrange+Math.random()*mr2),this.entity.getPosition()),Nrelative=BNTest.GLVec3.op_Subtraction(V,T),(Nrelative.getRoughLength()<dist||Math.random()>this.focus)&&(N.requestMoveTo(V,.42,!0),ok=!0);BNTest.EntityBehavior.prototype.update.call(this)}}});Bridge.define("BNTest.Barrier",{inherits:[BNTest.Entity],ctor:function(world,size){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.solid=!0;var M=new BNTest.Mesh(this.game);M.addCube2(new BNTest.GLVec3.ctor,size,new BNTest.GLColor(0,0,0,.3),null);this.model.meshes.add(M);this.cacheBoundingBox()},update:function(){BNTest.Entity.prototype.update.call(this);this.world.bringToFront(this.model)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.BasicSword",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:3,_shotDelay:0,_maxShotDelay:2,_angle:0,bulletSpeed:0,bulletGraphic:null,active:!1,speed:null,forcedAngle:0,minCoolDown:18,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);entity.useSwingAnimation=!0},getEnergyCost:function(){return 9.2},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0){if(this.active,this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally())){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,40);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.entity.forcedAngle=this._angle;this.entity.frictionActive=!1;this.active||this.customEvent(D)}}else this.active&&(this.entity.forcedAngle=null,this.entity.frictionActive=!0,this.active=!1);BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P=new BNTest.Projectile(this.entity.world,this.entity),M,size,HSZ,lifespan;P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(80);M.rotation.y=evt.A;size=30;HSZ=new BNTest.GLVec3.ctor(size,size,size);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.setScale(BNTest.GLVec3.createUniform(3));lifespan=this._maxShotDelay*this._maxAmmo|0;lifespan=lifespan+3|0;P.obstruction=!0;P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY).normalize(2.5));P.speed=BNTest.GLVec3.op_Addition(P.speed,this.entity.speed.clone());P.addBehavior(new BNTest.LifeSpan(P,lifespan));this.entity.world.add(P);this.active=!0;this.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));P.setPosition(BNTest.GLVec3.op_Addition(P.getPosition(),BNTest.GLVec3.op_Multiply$1(this.speed,.5)))},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.Coin",{inherits:[BNTest.Entity],value:10,pickupDelay:0,ctor:function(world,lifespan){var smooth,mdl,tmdl,coin,HP;lifespan===void 0&&(lifespan=900);this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(10);mdl="coin";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.model.alpha=1,this.model.setVisible(!0)):(coin="object/coin",BNTest.AnimationLoader.get_this().asyncGet$1([coin],Bridge.fn.bind(this,function(){var off,box,M2,md,M,M3;this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));off=this.model.offset;this.model.clear();this.model.offset=off;this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,.5);box=BNTest.VoxelMap.fromImages$1(coin);M2=new BNTest.Mesh(this.game);M2.addVoxelMap(box,smooth);box.setColor(new BNTest.GLColor);M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);M3=M.clone();md=new BNTest.Model(this.game);md.meshes.add(M3);M3.scale=BNTest.GLVec3.createUniform(1.1);M3.updateTranformation();M3.flattenGeometry();md=new BNTest.Model(this.game);M.scale=new BNTest.GLVec3.ctor(.8,.8,.8);md.meshes.add(M);M.updateTranformation();M.flattenGeometry();M.combine(M3);this.model.children.add(md);md=new BNTest.Model(this.game);md.bleedThrough=!0;md.meshes.add(M2);this.model.children.add(md);world.sendToBack(this.model);tmdl==null&&BNTest.ModelCache.get_this().set$1("coin",this.model)})));this.solid=!1;HP=new BNTest.LifeSpan(this,lifespan,120);this.addBehavior(HP)},setValue:function(Value){var rank,val,scale,T,C;if(Value<10){this.setScale(BNTest.GLVec3.createUniform(Value*.1*.5));this.value=Value;this.customBoundingBox=BNTest.BoundingBox.op_Multiply$1(this.customBoundingBox,this.model.scale.x);return}for(rank=0,val=Value;val>=500;)val*=.002,rank=rank+1|0;scale=1+val*.005;rank>0&&(T=[new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,0,1),new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,0,1)],C=T[rank],this.setColor(C));this.setScale(BNTest.GLVec3.createUniform(scale*.5));this.value=Value;this.customBoundingBox=BNTest.BoundingBox.op_Multiply$1(this.customBoundingBox,this.model.scale.x)},setColor:function(color){var P=this.model.offset,M;this.model=this.model.clone();this.model.offset=P;M=this.model.children.getItem(2);M.meshes.getItem(0).replaceAllColors(color)},update:function(){var player,BS,dist,spd,S,val;this.model.rotation.y+=5;BNTest.Entity.prototype.update.call(this);player=this.world.game.localplayer.character;BS=this.lastBB.getSize();this.speed=BNTest.GLVec3.op_Multiply$1(this.speed,.96);this.world.findSolidCollision$2(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,BS.y+1,0))).length>0?this.speed.y=0:this.speed.y+=.05;this.pickupDelay>0?this.pickupDelay=this.pickupDelay-1|0:player.restTime>=15&&player.invincibilityFrames<=0&&(dist=this.getPosition().roughDistance(player.getPosition()),dist<110&&(spd=2.5-dist*.01,S=BNTest.GLVec3.op_Subtraction(player.getPosition(),this.getPosition()).normalize(spd),this.speed.x=S.x,this.speed.y=S.y,this.speed.z=S.z));this.pickupDelay<=0&&BS.getRoughLength()>0&&player.lastBB.getSize().getRoughLength()>0&&player.lastBB.intersection$2(this.lastBB)&&(val=this.value,player.setCoins(player.getCoins()+val|0),this.playSound("powerup"),this.alive=!1)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.ControllableEntity",{inherits:[BNTest.Entity],controller:null,lController:null,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.controller=System.Array.init(7,!1);this.lController=System.Array.init(this.controller.length,!1)}});Bridge.define("BNTest.DonationBox",{inherits:[BNTest.Entity],defaultMaxHP:40,maxHP:0,HP:0,coinsToRelease:0,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);var smooth=this.game.smooth;this.solid=!0;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(20);this.customBoundingBox.min.y=-2;this.lastBB=this.customBoundingBox.clone();BNTest.AnimationLoader.get_this().asyncGet$1(["object/donationBox","object/donationBoxTop"],Bridge.fn.bind(this,function(){this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.model.clear();this.HP=this.maxHP=this.defaultMaxHP;world.add$1(this.model);var box=this.game.getVoxelCombo(["object/donationBox","object/donationBoxTop"]),M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);this.model.meshes.add(M)}))},update:function(){var $t,i,Val,c,m,m2;if(this.lastBB==null&&(this.lastBB=new BNTest.BoundingBox.ctor),!this.game.ended){var B=BNTest.BoundingBox.op_Multiply$1(this.lastBB,1.5),L=this.world.findSolidCollision(B,this),PC=this.game.localplayer.character,P=System.Linq.Enumerable.from(L).where($_.BNTest.DonationBox.f1).toArray();if(P.length>0&&(this.HP-=.5+P.length*.5,this.HP<=0&&PC.getCoins()>=10&&(this.coinsToRelease=this.coinsToRelease+1|0,this.HP=this.maxHP)),this.coinsToRelease>0&&PC.getCoins()<=0&&(this.coinsToRelease=0),this.coinsToRelease>0){for(i=this.coinsToRelease;i>0;)this.setScale(BNTest.GLVec3.op_Multiply$1(this.getScale(),.96)),i=i-1|0;this.getScale().x<=.6&&(this.coinsToRelease=this.coinsToRelease-1|0,Val=Math.min(PC.getCoins(),10),PC.setCoins(PC.getCoins()-Val|0),c=new BNTest.Coin(this.world),c.setPosition(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,-20,0))),c.solid=!1,m=3,m2=m+m|0,c.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),c.speed.y=-1+(-m|0)*Math.random(),Val!==10&&c.setValue(Val),this.world.add(c),this.getScale().x=($t=(this.getScale().z=1,1),this.getScale().y=$t,$t))}BNTest.Entity.prototype.update.call(this)}},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.ns("BNTest.DonationBox",$_);Bridge.apply($_.BNTest.DonationBox,{f1:function(E){return E.controller!=null&&E.team!==0}});Bridge.define("BNTest.EnemyEngager",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,predict:!0,passive:!1,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),P,E,EP,Pos;if(N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),P=this.entity.getPosition(),this.target!=null&&P.roughDistance(this.target.model.offset)>this.sightRange&&(this.target=null),this.target==null&&!this.passive)for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.sightRange&&(this.target=EP,i=ln)),i=i+1|0;this.target!=null?(controller[5]=!0,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),N.requestMoveTo(Pos,.5)):controller[5]=!1;BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.EnemyStrafer",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,predict:!0,passive:!1,attackrange:999999,ang:.1,frame:0,attackType:5,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller,N,P,D,E,EP,PC,Pos,rl,rel,A,NV;if(this.frame=this.frame+1|0,controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),P=this.entity.getPosition(),D=0,this.target!=null&&(D=P.roughDistance(this.target.model.offset),D>this.sightRange&&(this.target=null)),this.target==null&&!this.passive)for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.sightRange&&(this.target=EP,i=ln)),i=i+1|0;this.target!=null?(PC=this.entity,controller[this.attackType]=D<=this.attackrange?!0:!1,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),rl=BNTest.GLVec3.op_Subtraction(Pos,this.entity.getPosition()).toVector2(),rel=BNTest.MathHelper.radiansToDegrees(rl.toAngle()),this.entity.model.rotation.y=rel-90,N.setsAngle=!1,A=this.ang,D>this.attackrange*.75?A=A+A:D<this.sightRange*.6&&(A=-(A+A)),NV=BNTest.GLVec3.op_Addition$1(this.entity.getPosition(),rl.rotate(1.57-A)),N.requestMoveTo(NV,.5)):(controller[this.attackType]=!1,N.setsAngle=!0);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.EntityFollower",{inherits:[BNTest.EntityBehavior],target:null,ctor:function(entity,target){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.target=target},update:function(){var N=this.entity.getBehavior(BNTest.NavigatorAI);N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N));N.requestMoveTo(this.target.getPosition().clone(),.4);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.Foliage",{inherits:[BNTest.Entity],current:null,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.solid=!1;this.model.setVisible(!1);this.model.forceRender=!0;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(1)},addPatch:function(position,color,size,thickness,scale){var V,VL,amod,mod,M;thickness===void 0&&(thickness=.7);scale===void 0&&(scale=1);for(var VM=new BNTest.VoxelMap,N=System.Array.create(null,null,size,1,size),X=0,Y=0,Z=0,min=Bridge.Int.div(size,4)|0,max=size-min|0,S=size*.5;X<System.Array.getLength(N,0);){while(Y<System.Array.getLength(N,1)){while(Z<System.Array.getLength(N,2))V=new BNTest.GLVec3.ctor(X-S,0,Z-S),VL=V.getLength(),VL<=S&&(amod=.25,mod=(amod+VL/S)/(amod+1),Math.random()*mod<thickness&&N.set([X,Y,Z],color)),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}VM.map=N;VM.addNoise(.15);M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},addFlatShrub:function(position,color,scale){var VM,N,M;scale===void 0&&(scale=1);VM=new BNTest.VoxelMap;N=System.Array.create(null,null,10,1,10);VM.map=N;VM.fill(new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor,new BNTest.GLVec3.ctor(10,1,10)),color);VM.addNoise(.1);VM.addHoles(.6);M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},addShrub:function(position,color,scale){var VM,T;scale===void 0&&(scale=1);var Char="shrub",tmdl=BNTest.ModelCache.get_this().get(Char,!1),M=null,size=30;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),M=tmdl.meshes.getItem(0).clone()):(VM=BNTest.VoxelMap.generateRock(size,color,.9),VM.addNoise(.07),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,!0),T=new BNTest.Model(this.game),T.meshes.add(M),BNTest.ModelCache.get_this().set$1(Char,T));M.offset=position;M.offset.y-=(Bridge.Int.div(size,4)|0)*scale;M.rotation.y=Math.random()*360;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));this.addFoliage(M)},addFlower:function(position,petal,inner,scale){var $t,$t1,VM,N,M;inner===void 0&&(inner=null);scale===void 0&&(scale=1);inner==null&&(inner=petal.r===petal.g&&petal.b===0&&petal.r>0?new BNTest.GLColor(.7,.7,0):new BNTest.GLColor(1,1));VM=new BNTest.VoxelMap;N=System.Array.create(null,null,3,1,3);N.set([1,0,0],($t=($t1=(N.set([2,0,1],petal),petal),N.set([0,0,1],$t1),$t1),N.set([1,0,2],$t),$t));N.set([1,0,1],inner);VM.map=N;M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},absorbModel:function(E){this.absorbModel$1(E.model)},absorbModel$1:function(M,baseTransform){var matrix,i,C;for(baseTransform===void 0&&(baseTransform=null),M.updateTransform(),baseTransform==null&&M.transformed?baseTransform=M.transformation.clone():M.transformed&&baseTransform.multiplyMatrix(M.transformation),baseTransform==null&&(baseTransform=new BNTest.WGMatrix),M.setVisible(!1),i=0;i<M.meshes.getCount();)C=M.meshes.getItem(i),matrix=M.transformation.clone(),C.transformation!=null&&C.transformed&&matrix.multiplyMatrix(C.transformation),C.morphGeometry(matrix),this.addFoliage(C),i=i+1|0;for(i=0;i<M.children.getCount();)this.absorbModel$1(M.children.getItem(i),baseTransform.clone()),i=i+1|0},addFoliage:function(M){(this.current==null||(this.current.indices.length+M.indices.length|0)>=44500)&&(this.current=new BNTest.Mesh(this.game),this.model.meshes.add(this.current));M.flattenGeometry();this.current.combine(M,!0);this.model.setVisible(!0)},update:function(){BNTest.Entity.prototype.update.call(this)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.LifeSpan",{inherits:[BNTest.EntityBehavior],HP:0,flickerTime:0,frame:0,fadeTime:15,ctor:function(entity,HP,flickerTime){flickerTime===void 0&&(flickerTime=0);this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.HP=HP;this.flickerTime=flickerTime},update:function(){this.HP=this.HP-1|0;this.HP<=0?this.entity.alive=!1:this.flickerTime>0&&this.HP<this.flickerTime&&(this.frame=this.frame+1|0,(this.frame&1)>0&&this.entity.model.setVisible(!this.entity.model.getVisible()));this.HP<this.fadeTime&&(this.entity.model.alpha=this.HP/this.fadeTime);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.NavigatorAI",{inherits:[BNTest.EntityBehavior],canJump:!0,setsAngle:!0,_lastProgress:System.Int64.toNumber(System.Int64([1874919423,2328306])),_timeSinceLastProgress:0,persistence:45,_movementPriority:0,_moveTo:null,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getMoveTo:function(){return this._moveTo},setMoveTo:function(value){Bridge.referenceEquals(this._moveTo,value)||(this._lastProgress=System.Int64([1874919423,2328306]),this._timeSinceLastProgress=0,this._moveTo=value)},requestMoveTo:function(position,priority,onlyIfHigher){var ok,D;return priority===void 0&&(priority=.5),onlyIfHigher===void 0&&(onlyIfHigher=!1),ok=priority>this._movementPriority,onlyIfHigher||ok||priority!==this._movementPriority||(ok=!0),ok&&(Bridge.referenceEquals(position,this._moveTo)||(this.setMoveTo(position),Bridge.referenceEquals(this.getMoveTo(),position)&&(this._movementPriority=priority,this.entity.getHandledLocally()&&(D={},D.T="MT",D.X=this._moveTo.x,D.Y=this._moveTo.y,D.P=this._movementPriority,this.sendCustomEvent(D,!0),this.entity.getHandledLocally()&&this.entity.refreshBehaviorTick(BNTest.NetworkSync))))),!1},customEvent:function(evt){Bridge.referenceEquals(evt.T,"MT")&&this.requestMoveTo(new BNTest.GLVec3.ctor(evt.X,evt.Y,evt.Z),evt.P);Bridge.referenceEquals(evt.T,"R")&&this.reset()},resetController:function(){var controller=this.entity.controller;controller[0]=!1;controller[1]=!1;controller[2]=!1;controller[3]=!1},reset:function(){this.resetController();this._moveTo=null;this._movementPriority=-1},update:function(){var D,currentProgress,D1,Platformer,D2;if(this._moveTo!=null){var controller=this.entity.controller,lcontroller=this.entity.lController,relative=BNTest.GLVec3.op_Subtraction(this._moveTo,this.entity.getPosition()),V=BNTest.GLVec3.op_Addition(this.entity.getPosition(),BNTest.GLVec3.op_Multiply$1(relative,.5));if(this.entity.world.findSolidCollision(new BNTest.BoundingBox.$ctor1(V,BNTest.GLVec3.op_Addition(V,new BNTest.GLVec3.ctor(0,100,0)))).length<1){this.entity.getHandledLocally()&&(D={},D.T="R",this.sendCustomEvent(D,!0));this.reset();return}if(this.resetController(),Math.abs(relative.z)>1?relative.z>0?controller[3]=!0:controller[2]=!0:controller[3]=(controller[2]=!1,!1),Math.abs(relative.x)>1?(controller[0]=relative.x<0,controller[1]=relative.x>0):controller[0]=(controller[0]=!1,!1),currentProgress=relative.getRoughLength(),this._lastProgress>currentProgress)this._lastProgress=currentProgress,this._timeSinceLastProgress=0;else if(this._timeSinceLastProgress+=Math.max(1,this.framesPerTick),this._timeSinceLastProgress>this.persistence||currentProgress<4){this.entity.getHandledLocally()&&(D1={},D1.T="R",this.sendCustomEvent(D1,!0));this.reset();return}Bridge.is(this.entity,BNTest.PlatformerEntity)&&(Platformer=this.entity,this.canJump&&(controller[4]=Platformer.cantstep&&Platformer.getPosition().y>-250?!0:!1),this.setsAngle&&(Platformer.model.rotation.y=BNTest.MathHelper.radiansToDegrees(relative.toVector2().toAngle())-90));(controller[0]&&lcontroller[1]||controller[1]&&lcontroller[0])&&(currentProgress<150?(this.reset(),this.entity.getHandledLocally()&&(D2={},D2.T="R",this.sendCustomEvent(D2,!0))):Math.abs(relative.x)<150&&(controller[0]=!1,controller[1]=!1))}BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.NetworkSync",{inherits:[BNTest.EntityBehavior],timer:0,automaticSyncInterval:0,fields:null,lFields:null,needsSync:!1,forcesFlush:!1,updating:!1,updateOnSync:!1,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.fields=new(System.Collections.Generic.List$1(String));this.setBehaviorName("NS")},addField:function(fieldName){return this.fields.contains(fieldName)?!1:(this.fields.add(fieldName),!0)},addFields:function(fieldNames){for(var fieldName,$t=Bridge.getEnumerator(fieldNames);$t.moveNext();)fieldName=$t.getCurrent(),this.addField(fieldName)},_sync:function(){var $t,field,val,i;if(this.entity.getHandledLocally()){var O=this.entity,D={},L=new(System.Collections.Generic.List$1(Object)),ok=!1;for($t=Bridge.getEnumerator(this.fields);$t.moveNext();)field=$t.getCurrent(),val=this.getField(field),D[field]=val,L.add(val),(this.lFields==null||this.lFields.getCount()<L.getCount()||!Bridge.referenceEquals(this.lFields.getItem(L.getCount()-1|0),L.getItem(L.getCount()-1|0)))&&(ok=!0);i=0;ok&&(this.sendCustomEvent(D),this.lFields=L,this.forcesFlush&&(this.entity.game.netPlayNeedsFlush=!0))}},getField:function(fieldName){var O=this.entity;return O[fieldName]?O[fieldName]:O[System.String.concat("get",fieldName)]?O[System.String.concat("get",fieldName)]():(console.log(System.String.concat(System.String.concat(System.String.concat(System.String.concat('NetworkSync: Field "',fieldName),'" was not in '),Bridge.Reflection.getTypeFullName(Bridge.getType(this.entity))),".")),null)},setField:function(fieldName,data){var O=this.entity;if(O[fieldName]){O[fieldName]=data;return}if(O[System.String.concat("set",fieldName)]){O[System.String.concat("set",fieldName)](data);return}console.log(System.String.concat(System.String.concat(System.String.concat(System.String.concat('NetworkSync: Field "',fieldName),'" was not in '),Bridge.Reflection.getTypeFullName(Bridge.getType(this.entity))),"."))},sync:function(){this.needsSync=!0},customEvent:function(evt){var O,field;if(!this.entity.getHandledLocally()){O=this.entity;for(field in evt)this.setField(field,evt[field]);this.updateOnSync&&this.entity.update()}},update:function(){this.updating||(this.updating=!0,this.automaticSyncInterval>0&&(this.timer=this.timer+1|0,this.timer>this.automaticSyncInterval&&(this.needsSync=!0,this.timer=0)),this.needsSync&&(this._sync(),this.needsSync=!1),this.updating=!1)}});Bridge.define("BNTest.Orb",{inherits:[BNTest.Entity],ready:!1,started:!1,entity:null,coinsToRelease:0,ctor:function(world,entity){var smooth,mdl,tmdl;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.entity=entity;smooth=this.game.smooth;this.solid=!1;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(20);this.customBoundingBox.min.y=-2;this.lastBB=this.customBoundingBox.clone();mdl="orb";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.ready=!0):BNTest.AnimationLoader.get_this().asyncGet$1(["object/orb"],Bridge.fn.bind(this,function(){var alpha,pal,box,md,M;if(tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.'));this.model.copyFrom(tmdl,!0);this.ready=!0;return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.visible=!1;world.add$1(this.model);alpha=.36;pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,1,1,.36));box=this.game.getVoxelCombo(["object/orb"]);box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);md.scale=BNTest.GLVec3.createUniform(.6);M.addVoxelMap(box,smooth);md.meshes.add(M.clone());this.model.children.add(md);box=this.game.getVoxelCombo(["object/orb"]);pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,1,1,alpha*.4));box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);md.scale=BNTest.GLVec3.createUniform(1);md.meshes.add(M);this.model.children.add(md);this.model.scale=BNTest.GLVec3.createUniform(1.5);this.model.smoothen();this.ready=!0;tmdl==null&&BNTest.ModelCache.get_this().set$1(mdl,this.model)}))},update:function(){var f,off,P;if(this.lastBB==null&&(this.lastBB=new BNTest.BoundingBox.ctor),this.ready&&!this.started&&this.entity!=null&&(this.started=!0,this.setPosition(this.entity.getPosition().clone())),this.world.bringToFront(this.model),f=BNTest.MathHelper.clamp(this.model.scale.x*(1+(-.1+.2*Math.random())),1.1,1.9),this.model.scale=BNTest.GLVec3.createUniform(f),this.model.rotation.y=this.entity.model.rotation.y,this.entity!=null){this.visible=this.entity.visible;off=new BNTest.Vector2(10,0).rotate(BNTest.MathHelper.degreesToRadians(this.entity.model.rotation.y)-.6);P=BNTest.GLVec3.op_Addition$1(this.entity.getPosition().clone(),off);P.y-=5;var rel=BNTest.GLVec3.op_Subtraction(P,this.getPosition()),spd=1.5,rl=rel.getLength();spd+=rl*.03;this.model.offset=rl<=spd?P.clone():BNTest.GLVec3.op_Addition(this.model.offset,rel.normalize(spd));this.alive=this.entity.alive;this.alive&&(this.world.entities.contains(this.entity)||(this.alive=!1));this.visible=this.entity.visible}else this.alive=!1;BNTest.Entity.prototype.update.call(this)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.PlatformerControls",{inherits:[BNTest.EntityBehavior],_platformer:null,accel:.35,jumpSpeed:3,maxSpeed:1.9,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this._platformer=entity},update:function(){var controller=this._platformer.controller,acc=this.accel,Floor=this._platformer.floor,fric=this._platformer.friction,f;Floor!=null&&(f=Floor.groundFriction,acc*=f);controller[0]&&this._platformer.getHspeed()>-this.maxSpeed&&this._platformer.setHspeed(Math.max(this._platformer.getHspeed()-acc,-this.maxSpeed));controller[1]&&this._platformer.getHspeed()<this.maxSpeed&&this._platformer.setHspeed(Math.min(this._platformer.getHspeed()+acc,this.maxSpeed));controller[2]&&this._platformer.getZspeed()>-this.maxSpeed&&this._platformer.setZspeed(Math.max(this._platformer.getZspeed()-acc,-this.maxSpeed));controller[3]&&this._platformer.getZspeed()<this.maxSpeed&&this._platformer.setZspeed(Math.min(this._platformer.getZspeed()+acc,this.maxSpeed));this._platformer.getVspeed()>=0&&this._platformer.onGround&&controller[4]&&this._platformer.ceiling==null&&(this._platformer.setVspeed(-this.jumpSpeed),this._platformer.playSound("jump"));BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.Projectile",{inherits:[BNTest.Entity,BNTest.IHarmfulEntity],_Attacker:null,_IsHarmful:!0,_touchDamage:1,knockbackPower:1,gravity:null,bounces:!1,ifriction:1,rotationSpeed:null,multiHit:!1,damaged:null,config:{alias:["getAttacker","BNTest$IHarmfulEntity$getAttacker","getIsHarmful","BNTest$IHarmfulEntity$getIsHarmful","gettouchDamage","BNTest$IHarmfulEntity$gettouchDamage","settouchDamage","BNTest$IHarmfulEntity$settouchDamage","ontouchDamage","BNTest$IHarmfulEntity$ontouchDamage"],init:function(){this.damaged=new(System.Collections.Generic.List$1(BNTest.ICombatant))}},ctor:function(world,shooter){this.$initialize();BNTest.Entity.ctor.call(this,world);this._Attacker=shooter},getAttacker:function(){return this._Attacker},getIsHarmful:function(){return this._IsHarmful},gettouchDamage:function(){return this._touchDamage},settouchDamage:function(value){this._touchDamage=value},clone:function(){var P=new BNTest.Projectile(this.world,this.getAttacker()),T;return P.model=this.model.clone(),P.setPosition(this.getPosition().clone()),P.speed=this.speed.clone(),P.knockbackPower=this.knockbackPower,P.ifriction=this.ifriction,P.rotationSpeed=this.rotationSpeed,P.model.rotation=this.model.rotation,P.multiHit=this.multiHit,P.obstruction=this.obstruction,P.bounces=this.bounces,P.gravity=this.gravity,P.solid=this.solid,P.settouchDamage(this.gettouchDamage()),T=this.getBehavior(BNTest.LifeSpan),T!=null&&P.addBehavior(new BNTest.LifeSpan(P,T.HP,T.flickerTime)),P},update:function(){var LBS,R,HS,C,Solids,SY,Solids1,Y,D;if(this.lastBB==null&&(this.lastBB=this.getBoundingBox()),this.lastBB==null){BNTest.Entity.prototype.update.call(this);return}LBS=this.lastBB.getSize();this.lastBB!=null&&LBS.getRoughLength()>0&&(this.gravity!=null&&(this.speed=BNTest.GLVec3.op_Addition(this.speed,this.gravity)),this.ifriction<1&&(this.speed.x*=this.ifriction,this.speed.y*=this.ifriction),this.rotationSpeed!=null&&(R=this.model.rotation,R.x+=this.rotationSpeed.x,R.y+=this.rotationSpeed.y,R.z+=this.rotationSpeed.z),HS=BNTest.GLVec3.op_Multiply$1(this.speed,.5),C=this.lastBB.getCenter(),this.bounces?(SY=LBS.y,Solids1=System.Linq.Enumerable.from(this.game.world.findSolidCollision(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(this.speed.x,0,this.speed.z)),this)).where(function(E){return E.onKill==null&&E.lastBB.getSize().y>SY}).toList(BNTest.Entity),Solids1.getCount()>0&&(this.speed.x*=-.9,this.speed.z*=-.9),Y=this.gety(),D=Bridge.compare(0,this.speed.y),Solids1=System.Linq.Enumerable.from(this.game.world.findSolidCollision(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(0,this.speed.y,0)),this)).where(Bridge.fn.bind(this,function(E){return E.onKill==null&&Bridge.compare(this.gety(),E.gety())===D})).toList(BNTest.Entity),Solids1.getCount()>0&&(this.model.offset.y-=this.speed.y,this.speed.y*=-.9)):(Solids=System.Linq.Enumerable.from(this.game.world.findObstructionCollision$1(BNTest.GLVec3.op_Addition(C,BNTest.GLVec3.op_Addition(this.speed,HS)),this)).where($_.BNTest.Projectile.f1).toList(BNTest.Entity),Solids.addRange(System.Linq.Enumerable.from(this.game.world.findObstructionCollision$1(C,this)).where($_.BNTest.Projectile.f1)),Solids.getCount()>0&&(this.alive=!1)));BNTest.Entity.prototype.update.call(this)},ontouchDamage:function(target){var ret=!this.damaged.contains(target);return ret&&this.damaged.add(target),ret}});Bridge.ns("BNTest.Projectile",$_);Bridge.apply($_.BNTest.Projectile,{f1:function(E){return E.onKill==null}});Bridge.define("BNTest.ProximityAttacker",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,aggroRange:400,predict:!0,passive:!1,aggroFrames:2,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),T2=this.entity.getBehavior(BNTest.IWeaponBehavior),P=this.entity.getPosition(),E,EP,ok,PC,Pos,rel;if(this.target!=null&&P.roughDistance(this.target.model.offset)>this.sightRange&&(this.target=null),this.target==null&&!this.passive&&(this.aggroFrames<=1||this.entity.game.frame%this.aggroFrames==0))for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.aggroRange&&(this.target=EP,i=ln)),i=i+1|0;ok=!0;this.entity.char!=null&&(PC=this.entity,ok=!PC.manaburnout||T2._ammo>0,ok||(ok=PC.ammo+PC.ammoRechargeRate*60>PC.maxAmmo));this.target!=null&&ok?(controller[5]=!0,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),rel=BNTest.MathHelper.radiansToDegrees(BNTest.GLVec3.op_Subtraction(this.entity.getPosition(),Pos).toVector2().toAngle()),this.entity.model.rotation.y=rel+90,N.setsAngle=!1):(controller[5]=!1,N.setsAngle=!0);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.RapidFireGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:7,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:20,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(50);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RapidWideGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:9,_shotDelay:0,_maxShotDelay:3,_angle:0,bulletGraphic:null,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 2.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+13|0},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.6,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,9);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),BNTest.Vector2.op_Multiply(V,15));D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(8);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));P.addBehavior(new BNTest.LifeSpan(P,60));M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.sety(this.entity.gety()+2);P.setx(evt.X);P.sety(evt.Y);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,14));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RingShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:2,bulletLifeSpan:130,bulletGraphic:null,minCoolDown:100,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M;this.entity.playSound("pew");for(var spd=new BNTest.Vector2(evt.SX,evt.SY),HSZ=new BNTest.GLVec3.ctor(7,7,7),i=0;i<6.28;)P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(60),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd.rotate(i)),M.rotation.y=evt.A+BNTest.MathHelper.radiansToDegrees(i),M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X),P.sety(evt.Y+2),P.setz(evt.Z),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),i+=.20933333333333334},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.Rock",{inherits:[BNTest.Entity],size:18,ctor:function(world){var smooth,VM;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.solid=!0;var Char="rock",tmdl=BNTest.ModelCache.get_this().get(Char,!1),M=null,size=30;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),M=tmdl.meshes.getItem(0).clone(),this.model.meshes.add(M)):(VM=BNTest.VoxelMap.generateRock(size,BNTest.GLColor.createShade(.75),.9),VM.addNoise(.07),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,smooth),this.model.meshes.add(M),BNTest.ModelCache.get_this().set$1(Char,this.model));this.model.rotation.y=Math.random()*360;this.model.scale=BNTest.GLVec3.createUniform(.7+Math.random()*.65);this.customBoundingBox=new BNTest.BoundingBox.$ctor2(size);this.customBoundingBox=BNTest.BoundingBox.op_Multiply(this.customBoundingBox,this.model.scale);this.customBoundingBox=BNTest.BoundingBox.op_Subtraction(this.customBoundingBox,BNTest.GLVec3.op_Multiply$1(this.customBoundingBox.getSize(),.5))},update:function(){BNTest.Entity.prototype.update.call(this);this.getPosition().y=(-(Bridge.Int.div(this.size,2)|0)|0)+10|0},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.SecondaryResponder",{inherits:[BNTest.EntityBehavior],attemptTime:0,time:0,ctor:function(entity,attemptTime){attemptTime===void 0&&(attemptTime=30);this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.attemptTime=attemptTime},onAttacked:function(){var E=this.entity;E.controller[6]=!0;this.time=this.attemptTime},update:function(){if(this.time>0)this.time=this.time-1|0;else{var E=this.entity;E.controller[6]=!1}BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.SpawnIllusions",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:240,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){for(var D={},S=System.Array.init(0,null),ms=70,ms2=ms+ms,O=this.entity.getPosition().clone(),V=O.clone(),i=4;i>0;)V.x=O.x+(-ms+ms2*Math.random()),V.z=O.z+(-ms+ms2*Math.random()),S.push(V.toVec3()),i=i-1|0;D.S=S;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var S,PC;this.entity.model.rotation.y=6.28*Math.random();S=evt.S;this.entity.setPosition(new BNTest.GLVec3.$ctor1(S[0]));this.entity.model.alpha=.1;for(var i=1,ln=S.length,EP=this.entity;i<ln;)PC=new BNTest.PlayerCharacter(this.entity.world,new BNTest.Player(!0,!0,EP.me.minion),this.entity.char,this.entity.team),PC.setPosition(new BNTest.GLVec3.$ctor1(S[i])),PC.model.rotation.y=6.28*Math.random(),PC.canShoot=!1,PC.defense=EP.defense*.75,PC.knockbackResistLevel=EP.knockbackResistLevel,PC.canRespawn=!1,PC.addBehavior(new BNTest.LifeSpan(PC,900)),PC.reward=!1,PC.model.alpha=0,this.entity.world.add(PC),i=i+1|0},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.SwordSwing",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:3,_shotDelay:0,_maxShotDelay:3,_angle:0,bulletSpeed:24,bulletGraphic:null,active:!1,speed:null,forcedAngle:0,minCoolDown:45,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this._ammo>0){if(this.active&&(this.entity.speed=this.speed.clone()),this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally())){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.entity.forcedAngle=this._angle;this.entity.frictionActive=!1;this.active||this.customEvent(D)}}else this.active&&(this.entity.forcedAngle=null,this.entity.frictionActive=!0,this.entity.speed=new BNTest.GLVec3.ctor,this.active=!1);BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,size,HSZ,lifespan;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(50);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;size=30;HSZ=new BNTest.GLVec3.ctor(size,size,size);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.setScale(BNTest.GLVec3.createUniform(2));lifespan=this._maxShotDelay*this._maxAmmo|0;this.entity.invincibilityFrames=this.entity.invincibilityFrames+lifespan|0;P.addBehavior(new BNTest.LifeSpan(P,lifespan));this.entity.world.add(P);this.active=!0;this.speed=P.speed.clone();this.entity.speed=this.speed.clone();P.setPosition(BNTest.GLVec3.op_Addition(P.getPosition(),BNTest.GLVec3.op_Multiply$1(this.speed,.5)))},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.TextSprite",{inherits:[BNTest.Sprite],_Text:null,textInvallidated:!1,imageInvallidated:!1,textImage:null,textGraphic:null,_TextColor:null,_FontWeight:"normal",_FontFamily:"sans-serif",_FontSize:10,_shadowBlur:0,_shadowOffset:null,_shadowColor:"#000000",alpha:1,config:{init:function(){this._shadowOffset=new BNTest.Vector2}},ctor:function(){this.$initialize();BNTest.Sprite.ctor.call(this);this.textImage=document.createElement("canvas");this.textGraphic=this.textImage.getContext("2d");this.textGraphic.fillStyle="#FFFFFF"},getText:function(){return this._Text},setText:function(value){Bridge.referenceEquals(this._Text,value)||(this._Text=value,this.textInvallidated=!0)},getTextColor:function(){return this._TextColor},setTextColor:function(value){Bridge.referenceEquals(this._TextColor,value)||(this._TextColor=value,this.textInvallidated=!0)},getFontWeight:function(){return this._FontWeight},setFontWeight:function(value){Bridge.referenceEquals(this._FontWeight,value)||(this._FontWeight=value,this.updateFont())},getFontFamily:function(){return this._FontFamily},setFontFamily:function(value){Bridge.referenceEquals(this._FontFamily,value)||(this._FontFamily=value,this.updateFont())},getFontSize:function(){return this._FontSize},setFontSize:function(value){this._FontSize!==value&&(this._FontSize=value,this.updateFont())},getShadowBlur:function(){return this._shadowBlur},setShadowBlur:function(value){this._shadowBlur!==value&&(this._shadowBlur=value,this.imageInvallidated=!0)},getShadowOffset:function(){return this._shadowOffset.clone()},setShadowOffset:function(value){BNTest.Vector2.op_Inequality(this._shadowOffset,value)&&value.x!==this._shadowOffset.x&&value.y!==this._shadowOffset.y&&(this._shadowOffset=value.clone(),this.imageInvallidated=!0)},getShadowColor:function(){return this._shadowColor},setShadowColor:function(value){Bridge.referenceEquals(this._shadowColor,value)||(this._shadowColor=value,this.imageInvallidated=!0)},updateFont:function(){this.textGraphic.font=System.String.concat(System.String.concat(System.String.concat(System.String.concat(this._FontWeight," "),this._FontSize),"px "),this._FontFamily);this.textInvallidated=!0;this.imageInvallidated=!0;this.textGraphic.fillStyle=this._TextColor},redrawBaseTextImage:function(){var TM,Y;this.updateFont();for(var lines=this._Text.split(String.fromCharCode(10)),H=this.getFontSize()*1,W=0,i=0;i<lines.length;)TM=this.textGraphic.measureText(lines[i]),W=Math.max(W,Bridge.Int.clip32(Math.ceil(TM.width))),i=i+1|0;for(this.textImage.height=Bridge.Int.clip32(H*(lines.length+.25)),this.textImage.width=W,this.updateFont(),Y=0,i=0;i<lines.length;)this.textGraphic.fillText(lines[i],0,this.getFontSize()+Y),Y+=H,i=i+1|0;this.textInvallidated=!1;this.imageInvallidated=!0},renderTextImage:function(){if(this._shadowBlur<=0)this.spriteBuffer.width=this.textImage.width,this.spriteBuffer.height=this.textImage.height;else{var S=Bridge.Int.clip32(Math.ceil(this._shadowBlur+this._shadowBlur));this.spriteBuffer.width=this.textImage.width+S|0;this.spriteBuffer.height=this.textImage.height+S|0}this.spriteGraphics.shadowBlur=0;this.spriteGraphics.globalCompositeOperation="source-over";this._shadowBlur<=0?this.spriteGraphics.drawImage(this.textImage,0,0):this.spriteGraphics.drawImage(this.textImage,this._shadowBlur,this._shadowBlur);this._shadowBlur>0&&(this.spriteGraphics.shadowBlur=this._shadowBlur,this.spriteGraphics.shadowColor=this._shadowColor,this.spriteGraphics.shadowOffsetX=this._shadowOffset.x,this.spriteGraphics.shadowOffsetY=this._shadowOffset.y,this.spriteGraphics.drawImage(this.spriteBuffer,0,0));this.imageInvallidated=!1},draw:function(g){if(this.textInvallidated&&this.redrawBaseTextImage(),this.imageInvallidated&&this.renderTextImage(),this.alpha>=1)BNTest.Sprite.prototype.draw.call(this,g);else{var A=g.globalAlpha;g.globalAlpha=this.alpha;BNTest.Sprite.prototype.draw.call(this,g);g.globalAlpha=A}}});Bridge.define("BNTest.Tree",{inherits:[BNTest.Entity],size:90,ctor:function(world){var smooth,VM,M;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.solid=!0;var brightness=.65,Char="tree",tmdl=BNTest.ModelCache.get_this().get(Char,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),this.model.copyFrom(tmdl)):(VM=BNTest.VoxelMap.generateTree(this.size,new BNTest.GLColor(brightness,brightness*.65,0),1),VM.addNoise(.03),VM.addStripes(.075,1,8),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,smooth),this.model.meshes.add(M),this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,3),tmdl==null&&BNTest.ModelCache.get_this().set$1(Char,this.model));this.model.rotation.y=360*Math.random();this.setScale(BNTest.GLVec3.op_Multiply$1(this.getScale(),.8+Math.random()*.4));this.getPosition().y=-(this.size*this.model.scale.x*.5)+10;this.cacheBoundingBox()},update:function(){BNTest.Entity.prototype.update.call(this);this.getPosition().y=-(this.size*this.model.scale.x*.5)+10},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.WanderAI",{inherits:[BNTest.EntityBehavior],chance:1,range:60,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},update:function(){var N;if(!(this.chance<1)||!(this.chance<Math.random())){if(N=this.entity.getBehavior(BNTest.NavigatorAI),N==null&&(N=new BNTest.NavigatorAI(this.entity),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),N.getMoveTo()==null){var maxrange=this.range,mr2=maxrange+maxrange,V=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(-maxrange+Math.random()*mr2,0,-maxrange+Math.random()*mr2),this.entity.getPosition());N.requestMoveTo(V,.4)}BNTest.EntityBehavior.prototype.update.call(this)}}});Bridge.define("BNTest.WideShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:50,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,spd,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(35);spd=new BNTest.Vector2(evt.SX,evt.SY);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd);M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P);for(var sep=spd.normalize(15),up=sep.rotate(-2.35619),down=sep.rotate(2.35619),number=2,scale=1;number>0;)P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(35),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd),M.rotation.y=evt.A,M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X+up.x*scale),P.sety(evt.Y+2),P.setz(evt.Z+up.y*scale),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(35),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd),M.rotation.y=evt.A,M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X+down.x*scale),P.sety(evt.Y+2),P.setz(evt.Z+down.y*scale),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),number=number-1|0,scale=scale+1|0},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.YinYangOrbGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:3.5,bulletLifeSpan:160,bulletGraphic:null,minCoolDown:100,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=-.7;D.SZ=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y-5;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var spd,P,M,sz,HSZ,sep,up;this.entity.playSound("pew");spd=new BNTest.Vector2(evt.SX,evt.SZ);P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(80);P.speed=new BNTest.GLVec3.ctor(evt.SX,evt.SY,evt.SZ);P.obstruction=!0;P.gravity=new BNTest.GLVec3.ctor(0,.12,0);P.rotationSpeed=new BNTest.GLVec3.ctor(0,3.5,0);P.ifriction=.98;P.bounces=!0;P.multiHit=!0;P.knockbackPower=6;M.rotation.y=evt.A;M.rotation.x=60;sz=11*P.getScale().x;HSZ=BNTest.GLVec3.createUniform(sz);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));sep=spd.normalize(22);up=sep.rotate(-1.57);P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),up));this.entity.world.add(P);P=P.clone();P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),BNTest.Vector2.op_Multiply(up,-1)));this.entity.world.add(P);P=P.clone();P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),BNTest.Vector2.op_Multiply(up,-1)));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.PlatformerEntity",{inherits:[BNTest.ControllableEntity],onGround:!1,friction:.05,floor:null,ceiling:null,lastGround:null,cantstep:!1,frictionActive:!0,stepheight:10,ctor:function(world){this.$initialize();BNTest.ControllableEntity.ctor.call(this,world)},applyFriction:function(){if(this.onGround){var rate=.8,min=.15;this.floor!=null&&(rate=1-this.floor.groundFriction*.2,min*=this.floor.groundFriction,this.lastGround=this.getPosition().clone());this.setHspeed(this.getHspeed()*rate);this.setZspeed(this.getZspeed()*rate);Math.abs(this.getHspeed())+Math.abs(this.getZspeed())<min&&this.setHspeed((this.setZspeed(0),0))}else this.setHspeed(this.getHspeed()*.98),this.setZspeed(this.getZspeed()*.98)},updateCollisions:function(){for(var Y=this.lastBB.min.y,Y2=this.lastBB.max.y,EB=BNTest.BoundingBox.op_Multiply$1(this.lastBB,1.5),STY=this.lastBB.getSize().y/2+3,L=this.game.world.findSolidCollision(EB,this),DB=BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(0,STY/2,0)),TB,ground=System.Array.init(0,null),i=0,E,TY,MB,B,P,PB,CL,stuck,S,BB,C;i<L.length;)E=L[i],TB=E.lastBB,TY=TB.min.y-STY,TY-Y2<=this.stepheight&&TB.intersection$2(DB)&&ground.push(E),i=i+1|0;ground.sort($_.BNTest.PlatformerEntity.f1);MB=BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(0,5,0));B=null;ground.length>0&&(B=ground[0].lastBB,this.floor=ground[0]);this.cantstep=!1;B==null?(this.onGround=!1,this.speed.y=Math.min(this.speed.y+.1,5),this.model.rotation.x=-16):this.speed.y>=0&&(this.onGround=!0,this.speed.y=Math.min(this.speed.y,0),this.model.rotation.x=0,Y=B.min.y-STY,Math.abs(this.gety()-Y)<=this.stepheight?(P=BNTest.GLVec3.op_Multiply$1(ground[0].speed,ground[0].groundFriction),this.model.offset.x+=P.x,this.model.offset.y+=P.y,this.model.offset.z+=P.z,this.sety(Y)):(B.intersection$2(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(this.speed.x,this.speed.y,0)))&&(this.speed.x=0),B.intersection$2(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(0,this.speed.y,this.speed.z)))&&(this.speed.z=0)));TB=this.lastBB.clone();PB=BNTest.BoundingBox.op_Addition(TB,this.speed);CL=PB.intersection(L);L.length>0&&CL.length>0?(stuck=0,TB.max.y-=this.stepheight*.75,S=new BNTest.GLVec3.ctor(this.speed.x,0,0),PB=BNTest.BoundingBox.op_Addition(TB,S),PB.intersection(L).length<=0?(this.model.offset.x+=this.speed.x,TB=BNTest.BoundingBox.op_Addition(TB,S),stuck=stuck+1|0):this.cantstep=!0,S=new BNTest.GLVec3.ctor(0,0,this.speed.z),PB=BNTest.BoundingBox.op_Addition(TB,S),PB.intersection(L).length<=0?(this.model.offset.z+=this.speed.z,TB=BNTest.BoundingBox.op_Addition(TB,S),stuck=stuck+1|0):this.cantstep=!0,S=new BNTest.GLVec3.ctor(0,this.speed.y,0),PB=BNTest.BoundingBox.op_Addition(TB,S),PB.intersection(L).length<=0&&(stuck=stuck+1|0),this.model.offset.y+=this.speed.y,stuck>1&&(BB=CL[0].lastBB,C=BNTest.GLVec3.op_Subtraction(this.lastBB.getCenter(),BB.getCenter()),C.getRoughLength()<100&&(C=BNTest.GLVec3.op_Multiply$1(C,.001),BB.intersection$2(BNTest.BoundingBox.op_Addition(this.lastBB,C))&&(C=BNTest.GLVec3.op_Addition(C,BNTest.GLVec3.op_Addition(BNTest.GLVec3.op_Addition(C,C),C))),this.getPosition().x+=C.x,this.getPosition().z+=C.z,this.lastBB=BNTest.BoundingBox.op_Addition(this.lastBB,C)))):(this.model.offset.x+=this.speed.x,this.model.offset.y+=this.speed.y,this.model.offset.z+=this.speed.z)},update:function(){this.updateBehaviors();this.frictionActive&&this.applyFriction();var ospd=this.speed;this.speed=new BNTest.GLVec3.ctor;BNTest.ControllableEntity.prototype.update.call(this);this.speed=ospd;this.updateCollisions()}});Bridge.ns("BNTest.PlatformerEntity",$_);Bridge.apply($_.BNTest.PlatformerEntity,{f1:function(TA,TTB){return Bridge.compare(TA.lastBB.min.y,TTB.lastBB.min.y)}});Bridge.define("BNTest.PlayerCharacter",{inherits:[BNTest.PlatformerEntity,BNTest.ICombatant],animation:"idle",me:null,char:"reimu",canShoot:!0,started:!1,zpos:0,maxAlpha:1,infiniteAmmo:!1,forcedAngle:null,canRespawn:!0,reward:!0,useSwingAnimation:!1,flickerColor:null,_HP:100,_PointsForKilling:10,pmesh:null,invincibilityFrames:0,maxInvincibilityFrames:150,defense:1,maxRespawnTime:0,respawnTime:0,respawnPosition:null,HB:null,ammo:0,maxAmmo:90,ammoRechargeRate:.7,ammoRechargeCooldown:0,ammoMaxRechargeCooldown:45,manaburnout:!1,shootTime:0,maxShootTime:8,restTime:0,knockbackResistLevel:1,config:{properties:{Coins:0},alias:["getHP","BNTest$ICombatant$getHP","setHP","BNTest$ICombatant$setHP","getPointsForKilling","BNTest$ICombatant$getPointsForKilling","getTargetPriority","BNTest$ICombatant$getTargetPriority","onDamaged","BNTest$ICombatant$onDamaged","onDeath","BNTest$ICombatant$onDeath","onKill","BNTest$ICombatant$onKill"]},ctor:function(world,me,character,team){var $t,smooth,csz,hsz,weaponGraphic,weapons,tmdl,secondaryWeaponGraphic,O,speedrate,minion,spd,T2,T,TimeToRespawn,T1,T3,TimeToRespawn1,TimeToRespawn2,T4,mod,T5,TimeToRespawn3,sr2,T21,T6,T7,effects;team===void 0&&(team=-1e3);this.$initialize();BNTest.PlatformerEntity.ctor.call(this,world);this.game=world.game;this.controller=System.Array.init(6,!1);this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.groundFriction=.7;this.me=me;csz=8;hsz=csz/2;this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz));this.setHitboxSize(hsz);this.char=character;weaponGraphic="object/amulet";this.team=team;this.team===-1e3&&(this.team=me.CPU?1:0);me.CPU?(!1&&Math.random()<.2&&(this.char="reisen"),this.maxInvincibilityFrames=0,this.canShoot=!1):this.infiniteAmmo=!0;weapons=new(System.Collections.Generic.Dictionary$2(String,String));weapons.set("sakuya","object/knife");weapons.set("cirno","object/ice");weapons.set("marisa","object/star");weapons.set("reisen","object/bullet");weapons.set("koishi",(weapons.set("satori","object/heart"),"object/heart"));weapons.set("aya",($t=(weapons.set("tenshi","object/wind"),"object/wind"),weapons.set("youmu",$t),$t));weapons.containsKey(this.char)&&(weaponGraphic=weapons.get(this.char));tmdl=BNTest.ModelCache.get_this().get(this.char,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',this.char),'" model from cache.')),this.model.copyFrom(tmdl),this.initCPU(),this.initModel()):BNTest.AnimationLoader.get_this().asyncGet$1(["head/base","head/rahmoo","head/rahmooacc","head/rahmoobow","head/hairclip","head/suikahorns","head/suikabow","head/ponytailbow","body/rahmoo","body/top","arm/base","arm/dSleeve","arm/bracelet","foot/base","foot/shoe","head/maidheadband","head/medium","body/apron","body/icewings","head/witchhat","arm/shortsleeve","head/hatbow","head/wideRim","head/mediumRim","head/cap","body/thirdeye","foot/anklet","foot/lanklet","foot/socks","head/tokin","body/shortskirt","body/tie","head/headband","head/sideribbon","object/katana","arm/sleeve","body/shortskirtfrill","body/sidependant","head/reisenears","body/bunnytail","body/rainbowmidfrill","head/peaches"],Bridge.fn.bind(this,function(){var $t1,$t2,$t3,$t4,off,body,M,arm,itm,mitem,foot,head,hat;if(tmdl=BNTest.ModelCache.get_this().get(this.char,!1),tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',this.char),'" model from cache.'));this.model.copyFrom(tmdl);this.initCPU();this.initModel();return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));var hd=["head/base","head/rahmoo","head/rahmooacc"],ht=["head/rahmoobow"],ar=["arm/base","arm/dSleeve"],ft=["foot/base","foot/socks","foot/shoe"],mult=3,bdy=["body/rahmoo"],item=[],pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Headpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Hatpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Bodypal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Footpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Armpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Itempal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));Bridge.referenceEquals(this.char,"sanae")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(0,1,.3)),hd=["head/base","head/rahmoo","head/rahmooacc"],ht=["head/hairclip"],bdy.push("body/top"));Bridge.referenceEquals(this.char,"suika")&&(this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,.7),pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.6,0,.8)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,.85,.35)),ar=["arm/base","arm/bracelet"],hd=["head/base","head/rahmoo","head/ponytailbow"],ht=["head/suikabow","head/suikahorns"],bdy.push("body/top"));Bridge.referenceEquals(this.char,"sakuya")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.5,0,.9)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.8,.8,.8)),hd=["head/base","head/medium"],ht=["head/maidheadband"],bdy.push("body/apron"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"cirno")&&(pal.set(new BNTest.GLColor(1,0,0),($t1=new BNTest.GLColor(.3,.6,1),Hatpal.set(new BNTest.GLColor(1,1,1),$t1),$t1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.1,.75,1)),hd=["head/base","head/medium"],ht=["head/rahmoobow"],bdy.push("body/icewings"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"marisa")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.1,.1,.1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,.85,.35)),hd=["head/base","head/rahmoo"],ht=["head/witchhat","head/hatbow","head/mediumRim"],bdy.push("body/apron"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"koishi")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,.7,.2)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,.7,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.35,1,.45)),hd=["head/base","head/rahmoo"],ht=["head/cap","head/hatbow","head/mediumRim"],Hatpal.set(new BNTest.GLColor(.698,0,1),($t2=new BNTest.GLColor(1,.85,.35),Hatpal.set(new BNTest.GLColor(1,1,1),$t2),$t2)),bdy.push("body/top","body/thirdeye"),pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,.9,.4)),pal.set(new BNTest.GLColor(1,.5,.5),($t3=new BNTest.GLColor(.8,0,.9),Footpal.set(new BNTest.GLColor(.5,.5,.5),$t3),$t3)),ar=["arm/base","arm/shortsleeve"],ft.push("foot/lanklet"));Bridge.referenceEquals(this.char,"aya")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,0)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,0,0)),pal.set(new BNTest.GLColor(.5,.25,0),BNTest.GLColor.createShade(.15)),hd=["head/base","head/medium"],ht=["head/tokin"],bdy=["body/shortskirt","body/shortskirtfrill","body/top","body/tie"],ar=["arm/base","arm/shortsleeve"],Hatpal.set(new BNTest.GLColor(0,0,0),new BNTest.GLColor(.85,0,0)));Bridge.referenceEquals(this.char,"youmu")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,.7,.2)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,1,1)),hd=["head/base","head/medium"],ht=["head/headband","head/sideribbon"],bdy=["body/shortskirt","body/shortskirtfrill","body/top","body/tie"],ar=["arm/base","arm/shortsleeve"],Hatpal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,0)),item=["object/katana"]);Bridge.referenceEquals(this.char,"reisen")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,.45,.45)),Bodypal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.9,.55,.85)),hd=["head/base","head/rahmoo"],ht=["head/reisenears"],bdy=["body/shortskirt","body/top","body/sidependant","body/tie","body/bunnytail"],ar=["arm/base","arm/sleeve"],Bodypal.set(new BNTest.GLColor(1,1,1),($t4=BNTest.GLColor.createShade(.15),Armpal.set(new BNTest.GLColor(1,1,1),$t4),$t4)));Bridge.referenceEquals(this.char,"tenshi")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.3,.3,.85)),Bodypal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,0,0)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.3,.3,.85)),Hatpal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor),hd=["head/base","head/rahmoo"],ht=["head/cap","head/mediumRim","head/peaches"],bdy=["body/rahmoo","body/top","body/tie","body/rainbowmidfrill"],ar=["arm/base","arm/shortsleeve"],item=["object/katana"],Itempal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,.4,.4)));this.team===1&&this.initCPU();off=this.model.offset;this.model.offset=off;world.add$1(this.model);this.model.Dir=1;this.model.Max=2.25;this.model.Spd=.075*mult;body=BNTest.VoxelMap.fromAnimationCombo(bdy);body.applyPalette(pal);body.applyPalette(Bodypal);M=new BNTest.Mesh(this.game);M.Dir=1;M.Max=2.25;M.Spd=.075*mult;M.addVoxelMap(body,smooth);this.model.meshes.add(M);arm=BNTest.VoxelMap.fromAnimationCombo(ar);arm.applyPalette(pal);arm.applyPalette(Armpal);M=new BNTest.Mesh(this.game);M.Dir=1;M.Spd=1.5*mult;M.addVoxelMap(arm,smooth);M.offset.x=1.5;M.offset.y=3;M.rotation.z=45;item.length>0&&(itm=BNTest.VoxelMap.fromAnimationCombo(item),itm.applyPalette(Itempal),mitem=new BNTest.Mesh(this.game),mitem.addVoxelMap(itm,smooth),mitem.rotation.x=-90,mitem.offset.x=-1,mitem.offset.y=3,mitem.offset.z=9,mitem.updateTranformation(),mitem.morphGeometry(mitem.transformation),M.combine(mitem));this.model.meshes.add(M);M=new BNTest.Mesh(this.game);M.Dir=-1;M.Spd=1.5*mult;M.addVoxelMap(arm,smooth);M.offset.x=-1.5;M.offset.y=3;M.rotation.z=-45;this.model.meshes.add(M);foot=BNTest.VoxelMap.fromAnimationCombo(ft);foot.applyPalette(pal);foot.applyPalette(Footpal);M=new BNTest.Mesh(this.game);M.Dir=-1;M.Spd=1.5*mult;M.addVoxelMap(foot,smooth);M.offset.x=1.5;M.offset.y=7;this.model.meshes.add(M);M=new BNTest.Mesh(this.game);M.Dir=1;M.Spd=1.5*mult;M.addVoxelMap(foot,smooth);M.offset.x=-1.5;M.offset.y=7;this.model.meshes.add(M);head=BNTest.VoxelMap.fromAnimationCombo(hd);head.applyPalette(pal);head.applyPalette(Headpal);hat=BNTest.VoxelMap.fromAnimationCombo(ht);hat.applyPalette(pal);hat.applyPalette(Hatpal);head.combine(hat);M=new BNTest.Mesh(this.game);M.Dir=1;M.Max=4.5;M.Spd=.15*mult;M.addVoxelMap(head,smooth);this.model.meshes.add(M);tmdl==null&&BNTest.ModelCache.get_this().set$1(this.char,this.model)}));this.addBehavior(new BNTest.PlatformerControls(this));secondaryWeaponGraphic="";Bridge.referenceEquals(this.char,"koishi")?(this.addBehavior(new BNTest.RingShot(this)),this.game.localplayer==null||Bridge.referenceEquals(this.game.localplayer.character,this)||this.game.localplayer.character==null||(this.maxAlpha=.05,this.zpos=1)):Bridge.referenceEquals(this.char,"youmu")?(this.addBehavior(new BNTest.BasicSword(this)),this.addBehavior(new BNTest.SwordSwing(this)),O=new BNTest.Orb(world,this),world.add(O)):Bridge.referenceEquals(this.char,"sakuya")?this.addBehavior(new BNTest.WideShot(this)):Bridge.referenceEquals(this.char,"tenshi")?this.addBehavior(new BNTest.BasicSword(this)):this.addBehavior(new BNTest.RapidFireGun(this));Bridge.referenceEquals(this.char,"reisen")&&this.addBehavior(new BNTest.SpawnIllusions(this));Bridge.referenceEquals(this.char,"reimu")&&(this.addBehavior(new BNTest.YinYangOrbGun(this)),secondaryWeaponGraphic="object/yinyangorb");speedrate=this.game.bulletSpeedRate;minion=me.minion;me.CPU&&minion&&(spd=.4,T2=this.getBehavior(BNTest.IWeaponBehavior),Bridge.referenceEquals(this.char,"aya")?(this.canShoot=!0,T=new BNTest.EnemyStrafer(this),T.framesPerTick=10,T.predict=!1,this.addBehavior(T),T2._maxAmmo=1,T2.bulletSpeed=2.5,T2.bulletLifeSpan=450,T2._maxShotDelay=40,TimeToRespawn=15,this.maxRespawnTime=60*TimeToRespawn|0,this.defense=1.4,spd=.75):Bridge.referenceEquals(this.char,"youmu")&&(this.canShoot=!0,T1=new BNTest.EnemyStrafer(this),T1.framesPerTick=10,T1.predict=!1,T1.attackType=6,this.addBehavior(T1),T1.attackrange=150,T3=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f1),T3.minCoolDown=120,TimeToRespawn1=18,this.maxRespawnTime=60*TimeToRespawn1|0,this.defense=3.4,spd=.6),Bridge.referenceEquals(this.char,"reisen")&&(TimeToRespawn2=6,T4=new BNTest.ProximityAttacker(this),T4.framesPerTick=20,this.defense=1.4,this.canShoot=!0,this.addBehavior(T4),this.maxRespawnTime=60*TimeToRespawn2|0,mod=5,T2.bulletSpeed/=mod,T2.bulletLifeSpan=T2.bulletLifeSpan*mod|0,T2.minCoolDown+=30,spd=.5,T2._maxAmmo=1),(Bridge.referenceEquals(this.char,"sanae")||Bridge.referenceEquals(this.char,"sakuya")||Bridge.referenceEquals(this.char,"cirno")||Bridge.referenceEquals(this.char,"marisa"))&&(this.canShoot=!0,T5=new BNTest.EnemyEngager(this),T5.framesPerTick=40,T5.predict=!1,this.addBehavior(T5),T2._maxAmmo=1,T2.bulletSpeed=3,T2.bulletLifeSpan=450,T2._maxShotDelay=30,Bridge.referenceEquals(this.char,"sanae"),TimeToRespawn3=6,Bridge.referenceEquals(this.char,"sakuya")&&(T2.bulletSpeed=2.5,T2.bulletLifeSpan=600,T2._maxShotDelay=100,T5.predict=!0,T5.framesPerTick=20,TimeToRespawn3=13,this.defense=1.4),Bridge.referenceEquals(this.char,"cirno")&&(T2.bulletLifeSpan=30,T2._maxShotDelay=12,spd*=1.5,T5.framesPerTick=15,this.defense=2,T5.passive=!0,TimeToRespawn3=3),this.maxRespawnTime=60*TimeToRespawn3|0),T2!=null&&(T2._maxShotDelay=Bridge.Int.clip32(Bridge.Math.round(T2._maxShotDelay/speedrate,0,6)),T2.bulletSpeed*=speedrate,T2.bulletLifeSpan=Bridge.Int.clip32(T2.bulletLifeSpan/speedrate),sr2=Math.pow(speedrate,1.5),this.maxAmmo*=sr2,this.ammoRechargeRate*=sr2),this.getBehavior(BNTest.PlatformerControls).maxSpeed*=spd*speedrate);me.CPU&&!minion&&(T21=this.getBehavior(BNTest.IWeaponBehavior),Bridge.referenceEquals(this.char,"tenshi")?(T7=new BNTest.EnemyEngager(this),T7.framesPerTick=20,this.addBehavior(T7)):(T6=new BNTest.ProximityAttacker(this),T6.framesPerTick=20,T6.predict=!0,Bridge.referenceEquals(this.char,"koishi")?T6.aggroRange=100:(this.maxAmmo=1,this.ammoRechargeRate=.00333333341),this.addBehavior(T6)),this.canShoot=!0,this.maxRespawnTime=999999999,T21!=null&&(T21._maxShotDelay=Bridge.Int.clip32(Bridge.Math.round(T21._maxShotDelay/speedrate,0,6)),T21.bulletSpeed*=this.game.bulletSpeedRate,T21.bulletLifeSpan=Bridge.Int.clip32(T21.bulletLifeSpan/this.game.bulletSpeedRate)));me.CPU&&Bridge.referenceEquals(this.char,"reisen")&&this.addBehavior(new BNTest.SecondaryResponder(this));this.pmesh==null&&(effects=[],effects.push(weaponGraphic),Bridge.referenceEquals(secondaryWeaponGraphic,"")||effects.push(secondaryWeaponGraphic),BNTest.AnimationLoader.get_this().asyncGet$1(effects,Bridge.fn.bind(this,function(){var pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),TPM,VM,weapon,weapon2,w2msh;me.CPU&&pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,1));TPM=BNTest.ModelCache.get_this().get(System.String.concat("W1:",weaponGraphic));TPM!=null?this.pmesh=TPM.meshes.getItem(0):(this.pmesh=new BNTest.Mesh(this.game),VM=BNTest.VoxelMap.fromImages$1(weaponGraphic),VM.swapYZ(),this.pmesh.addVoxelMap(VM),BNTest.ModelCache.get_this().set(System.String.concat("W1:",weaponGraphic),this.pmesh));this.pmesh.applyPalette(pal);weapon=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f2);weapon2=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f3);weapon.bulletGraphic=this.pmesh;weapon2==null||Bridge.referenceEquals(secondaryWeaponGraphic,"")?weapon2!=null&&(weapon2.bulletGraphic=this.pmesh):(w2msh=null,TPM=BNTest.ModelCache.get_this().get(System.String.concat("W2:",secondaryWeaponGraphic)),TPM!=null?w2msh=TPM.meshes.getItem(0):(w2msh=new BNTest.Mesh(this.game),VM=BNTest.VoxelMap.fromImages$1(secondaryWeaponGraphic),VM.swapYZ(),w2msh.addVoxelMap(VM),BNTest.ModelCache.get_this().set(System.String.concat("W2:",secondaryWeaponGraphic),w2msh)),w2msh.applyPalette(pal),weapon2.bulletGraphic=w2msh)})));me.CPU&&Bridge.referenceEquals(this.char,this.game.localplayer.character.char)&&(this.model.color=new BNTest.GLColor(.25,.25,.25))},getHP:function(){return this._HP},setHP:function(value){this._HP=value},getPointsForKilling:function(){return this._PointsForKilling},getTargetPriority:function(){return 10},getHitboxSize:function(){return this.HB.getSize().x},setHitboxSize:function(value){this.HB=new BNTest.BoundingBox.$ctor2(value);this.getHitbox()},getHitbox:function(){return this.HB.setPosition(this.model.offset),this.HB},initModel:function(){var mult=3.5,i=0,M;this.model.Dir=1;this.model.Max=2.25;this.model.Spd=.075*mult;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Max=2.25;M.Spd=.075*mult;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Spd=1.5*mult;M.offset.x=1.5;M.offset.y=3;M.rotation=new BNTest.GLVec3.ctor;M.rotation.z=45;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=-1;M.Spd=1.5*mult;M.offset.x=-1.5;M.offset.y=3;M.rotation=new BNTest.GLVec3.ctor;M.rotation.z=-45;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=-1;M.Spd=1.5*mult;M.offset.x=1.5;M.offset.y=7;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Spd=1.5*mult;M.offset.x=-1.5;M.offset.y=7;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Max=4.5;M.Spd=.15*mult;M.rotation=new BNTest.GLVec3.ctor},initCPU:function(){var T=new BNTest.NavigatorAI(this),NS;T.framesPerTick=0;this.addBehavior(T);T=new BNTest.WanderAI(this);T.framesPerTick=25;Bridge.cast(T,BNTest.WanderAI).range=20;this.addBehavior(T);T=new BNTest.EntityFollower(this,System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.PlayerCharacter).toArray()[0]);T.framesPerTick=10;T=new BNTest.AimedWandering(this);Bridge.cast(T,BNTest.AimedWandering).target=System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.DonationBox).toArray()[0];T.framesPerTick=50;this.addBehavior(T);NS=new BNTest.NetworkSync(this);this.me.CPU&&(NS.framesPerTick=45);NS.forcesFlush=!0;NS.updateOnSync=!0;this.addBehavior(NS)},updateShoot:function(){var weapon=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f2),weapon2=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f3),ang=this.model.rotation.y,resting,rate;weapon.BNTest$IWeaponBehavior$setFiringAngle(ang);this.shootTime-=1;this.shootTime<=0?(resting=!0,this.controller[5]&&!this.manaburnout&&(resting=!1,this.restTime=0,weapon!=null&&(this.shootTime+=weapon.BNTest$IWeaponBehavior$getMaxCooldown(),weapon.BNTest$IWeaponBehavior$fire(ang),this.ammo-=weapon.BNTest$IWeaponBehavior$getEnergyCost()),this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown),this.model.alpha=1),this.controller[6]&&!this.manaburnout&&(resting=!1,this.restTime=0,weapon2!=null&&(this.shootTime+=weapon2.BNTest$IWeaponBehavior$getMaxCooldown(),weapon2.BNTest$IWeaponBehavior$fire(ang),this.ammo-=weapon2.BNTest$IWeaponBehavior$getEnergyCost()),this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown),this.model.alpha=1),resting&&(this.shootTime=0,this.restTime=this.restTime+1|0)):this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown);this.ammoRechargeCooldown-=1;this.ammoRechargeCooldown<=0&&(rate=this.ammoRechargeRate,this.manaburnout,this.ammo=Math.min(this.ammo+rate,this.maxAmmo))},update:function(){var Dist,H;if(this.respawnPosition==null&&(this.respawnPosition=this.getPosition().clone()),this.respawnTime>0){this.model.setVisible(!1);this.lastBB=new BNTest.BoundingBox.ctor;this.respawnTime=this.respawnTime-1|0;this.me.CPU||(this.setPosition(BNTest.GLVec3.lerp(this.getPosition(),this.respawnPosition,.015)),Dist=BNTest.GLVec3.op_Subtraction(this.respawnPosition,this.getPosition()),this.respawnTime<=0||Dist.getLength()<=.5?this.setPosition(this.respawnPosition.clone()):this.setPosition(BNTest.GLVec3.op_Addition(this.getPosition(),Dist.normalize(.5))));return}BNTest.PlatformerEntity.prototype.update.call(this);this.canShoot&&this.pmesh!=null&&(this.updateShoot(),this.infiniteAmmo||(this.ammo<0?(this.ammo=0,this.manaburnout=!0,this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown)):this.ammo>=this.maxAmmo&&(this.manaburnout=!1)));this.onGround||(this.gety()>200||this.gety()<-500&&this.speed.y<0)&&(this.setx(0),this.sety(-120),this.setz(0),this.speed=new BNTest.GLVec3.ctor,this.model.rotation.x=0,this.me.CPU&&(H=this.getHP(),this.game.setNPC(this),this.setHP(H)));this.model.inView&&this.animate()},animate:function(){var meshcount,swing;(this.model.color=this.flickerColor!=null&&(this.game.frame&2)>0?this.flickerColor:new BNTest.GLColor(1,1,1),meshcount=this.model.meshes.getCount(),meshcount<5)||(this.zpos>0&&this.world.bringToFront(this.model),this.zpos<0&&this.world.sendToBack(this.model),this.invincibilityFrames>0?(this.model.setVisible(!this.model.getVisible()),this.invincibilityFrames=this.invincibilityFrames-1|0):(this.model.setVisible(!0),this.model.alpha>this.maxAlpha?this.model.alpha=Math.max(this.maxAlpha,this.model.alpha-.007):this.model.alpha<this.maxAlpha&&(this.model.alpha=Math.min(this.maxAlpha,this.model.alpha+.01))),this.onGround&&!this.me.CPU&&(this.model.rotation.y=BNTest.MathHelper.radiansToDegrees(this.game.mouseAngle)-90),swing=!1,this.useSwingAnimation&&this.controller[5]&&!this.manaburnout?(Bridge.referenceEquals(this.animation,"attackswing")||(this.model.meshes.getItem(1).rotation.x=0),this.animation="attackswing",swing=!0):Bridge.referenceEquals(this.animation,"attackswing")&&this.initModel(),this.speed.y===0&&Bridge.referenceEquals(this.animation,"attackswing")&&(this.rotateTest(this.model.meshes.getItem(1),"y",3,1.25),this.rotateTest(this.model.meshes.getItem(1),"x",1.2,1.25)),this.speed.y===0&&(this.speed.x!==0||this.speed.z!==0)?(Bridge.referenceEquals(this.animation,"jump")&&(this.model.meshes.getItem(3).offset.z=0,this.model.meshes.getItem(4).offset.z=0,this.model.meshes.getItem(3).rotation.x=0,this.model.meshes.getItem(4).rotation.x=0),swing||(this.animation="walk"),this.me.CPU,this.rotateTest(this.model.meshes.getItem(0)),Bridge.referenceEquals(this.animation,"attackswing")||(this.rotateTest(this.model.meshes.getItem(1)),this.rotateTest(this.model.meshes.getItem(2))),this.rotateTest(this.model.meshes.getItem(3)),this.rotateTest(this.model.meshes.getItem(4)),this.model.meshes.getItem(3).offset.z=-(this.model.meshes.getItem(3).rotation.x*.025),this.model.meshes.getItem(4).offset.z=-(this.model.meshes.getItem(4).rotation.x*.025),this.rotateTest(this.model.meshes.getItem(5),"y")):this.onGround?(this.animation="idle",this.model.meshes.getItem(3).rotation.x=0,this.model.meshes.getItem(4).rotation.x=0,this.model.meshes.getItem(3).offset.z=0,this.model.meshes.getItem(4).offset.z=0):(this.animation="jump",this.model.meshes.getItem(3).rotation.x=25,this.model.meshes.getItem(4).rotation.x=25,this.model.meshes.getItem(3).offset.z=1.5,this.model.meshes.getItem(4).offset.z=1.5),System.Nullable.hasValue(this.forcedAngle)&&(this.model.rotation.y=System.Nullable.getValue(this.forcedAngle)))},onDamaged:function(source,amount){var i,D,src;if(!(this.invincibilityFrames>0)&&!(this.respawnTime>0)){for(this.model.alpha=1,i=0;i<this._behaviors.getCount();){if(D=this._behaviors.getItem(i),D.onAttacked)D.onAttacked(source);i=i+1|0}if(src=source,this.setHP(this.getHP()-amount/this.defense),!this.me.CPU){this.dropCoins(5+(5*(Bridge.Int.div(this.game.wave,2)|0)|0)|0,5,1);this.invincibilityFrames=this.maxInvincibilityFrames;src.multiHit||(src.alive=!1);return}this.speed=BNTest.GLVec3.op_Addition(this.speed,BNTest.GLVec3.op_Division$1(BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply$1(src.speed,.8),src.knockbackPower),this.knockbackResistLevel));src.multiHit||(src.alive=!1);this.speed.y-=2/this.knockbackResistLevel;this.invincibilityFrames=this.maxInvincibilityFrames}},dropCoins:function(MaxValue,number,permaloss,lifespan){var i,c,m,m2,Value;for(permaloss===void 0&&(permaloss=0),lifespan===void 0&&(lifespan=900),i=number;i>0;){if(c=new BNTest.Coin(this.world,lifespan),c.setPosition(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,-20,0))),c.solid=!1,m=3,m2=m+m|0,c.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),c.speed.y=-1+(-m|0)*Math.random(),c.pickupDelay=90,Value=10,this.getCoins()>MaxValue?Value=MaxValue:(Value=Bridge.Int.div(MaxValue,10)|0,Value<1&&(Value=1)),(this.getCoins()-c.value|0)<=0)return;c.setValue(Value);i>permaloss&&this.world.add(c);this.setCoins(this.getCoins()-c.value|0);i=i-1|0}},onDeath:function(){var N,c,csz,hsz,csz1,hsz1;this.me!=null&&(this.me.lives=this.me.lives-1|0);this.visible=!1;this.me.CPU||(this.dropCoins(Bridge.Int.clip32(this.getCoins()*.2),3,1,1500),this.dropCoins(20*this.game.wave|0,1,0,1500),this.respawnTime=120,this.setHP(100));N=new(System.Collections.Generic.Dictionary$2(String,System.Int32));N.set("sakuya",40);N.set("sanae",30);N.set("cirno",20);N.set("aya",80);N.set("youmu",50);N.set("reisen",60);c=new BNTest.Coin(this.world);this.me.minion?this.model.scale.x>1?c.setValue(200):N.containsKey(this.char)?c.setValue(N.get(this.char)):c.setValue(10):c.setValue((100*this.game.wave|0)+500|0);c.solid=!1;c.setPosition(this.getPosition().clone());c.speed=BNTest.GLVec3.op_Multiply$1(this.speed,.35);this.reward&&this.world.add(c);this.me.CPU&&(this.respawnTime=this.maxRespawnTime,this.alive=!0,this.game.setNPC(this),this.controller[4]=!1,this.controller[5]=!1,Bridge.referenceEquals(this.char,"suika")&&(Math.random()<.1?(this.model.scale=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.getOne(),5),csz=10*this.model.scale.x,hsz=csz/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz)),this.setHitboxSize(hsz),this.stepheight=5*this.model.scale.x,this.defense=6,this.knockbackResistLevel=3):(this.model.scale=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.getOne(),.8),csz1=8,hsz1=csz1/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz1,-csz1,-hsz1),new BNTest.GLVec3.ctor(hsz1,csz1,hsz1)),this.setHitboxSize(hsz1),this.stepheight=5,this.defense=1,this.knockbackResistLevel=1)));this.canRespawn||(this.alive=!1)},onKill:function(){}});Bridge.ns("BNTest.PlayerCharacter",$_);Bridge.apply($_.BNTest.PlayerCharacter,{f1:function(W){return W.BNTest$IWeaponBehavior$getWeaponType()===2},f2:function(WB){return WB.BNTest$IWeaponBehavior$getWeaponType()===1},f3:function(WB){return WB.BNTest$IWeaponBehavior$getWeaponType()===2}})});