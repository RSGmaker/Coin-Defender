Bridge.assembly("CoinDefender",function(){"use strict";Bridge.define("BNTest.GameMode",{statics:{teamBattle:null,deathMatch:null,gameModes:null,config:{init:function(){Bridge.ready(this.init)}},getGameModesOfType:function(type){return new(System.Collections.Generic.List$1(BNTest.GameMode))(System.Linq.Enumerable.from(BNTest.GameMode.gameModes).where(function(G){return G.getModeType()===type}))},getGameModeByName:function(name){var ret=new(System.Collections.Generic.List$1(BNTest.GameMode))(System.Linq.Enumerable.from(BNTest.GameMode.gameModes).where(function(G){return Bridge.referenceEquals(G.getName(),name)}));return ret.getCount()>0?ret.getItem(0):null},init:function(){BNTest.GameMode.teamBattle==null&&(BNTest.GameMode.gameModes=new(System.Collections.Generic.List$1(BNTest.GameMode)),BNTest.GameMode.teamBattle=new BNTest.GameMode("Team Battle"),BNTest.GameMode.teamBattle.setDescription("2 teams battle with limited lives\nuntil only 1 team remains."),BNTest.GameMode.deathMatch=new BNTest.GameMode("Death Match"),BNTest.GameMode.deathMatch.setDescription("A free for all match with\nlimited lives."),BNTest.GameMode.deathMatch.setTeams(!1))}},$entryPoint:!0,config:{properties:{Teams:!1,StartingLives:0,Survival:!1,AllowOnlinePlay:!1,AllowCharacterSelect:!1,NumberOfPlayers:0,RespawnTime:0,Name:null,ModeType:0,unlocked:!1,Description:null}},ctor:function(name){this.$initialize();this.setTeams(!0);this.setStartingLives(3);this.setSurvival(!0);this.setAllowOnlinePlay(!0);this.setAllowCharacterSelect(!0);this.setNumberOfPlayers(6);this.setRespawnTime(390);this.setName(name);this.setModeType(BNTest.GameMode.ModeTypes.Skirmish);this.setDescription(System.String.concat("Missing description for ",name));this.setunlocked(!0);BNTest.GameMode.gameModes.add(this)}});Bridge.define("BNTest.EntityBehavior",{enabled:!0,framesPerTick:0,entity:null,config:{properties:{BehaviorName:null,FullName:null}},ctor:function(entity){if(this.$initialize(),this.entity=entity,this.setFullName(Bridge.Reflection.getTypeFullName(Bridge.getType(this))),Bridge.referenceEquals(this.getBehaviorName(),"")||this.getBehaviorName()==null){var s=this.getFullName().split(".");this.setBehaviorName(s[s.length-1|0])}},update:function(){},draw:function(){},sendCustomEvent:function(evt,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.I=this.entity.ID;D.D=evt;D.T=this.getBehaviorName();this.entity.game.sendEvent("CBE",D,triggerflush)},customEvent:function(){}});Bridge.define("BNTest.AnimationLoader",{statics:{directory:"",_throttleRequests:!1,spritesheetdata:'[{"name":"Sakuya_Blink0","x":1122,"y":645,"width":96,"height":128},{"name":"Sakuya_Idle0","x":1122,"y":516,"width":96,"height":128},{"name":"Sakuya_Jump0","x":388,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk0","x":194,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk1","x":97,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk2","x":0,"y":1048,"width":96,"height":128},{"name":"Sakuya_Walk3","x":1025,"y":903,"width":96,"height":128},{"name":"SakuyaArm0","x":1122,"y":1065,"width":16,"height":81},{"name":"Sakuyabullet0","x":1067,"y":1146,"width":40,"height":20},{"name":"Starbullet0","x":945,"y":855,"width":32,"height":32},{"name":"Tile0","x":1122,"y":872,"width":48,"height":48},{"name":"Tile1","x":1067,"y":1048,"width":48,"height":48},{"name":"Tile2","x":1122,"y":774,"width":48,"height":48},{"name":"Tile3","x":1122,"y":823,"width":48,"height":48},{"name":"Tile4","x":970,"y":919,"width":48,"height":48},{"name":"Tile5","x":970,"y":968,"width":48,"height":48},{"name":"Tile6","x":1067,"y":1097,"width":48,"height":48},{"name":"Tombstone0","x":940,"y":790,"width":48,"height":64},{"name":"Yinyangorb0","x":875,"y":790,"width":64,"height":64},{"name":"Cirno_Blink0","x":873,"y":919,"width":96,"height":128},{"name":"Cirno_Idle0","x":1025,"y":0,"width":96,"height":128},{"name":"Cirno_Jump0","x":1025,"y":129,"width":96,"height":128},{"name":"Cirno_Walk0","x":1025,"y":258,"width":96,"height":128},{"name":"Cirno_Walk1","x":1025,"y":387,"width":96,"height":128},{"name":"Cirno_Walk2","x":1025,"y":516,"width":96,"height":128},{"name":"Cirno_Walk3","x":1025,"y":645,"width":96,"height":128},{"name":"CirnoArm0","x":1122,"y":921,"width":16,"height":61},{"name":"Flame0","x":516,"y":790,"width":128,"height":128},{"name":"Flame1","x":387,"y":790,"width":128,"height":128},{"name":"Flame2","x":258,"y":790,"width":128,"height":128},{"name":"Flame3","x":129,"y":790,"width":128,"height":128},{"name":"Flame4","x":645,"y":790,"width":128,"height":128},{"name":"Flame5","x":0,"y":790,"width":128,"height":128},{"name":"LFairy2","x":875,"y":855,"width":36,"height":34},{"name":"Light0","x":774,"y":790,"width":100,"height":100},{"name":"Lightorbbullet","x":912,"y":855,"width":32,"height":32},{"name":"Marisa_Blink0","x":776,"y":1048,"width":96,"height":128},{"name":"Marisa_Idle0","x":873,"y":1048,"width":96,"height":128},{"name":"Marisa_Jump0","x":970,"y":1048,"width":96,"height":128},{"name":"Marisa_Walk0","x":1122,"y":0,"width":96,"height":128},{"name":"Marisa_Walk1","x":1122,"y":129,"width":96,"height":128},{"name":"Marisa_Walk2","x":1122,"y":258,"width":96,"height":128},{"name":"Marisa_Walk3","x":582,"y":1048,"width":96,"height":128},{"name":"MarisaArm0","x":1006,"y":790,"width":16,"height":61},{"name":"Marisabullet0","x":0,"y":769,"width":200,"height":20},{"name":"Reimu_Blink0","x":679,"y":919,"width":96,"height":128},{"name":"Reimu_Idle0","x":582,"y":919,"width":96,"height":128},{"name":"Reimu_Jump0","x":485,"y":919,"width":96,"height":128},{"name":"Reimu_Walk0","x":388,"y":919,"width":96,"height":128},{"name":"Reimu_Walk1","x":291,"y":919,"width":96,"height":128},{"name":"Reimu_Walk2","x":194,"y":919,"width":96,"height":128},{"name":"Reimu_Walk3","x":97,"y":919,"width":96,"height":128},{"name":"ReimuArm0","x":1122,"y":983,"width":16,"height":81},{"name":"Reisen_Blink0","x":0,"y":919,"width":96,"height":128},{"name":"Reisen_Idle0","x":1122,"y":387,"width":96,"height":128},{"name":"Reisen_Jump0","x":776,"y":919,"width":96,"height":128},{"name":"Reisen_Walk0","x":679,"y":1048,"width":96,"height":128},{"name":"Reisen_Walk1","x":485,"y":1048,"width":96,"height":128},{"name":"Reisen_Walk2","x":1025,"y":774,"width":96,"height":128},{"name":"Reisen_Walk3","x":291,"y":1048,"width":96,"height":128},{"name":"ReisenArm0","x":989,"y":790,"width":16,"height":61},{"name":"Reisenbullet0","x":970,"y":1017,"width":32,"height":20},{"name":"BG0","x":0,"y":0,"width":1024,"height":768}]',__this:null,get_this:function(){return BNTest.AnimationLoader.__this==null&&(BNTest.AnimationLoader.__this=new BNTest.AnimationLoader),BNTest.AnimationLoader.__this},init:function(){BNTest.AnimationLoader.__this==null&&(BNTest.AnimationLoader.__this=new BNTest.AnimationLoader)},getPixels:function(image){var tmp=document.createElement("canvas"),g;return tmp.width=image.width,tmp.height=image.height,g=BNTest.Helper.getContext(tmp),g.drawImage(image,0,0),g.getImageData(0,0,tmp.width,tmp.height).data},flipImage:function(I){var outer=document.createElement("canvas"),C=document.createElement("canvas"),g=C.getContext("2d"),ID,ret;return g.scale(-1,1),g.drawImage(I,I.width,0),g=outer.getContext("2d"),g.drawImage(C,0,0),ID=g.getImageData(0,0,I.width,I.height),ret=new Image,ret.src=g.canvas.toDataURL(),ret},preLoad:function(paths){BNTest.HelperExtensions.forEach(String,paths,$_.BNTest.AnimationLoader.f1)},get:function(path){return BNTest.AnimationLoader.__this.getAnimation(path)}},zip:null,zipPath:"",baseZipPath:"",jzip:null,_data:null,_callbacks:null,_loading:null,spritesheet:null,spritesheetimage:null,queued:null,ready:!1,ctor:function(){this.$initialize();this._data=new(System.Collections.Generic.Dictionary$2(String,System.Collections.Generic.List$1(HTMLImageElement)));this._loading=new(System.Collections.Generic.List$1(String));this.queued=new(System.Collections.Generic.List$1(String));this._callbacks=new(System.Collections.Generic.Dictionary$2(String,System.Collections.Generic.List$1(Function)));return},queueEmpty:function(){return this._loading.getCount()===0},queueSize:function(){return this._loading.getCount()},onReady:function(){this.ready=!0;BNTest.HelperExtensions.forEach(String,this.queued.toArray(),Bridge.fn.bind(this,$_.BNTest.AnimationLoader.f2))},downloadFile:function(path,responseType){responseType===void 0&&(responseType=2);var X=new XMLHttpRequest;return(X.responseType=responseType,X.open("GET",path,!1),X.status===200||X.status===304)?X:null},_LoadAnimation:function(list,path,img){var I,self,index,file;if(img===void 0&&(img=null),img!=null)if(img.width>0)list.add(img);else return;I=new Image;self=BNTest.AnimationLoader.get_this();I.onload=function(){self._LoadAnimation(list,path,I)};I.onerror=function(){self._Finish(path)};index=list.getCount();file=System.String.concat(System.String.concat(System.String.concat(path,"_"),index),".png");console.log(System.String.concat("Now loading:",file));I.src=file},isLoading:function(path){return path=System.String.concat(BNTest.AnimationLoader.directory,path),this._loading.contains(path)},isIdle:function(){return this._loading.getCount()<=0&&this.queued.getCount()<=0},_Finish:function(path){var self=BNTest.AnimationLoader.get_this(),L=self._loading,A;L.contains(path)?(this._data.get(path).getCount()>0?console.log(System.String.concat("finish:",path)):console.log(System.String.concat("Could not load:",path)),L.remove(path)):console.log(System.String.concat("Could not load:",path));BNTest.AnimationLoader._throttleRequests&&L.getCount()>0&&(console.log(System.String.concat("Now resuming:",L.getItem(0))),Bridge.global.setTimeout(function(){self._LoadAnimation(self._data.get(L.getItem(0)),L.getItem(0))}));self._callbacks.containsKey(path)&&(A=self._callbacks.get(path),A!=null&&BNTest.HelperExtensions.forEach(Function,A,function(C){C(path)}))},asyncGet:function(path,callback,callImmediatelyIfAvailable){var R,P,L;return(callImmediatelyIfAvailable===void 0&&(callImmediatelyIfAvailable=!1),R=BNTest.AnimationLoader.get(path),P=System.String.concat(BNTest.AnimationLoader.directory,path),R==null||R.getCount()<=0)?(this._callbacks.containsKey(P)?L=this._callbacks.get(P):(L=new(System.Collections.Generic.List$1(Function)),this._callbacks.set(P,L)),L.add(callback),!0):(callImmediatelyIfAvailable&&callback(P),!1)},asyncGet$1:function(paths,callback){for(var total=paths.length,i=0;i<paths.length;)(function(){this.asyncGet(paths[i],function(){total=total-1|0;total===0&&callback()},!0);i=i+1|0}).call(this);return total>0},_GetAnimation:function(L,path){var flip=!1,loc=path,self;path.lastIndexOf(String.fromCharCode(70))===(path.length-1|0)&&(flip=!0,loc=System.String.remove(loc,path.length-1|0));!BNTest.AnimationLoader._throttleRequests||this._loading.getCount()<=0?(console.log(System.String.concat("Starting:",loc)),self=BNTest.AnimationLoader.get_this(),Bridge.global.setTimeout(function(){self._LoadAnimation(L,loc)})):BNTest.AnimationLoader._throttleRequests&&console.log(System.String.concat("adding to queue:",loc));this._loading.add(path)},_GetAnimationFromSpriteSheet:function(path){var frame,p,rect;if(!this.ready){this.queued.contains(path)||this.queued.add(path);return}console.log(System.String.concat("loading from spritesheet:",path));for(var L=this._data.get(path),frames=this.spritesheet,i=0,tmp=document.createElement("canvas"),g=BNTest.Helper.getContext(tmp);i<frames.length;)frame=frames[i],p=System.String.concat(BNTest.AnimationLoader.directory,frame.name),System.String.startsWith(p,path)&&(rect=frame,tmp.width=rect.width,tmp.height=rect.height,g.drawImage(this.spritesheetimage,-rect.x,-rect.y),L.add(tmp),console.log(System.String.concat("added from spritesheet:",p)),tmp=document.createElement("canvas"),g=BNTest.Helper.getContext(tmp)),i=i+1|0;console.log(System.String.concat("finished loading from spritesheet:",path));this.queued.contains(path)&&this.queued.remove(path)},loadAnimationFromJZip:function(path){var ret=new(System.Collections.Generic.List$1(HTMLImageElement)),Z=this.jzip,self,P;try{self=this;P=path;System.String.indexOf(P,this.baseZipPath)===0&&(P=P.substr(this.baseZipPath.length+1|0));var s="",SA=null,A=function(img){img==null?(self._Finish(path),console.log(System.String.concat(System.String.concat("finished ",path)," out of zip!"))):(ret.add(img),s=System.String.concat(System.String.concat(System.String.concat(P,"_"),ret.getCount()),".png"),console.log(System.String.concat(System.String.concat('loading "',s),'" from zip')),JSZipHelper.loadImage(Z,s,SA))};SA=A;s=System.String.concat(System.String.concat(System.String.concat(P,"_"),ret.getCount()),".png");console.log(System.String.concat(System.String.concat('loading "',s),'" from zip'));JSZipHelper.loadImage(Z,s,SA)}catch($e1){$e1=System.Exception.create($e1)}return console.log(System.String.concat(System.String.concat('attempting to load "',path),'" from zip file.')),ret},loadAnimationFromZip:function(path){var ret=new(System.Collections.Generic.List$1(HTMLImageElement)),P,f,i;try{for(P=path,System.String.indexOf(P,this.baseZipPath)===0&&(P=P.substr(this.baseZipPath.length+1|0)),f=System.String.concat(System.String.concat(this.zipPath,"://"),P),i=0;;){var ipath=System.String.concat(System.String.concat(System.String.concat(f,"_"),i),".png"),img=this.zip.loadImage(ipath),N=new Image;N.src=img;ret.add(N);i=i+1|0}}catch($e1){$e1=System.Exception.create($e1)}return ret.getCount()>0?(console.log(System.String.concat(System.String.concat('Loaded animation "',path),'" from zip file.')),ret):null},setZip:function(zipPath){this.zipPath=zipPath;this.baseZipPath=System.String.replaceAll(zipPath,".zip","");this.jzip==null&&(this.zip=new ZipLoader(zipPath))},getAnimation:function(path){var R,R1,L;if(path=System.String.concat(BNTest.AnimationLoader.directory,path),this._data.containsKey(path))return this._data.get(path);if(this.jzip!=null){if(R=this.loadAnimationFromJZip(path),R!=null)return this._data.set(path,R),R}else if(this.zip!=null&&(R1=this.loadAnimationFromZip(path),R1!=null))return this._data.set(path,R1),R1;return L=new(System.Collections.Generic.List$1(HTMLImageElement)),this._data.set(path,L),this._GetAnimation(L,path),L}});var $_={};Bridge.ns("BNTest.AnimationLoader",$_);Bridge.apply($_.BNTest.AnimationLoader,{f1:function(path){BNTest.AnimationLoader.__this.getAnimation(path)},f2:function(Q){this._GetAnimationFromSpriteSheet(Q)}});Bridge.define("BNTest.App",{statics:{div:null,canvas:null,guiCanvas:null,gui:null,targetAspect:0,screenBounds:null,_lSize:-1,_lHeight:-1,gameName:"Coin Defender",gameVersion:"0.6",storage:null,IC:null,DEBUG:!1,started:!1,config:{init:function(){this.storage=Bridge.global.localStorage}},initSaveData:function(){if((BNTest.App.storage.Mon==null||Bridge.referenceEquals(BNTest.App.storage.Mon,""))&&(BNTest.App.storage.Mon=0),(BNTest.App.storage.MaxLevel==null||Bridge.referenceEquals(BNTest.App.storage.MaxLevel,""))&&(BNTest.App.storage.MaxLevel=0),BNTest.App.storage.Characters==null){var Chars={};Chars.Reimu=!0;BNTest.App.storage.Characters=Chars}},update:function(){BNTest.KeyboardManager.update();BNTest.App.started||(BNTest.App.updateWindow(),BNTest.App.started=!0)},updateWindow:function(){var H=window.innerHeight,size;H!==BNTest.App._lHeight&&(size=Math.ceil(H*(1/BNTest.App.targetAspect)),BNTest.App.canvas.style.width="100%",BNTest.App.guiCanvas.style.width="100%",BNTest.App.div.style.width=System.String.concat(System.Double.format(size,"G"),"px"),BNTest.App.div.style.position="relative",BNTest.App.div.style.left=System.String.concat(System.Double.format((Bridge.Int.div(window.innerWidth,2)|0)-size/2,"G"),"px"),BNTest.App._lHeight=H)},initCube:function(canvas){var cube=new BNTest.Cube;BNTest.App.initSettings(cube);cube.canvas=canvas;cube.gl=BNTest.App.create3DContext(cube.canvas);cube.gl!=null?(cube.initShaders(),cube.initBuffers(),cube.initTexture(),cube.tick(),document.addEventListener("keydown",Bridge.fn.bind(cube,cube.handleKeyDown)),document.addEventListener("keyup",Bridge.fn.bind(cube,cube.handleKeyUp))):BNTest.App.showError(cube.canvas,'<b>Either the browser doesn\'t support WebGL or it is disabled.<br>Please follow <a href="http://get.webgl.com">Get WebGL<\/a>.<\/b>')},showError:function(canvas,message){canvas.parentElement.replaceChild(Bridge.merge(document.createElement("p"),{innerHTML:message}),canvas)},initSettings:function(cube){var useSettings=document.getElementById("settings");useSettings!=null&&useSettings.checked&&(cube.useBlending=document.getElementById("blending").checked,cube.alpha=parseFloat(document.getElementById("alpha").value),cube.useLighting=document.getElementById("lighting").checked,cube.ambientR=parseFloat(document.getElementById("ambientR").value),cube.ambientG=parseFloat(document.getElementById("ambientG").value),cube.ambientB=parseFloat(document.getElementById("ambientB").value),cube.lightDirectionX=parseFloat(document.getElementById("lightDirectionX").value),cube.lightDirectionY=parseFloat(document.getElementById("lightDirectionY").value),cube.lightDirectionZ=parseFloat(document.getElementById("lightDirectionZ").value),cube.directionalR=parseFloat(document.getElementById("directionalR").value),cube.directionalG=parseFloat(document.getElementById("directionalG").value),cube.directionalB=parseFloat(document.getElementById("directionalB").value),cube.textureImageSrc="crate.gif")},create3DContext:function(canvas){for(var context=null,name,$t=Bridge.getEnumerator(["webgl","experimental-webgl","webkit-3d","moz-webgl"]);$t.moveNext();){name=$t.getCurrent();try{context=canvas.getContext(name)}catch($e1){$e1=System.Exception.create($e1)}if(context!=null)break}return context}},$main:function(){var button=Bridge.merge(document.createElement("button"),{innerHTML:"Click Me",onclick:$_.BNTest.App.f1}),Canv,smooth;BNTest.App.initSaveData();document.body.style.cssText="overflow: hidden;margin: 0;padding: 0;";document.body.onresize=$_.BNTest.App.f2;BNTest.AnimationLoader.init();document.title=System.String.concat(System.String.concat(System.String.concat(BNTest.App.gameName," "),BNTest.App.gameVersion)," by:RSGmaker");BNTest.WGMatrix.init();BNTest.App.IC=new BNTest.InputController("KeyboardMouse");BNTest.App.div=document.createElement("div");Canv=document.createElement("canvas");BNTest.App.canvas=Canv;BNTest.App.targetAspect=.75;Canv.width=1024;Canv.height=Bridge.Int.clip32(Canv.width*BNTest.App.targetAspect);BNTest.App.screenBounds=new BNTest.Rectangle(0,0,Canv.width,Canv.height);BNTest.App.div.appendChild(Canv);document.body.appendChild(BNTest.App.div);BNTest.App.guiCanvas=document.createElement("canvas");BNTest.App.guiCanvas.width=Canv.width;BNTest.App.guiCanvas.height=Canv.height;BNTest.App.guiCanvas.style.position="absolute";BNTest.App.guiCanvas.style.left="0px";BNTest.App.guiCanvas.style.top="0px";BNTest.App.gui=BNTest.Helper.getContext(BNTest.App.guiCanvas);BNTest.App.div.appendChild(BNTest.App.guiCanvas);BNTest.KeyboardManager.init();var GD=new BNTest.GLDemo,CV=BNTest.App.canvas;GD.start(BNTest.App.canvas);smooth=!0}});Bridge.ns("BNTest.App",$_);Bridge.apply($_.BNTest.App,{f1:function(){Bridge.Console.log("Success!")},f2:function(){BNTest.App.updateWindow()}});Bridge.define("BNTest.Audio",{_AM:null,_audio:null,_hasPlayed:!1,_blast:null,_loop:!1,onPlay:null,onStop:null,lasttime:0,config:{properties:{ID:null}},ctor:function(audio,ID,AudioManager){var self,maxvoices,voices;for(this.$initialize(),this._audio=audio,this.setID(ID),self=this,this._AM=AudioManager,this.setAudio(),this._blast=new(System.Collections.Generic.List$1(HTMLAudioElement)),maxvoices=6,voices=1;voices<maxvoices;)this._blast.add(Bridge.cast(this._audio.cloneNode(),HTMLAudioElement)),voices=voices+1|0},getIsPlaying:function(){return!(!this._hasPlayed||this._audio.paused||this._audio.currentTime===0)},setIsPlaying:function(value){value?this.play():this.pause()},getLoop:function(){return this._loop},setLoop:function(value){this._loop=value},getCurrentTime:function(){return this._audio.currentTime},setCurrentTime:function(value){this._audio.currentTime=value},getVolume:function(){return this._audio.volume},setVolume:function(value){this._audio.volume=value},play:function(){return this.getIsPlaying()?!1:(this.lasttime=this.getCurrentTime(),this._audio.play(),this._hasPlayed=!0,!0)},pause:function(){return this.getIsPlaying()?(this._audio.pause(),!0):!1},stop:function(){return this.getIsPlaying()?(this._audio.pause(),this._audio.currentTime=0,!0):!1},setAudio:function(){var self=this;this._audio.onplay=function(){self._OnPlay()};this._audio.onpause=function(){self._OnStop()};this._audio.onended=function(){self._OnEnd()};this._audio.ontimeupdate=function(){self._OnUpdate()}},blast:function(volume){var i,A;if(volume===void 0&&(volume=1),this.getIsPlaying())for(i=0;i<this._blast.getCount();)A=this._blast.getItem(i),(A.paused||A.currentTime<.1||A.played.length===0)&&(A.paused||A.currentTime===0||A.played.length===0)&&(A.volume=volume,A.play(),i=this._blast.getCount()),i=i+1|0;else this.setVolume(volume),this.play()},_OnPlay:function(){this._AM.onPlay(this);if(this.onPlay)this.onPlay(this)},_OnStop:function(){this._AM.onStop(this);if(this.onStop)this.onStop(this)},_OnEnd:function(){this._loop?(this.setCurrentTime(0),this.play()):this._OnStop()},_OnUpdate:function(){return}});Bridge.define("BNTest.AudioManager",{statics:{directory:"",__this:null,get_this:function(){return BNTest.AudioManager.__this==null&&(BNTest.AudioManager.__this=new BNTest.AudioManager),BNTest.AudioManager.__this},init:function(){BNTest.AudioManager.__this==null&&(BNTest.AudioManager.__this=new BNTest.AudioManager)}},data:null,playing:null,ctor:function(){this.$initialize();this.data=new(System.Collections.Generic.Dictionary$2(String,BNTest.Audio));this.playing=new(System.Collections.Generic.List$1(BNTest.Audio))},get:function(path){var AE,A;return path=System.String.concat(BNTest.AudioManager.directory,path),this.data.containsKey(path)?this.data.get(path):(AE=new Audio(path),console.log(System.String.concat("AM:",path)),A=new BNTest.Audio(AE,path,this),this.data.add(path,A),A)},play:function(path,loop){loop===void 0&&(loop=!1);var A=this.get(path);return A.setLoop(loop),A.play(),A},blast:function(path,volume){volume===void 0&&(volume=1);var A=this.get(path);A.blast(volume)},stop:function(path){var A=this.get(path);A.stop()},pause:function(path){var A=this.get(path);A.pause()},onPlay:function(audio){this.playing.contains(audio)||this.playing.add(audio)},onStop:function(audio){this.playing.contains(audio)&&this.playing.remove(audio)},stopAllFromDirectory:function(directory){directory=System.String.concat(BNTest.AudioManager.directory,directory);BNTest.HelperExtensions.forEach(BNTest.Audio,this.data.getValues(),function(A){System.String.startsWith(A.getID(),directory)&&A.stop()})}});Bridge.define("BNTest.Entity",{model:null,alive:!0,speed:null,game:null,lastBB:null,_behaviors:null,_behaviorTicks:null,zOrder:0,ID:null,hideHitbox:!1,solid:!0,obstruction:!1,groundFriction:1,platform:!1,customBoundingBox:null,world:null,team:-1,BB:null,behaviorsUpdated:!1,config:{init:function(){this.speed=new BNTest.GLVec3.ctor;this.BB=new BNTest.BoundingBox.ctor}},ctor:function(world){this.$initialize();this.world=world;this.ID=BNTest.Helper.getRandomString();this.game=world.game;this.lastBB=this.model!=null?this.getBoundingBox():new BNTest.BoundingBox.ctor},getHspeed:function(){return this.speed.x},setHspeed:function(value){this.speed.x=value},getVspeed:function(){return this.speed.y},setVspeed:function(value){this.speed.y=value},getZspeed:function(){return this.speed.z},setZspeed:function(value){this.speed.z=value},getPosition:function(){return this.model.offset},setPosition:function(value){this.model.offset=value},getx:function(){return this.model.offset.x},setx:function(value){this.model.offset.x=value},gety:function(){return this.model.offset.y},sety:function(value){this.model.offset.y=value},getz:function(){return this.model.offset.z},setz:function(value){this.model.offset.z=value},getScale:function(){return this.model.scale},setScale:function(value){this.model.scale=value},getHandledLocally:function(){return this.game.hoster},getHitbox:function(){return this.lastBB==null?this.getHitbox():this.lastBB},getBoundingBox:function(){return this.customBoundingBox!=null?(this.BB.copyFrom(this.customBoundingBox),this.BB.add(this.model.offset),this.BB):this.model.getBoundingBox()},addBehavior:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(BNTest.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32)));this._behaviors.add(behavior);this._behaviorTicks.add(0)},removeBehavior:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(BNTest.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32)));this._behaviors.contains(behavior)&&(this._behaviorTicks.removeAt(this._behaviors.indexOf(behavior)),this._behaviors.remove(behavior))},removeBehavior$1:function(T){var $t,L,behavior;if(this._behaviors!=null){for(L=new(System.Collections.Generic.List$1(BNTest.EntityBehavior))(System.Linq.Enumerable.from(this._behaviors).where(function(behavior){return Bridge.is(behavior,T)})),$t=Bridge.getEnumerator(L);$t.moveNext();)behavior=$t.getCurrent(),this.removeBehavior(behavior);return}},getBehavior:function(T){var B,ret;if(this._behaviors==null)return Bridge.getDefaultValue(T);for(var TT=T,i=0,ln=this._behaviors.getCount();i<ln;){if(B=this._behaviors.getItem(i),Bridge.Reflection.isInstanceOfType(B,TT))return B;i=i+1|0}return ret=null,Bridge.getDefaultValue(T)},getBehavior$1:function(T,func){for(var TT=T,i=0,ln=this._behaviors.getCount(),B;i<ln;){if(B=this._behaviors.getItem(i),Bridge.Reflection.isInstanceOfType(B,TT)&&func(B))return B;i=i+1|0}return null},getTeamColor:function(){return Bridge.is(this,BNTest.ICombatant)?this.game.gamePlaySettings.gameMode.getTeams()?this.game.getTeamColor(this.team):Bridge.referenceEquals(this,this.game.localplayer.character)?this.game.getTeamColor(1):this.game.getTeamColor(2):new BNTest.GLColor},sameTeam:function(combatant){return this==combatant?!0:this.team===combatant.team?this.game.gamePlaySettings.gameMode.getTeams()?!0:this.team===0:!1},getBehaviorFromName:function(Name){var i,ln,B;if(this._behaviors==null)return null;try{for(i=0,ln=this._behaviors.getCount();i<ln;){if(B=this._behaviors.getItem(i),Bridge.referenceEquals(B.getBehaviorName(),Name))return B;i=i+1|0}}catch($e1){$e1=System.Exception.create($e1);Bridge.Console.log(System.String.concat(System.String.concat("Behavior ",Name)," was not found."))}return null},customEvent:function(){},sendCustomEvent:function(evt,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.I=this.ID;D.D=evt;this.game.sendEvent("CE",D,triggerflush)},playSound:function(sound){this.game.playSoundEffect(this.getCenter(),sound)},getCenter:function(){return this.lastBB.getCenter()},rotateTest:function(M,val,speed,maxmod){val===void 0&&(val="x");speed===void 0&&(speed=1);maxmod===void 0&&(maxmod=1);M.Dir==null&&(M.Dir=1);M.Max==null&&(M.Max=45);M.Spd==null&&(M.Spd=1.5);var max=M.Max,spd=M.Spd;speed!==1&&(spd*=speed);maxmod!==1&&(max*=maxmod);M.rotation[val]=M.rotation[val]+spd*M.Dir;Math.abs(M.rotation[val])>=max&&(M.Dir=-M.Dir)},cacheBoundingBox:function(){this.customBoundingBox=null;this.customBoundingBox=BNTest.BoundingBox.op_Subtraction(this.getBoundingBox(),this.getPosition())},updateBehaviors:function(){var $t,i,behavior;if(this._behaviors!=null&&!this.behaviorsUpdated){for(i=0;i<this._behaviors.getCount();)behavior=this._behaviors.getItem(i),behavior.enabled&&Bridge.identity(this._behaviorTicks.getItem(i),($t=this._behaviorTicks.getItem(i)+1|0,this._behaviorTicks.setItem(i,$t),$t))>=behavior.framesPerTick&&(this._behaviorTicks.setItem(i,0),behavior.update()),i=i+1|0;this.behaviorsUpdated=!0}},update:function(){var cam,C,dist;this.model.offset.x+=this.speed.x;this.model.offset.y+=this.speed.y;this.model.offset.z+=this.speed.z;this.updateBehaviors();this.lastBB=this.getBoundingBox();this.behaviorsUpdated=!1;this.model!=null&&(cam=this.world.cam,this.game.camera.rotation.y===0&&(this.lastBB.min.z-this.game.cameraDist-20>cam.z||Math.abs(this.model.offset.x-cam.x)>BNTest.World.viewDistanceS)?this.model.inView=!1:(C=this.lastBB.getCenter(),dist=cam.roughDistance(C),this.model.inView=dist<=BNTest.World.viewDistance))},refreshBehaviorTick:function(T){var B=this.getBehavior(T);B!=null&&this._behaviorTicks.setItem(this._behaviors.indexOf(B),B.framesPerTick)},draw:function(gl){var $t,behavior;if(this._behaviors!=null)for($t=Bridge.getEnumerator(this._behaviors);$t.moveNext();)behavior=$t.getCurrent(),behavior.draw(gl)},onRemove:function(){}});Bridge.define("BNTest.IWeaponBehavior",{$kind:"interface"});Bridge.define("BNTest.BoundingBox",{statics:{op_Addition:function(B,V){var ret=B.clone();return ret.add(V),ret},op_Subtraction:function(B,V){var ret=B.clone();return ret.subtract(V),ret},op_Multiply:function(B,V){var A=B.getCenter(),S=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply(B.getSize(),V),.5),min=BNTest.GLVec3.op_Subtraction(A,S),max=BNTest.GLVec3.op_Addition(A,S);return new BNTest.BoundingBox.$ctor1(min,max)},op_Multiply$1:function(B,Scale){var V=new BNTest.GLVec3.ctor(Scale,Scale,Scale),A=B.getCenter(),S=BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply(B.getSize(),V),.5),min=BNTest.GLVec3.op_Subtraction(A,S),max=BNTest.GLVec3.op_Addition(A,S);return new BNTest.BoundingBox.$ctor1(min,max)}},min:null,max:null,$ctor1:function(Min,Max){this.$initialize();this.min=BNTest.GLVec3.min(Min,Max);this.max=BNTest.GLVec3.max(Min,Max)},ctor:function(){this.$initialize();this.min=new BNTest.GLVec3.ctor;this.max=new BNTest.GLVec3.ctor},$ctor2:function(size){this.$initialize();var hsize=size/2;this.min=new BNTest.GLVec3.ctor(-hsize,-hsize,-hsize);this.max=new BNTest.GLVec3.ctor(hsize,hsize,hsize)},getPosition:function(){return this.min},setPosition:function(value){var X=this.max.x-this.min.x,Y=this.max.y-this.min.y,Z=this.max.z-this.min.z;this.min=value;this.max.x=this.min.x+X;this.max.y=this.min.y+Y;this.max.z=this.min.z+Z},getEmpty:function(){return this.min.equals(this.max)},getSize:function(){return BNTest.GLVec3.op_Subtraction(this.max,this.min)},setSize:function(value){var Sz=BNTest.GLVec3.op_Division$1(value,2);this.min.x=-Sz.x;this.min.y=-Sz.y;this.min.z=-Sz.z;this.max.x=Sz.x;this.max.y=Sz.y;this.max.z=Sz.z},getRoughLength:function(){return Math.abs(this.max.x-this.min.x)+Math.abs(this.max.y-this.min.y)+Math.abs(this.max.z-this.min.z)},getLeft:function(){return this.min.x},getTop:function(){return this.min.y},getBack:function(){return this.min.z},getRight:function(){return this.max.x},getBottom:function(){return this.max.y},getFront:function(){return this.max.z},getCenter:function(){var X=(this.max.x-this.min.x)*.5,Y=(this.max.y-this.min.y)*.5,Z=(this.max.z-this.min.z)*.5;return new BNTest.GLVec3.ctor(this.min.x+X,this.min.y+Y,this.min.z+Z)},copyFrom:function(B){var BM=B.min;this.min.x=BM.x;this.min.y=BM.y;this.min.z=BM.z;BM=B.max;this.max.x=BM.x;this.max.y=BM.y;this.max.z=BM.z},add:function(offset){this.min.x+=offset.x;this.min.y+=offset.y;this.min.z+=offset.z;this.max.x+=offset.x;this.max.y+=offset.y;this.max.z+=offset.z},add$1:function(X,Y,Z){this.min.x+=X;this.min.y+=Y;this.min.z+=Z;this.max.x+=X;this.max.y+=Y;this.max.z+=Z},subtract:function(offset){this.min.x-=offset.x;this.min.y-=offset.y;this.min.z-=offset.z;this.max.x-=offset.x;this.max.y-=offset.y;this.max.z-=offset.z},subtract$1:function(X,Y,Z){this.min.x-=X;this.min.y-=Y;this.min.z-=Z;this.max.x-=X;this.max.y-=Y;this.max.z-=Z},toString:function(){return System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat("{Pos:",this.min.toString()),"}"),"{Size:"),this.getSize().toString()),"}")},clone:function(){return new BNTest.BoundingBox.$ctor1(this.min,this.max)},intersection$3:function(list){return System.Linq.Enumerable.from(list).where(Bridge.fn.bind(this,$_.BNTest.BoundingBox.f1)).toList(BNTest.BoundingBox)},intersection:function(list){for(var ret=System.Array.init(0,null),i=0,ln=list.length,B;i<ln;)B=list[i],B.lastBB.intersection$2(this)&&ret.push(B),i=i+1|0;return ret},intersection$1:function(list){for(var ret=System.Array.init(0,null),L=list.items,i=0,ln=L.length,B;i<ln;)B=L[i],B.lastBB.intersection$2(this)&&ret.push(B),i=i+1|0;return ret},intersection$2:function(b){var bmn=b.min,bmx=b.max;return this.max.x>=bmn.x&&this.min.x<=bmx.x&&this.max.y>=bmn.y&&this.min.y<=bmx.y&&!!(this.max.z>=bmn.z&this.min.z<=bmx.z)},contains:function(V){return BNTest.GLVec3.op_LessThanOrEqual(this.min,V)&&BNTest.GLVec3.op_GreaterThanOrEqual(this.max,V)}});Bridge.ns("BNTest.BoundingBox",$_);Bridge.apply($_.BNTest.BoundingBox,{f1:function(B){return this.intersection$2(B)}});Bridge.define("BNTest.ButtonMenu",{rows:null,menuWidth:0,menuHeight:0,fontSize:0,selectionMenu:!1,selected:null,self:null,onChoose:null,position:null,config:{init:function(){this.position=new BNTest.Vector2}},ctor:function(menuWidth,menuHeight,FontSize,selectionMenu){selectionMenu===void 0&&(selectionMenu=!1);this.$initialize();this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(BNTest.ButtonSprite)));this.menuWidth=menuWidth;this.menuHeight=menuHeight;this.fontSize=FontSize;this.selectionMenu=selectionMenu;this.self=this},getSelectedData:function(){return this.self.selected!=null?this.self.selected.data:null},getSelectedText:function(){return this.self.selected!=null&&Bridge.is(this.self.selected.getContents(),BNTest.TextSprite)?Bridge.cast(this.self.selected.getContents(),BNTest.TextSprite).getText():null},setSelectedText:function(value){var B=null;BNTest.HelperExtensions.forEach(System.Collections.Generic.List$1(BNTest.ButtonSprite),this.rows,function(F){BNTest.HelperExtensions.forEach(BNTest.ButtonSprite,F,function(BB){Bridge.is(BB.getContents(),BNTest.TextSprite)&&Bridge.referenceEquals(BB.getContents().getText(),value)&&(B=BB)})});B!=null&&this.select(B)},getAllButtons:function(){var all=new(System.Collections.Generic.List$1(BNTest.ButtonSprite));return BNTest.HelperExtensions.forEach(System.Collections.Generic.List$1(BNTest.ButtonSprite),this.rows,function(R){all.addRange(R)}),all},getSpriteByData:function(data){var all=new(System.Collections.Generic.List$1(BNTest.ButtonSprite))(System.Linq.Enumerable.from(this.getAllButtons()).where(function(B){return Bridge.referenceEquals(B.data,data)}));return all.getCount()>0?all.getItem(0):null},addButtons:function(buttonText){BNTest.HelperExtensions.forEach(String,buttonText,Bridge.fn.bind(this,$_.BNTest.ButtonMenu.f1))},addButton:function(buttonText,row,data){var T,B;return row===void 0&&(row=-1),data===void 0&&(data=null),T=new BNTest.TextSprite,T.setText(buttonText),T.setFontSize(this.fontSize),B=new BNTest.ButtonSprite.ctor(T,Bridge.Int.clip32(this.fontSize*.1)),data!=null&&(B.data=data),this.addButton$1(B,row),B},addButton$1:function(button,row){row===void 0&&(row=-1);this.rows.getCount()===0&&this.rows.add(new(System.Collections.Generic.List$1(BNTest.ButtonSprite)));row===-1&&(row=this.rows.getCount()-1|0);button!=null&&(button.onClick=Bridge.fn.bind(this,function(){this.self.select(button)}));this.rows.getItem(row).add(button)},select:function(button){if(!Bridge.referenceEquals(this.selected,button)||!this.selectionMenu){this.selected!=null&&this.selectionMenu&&this.selected.setColorScheme$1(0);this.selected=button;var OSC=this.onChoose,self=this;this.selectionMenu&&this.selected!=null&&this.selected.setColorScheme$1(1);this.selected!=null&&OSC&&self.onChoose()}},combineRows:function(){var all=new(System.Collections.Generic.List$1(BNTest.ButtonSprite));BNTest.HelperExtensions.forEach(System.Collections.Generic.List$1(BNTest.ButtonSprite),this.rows,function(R){all.addRange(R)});this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(BNTest.ButtonSprite)));this.rows.add(all)},addRow:function(){var ret=new(System.Collections.Generic.List$1(BNTest.ButtonSprite));return this.rows.add(ret),ret},breakUp:function(totalRows){var all;this.combineRows();all=this.rows.getItem(0);this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(BNTest.ButtonSprite)));for(var C=Math.ceil(all.getCount()/totalRows),row=this.addRow(),i=0;i<all.getCount();)row.getCount()>=C&&(row=this.addRow()),this.addButton$1(all.getItem(i)),i=i+1|0},centerOn:function(sprite,Center){sprite.draw(null);var S=sprite.getSize(),S2=BNTest.Vector2.op_Division(S,2);sprite.position=BNTest.Vector2.op_Subtraction(Center,S2)},updateRow:function(index,y){var row=this.rows.getItem(index),X=this.menuWidth/(row.getCount()+1),i=0,CX=X,B;for(CX+=this.position.x;i<row.getCount();)B=row.getItem(i),B!=null&&this.centerOn(B,new BNTest.Vector2(CX,y)),CX+=X,i=i+1|0},finish:function(totalRows){var y,CY,i;for(totalRows===void 0&&(totalRows=-1),totalRows>0&&this.breakUp(totalRows),y=0,CY=0,totalRows>0&&this.rows.getCount()<totalRows?(y=this.menuHeight/(this.rows.getCount()+1|0),CY=y):(y=this.menuHeight/this.rows.getCount(),CY=0),CY+=this.position.y,i=0;i<this.rows.getCount();)this.updateRow(i,CY),CY+=y,i=i+1|0},update:function(mousePosition,clicked){mousePosition===void 0&&(mousePosition=null);clicked===void 0&&(clicked=!0);BNTest.Vector2.op_Equality(mousePosition,null)&&(mousePosition=BNTest.KeyboardManager.get_this().cMouse,clicked=BNTest.KeyboardManager.get_this().tappedMouseButtons.contains(0));clicked&&BNTest.HelperExtensions.forEach(System.Collections.Generic.List$1(BNTest.ButtonSprite),this.rows,function(R){BNTest.HelperExtensions.forEach(BNTest.ButtonSprite,R,function(B){B!=null&&B.checkClick(mousePosition)})})},draw:function(g){BNTest.HelperExtensions.forEach(System.Collections.Generic.List$1(BNTest.ButtonSprite),this.rows,function(R){BNTest.HelperExtensions.forEach(BNTest.ButtonSprite,R,function(B){B!=null&&B.draw(g)})})}});Bridge.ns("BNTest.ButtonMenu",$_);Bridge.apply($_.BNTest.ButtonMenu,{f1:function(T){this.addButton(T)}});Bridge.define("BNTest.Sprite",{position:null,spriteBuffer:null,visible:!0,spriteGraphics:null,ctor:function(){this.$initialize();this.spriteBuffer=document.createElement("canvas");this.spriteGraphics=this.spriteBuffer.getContext("2d");this.position=new BNTest.Vector2},getSize:function(){return new BNTest.Vector2(this.spriteBuffer.width,this.spriteBuffer.height)},setSize:function(value){BNTest.Vector2.op_Equality(value,null)&&(value=new BNTest.Vector2);this.spriteBuffer.width=Bridge.Int.clip32(value.x);this.spriteBuffer.height=Bridge.Int.clip32(value.y)},getGraphics:function(){return this.spriteGraphics},onFrame:function(){},draw:function(g){this.visible&&g.drawImage(this.spriteBuffer,this.position.x,this.position.y)},getBounds:function(){return new BNTest.Rectangle(this.position.x,this.position.y,this.spriteBuffer.width,this.spriteBuffer.height)}});Bridge.define("BNTest.ButtonSprite.ColorScheme",{borderColor:null,buttonColor:null,ctor:function(borderColor,buttonColor){borderColor===void 0&&(borderColor="#00AA33");buttonColor===void 0&&(buttonColor="#11CC55");this.$initialize();this.borderColor=borderColor;this.buttonColor=buttonColor}});Bridge.define("BNTest.Cube",{canvas:null,gl:null,program:null,texture:null,useBlending:!0,alpha:1,useLighting:!0,ambientR:.4,ambientG:.4,ambientB:.4,lightDirectionX:0,lightDirectionY:0,lightDirectionZ:-1,directionalR:.25,directionalG:.25,directionalB:.25,textureImageSrc:"crate.gif",mvMatrix:null,mvMatrixStack:null,pMatrix:null,vertexPositionAttribute:0,vertexNormalAttribute:0,textureCoordAttribute:0,vertexColorAttribute:0,pMatrixUniform:null,mvMatrixUniform:null,nMatrixUniform:null,samplerUniform:null,useLightingUniform:null,ambientColorUniform:null,lightingDirectionUniform:null,directionalColorUniform:null,alphaUniform:null,cubeVertexPositionBuffer:null,cubeVertexNormalBuffer:null,cubeVertexTextureCoordBuffer:null,cubeVertexIndexBuffer:null,cubeVertexColorBuffer:null,xRotation:0,xSpeed:15,yRotation:0,ySpeed:-15,z:-5,currentlyPressedKeys:null,lastTime:0,config:{init:function(){this.mvMatrix=mat4.create();this.mvMatrixStack=[];this.pMatrix=mat4.create();this.currentlyPressedKeys=[]}},getShader:function(gl,id){var shaderScript=document.getElementById(id),str,k,shader;if(shaderScript==null)return null;for(str="",k=shaderScript.firstChild;k!=null;)k.nodeType===3&&(str=System.String.concat(str,k.textContent)),k=k.nextSibling;if(Bridge.referenceEquals(shaderScript.type,"x-shader/x-fragment"))shader=gl.createShader(gl.FRAGMENT_SHADER);else if(Bridge.referenceEquals(shaderScript.type,"x-shader/x-vertex"))shader=gl.createShader(gl.VERTEX_SHADER);else return null;return(gl.shaderSource(shader,str),gl.compileShader(shader),!gl.getShaderParameter(shader,gl.COMPILE_STATUS))?(Bridge.global.alert(gl.getShaderInfoLog(shader)),null):shader},initShaders:function(){var fragmentShader=this.getShader(this.gl,"shader-fs"),vertexShader=this.getShader(this.gl,"shader-vs"),shaderProgram=this.gl.createProgram();Bridge.is(shaderProgram,System.Int32)&&Bridge.global.alert("Could not initialise program");this.gl.attachShader(shaderProgram,vertexShader);this.gl.attachShader(shaderProgram,fragmentShader);this.gl.linkProgram(shaderProgram);this.gl.getProgramParameter(shaderProgram,this.gl.LINK_STATUS)||Bridge.global.alert("Could not initialise shaders");this.gl.useProgram(shaderProgram);this.vertexPositionAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexPosition");this.vertexNormalAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexNormal");this.textureCoordAttribute=this.gl.getAttribLocation(shaderProgram,"aTextureCoord");this.vertexColorAttribute=this.gl.getAttribLocation(shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(this.vertexPositionAttribute);this.gl.enableVertexAttribArray(this.vertexNormalAttribute);this.gl.enableVertexAttribArray(this.textureCoordAttribute);this.pMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uPMatrix");this.mvMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uMVMatrix");this.nMatrixUniform=this.gl.getUniformLocation(shaderProgram,"uNMatrix");this.samplerUniform=this.gl.getUniformLocation(shaderProgram,"uSampler");this.useLightingUniform=this.gl.getUniformLocation(shaderProgram,"uUseLighting");this.ambientColorUniform=this.gl.getUniformLocation(shaderProgram,"uAmbientColor");this.lightingDirectionUniform=this.gl.getUniformLocation(shaderProgram,"uLightingDirection");this.directionalColorUniform=this.gl.getUniformLocation(shaderProgram,"uDirectionalColor");this.alphaUniform=this.gl.getUniformLocation(shaderProgram,"uAlpha");this.program=shaderProgram},handleLoadedTexture:function(image){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null)},initTexture:function(){this.texture=this.gl.createTexture();var textureImageElement=new Image;textureImageElement.onload=Bridge.fn.bind(this,function(){this.handleLoadedTexture(textureImageElement)});textureImageElement.src=this.textureImageSrc},setMatrixUniforms:function(){this.gl.uniformMatrix4fv(this.pMatrixUniform,!1,this.pMatrix);this.gl.uniformMatrix4fv(this.mvMatrixUniform,!1,this.mvMatrix);var normalMatrix=mat3.create();mat4.toInverseMat3(this.mvMatrix,normalMatrix);mat3.transpose(normalMatrix);this.gl.uniformMatrix3fv(this.nMatrixUniform,!1,normalMatrix)},degToRad:function(degrees){return degrees*Math.PI/180},handleKeyDown:function(e){this.currentlyPressedKeys[e.keyCode]=!0},handleKeyUp:function(e){this.currentlyPressedKeys[e.keyCode]=!1},handleKeys:function(){this.currentlyPressedKeys[81]&&(this.z-=.05);this.currentlyPressedKeys[69]&&(this.z+=.05);this.currentlyPressedKeys[65]&&(this.ySpeed=this.ySpeed-1|0);this.currentlyPressedKeys[68]&&(this.ySpeed=this.ySpeed+1|0);this.currentlyPressedKeys[87]&&(this.xSpeed=this.xSpeed-1|0);this.currentlyPressedKeys[83]&&(this.xSpeed=this.xSpeed+1|0)},initBuffers:function(){var vertices,vertexNormals,textureCoords,cubeVertexIndices;this.cubeVertexPositionBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer);vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertices),this.gl.STATIC_DRAW);this.cubeVertexColorBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexColorBuffer);for(var vcolor=System.Array.init((Bridge.Int.div(vertices.length,3)|0)*4|0,0),i=0;(i+3|0)<vcolor.length;)vcolor[i]=1,vcolor[i+1|0]=1,vcolor[i+2|0]=1,vcolor[i+3|0]=1,i=i+4|0;this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vcolor),this.gl.STATIC_DRAW);this.cubeVertexNormalBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer);vertexNormals=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertexNormals),this.gl.STATIC_DRAW);this.cubeVertexTextureCoordBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer);textureCoords=[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(textureCoords),this.gl.STATIC_DRAW);this.cubeVertexIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);cubeVertexIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(cubeVertexIndices),this.gl.STATIC_DRAW)},drawCube:function(){if(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexPositionBuffer),this.gl.vertexAttribPointer(this.vertexPositionAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexNormalBuffer),this.gl.vertexAttribPointer(this.vertexNormalAttribute,3,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVertexTextureCoordBuffer),this.gl.vertexAttribPointer(this.textureCoordAttribute,2,this.gl.FLOAT,!1,0,0),this.ambientR=1,this.ambientG=1,this.ambientB=1,this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.uniform1i(this.samplerUniform,0),this.useBlending?(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this.gl.enable(this.gl.BLEND),this.gl.disable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,this.alpha)):(this.gl.disable(this.gl.BLEND),this.gl.enable(this.gl.DEPTH_TEST),this.gl.uniform1f(this.alphaUniform,1)),this.gl.uniform1i(this.useLightingUniform,this.useLighting),this.useLighting){this.gl.uniform3f(this.ambientColorUniform,this.ambientR,this.ambientG,this.ambientB);var lightingDirection=[this.lightDirectionX,this.lightDirectionY,this.lightDirectionZ],adjustedLD=vec3.create();vec3.normalize(lightingDirection,adjustedLD);vec3.scale(adjustedLD,-1);this.gl.uniform3fv(this.lightingDirectionUniform,adjustedLD);this.gl.uniform3f(this.directionalColorUniform,this.directionalR,this.directionalG,this.directionalB)}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVertexIndexBuffer);this.setMatrixUniforms();this.gl.drawElements(this.gl.TRIANGLES,36,this.gl.UNSIGNED_SHORT,0)},drawScene:function(){this.gl.viewport(0,0,this.canvas.width,this.canvas.height);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);mat4.perspective(45,this.canvas.width/this.canvas.height,.1,100,this.pMatrix);mat4.identity(this.mvMatrix);mat4.translate(this.mvMatrix,[0,0,this.z]);mat4.rotate(this.mvMatrix,this.degToRad(this.xRotation),[1,0,0]);mat4.rotate(this.mvMatrix,this.degToRad(this.yRotation),[0,1,0]);this.drawCube();mat4.translate(this.mvMatrix,[2,0,0]);this.drawCube()},animate:function(){var timeNow=(new Date).getTime(),elapsed;this.lastTime!==0&&(elapsed=timeNow-this.lastTime,this.xRotation+=this.xSpeed*elapsed/1e3,this.yRotation+=this.ySpeed*elapsed/1e3);this.lastTime=timeNow},tick:function(){BNTest.App.initSettings(this);this.handleKeys();this.drawScene();this.animate();Bridge.global.setTimeout(Bridge.fn.bind(this,this.tick),20)}});Bridge.define("BNTest.FeatureCategory",{name:null,parent:null,subCategories:null,items:null,oneOnly:!1,displayAsOneCategory:!1,config:{init:function(){this.subCategories=new(System.Collections.Generic.List$1(BNTest.FeatureCategory));this.items=new(System.Collections.Generic.List$1(BNTest.FeatureItem))}},getItems:function(){var ret=System.Linq.Enumerable.from(this.items).toList(BNTest.FeatureItem),i;if(this.displayAsOneCategory)for(i=0;i<this.subCategories.getCount();)ret.addRange(this.subCategories.getItem(i).getItems()),i=i+1|0;return ret}});Bridge.define("BNTest.FeatureItem",{name:null,category:null,cost:0,requirements:null,config:{init:function(){this.requirements=$_.BNTest.FeatureItem.f1}},getPurchased:function(){var A=BNTest.App.storage[System.String.concat(System.String.concat(this.category.name,"_"),this.name)];return A==null||Bridge.referenceEquals(A,"")?!1:System.Boolean.parse(A)},setPurchased:function(value){BNTest.App.storage[System.String.concat(System.String.concat(this.category.name,"_"),this.name)]=value},getBuyable:function(){return this.requirements()},purchase:function(){if(!this.getPurchased()&&this.getBuyable()){var money=System.Int32.parse(BNTest.App.storage.Mon);if(money>=this.cost)return money=money-this.cost|0,BNTest.App.storage.Mon=money,this.setPurchased(!0),!0}return!1},clone:function(){var ret=new BNTest.FeatureItem;return ret.name=this.name,ret.category=this.category,ret.requirements=this.requirements,ret.cost=this.cost,ret}});Bridge.ns("BNTest.FeatureItem",$_);Bridge.apply($_.BNTest.FeatureItem,{f1:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=10}});Bridge.define("BNTest.GameMode.ModeTypes",{$kind:"enum",statics:{Skirmish:0,Challenge:1,CallengeCoop:2}});Bridge.define("BNTest.GamePad",{connected:!1,axes:null,buttons:null,id:null,index:System.Int64(0),ctor:function(pad){var length,i;for(this.$initialize(),this.id=pad.id,this.index=System.Int64(pad.index),this.connected=pad.connected,this.axes=pad.axes,length=pad.buttons.length,this.buttons=System.Array.init(length,null),i=0;i<length;)this.buttons[i]=pad.buttons[i],i=i+1|0},update:function(){for(var i=0;i<this.buttons.length;)this.buttons[i].tapped=!1,i=i+1|0},combineData:function(pad){Bridge.referenceEquals(this.id,pad.id)&&(this.connected=pad.connected,this.axes=pad.axes,this.combineButtonData(pad.buttons))},combineButtonData:function(buttons){var Lb=buttons,i;for(this.buttons=buttons,i=0;i<buttons.length;)buttons[i].pressed&&!Lb[i].pressed&&(buttons[i].tapped=!0),i=i+1|0}});Bridge.define("BNTest.GamePadButton",{tapped:!1,pressed:!1,value:0,ctor:function(button){this.$initialize();this.pressed=button.pressed;this.value=button.value;this.tapped=!1}});Bridge.define("BNTest.GamePadManager",{statics:{_this:null},keyboard:null,gamepads:null,tempgamepads:null,ctor:function(){this.$initialize();this.gamepads=new(System.Collections.Generic.List$1(BNTest.GamePad));this.update()},getactiveGamepads:function(){return new(System.Collections.Generic.List$1(BNTest.GamePad))(System.Linq.Enumerable.from(this.gamepads).where($_.BNTest.GamePadManager.f1))},callBackTest:function(){Bridge.global.alert("Callback!")},getPad:function(id){var L=new(System.Collections.Generic.List$1(BNTest.GamePad))(System.Linq.Enumerable.from(this.gamepads).where(function(gamepad){return Bridge.referenceEquals(gamepad.id,id)}));return L.getCount()>0?L.getItem(0):null},update:function(){for(var i=0,pads,pad;i<this.gamepads.getCount();)this.gamepads.getItem(i).update(),i=i+1|0;for(i=0,this.tempgamepads=navigator.getGamepads()||navigator.webkitGetGamepads()||[],pads=new(System.Collections.Generic.List$1(BNTest.GamePad));i<this.tempgamepads.length;)this.tempgamepads[i]!=null&&(pad=new BNTest.GamePad(this.tempgamepads[i]),this._Update(pad),pads.add(pad)),i=i+1|0;for(i=0;i<pads.getCount();){for(var id=pads.getItem(i).id,j=0,ok=!0;j<this.gamepads.getCount();)Bridge.referenceEquals(this.gamepads.getItem(j).id,id)&&(ok=!1),j=j+1|0;ok&&this.gamepads.add(pads.getItem(i));i=i+1|0}},_Update:function(pad){for(var i=0,P;i<this.gamepads.getCount();)P=this.gamepads.getItem(i),Bridge.referenceEquals(P.id,pad.id)&&P.combineData(pad),i=i+1|0}});Bridge.ns("BNTest.GamePadManager",$_);Bridge.apply($_.BNTest.GamePadManager,{f1:function(gamepad){return gamepad.connected}});Bridge.define("BNTest.GamePlaySettings",{online:!1,myCharacter:"Reisen",gameMode:null,myTeam:1,blueNPCs:3,redNPCs:2,roomID:"",hostNPOut:null,computerAIModifier:1,ctor:function(){this.$initialize();this.gameMode=BNTest.GameMode.deathMatch}});Bridge.define("BNTest.GLColor",{statics:{white:null,config:{init:function(){this.white=new BNTest.GLColor(1,1,1)}},fromArgb:function(a,r,g,b){return new BNTest.GLColor(a/255,r/255,g/255,b/255)},colorFromAhsb:function(a,h,s,b){if(0===s)return BNTest.GLColor.createShade(b/255);var fMax,fMid,fMin,iSextant,iMax,iMid,iMin;.5<b?(fMax=b-b*s+s,fMin=b+b*s-s):(fMax=b+b*s,fMin=b-b*s);iSextant=Bridge.Int.clip32(Math.floor(h/60));300<=h&&(h-=360);h/=60;h-=2*Math.floor((iSextant+1)%6/2);fMid=0==iSextant%2?h*(fMax-fMin)+fMin:fMin-h*(fMax-fMin);iMax=System.Convert.toInt32(fMax*255);iMid=System.Convert.toInt32(fMid*255);iMin=System.Convert.toInt32(fMin*255);switch(iSextant){case 1:return BNTest.GLColor.fromArgb(a,iMid,iMax,iMin);case 2:return BNTest.GLColor.fromArgb(a,iMin,iMax,iMid);case 3:return BNTest.GLColor.fromArgb(a,iMin,iMid,iMax);case 4:return BNTest.GLColor.fromArgb(a,iMid,iMin,iMax);case 5:return BNTest.GLColor.fromArgb(a,iMax,iMin,iMid);default:return BNTest.GLColor.fromArgb(a,iMax,iMid,iMin)}},randomB:function(RMn,GMn,BMn,RMx,GMx,BMx){return RMn===void 0&&(RMn=0),GMn===void 0&&(GMn=0),BMn===void 0&&(BMn=0),RMx===void 0&&(RMx=1),GMx===void 0&&(GMx=1),BMx===void 0&&(BMx=1),new BNTest.GLColor(RMn+Math.random()*(RMx-RMn),GMn+Math.random()*(GMx-GMn),BMn+Math.random()*(BMx-BMn))},random$1:function(max){return new BNTest.GLColor(Math.random()*max,Math.random()*max,Math.random()*max,1)},random:function(){return new BNTest.GLColor(Math.random(),Math.random(),Math.random(),1)},random2:function(){return new BNTest.GLColor(Math.random(),Math.random(),Math.random(),Math.random())},createShade:function(Value){return new BNTest.GLColor(Value,Value,Value,1)},op_Addition:function(C1,C2){var R=BNTest.MathHelper.clamp(C1.r+C2.r),G=BNTest.MathHelper.clamp(C1.g+C2.g),B=BNTest.MathHelper.clamp(C1.b+C2.b);return new BNTest.GLColor(R,G,B,C1.a)},op_Subtraction:function(C1,C2){var R=BNTest.MathHelper.clamp(C1.r-C2.r),G=BNTest.MathHelper.clamp(C1.g-C2.g),B=BNTest.MathHelper.clamp(C1.b-C2.b);return new BNTest.GLColor(R,G,B,C1.a)},op_Multiply:function(C,brightness){return new BNTest.GLColor(C.r*brightness,C.g*brightness,C.b*brightness)}},a:0,r:0,g:0,b:0,ctor:function(R,G,B,A){R===void 0&&(R=0);G===void 0&&(G=0);B===void 0&&(B=0);A===void 0&&(A=1);this.$initialize();this.r=R;this.g=G;this.b=B;this.a=A},getRoughLength:function(){return Math.abs(this.r)+Math.abs(this.g)+Math.abs(this.b)},equals:function(o){var C=o;return C.r===this.r&&C.g===this.g&&C.b===this.b&&C.a===this.a},similar:function(C){if(this.equals(C))return!0;var R=Math.abs(this.r-C.r),G=Math.abs(this.g-C.g),B=Math.abs(this.b-C.b);return R+G+B<=.0075},toARGB:function(){var R=Bridge.Int.clip32(this.r*255),G=Bridge.Int.clip32(this.g*255),B=Bridge.Int.clip32(this.b*255),A=Bridge.Int.clip32(this.a*255);return((Bridge.Int.clip32(this.r*255)+(Bridge.Int.clip32(this.g*255)<<8)|0)+(Bridge.Int.clip32(this.b*255)<<16)|0)+(Bridge.Int.clip32(this.a*255)<<24)|0},fromArgb:function(ARGB){var R=(ARGB&255)/255,G=(ARGB>>8&255)/255,B=(ARGB>>16&255)/255,A=(ARGB>>24&255)/255;return new BNTest.GLColor(R,G,B,A)},setAhsb:function(h,s,b){var C=BNTest.GLColor.colorFromAhsb(255,h,s,b);this.r=C.r;this.g=C.g;this.b=C.b},copy:function(C){this.a=C.a;this.r=C.r;this.g=C.g;this.b=C.b},add:function(C){this.r=BNTest.MathHelper.clamp(this.r+C.r);this.g=BNTest.MathHelper.clamp(this.g+C.g);this.b=BNTest.MathHelper.clamp(this.b+C.b)},add$1:function(R,G,B){this.r=BNTest.MathHelper.clamp(this.r+R);this.g=BNTest.MathHelper.clamp(this.g+G);this.b=BNTest.MathHelper.clamp(this.b+B)},clone:function(){return new BNTest.GLColor(this.r,this.g,this.b,this.a)}});Bridge.define("BNTest.GLDemo",{statics:{allowAlpha:!0,VK_Enter:13,_this:null,missingTime:0,lastTime:0,updated:!0,doDrawScene:function(elapsedTime){requestAnimationFrame(BNTest.GLDemo.doDrawScene);BNTest.GLDemo.lastTime===0&&(BNTest.GLDemo.lastTime=elapsedTime);var T=elapsedTime-BNTest.GLDemo.lastTime;BNTest.GLDemo._this.paused||BNTest.GLDemo._this.gameDisabled||(BNTest.GLDemo._this.totaltime+=T);BNTest.GLDemo.missingTime+=T;BNTest.GLDemo.missingTime>48&&(BNTest.GLDemo.missingTime=35);BNTest.GLDemo.updated&&(BNTest.GLDemo._this.serverMode||BNTest.GLDemo._this.drawScene(elapsedTime),BNTest.GLDemo.updated=!1);BNTest.GLDemo._this.update(elapsedTime);BNTest.GLDemo.missingTime-=16.6667;BNTest.GLDemo.updated=!0;BNTest.GLDemo.missingTime>=16.6667&&(BNTest.GLDemo._this.update(elapsedTime),BNTest.GLDemo.missingTime-=16.6667,BNTest.GLDemo.updated=!0);BNTest.GLDemo.lastTime=elapsedTime},test:function(self){self._test()}},canvas:null,gl:null,shaderProgram:null,cubeVerticesBuffer:null,cubeVerticesColorBuffer:null,cubeVerticesIndexBuffer:null,vertexPositionAttribute:0,vertexColorAttribute:0,localplayer:null,boss:null,netPlayNeedsFlush:!1,cameracontrols:!1,matrixNeedsFlush:!0,vertexTextureCoordAttribute:0,samplerUniform:null,alphaUniform:null,colorUniform:null,lightPosUniform:null,darknessLevelUniform:null,ambientLightLevel:null,defaultDarknessLevel:.0007,defaultAmbientLightLevel:.6,currentSong:0,serverMode:!1,world:null,camera:null,skippedWave:!1,foliage:null,guiVisible:!0,hoster:!0,showVertCounter:!1,fogActive:!1,cameraDist:300,lastCameraDist:0,lastZnear:0,bGMVolume:.4,bGMMute:!1,masterVolume:1,gameDisabled:!1,gamePlaySettings:null,currentAlpha:1,alphalist:null,cubeRotation:0,cubeXOffset:0,cubeYOffset:0,cubeZOffset:0,lastCubeUpdateTime:0,theDepthFunc:0,xIncValue:0,yIncValue:0,zIncValue:0,mouseAngle:0,loadProgress:0,maxLoadProgress:0,maxLoadQueue:0,model:null,perspectiveMatrix:null,mvMatrix:null,matrix:null,depthTest:!1,entities:null,players:null,online:!1,frame:0,music:null,lastMusic:null,VTS:null,TS:null,LTS:null,BTS:null,CTS:null,radar:null,ended:!0,gameover:!1,started:!1,totaltime:0,lastsong:"",titleRunning:!1,titlescreen:!0,defaultBulletSpeedRate:.65,bulletSpeedRate:1,lightLevel:1,currentlightlevel:1,testobj:null,characters:null,CS:null,startButton:null,shopButton:null,shop:null,wavetime:3,wave:0,enemyList:null,smooth:!0,lastModelName:"rahmoo",lastModel:null,nPCSpawntime:0,dNPCSpawntime:7500,nextSpawn:0,nPCs:0,maxWaveDelay:150,waveDelay:0,paused:!1,latencyM:100,dlatency:0,tflat:null,FA:null,temp:null,mvMatrixStack:null,pUniform:null,mvUniform:null,config:{init:function(){this.alphalist=[];this.matrix=new BNTest.WGMatrix;this.entities=new(System.Collections.Generic.List$1(BNTest.Entity));this.players=new(System.Collections.Generic.List$1(BNTest.Player));this.VTS=new BNTest.TextSprite;this.TS=new BNTest.TextSprite;this.LTS=new BNTest.TextSprite;this.BTS=new BNTest.TextSprite;this.CTS=new BNTest.TextSprite;this.radar=new BNTest.Sprite;this.tflat=System.Array.init(16,0);this.FA=new Float32Array(16);this.temp=new BNTest.WGMatrix;this.mvMatrixStack=[]}},start:function(canvas){var self,path,f,isFirefox,character,PC,box,c,hp,F,B,BS,V,tree,fi;if(this.canvas=canvas,self=this,this.enemyList=System.Array.init(0,null),this.initFeatures(),this.VTS.setText(System.String.concat("Version:",BNTest.App.gameVersion)),this.VTS.setFontSize(16),this.VTS.setTextColor("#FFFFFF"),this.VTS.setShadowBlur(5),this.VTS.setShadowOffset(new BNTest.Vector2(3,3)),this.VTS.setShadowColor("#000000"),this.CTS.alpha=0,this.CTS.setText("Combo:0"),this.CTS.setFontSize(32),this.CTS.setTextColor("#FFFFFF"),this.CTS.setShadowBlur(5),this.CTS.setShadowOffset(new BNTest.Vector2(3,3)),this.CTS.setShadowColor("#000000"),this.CTS.position=new BNTest.Vector2(830,660),this.radar.spriteBuffer.width=(this.radar.spriteBuffer.height=150,150),BNTest.AudioManager.init(),BNTest.AnimationLoader.directory="Assets/Images/",BNTest.AudioManager.directory="Assets/Audio/",path="Assets/Images.zip",f=System.String.concat(path,"://rahmoo_0.png"),console.log(System.String.concat("test zip path:",f)),isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,isFirefox?(this.bGMVolume*=.75,BNTest.AnimationLoader.get_this().jzip!=null&&BNTest.AnimationLoader.get_this().setZip("Assets/Images.zip")):BNTest.AnimationLoader.get_this().setZip("Assets/Images.zip"),BNTest.App.DEBUG&&(this.bGMMute=!0),this.initWebGL(canvas),this.playMusic("titlescreen",.6),BNTest.GLDemo._this=this,this.gl!=null){this.gl.clearColor(0,0,0,1);this.gl.clearColor(.5,.75,.95,1);this.gl.clearDepth(1);this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.FRONT);BNTest.GLDemo.allowAlpha?(this.depthTest=!0,this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA)):(this.depthTest=!0,this.gl.enable(this.gl.DEPTH_TEST),this.setDepthFunc(this.gl.LEQUAL));this.initShaders();this.initBuffers();Bridge.global.requestAnimationFrame(BNTest.GLDemo.doDrawScene);this.camera=new BNTest.Model(self);this.camera.rotation.x=40;this.world=new BNTest.World(self);this.camera.children.add(this.world.model);this.foliage=new BNTest.Foliage(this.world);this.generateFloor();this.world.add(this.foliage);this.gamePlaySettings=new BNTest.GamePlaySettings;this.gamePlaySettings.gameMode=BNTest.GameMode.teamBattle;this.localplayer=new BNTest.Player(!0,!1);character="default";PC=new BNTest.PlayerCharacter(this.world,this.localplayer,character);this.localplayer.character=PC;PC.getPosition().y=-15e3;PC.setCoins(1e3);PC.defense=5;PC.model.setVisible(!1);PC.setHitboxSize(PC.getHitboxSize()*.35);this.world.add(PC);box=new BNTest.DonationBox(this.world);this.world.add(box);c=new BNTest.Coin(this.world);c.solid=!1;c.setPosition(new BNTest.GLVec3.ctor(50,1e4,50));c.getBehavior(BNTest.LifeSpan).HP=1;c.model.setVisible(!1);this.world.add(c);hp=new BNTest.HPOrb(this.world);hp.solid=!1;hp.setPosition(new BNTest.GLVec3.ctor(50,1e4,50));hp.getBehavior(BNTest.LifeSpan).HP=1;hp.model.setVisible(!1);this.world.add(hp);F=this.foliage;this.world.add(F);B=this.world.model.getBoundingBox();BS=B.getSize();BS.y=0;var max=40,i=max,RND=new System.Random.ctor,FC=[new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,0,1),new BNTest.GLColor(0,0,1)],shrub=new BNTest.GLColor(0,.6,.1),rng=800,rng2=rng+rng|0,range=new BNTest.GLVec3.ctor(rng2,-5,rng2),hrange=new BNTest.GLVec3.ctor(rng,-15,rng);for(box.lastBB=BNTest.BoundingBox.op_Addition(new BNTest.BoundingBox.$ctor2(40),box.model.offset);i>0;){for(V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V,!0)&&(tree=new BNTest.Tree(this.world),tree.setPosition(new BNTest.GLVec3.ctor(V.x,tree.getPosition().y,V.z)),this.world.add(tree),tree.cacheBoundingBox(),tree.lastBB=BNTest.BoundingBox.op_Addition(tree.customBoundingBox,tree.getPosition()),F.absorbModel$1(tree.model)),fi=7;fi>0;)V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V)&&(V.y=7,F.addFlower(V,BNTest.HelperExtensions.pick(BNTest.GLColor,FC),null,2+Math.random()*3)),fi=fi-1|0;for(fi=3,fi=2;fi>0;)V=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange),this.safeForFoliage(V)&&(V.y=8,F.addPatch(V,shrub,15+Bridge.Int.clip32(Math.random()*15)|0,.1+Math.random()*.2,2.5+Math.random()*2.5)),fi=fi-1|0;i=i-1|0}BNTest.AnimationLoader.get_this().asyncGet$1(["object/mushroom"],Bridge.fn.bind(this,function(){var $t,OVM=BNTest.VoxelMap.fromImages$1("object/mushroom"),pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),C=new BNTest.GLColor,C2=new BNTest.GLColor(1,1,1),VM,mod,V1,msh;for(pal.set(new BNTest.GLColor(1,0,0),C),pal.set(new BNTest.GLColor(1,1,1),C2),i=max*2|0,VM=OVM.clone(),mod=new BNTest.Model(this);i>0;)V1=BNTest.GLVec3.random(range,RND),V1.subtract(hrange),this.safeForFoliage(V1)&&(V1.y=4,C2.a=C2.r=C2.g=C2.b=1,C.setAhsb(Math.random(),Math.random(),Math.random()),Math.random()<.5&&C2.copy(C),VM.copyFrom(OVM),VM.applyPalette(pal),VM.addNoise(.1*Math.random()),msh=new BNTest.Mesh(this),msh.addVoxelMap(VM,!0),mod.meshes.add(msh),mod.offset=V1,mod.rotation.y=Math.random()*360,mod.scale.y=.75+Math.random()*.7,mod.scale.x=($t=mod.scale.y*(.75+Math.random()*.7),mod.scale.z=$t,$t),this.foliage.absorbModel$1(mod),mod.meshes.remove(msh)),i=i-1|0}))}},playMusic:function(song,volume){(volume===void 0&&(volume=1),Bridge.referenceEquals(song,this.lastsong)||this.serverMode)||(this.lastMusic!=null&&(this.lastMusic.stop(),this.lastMusic=null),this.lastMusic=this.music,this.music=BNTest.AudioManager.get_this().play(System.String.concat(System.String.concat("BGM/",song),".ogg"),!0),this.music.setVolume(0),this.lastsong=song)},updateAudio:function(){var spd=.004,vol;this.lastMusic!=null&&(this.lastMusic.setVolume(BNTest.MathHelper.clamp(this.lastMusic.getVolume()-spd)),this.lastMusic.getVolume()<=0&&(this.lastMusic.stop(),this.lastMusic=null));this.music==null||this.bGMMute||(vol=this.bGMVolume*this.masterVolume,this.music.getVolume()<vol&&this.music.setVolume(BNTest.MathHelper.clamp(this.music.getVolume()+spd,0,vol)))},safeForFoliage:function(V,solid){var Bnds,VL;return(solid===void 0&&(solid=!1),Bnds=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Subtraction(V,BNTest.GLVec3.createUniform(-25)),BNTest.GLVec3.op_Addition(V,BNTest.GLVec3.createUniform(80))),this.world.findSolidCollision(Bnds).length<=0&&(!solid||(VL=V.getRoughLength(),VL>=250||Math.abs(V.z-60)>150)))?!0:!1},setBarriers:function(box,thickness){thickness===void 0&&(thickness=1);var size=box.getSize(),B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(size.x,size.y,thickness));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,0)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(size.x,size.y,thickness));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,size.z)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(thickness,size.y,size.z));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(size.x,0,0)));this.world.add(B);B=new BNTest.Barrier(this.world,new BNTest.GLVec3.ctor(thickness,size.y,size.z));B.setPosition(BNTest.GLVec3.op_Addition(box.min,new BNTest.GLVec3.ctor(0,0,0)));this.world.add(B)},addNPC:function(){var Char="suika",NPC;this.nPCs>=this.enemyList.length||(Char=this.enemyList[this.nPCs],NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0,!0),Char),this.setNPC(NPC),this.world.add(NPC),this.nPCs=this.nPCs+1|0)},setNPC:function(NPC){var DP=System.Linq.Enumerable.from(this.world.entities).first($_.BNTest.GLDemo.f1),mindist=250,range=500-mindist,dist=mindist+Math.random()*range,V=BNTest.Vector2.op_Multiply(BNTest.Vector2.fromRadian(6.28*Math.random()),dist);NPC.setx(V.x+DP.getx());NPC.sety(-500);NPC.setz(V.y+DP.getz());NPC.speed=new BNTest.GLVec3.ctor;NPC.setHP(100)},addRisingPlatforms:function(number){var A=number+.5,B=new BNTest.BoundingBox.$ctor2(50),rng=400,rng2=rng+rng|0,hrng6=rng*1.5,range=new BNTest.GLVec3.ctor(rng2,-55,rng2),hrange=new BNTest.GLVec3.ctor(rng,-65,rng),RND=new System.Random.ctor,max=400,min=50,DP=System.Linq.Enumerable.from(this.world.entities).first($_.BNTest.GLDemo.f1).getPosition(),sz,pr,NP,R;DP=BNTest.GLVec3.op_Addition(DP,new BNTest.GLVec3.ctor(0,0,-30));for(var rate=.45,irate=1-rate,mx2=max*(rate+.15),P=null,mmax=(max*max|0)*.12;A>=1;){sz=BNTest.GLVec3.op_Multiply(BNTest.GLVec3.createUniform(min+(max-min|0)*RND.nextDouble()),new BNTest.GLVec3.ctor(.3+.7*RND.nextDouble(),.1+.3*RND.nextDouble(),.3+.7*RND.nextDouble()));B.setSize(sz);Math.random()<.2||P==null?P=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(range,RND),hrange):(pr=.111111112,NP=BNTest.GLVec3.op_Subtraction(BNTest.GLVec3.random(BNTest.GLVec3.op_Multiply$1(range,pr),RND),BNTest.GLVec3.op_Multiply$1(hrange,pr)),P.add(NP),P.y=NP.y);var C=BNTest.BoundingBox.op_Addition(B,P),S=Math.abs(sz.x)*Math.abs(sz.z),PD=P.roughDistance(DP);PD>mx2+Math.max(Math.abs(sz.x),Math.abs(sz.z))*irate&&PD<=hrng6&&S<mmax&&System.Linq.Enumerable.from(this.world.findSolidCollision(C)).where($_.BNTest.GLDemo.f2).toArray().length<=0&&(R=new BNTest.RisingPlatform(this.world,B),this.world.add(R),R.setPosition(P),A-=1);A-=.025}},generateFloor:function(){var rndshft=!1,self=this,scl=4,sz=80,size=2,floor,cx,cz,B;rndshft&&(sz=Bridge.Int.div(sz,2)|0,size=size*2|0);var hsz=Bridge.Int.div(sz,2)|0,Vsz=new BNTest.GLVec3.ctor(hsz,0,hsz),Depth=2,centered=!0,yr=0,yr2=yr+yr|0,FVM=BNTest.VoxelMap.gen(sz,Depth,0,!0,!1,!0),msh=new BNTest.Mesh(self);msh.addVoxelMap(FVM,!1,centered,!0);rndshft&&(msh.randomShift(.15),msh.scale.x=1.04,msh.scale.z=1.04);floor=new BNTest.Entity(this.world);floor.model=new BNTest.Model(self);for(var $final=floor,rots=[0,90,180,270],V,x=-size|0,z=-size|0;x<=size;){while(z<=size)floor=new BNTest.Entity(this.world),floor.model=new BNTest.Model(self),floor.sety((10-yr|0)+Math.random()*yr2),centered&&floor.sety(floor.gety()+Depth*scl*.5),floor.getScale().x=scl,floor.getScale().y=floor.getScale().x,floor.getScale().z=floor.getScale().x,V=BNTest.GLVec3.op_Multiply$1(Vsz,floor.getScale().x),floor.setx(-V.x),floor.setz(-V.z),cx=x,cz=z,centered&&(cx+=.5,cz+=.5),floor.setx(floor.getx()+V.x*cx*2),floor.setz(floor.getz()+V.z*cz*2),floor.model.meshes.add(msh.clone()),floor.cacheBoundingBox(),this.world.add(floor),floor.model.rotation.y=BNTest.HelperExtensions.pick(System.Double,rots),this.foliage.absorbModel(floor),z=z+1|0;z=-size|0;x=x+1|0}B=this.world.model.getBoundingBox();B.min.y-=200;this.setBarriers(B,5)},setDepthFunc:function(DF){this.gl.depthFunc(DF);this.theDepthFunc=DF},setDepthTest:function(active){this.depthTest!==active&&(this.depthTest=active,active?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST))},initFeatures:function(){var FC=new BNTest.FeatureCategory,FI,F,cost,self,A;this.characters=FC;FC.name="Characters";FC.oneOnly=!0;FI=FC.items;F=new BNTest.FeatureItem;F.name="Reimu";F.category=FC;F.cost=0;F.setPurchased(!0);F.requirements=$_.BNTest.GLDemo.f3;FI.add(F);F=new BNTest.FeatureItem;F.name="Cirno";F.category=FC;F.cost=90;F.requirements=$_.BNTest.GLDemo.f4;FI.add(F);cost=200;F=new BNTest.FeatureItem;F.name="Sanae";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f5;FI.add(F);F=new BNTest.FeatureItem;F.name="Reisen";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f6;FI.add(F);F=new BNTest.FeatureItem;F.name="Youmu";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f7;FI.add(F);F=new BNTest.FeatureItem;F.name="Koishi";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f8;FI.add(F);F=new BNTest.FeatureItem;F.name="Marisa";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f9;FI.add(F);F=new BNTest.FeatureItem;F.name="Tenshi";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f10;FI.add(F);F=new BNTest.FeatureItem;F.name="Flandre";F.category=FC;F.cost=cost;F.requirements=$_.BNTest.GLDemo.f11;FI.add(F);this.CS=new BNTest.CharacterSelect(FC);this.startButton=new BNTest.ButtonSprite.$ctor1("Start Game",63);this.startButton.position=new BNTest.Vector2(680,400);self=this;this.startButton.onClick=function(){self.startGame()};this.shopButton=new BNTest.ButtonSprite.$ctor1("Shop",50);this.shopButton.position=new BNTest.Vector2(680,550);A=System.Int32.parse(BNTest.App.storage.MaxLevel);this.shopButton.onClick=Bridge.fn.bind(this,$_.BNTest.GLDemo.f12);this.shop=new BNTest.ShopScreen(FC);this.shop.visible=!1},endWave:function(){var P,i,hp,m,m2,rate,money,ml;if(this.boss=null,this.wave>=1&&!this.skippedWave){for(P=System.Linq.Enumerable.from(this.world.entities).first($_.BNTest.GLDemo.f1).getPosition(),i=4;i>0;)hp=new BNTest.HPOrb(this.world),hp.setPosition(new BNTest.GLVec3.ctor(0,-20,0)),hp.getPosition().add(P),hp.solid=!1,m=3,m2=m+m|0,hp.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),hp.speed.y=-1+(-m|0)*Math.random(),hp.pickupDelay=15,this.world.add(hp),i=i-1|0;rate=.005;rate+=this.wave*.0005;money=Bridge.Int.clip32(this.localplayer.character.getCoins()*rate);BNTest.App.storage.Mon=System.Int32.parse(BNTest.App.storage.Mon)+money;ml=System.Int32.parse(BNTest.App.storage.MaxLevel);this.wave>ml&&(BNTest.App.storage.MaxLevel=this.wave)}this.clearEntities()},nextWave:function(skip){var E,basetime,DB,L,D,NPC,T;if(skip===void 0&&(skip=10),this.endWave(),this.wave=this.wave+1|0,this.wave%4==1){this.playNextSong(this.wave>1);for(var i=0,LE=this.world.entities,ln=LE.getCount();i<ln;)E=LE.getItem(i),E.active&&(E.active=!1),i=i+1|0;this.addRisingPlatforms(24)}if(this.bulletSpeedRate=this.defaultBulletSpeedRate+this.wave*.01,this.bulletSpeedRate=Math.min(this.bulletSpeedRate,2.5),this.waveDelay=this.maxWaveDelay,this.totaltime=0,this.nPCs=0,this.nextSpawn=-((this.nPCSpawntime-1)*(Bridge.Int.div(skip,2)|0)),this.started=!0,basetime=.5,DB=System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.DonationBox).toArray()[0],DB.maxHP=DB.defaultMaxHP,this.nPCSpawntime=this.dNPCSpawntime,this.enemyList=System.Array.init(0,null),L=this.enemyList,D=1,this.wave===1)BNTest.Helper.addMultiple(String,L,"suika",15),BNTest.Helper.addMultiple(String,L,"cirno",1),BNTest.Helper.addMultiple(String,L,"suika",6),DB.maxHP=DB.maxHP*2|0,D=1.2;else if(this.wave===2)BNTest.Helper.addMultiple(String,L,"suika",13),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"suika",8);else if(this.wave===3)BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"cirno",4),BNTest.Helper.addMultiple(String,L,"suika",10);else if(this.wave===4)BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"cirno",4),BNTest.Helper.addMultiple(String,L,"suika",10);else if(this.wave===5)BNTest.Helper.addMultiple(String,L,"suika",8),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"cirno",3),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"suika",4),BNTest.Helper.addMultiple(String,L,"cirno",2),BNTest.Helper.addMultiple(String,L,"suika",3);else if(this.wave===6)BNTest.Helper.addMultiple(String,L,"suika",10),D=.8,BNTest.Helper.addMultiple(String,L,"sakuya",3),BNTest.Helper.addMultiple(String,L,"suika",8);else if(this.wave===7)BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"sakuya",1),BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sakuya",2);else if(this.wave===9)D=.81,BNTest.Helper.addMultiple(String,L,"cirno",27),basetime=.27;else if(this.wave===10)D=.9,BNTest.Helper.addMultiple(String,L,"suika",7),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",5),BNTest.Helper.addMultiple(String,L,"suika",6);else if(this.wave===11)D=.85,BNTest.Helper.addMultiple(String,L,"cirno",3),BNTest.Helper.addMultiple(String,L,"suika",4),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",3),BNTest.Helper.addMultiple(String,L,"suika",14);else if(this.wave===12)D=.9,BNTest.Helper.addMultiple(String,L,"sanae",4),BNTest.Helper.addMultiple(String,L,"suika",12),BNTest.Helper.addMultiple(String,L,"aya",1),BNTest.Helper.addMultiple(String,L,"suika",6),BNTest.Helper.addMultiple(String,L,"aya",1),BNTest.Helper.addMultiple(String,L,"suika",4);else if(this.wave===13)D=.35,BNTest.Helper.addMultiple(String,L,"suika",50);else if(this.wave===14)BNTest.Helper.addMultiple(String,L,"suika",10),BNTest.Helper.addMultiple(String,L,"sakuya",2),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"suika",2),BNTest.Helper.addMultiple(String,L,"youmu",1),BNTest.Helper.addMultiple(String,L,"suika",5),BNTest.Helper.addMultiple(String,L,"youmu",1),BNTest.Helper.addMultiple(String,L,"suika",7);else if(this.wave===15)BNTest.Helper.addMultiple(String,L,"nazrin",8),BNTest.Helper.addMultiple(String,L,"aya",2),BNTest.Helper.addMultiple(String,L,"sanae",2),BNTest.Helper.addMultiple(String,L,"suika",12);else if(this.wave===18)BNTest.Helper.addMultiple(String,L,"suika",10),BNTest.Helper.addMultiple(String,L,"reisen",2),BNTest.Helper.addMultiple(String,L,"sanae",1),BNTest.Helper.addMultiple(String,L,"suika",3),BNTest.Helper.addMultiple(String,L,"sakuya",1),BNTest.Helper.addMultiple(String,L,"reisen",1),BNTest.Helper.addMultiple(String,L,"suika",6);else if(this.wave===22||this.wave%10!=0&&this.wave>26&&Math.random()<=.07)BNTest.Helper.addMultiple(String,L,"suika",10),BNTest.Helper.addMultiple(String,L,"rumia",5),BNTest.Helper.addMultiple(String,L,"cirno",3),BNTest.Helper.addMultiple(String,L,"suika",6),BNTest.Helper.addMultiple(String,L,"rumia",1),BNTest.Helper.addMultiple(String,L,"cirno",1),BNTest.Helper.addMultiple(String,L,"suika",4);else if(this.wave===101)D=.25,BNTest.Helper.addMultiple(String,L,"suika",101);else if(this.wave>0&&this.wave%8==0){for(var bosses=["koishi","marisa","tenshi","flandre"],Char="",i1=Bridge.Int.div(this.wave-8|0,8)|0;i1>=bosses.length;)i1=i1-bosses.length|0;Char=bosses[i1];NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0),Char);NPC.defense=12+(Bridge.Int.div(this.wave,3)|0)|0;this.setNPC(NPC);this.world.add(NPC);this.boss=NPC;BNTest.Helper.addMultiple(String,L,"sanae",1);BNTest.Helper.addMultiple(String,L,"cirno",1);BNTest.Helper.addMultiple(String,L,"suika",15)}L.length===0&&this.doRandomWave();this.nPCSpawntime*=D;T=this.nPCSpawntime/1e3;T/=60;T*=.5;this.wavetime=(this.enemyList.length-skip|0)*T+basetime;this.skippedWave=!1},doRandomWave:function(){var difficulty=this.wave*.1,max=Math.min(50,20+difficulty),pool=System.Array.init(0,null),RND,i;for(BNTest.Helper.addMultiple(String,pool,"suika",60),BNTest.Helper.addMultiple(String,pool,"cirno",12),BNTest.Helper.addMultiple(String,pool,"sanae",Bridge.Int.clip32(10+difficulty*2)),BNTest.Helper.addMultiple(String,pool,"sakuya",Bridge.Int.clip32(4+difficulty*1.6)),BNTest.Helper.addMultiple(String,pool,"aya",Bridge.Int.clip32(2+difficulty*1.3)),BNTest.Helper.addMultiple(String,pool,"youmu",Bridge.Int.clip32(2+difficulty*1.1)),this.wave>20&&(BNTest.Helper.addMultiple(String,pool,"reisen",Bridge.Int.clip32(2+difficulty*1.1)),BNTest.Helper.addMultiple(String,pool,"nazrin",Bridge.Int.clip32(5+difficulty*2))),RND=new System.Random.ctor,i=0;i<max;)this.enemyList.push(BNTest.HelperExtensions.pick(String,pool,RND)),i=i+1|0},startGame:function(){var Char,LPC,PC;this.ended&&BNTest.AnimationLoader.get_this().isIdle()&&(this.localplayer.character==null&&(this.localplayer.character=new BNTest.PlayerCharacter(this.world,this.localplayer,"default")),this.gameover&&(this.localplayer.lives=3,this.localplayer.character.setCoins(1e3),this.localplayer.character.setHP(100),this.wave=0),this.currentSong=0,this.guiVisible=!0,BNTest.KeyboardManager.update(),Char=this.CS.menu.getSelectedText(),Char=Char.toLowerCase(),LPC=this.localplayer.character,Bridge.referenceEquals(Char,LPC.char)||(this.localplayer.character=null,this.world.remove(LPC),PC=new BNTest.PlayerCharacter(this.world,this.localplayer,Char,LPC.team),this.localplayer.character=PC,this.world.add(PC),PC.setPosition(LPC.getPosition()),PC.setHP(LPC.getHP()),PC.setCoins(LPC.getCoins()),PC.defense=LPC.defense,PC.setHitboxSize(LPC.getHitboxSize()),PC.respawnPosition=LPC.respawnPosition),this.gameDisabled=!1,BNTest.App.guiCanvas.style.opacity="0.85",this.titleRunning=!1,this.titlescreen=!1,this.world.add(this.localplayer.character),this.localplayer.character.setPosition(new BNTest.GLVec3.ctor(0,-15,0)),this.world.model.rotation.y=0,this.gameover=!1,this.ended=!1,this.localplayer.character.respawnPosition=this.localplayer.character.getPosition().clone(),this.nextWave(),this.clearEntities())},playNextSong:function(next){next===void 0&&(next=!0);next&&(this.currentSong=this.currentSong+1|0);this.currentSong=this.currentSong%4;this.playMusic(System.String.concat("music",this.currentSong))},playStageMusic:function(){var i=(Bridge.Int.div(this.wave-1|0,8)|0)+1|0;i=i+1|0;i=i%2;this.playMusic(System.String.concat("music",i))},updateControls:function(){var $t,$t1,x,y,cid,o;this.CS.visible&&!this.shop.visible&&(this.CS.update(),this.startButton.checkClick(),this.shopButton.checkClick());this.shop.visible&&this.shop.update();BNTest.App.DEBUG&&this.updateDebug();BNTest.KeyboardManager.get_this().tappedButtons.contains(77)&&(this.lastMusic!=null&&(this.lastMusic.stop(),this.lastMusic=null),this.music.getVolume()===0?(this.music.setVolume(this.bGMVolume),this.bGMMute=!1):(this.music.setVolume(0),this.bGMMute=!0));BNTest.KeyboardManager.get_this().tappedButtons.contains(BNTest.GLDemo.VK_Enter)&&!this.ended&&(this.paused=!this.paused);BNTest.KeyboardManager.get_this().tappedButtons.contains(48)&&(this.radar.visible=!this.radar.visible);BNTest.KeyboardManager.get_this().pressedButtons.contains(219)&&(this.frame&3)==0&&(this.radar.spriteBuffer.height=($t=Math.min(this.radar.spriteBuffer.width+3|0,500),this.radar.spriteBuffer.width=$t,$t));BNTest.KeyboardManager.get_this().pressedButtons.contains(221)&&(this.frame&3)==0&&(this.radar.spriteBuffer.height=($t1=Math.max(this.radar.spriteBuffer.width-3|0,15),this.radar.spriteBuffer.width=$t1,$t1));var PC=this.localplayer.character,threshhold=.7,C=null;(PC!=null&&(C=PC.controller),BNTest.App.IC!=null&&C!=null)&&(x=BNTest.App.IC.getState(0),y=BNTest.App.IC.getState(1),C[0]=x<=-threshhold,C[1]=x>=threshhold,C[2]=y<=-threshhold,C[3]=y>=threshhold,cid=BNTest.App.IC.getMapControllerID$1(5),(Bridge.referenceEquals(cid,"Keyboard")||Bridge.referenceEquals(cid,"Mouse"))&&(C[4]=BNTest.App.IC.getPressed(2),C[5]=BNTest.App.IC.getPressed(3),C[6]=BNTest.App.IC.getPressed(4)),C[4]=BNTest.App.IC.getPressed(2),C[5]=BNTest.App.IC.getPressed(3),C[6]=BNTest.App.IC.getPressed(4),o={})},rotateTest:function(M,val){val===void 0&&(val="x");M.Dir==null&&(M.Dir=1);M.Max==null&&(M.Max=45);M.Spd==null&&(M.Spd=1.5);var max=System.Nullable.getValue(Bridge.cast(M.Max,System.Double)),spd=System.Nullable.getValue(Bridge.cast(M.Spd,System.Double));M.rotation[val]=System.Nullable.getValue(Bridge.cast(M.rotation[val],System.Double))+spd*System.Nullable.getValue(Bridge.cast(M.Dir,System.Double));Math.abs(System.Nullable.getValue(Bridge.cast(M.rotation[val],System.Double)))>=max&&(M.Dir=-System.Nullable.getValue(Bridge.cast(M.Dir,System.Double)))},initWebGL:function(canvas){this.gl=null;try{this.gl=canvas.getContext("experimental-webgl")}catch(e){e=System.Exception.create(e)}this.gl==null&&Bridge.global.alert("Unable to initialize WebGL. Your browser may not support it.")},initBuffers:function(){var vertices,colors,generatedColors,j,c,i,cubeVertexIndices;for(this.cubeVerticesBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVerticesBuffer),vertices=[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(vertices),this.gl.STATIC_DRAW),colors=[[1,1,1,1],[1,0,0,1],[0,1,0,1],[0,0,1,1],[1,1,0,1],[1,0,1,1]],generatedColors=[],j=0;j<6;j=j+1|0)for(c=colors[j],i=0;i<4;i=i+1|0)generatedColors=generatedColors.concat(c);this.cubeVerticesColorBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cubeVerticesColorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(generatedColors),this.gl.STATIC_DRAW);this.cubeVerticesIndexBuffer=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer);cubeVertexIndices=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(cubeVertexIndices),this.gl.STATIC_DRAW)},getVoxelCombo:function(assets){var A,VM;if(assets==null||assets.length===0)return null;for(var ret=null,i=0,ok=!0;i<assets.length;)A=BNTest.AnimationLoader.get(assets[i]),A!=null&&A.getCount()>0&&ok?(VM=BNTest.VoxelMap.fromImages(A),ret==null?ret=VM:VM!=null?ret.combine(VM):(ret=null,ok=!1)):ok=!1,i=i+1|0;return ret},attack:function(target,source){if(target.BNTest$ICombatant$onDamaged(source,source.BNTest$IHarmfulEntity$gettouchDamage()),target.playSound("hit"),target.BNTest$ICombatant$getHP()<=0&&target.getHandledLocally()){var D={};D.I=target.ID;D.A=source.BNTest$IHarmfulEntity$getAttacker().ID;D.S=source.ID;this.sendEvent("Kill",D)}},update:function(){if(!this.paused){if(!this.gameDisabled)if(this.waveDelay>0)this.totaltime=0,this.waveDelay=this.waveDelay-1|0;else if(this.totaltime>this.nextSpawn&&!this.ended&&BNTest.AnimationLoader.get_this().isIdle()){this.nextSpawn+=this.nPCSpawntime;for(var i=2;i>0;)this.addNPC(),i=i-1|0}this.world.update()}},updateDebug:function(){var Char,NPC,Char1,LPC,PC,wav,i;BNTest.KeyboardManager.get_this().tappedButtons.contains(70)&&(this.fogActive=!this.fogActive,this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),this.fogActive));BNTest.KeyboardManager.get_this().tappedButtons.contains(82)&&(BNTest.KeyboardManager.allowRightClick=!BNTest.KeyboardManager.allowRightClick);BNTest.KeyboardManager.get_this().tappedButtons.contains(67)&&(this.cameracontrols=!this.cameracontrols,this.camera.rotation.y=0);BNTest.KeyboardManager.get_this().tappedButtons.contains(66)&&BNTest.AnimationLoader.get_this().isIdle()&&!this.ended&&this.boss==null&&(Char="marisa",NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0),Char),NPC.defense=15+this.wave|0,this.setNPC(NPC),NPC.setHP(10),this.world.add(NPC),this.boss=NPC);BNTest.KeyboardManager.get_this().tappedButtons.contains(78)&&!this.ended&&(this.localplayer.character.setCoins(this.localplayer.character.getCoins()+100|0),this.waveDelay=0,this.wavetime=0,this.skippedWave=!0,this.nextWave());BNTest.KeyboardManager.get_this().tappedButtons.contains(79)&&!this.ended&&(this.gameDisabled=!this.gameDisabled,this.gameDisabled?this.clearEntities():(this.skippedWave=!0,this.clearEntities(),this.wave=this.wave-1|0,this.nextWave()));BNTest.KeyboardManager.get_this().tappedButtons.contains(88)&&this.localplayer.character.model.smoothen(.7);BNTest.KeyboardManager.get_this().tappedButtons.contains(90)&&(Char1=Bridge.global.prompt("Enter a character name","Reimu"),Char1=Char1.toLowerCase(),LPC=this.localplayer.character,Bridge.referenceEquals(Char1,LPC.char)||(this.localplayer.character=null,this.world.remove(LPC),PC=new BNTest.PlayerCharacter(this.world,this.localplayer,Char1,LPC.team),this.localplayer.character=PC,this.world.add(PC),PC.setPosition(LPC.getPosition()),PC.setHP(LPC.getHP()),PC.setCoins(LPC.getCoins()),PC.respawnPosition=LPC.respawnPosition));BNTest.KeyboardManager.get_this().tappedButtons.contains(75)&&Bridge.global.confirm('You have activated the save data "Factory Reset" function.\nPress OK to continue.')&&(Bridge.global.localStorage.clear(),BNTest.App.initSaveData());BNTest.KeyboardManager.get_this().tappedButtons.contains(74)&&(BNTest.App.storage.MaxLevel=50,BNTest.App.storage.Mon=1e4);BNTest.KeyboardManager.get_this().tappedButtons.contains(72)&&(this.guiVisible=!this.guiVisible);BNTest.KeyboardManager.get_this().tappedButtons.contains(86)&&(this.showVertCounter=!this.showVertCounter);BNTest.KeyboardManager.get_this().tappedButtons.contains(76)&&(wav=Bridge.global.prompt("Enter a wave",System.String.concat("",this.wave)),i={v:0},System.Int32.tryParse(wav,i),i.v>0&&(this.wave=i.v-1|0,this.skippedWave=!0,this.clearEntities(),this.nextWave()))},drawGauge:function(g,position,size,border,progress,color,drawborder){drawborder===void 0&&(drawborder=!0);drawborder&&(g.globalAlpha=.6,g.fillStyle="#000000",g.fillRect(position.x,position.y,size.x,size.y));g.fillStyle=color;g.globalAlpha=1;g.fillRect(Bridge.Int.clip32(position.x)+border|0,Bridge.Int.clip32(position.y)+border|0,(size.x-(border+border|0))*progress,Bridge.Int.clip32(size.y)-(border+border|0)|0);g.globalAlpha=.5;var grd=g.createLinearGradient(0,0,0,size.y);grd.addColorStop(0,color);grd.addColorStop(.4,"white");grd.addColorStop(1,color);g.fillStyle=grd;g.fillRect(Bridge.Int.clip32(position.x)+border|0,Bridge.Int.clip32(position.y)+border|0,(size.x-(border+border|0))*progress,Bridge.Int.clip32(size.y)-(border+border|0)|0);g.globalAlpha=1},drawScene:function(){var self=this,V,walking,spd,D,fog,currentTime,delta;this.updateAudio();this.gl.clearDepth(1);this.frame=this.frame+1|0;V=BNTest.Vector2.op_Subtraction(BNTest.KeyboardManager.get_this().cMouse,new BNTest.Vector2(BNTest.App.canvas.width>>1,BNTest.App.canvas.height>>1));V.x*=.75;this.mouseAngle=V.toAngle();this.updateControls();walking=!1;this.world!=null&&(this.cameracontrols&&(BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(2)&&(this.cameraDist*=1.01),BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(1)&&(this.camera.rotation.z+=2),BNTest.KeyboardManager.get_this().pressedMouseButtons.contains(0)&&(this.cameraDist*=.99),BNTest.KeyboardManager.get_this().mouseDelta!==0&&(this.cameraDist*=1+BNTest.KeyboardManager.get_this().mouseDelta*.05)),this.model!=null&&this.world.setOffset(BNTest.GLVec3.op_Multiply$1(this.model.offset,-1)),spd=.8,D=new BNTest.GLVec3.ctor);BNTest.App.update();this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);this.setPerspective();this.loadIdentity();this.mvTranslate([0,0,-this.cameraDist]);this.fogActive&&(fog=.55,fog/=this.cameraDist,fog=fog*fog*1.44,this.lightLevel!==this.currentlightlevel&&(this.currentlightlevel=BNTest.MathHelper.incrementTowards$1(this.currentlightlevel,this.lightLevel,.0025,.01)),this.currentlightlevel=BNTest.MathHelper.clamp(this.currentlightlevel),this.currentlightlevel!==1&&(fog/=.35+this.currentlightlevel*.65),this.currentlightlevel>0?this.gl.uniform1f(this.darknessLevelUniform,this.defaultDarknessLevel/this.currentlightlevel):this.gl.uniform1f(this.darknessLevelUniform,1),this.gl.uniform3f(this.lightPosUniform,0,0,this.cameraDist/2),this.gl.uniform1f(this.ambientLightLevel,this.defaultAmbientLightLevel*this.currentlightlevel),this.lightLevel=1,this.gl.uniform1f(this.gl.getUniformLocation(this.shaderProgram,"uFogDensity"),fog));this.mvPushMatrix();this.mvScale(new BNTest.GLVec3.ctor(1,-1,1));this.cameracontrols&&(this.cubeRotation=-(BNTest.KeyboardManager.get_this().cMouse.x-512)*.4,this.camera.rotation.y=this.cubeRotation,this.cubeRotation=(BNTest.KeyboardManager.get_this().cMouse.y-384)*.4,this.camera.rotation.x=this.cubeRotation);this.matrixNeedsFlush=!0;this.titlescreen&&!this.titleRunning&&BNTest.AnimationLoader.get_this().isIdle()&&this.doTitle();this.camera!=null&&(this.world.prepareRender(),this.camera.render());this.titlescreen?(this.world.setOffset(new BNTest.GLVec3.ctor(0,15,0)),this.world.model.rotation.y+=.1):this.localplayer!=null&&this.world.setOffset(BNTest.GLVec3.op_Multiply$1(this.localplayer.character.model.offset,-1));this.started||BNTest.AnimationLoader.get_this().queueEmpty();this.mvPopMatrix();currentTime=(new Date).getTime();this.lastCubeUpdateTime!=null&&this.lastCubeUpdateTime>0&&(delta=currentTime-this.lastCubeUpdateTime,this.cubeRotation+=30*delta/1e3);this.updateGui();this.lastCubeUpdateTime=currentTime},setPerspective:function(znearRate){var ZN,znear,zfar,flat,A;(znearRate===void 0&&(znearRate=.325),ZN=this.cameraDist*znearRate,this.perspectiveMatrix==null||this.cameraDist!==this.lastCameraDist||ZN!==this.lastZnear)&&(znear=.1,zfar=1e4,znear=ZN,this.perspectiveMatrix=makePerspective(45,640/480,znear,zfar),flat=this.tflat,this.flatten$2(this.perspectiveMatrix,flat),A=new Float32Array(flat),this.gl.uniformMatrix4fv(this.pUniform,!1,A),this.lastZnear=ZN)},clearEntities:function(coins){coins===void 0&&(coins=!1);BNTest.HelperExtensions.forEach(BNTest.Entity,this.world.entities,function(E){(Bridge.is(E,BNTest.PlayerCharacter)&&Bridge.cast(E,BNTest.PlayerCharacter).me.CPU||coins&&Bridge.is(E,BNTest.Coin)||Bridge.is(E,BNTest.Projectile))&&(E.alive=!1)});this.boss=null},doTitle:function(){var A=System.Int32.parse(BNTest.App.storage.MaxLevel),i,Char,NPC,W;for(this.CS.initMenu(),this.titleRunning=!0,this.paused=!1,this.world.remove(this.localplayer.character),this.localplayer.character.model.setVisible(!1),i=0;i<30;)Char="suika",NPC=new BNTest.PlayerCharacter(this.world,new BNTest.Player(!0,!0,!0),Char),this.setNPC(NPC),this.world.add(NPC),this.nPCs=this.nPCs+1|0,NPC.getBehavior(BNTest.NavigatorAI).canJump=!1,NPC.getBehavior(BNTest.AimedWandering).enabled=!1,W=NPC.getBehavior(BNTest.WanderAI),W.framesPerTick=15+Bridge.Int.clip32(Math.random()*20)|0,W.range*=2,W.chance=.6,i=i+1|0;this.playMusic("titlescreen",.6)},updateRadar:function(){var rg=this.radar.getGraphics(),rsz=this.radar.spriteBuffer.width,hrsz=Bridge.Int.div(rsz,2)|0,A,V,L,hsz;rg.clearRect(0,0,rsz,rsz);rg.globalAlpha=.6;rg.beginPath();rg.arc(hrsz,hrsz,hrsz,0,2*Math.PI,!1);rg.fillStyle="#005500";rg.fill();rg.lineWidth=3;rg.strokeStyle="#002200";rg.stroke();rg.globalAlpha=1;for(var i=0,LE=this.world.entities,ln=LE.getCount(),P=this.localplayer.character.getPosition().toVector2(),scale=.1,Y=this.localplayer.character.gety(),team=this.localplayer.character.team;i<ln;){var E=LE.getItem(i),D=E,color="#00FF00",ok=!1,sz=5,MY=50;D.me&&(ok=!0,Bridge.referenceEquals(D.team,team)||(color="#FF0000",Bridge.referenceEquals(D,this.boss)&&(sz=sz+2|0,color="#FF6633")));A=E.getAttacker;A?(A=E.getAttacker(),A&&A.me&&(ok=!0,sz=3,MY=8,Bridge.referenceEquals(A.team,team)||(color="#FF0000"))):E.value||E.healing?(ok=!0,color="#FFFF00"):E.defaultMaxHP&&(ok=!0,color="#00FFFF",sz=9);ok&&(E.model!=null&&(E.model.alpha<.15||!E.model.getVisible())&&(ok=!1),Math.abs(E.getPosition().y-Y)>MY&&(ok=!1),Bridge.referenceEquals(E,this.localplayer.character)&&(color="#FFFFFF",ok=!0,sz=sz+2|0),ok&&(V=BNTest.Vector2.op_Subtraction(E.getPosition().toVector2(),P),V.x*=scale,V.y*=scale,rg.fillStyle=color,L=V.getLength(),L>hrsz&&(V=V.normalize(hrsz),L=hrsz),L<=hrsz&&(hsz=sz>>1,rg.fillRect(V.x+hrsz-hsz,V.y+hrsz-hsz,sz,sz))));i=i+1|0}},updateGui:function(){var time,pad,gui,QS,loaded,off,combo,M4,V,T,R,TX,TY;if(!(this.frame%2>0)||this.titlescreen){var tt=Bridge.Int.clip32(this.totaltime*.001),max=this.wavetime*60,tim=Bridge.Int.clip32(max-tt),done=tim<0&&!this.ended;this.boss!=null&&(done=this.boss.getHP()<=0||this.boss.respawnTime>0);done&&this.nextWave();(this.localplayer.character.getCoins()<=0||this.localplayer.lives<0||BNTest.KeyboardManager.get_this().pressedButtons.contains(27))&&!this.gameover&&(this.gameover=!0,BNTest.KeyboardManager.get_this().pressedButtons.contains(27),this.ended=!0,this.clearEntities(!0),this.totaltime=0,this.titlescreen=!0,BNTest.App.guiCanvas.style.opacity="1",this.localplayer.character.respawnTime>0&&(this.localplayer.character.respawnTime=0));tim=Math.max(0,tim);var s=tim%60,m=(Bridge.Int.div(tim,60)|0)%60,wv=System.String.concat(System.String.concat(System.String.concat("",(Bridge.Int.div(this.wave-1|0,8)|0)+1|0),"-"),(this.wave-1|0)%8+1|0);if(this.wave===9&&(wv="⑨"),time=System.String.concat(System.String.concat(System.String.alignString(System.String.concat("",m),2,48),":"),System.String.alignString(System.String.concat("",s),2,48)),tim<11&&(time=System.String.concat("",s)),pad=50,this.ended?time=BNTest.AnimationLoader.get_this().isIdle()?this.gameover?tt<20?this.localplayer.character.getCoins()<=0?"No more coins, Game Over!":this.localplayer.lives<0?"No more lives, Game Over!":"Game ended":this.CS.charCount>1?"Choose a character":"Game is ready":this.CS.charCount>1?"Choose a character":"Game is ready":"Assets are being loaded, please wait...":this.boss!=null&&(time=System.String.concat(System.String.concat(String.fromCharCode(this.boss.char.charCodeAt(0)).toUpperCase(),this.boss.char.substr(1)),":")),pad=66-(time.length>>1)|0,gui=BNTest.App.gui,gui.clearRect(0,0,1024,1024),this.CS.visible=this.titlescreen,this.titlescreen&&(gui.fillStyle="#220077",gui.globalAlpha=.5,gui.fillRect(0,0,1024,1024),gui.globalAlpha=1,QS=BNTest.AnimationLoader.get_this().queueSize(),this.maxLoadQueue=Math.max(this.maxLoadQueue,QS),QS>0&&(loaded=this.maxLoadQueue-QS|0,this.maxLoadProgress=loaded/this.maxLoadQueue,this.loadProgress=BNTest.MathHelper.lerp(this.loadProgress,this.maxLoadProgress,.07),this.loadProgress=Math.min(this.loadProgress,this.maxLoadQueue,1),this.drawGauge(gui,new BNTest.Vector2(350,42),new BNTest.Vector2(320,24),2,this.loadProgress,"#00DD00")),BNTest.AnimationLoader.get_this().isIdle()?this.startButton.unlock():this.startButton.lock(),this.shop.visible||(this.CS.draw(gui),this.startButton.draw(gui),this.shopButton.draw(gui))),gui.lineWidth=3,this.started&&this.guiVisible){if(this.drawGauge(gui,new BNTest.Vector2(2,2),new BNTest.Vector2(220,32),3,Math.max(0,this.localplayer.character.getHP()/100),"#00DD00"),this.boss!=null&&this.drawGauge(gui,new BNTest.Vector2(350,42),new BNTest.Vector2(320,24),2,Math.max(0,this.boss.getHP()/100),"#00DD00"),!this.ended&&this.radar.visible&&(this.updateRadar(),gui.globalAlpha=.9,off=40,this.radar.position=new BNTest.Vector2(1023-off/BNTest.App.targetAspect-this.radar.spriteBuffer.width,off),this.radar.draw(gui),gui.globalAlpha=1),combo=this.localplayer.character.combo,combo>1&&(this.CTS.alpha+=.125,this.CTS.setText(System.String.concat("Combo:",combo)),this.CTS.visible=!0,!1)){var TMat=new BNTest.WGMatrix,DB=System.Linq.Enumerable.from(this.world.entities).first($_.BNTest.GLDemo.f13),Mat=new BNTest.WGMatrix;TMat.mvTranslate([0,0,-this.cameraDist]);Mat.mat4MultMatrix(TMat);TMat.clear();TMat.mvScale(new BNTest.GLVec3.ctor(1,-1,1));Mat.mat4MultMatrix(TMat);TMat.clear();Mat.mat4MultMatrix(this.camera.transformation);Mat.mat4MultMatrix(this.world.model.transformation);M4=new BNTest.WGMatrix;V=BNTest.GLVec3.transform(DB.getPosition(),Mat,!1);this.CTS.position.x=(Bridge.Int.div(BNTest.App.canvas.width,2)|0)-(Bridge.Int.div(this.CTS.spriteBuffer.width,2)|0);this.CTS.position.y=(Bridge.Int.div(BNTest.App.canvas.height,2)|0)-this.CTS.spriteBuffer.height;this.CTS.position.y-=20;this.CTS.position.x+=V.x;this.CTS.position.y+=V.z}this.CTS.visible&&(combo<=1&&(this.CTS.alpha-=.17,this.CTS.alpha<=0&&(this.CTS.visible=!1)),this.CTS.draw(gui))}this.TS.setTextColor("#FFFFFF");this.TS.setShadowOffset(new BNTest.Vector2(3,3));this.TS.setFontSize(26);this.TS.setShadowBlur(5);this.TS.setShadowColor("#000000");T=System.String.concat(System.String.alignString("",-pad,32),time);this.started&&this.guiVisible&&(T=System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(T,"\n"),"Coins:"),this.localplayer.character.getCoins()),"\nLives:"),Math.max(this.localplayer.lives,0))," Wave:"),wv),BNTest.App.DEBUG&&this.showVertCounter&&(R=this.world.model.countElements(),T=System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat(T,"\n"),this.intToDigits(R[1]))," Verticies in "),this.intToDigits(R[0]))," Meshes.")));this.TS.setText(T);this.TS.position=new BNTest.Vector2(2,-4);this.guiVisible&&this.TS.draw(gui);var C="#FFFFFF",fs=60,SB=7,SC="#000000";T="";TX=300;TY=150;this.titlescreen?(fs=fs+10|0,C="#FF0000",T=BNTest.App.gameName,this.LTS.alpha=1,SC="#FFFFFF",TX=TX-20|0,SB=8,this.BTS.setTextColor("#FFFFFF"),this.BTS.setFontSize(18),this.BTS.setText(System.String.concat(System.String.alignString("Graphics and Code by:RSGmaker",-100,32),"Touhou Project is owned by ZUN")),this.BTS.position=new BNTest.Vector2(50,720),this.BTS.setShadowOffset(new BNTest.Vector2(3,3)),this.BTS.setShadowBlur(3),this.BTS.setShadowColor("#000000"),this.BTS.draw(gui),this.VTS.position=new BNTest.Vector2(763,98+this.LTS.position.y),this.VTS.draw(gui)):this.paused?(this.LTS.alpha=1,C="#EEEE88",T="Paused",fs=fs+10|0,TX=TX+65|0,TY=TY+25|0,SB=8):this.waveDelay>0&&(T=System.String.concat("Wave ",wv),fs=120-Bridge.Int.clip32(this.waveDelay*.35)|0,this.LTS.alpha=this.waveDelay*.005,fs<1&&(fs=1));!Bridge.referenceEquals(T,"")&&this.guiVisible&&(this.LTS.setShadowOffset(new BNTest.Vector2(3,3)),this.LTS.setShadowBlur(SB),this.LTS.setShadowColor(SC),this.LTS.setFontSize(fs),this.LTS.setTextColor(C),this.LTS.position=new BNTest.Vector2(TX,TY),this.LTS.setText(T),this.LTS.draw(gui));this.shop.visible&&this.shop.draw(gui)}},intToDigits:function(N){for(var ret=System.String.concat("",N),ln=ret.length,i=ln-3|0;i>0;)ret=System.String.insert(i,ret,","),i=i-3|0,ln=ln+1|0;return ret},getTeamColor:function(){return new BNTest.GLColor},playSoundEffect:function(position,sound){var dist,ml;if(!this.serverMode){var vol=1,min=450;if(position!=null&&(dist=this.world.cam.roughDistance(position),dist-=min,ml=1600-min,dist>0)){if(dist>=ml)return;vol=BNTest.MathHelper.clamp(1-dist/ml)}BNTest.AudioManager.get_this().blast(System.String.concat(System.String.concat("SFX/",sound),".ogg"),vol*this.masterVolume)}},sendEvent:function(type,data,flush){var D,NU;flush===void 0&&(flush=!1);D={};D.E=type;D.D=data;NU=null;this.online;this.processEvent(D,NU,0);flush&&(this.netPlayNeedsFlush=!0)},processEvent:function(msg,user,latency){for(var i=0,ln=this.players.getCount(),LP=System.Array.init(0,null),Pl,evt,entity,attacker,PC;i<ln;)Pl=this.players.getItem(i),user!=null&&Bridge.referenceEquals(Pl.networkID,user.userID)&&LP.push(Pl),i=i+1|0;var P=null,D=msg.D,hascharacter=!0;if(LP.length<=0?P!=null||user!=null||this.online?user.getIsMe()?(this.localplayer.networkID=user.userID,P=this.localplayer):hascharacter=!1:P=this.localplayer:P=LP[0],evt=msg.E,user==null||user.getIsMe()||(this.dlatency+=latency,this.dlatency*=1-1/this.latencyM),Bridge.referenceEquals(evt,"Kill")&&(entity=this.entityFromID(D.I),entity!=null&&entity.getHP()<=0&&(attacker=this.entityFromID(D.A),entity.BNTest$ICombatant$onDeath(this.entityFromID(D.S)),attacker!=null&&Bridge.is(attacker,BNTest.PlayerCharacter)))){PC=attacker;PC.me.score=PC.me.score+entity.BNTest$ICombatant$getPointsForKilling()|0;PC.onKill(entity)}},entityFromID:function(ID){var LE=System.Linq.Enumerable.from(this.world.entities).where(function(E){return Bridge.referenceEquals(E.ID,ID)}).toList(BNTest.Entity);return LE.getCount()>0?LE.getItem(0):null},initShaders:function(){var fragmentShader=this.getShader(this.gl,"Bshader-fs"),vertexShader=this.getShader(this.gl,"Bshader-vs"),G,img,texture,self;this.shaderProgram=this.gl.createProgram();this.gl.attachShader(this.shaderProgram,vertexShader);this.gl.attachShader(this.shaderProgram,fragmentShader);this.gl.linkProgram(this.shaderProgram);this.gl.getProgramParameter(this.shaderProgram,this.gl.LINK_STATUS)==null&&Bridge.global.alert(System.String.concat("Unable to initialize the shader program: ",this.gl.getProgramInfoLog(this.shaderProgram)));this.gl.useProgram(this.shaderProgram);this.gl.bindAttribLocation(this.shaderProgram,0,"aVertexPosition");this.vertexPositionAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexPosition");this.gl.enableVertexAttribArray(this.vertexPositionAttribute);this.vertexColorAttribute=this.gl.getAttribLocation(this.shaderProgram,"aVertexColor");this.gl.enableVertexAttribArray(this.vertexColorAttribute);this.vertexTextureCoordAttribute=this.gl.getAttribLocation(this.shaderProgram,"aTextureCoord");this.samplerUniform=this.gl.getUniformLocation(this.shaderProgram,"uSampler");this.enableTextures();this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),!1);this.gl.uniform1f(this.gl.getUniformLocation(this.shaderProgram,"uFogDensity"),.01);this.alphaUniform=this.gl.getUniformLocation(this.shaderProgram,"uAlpha");this.colorUniform=this.gl.getUniformLocation(this.shaderProgram,"uPColor");this.pUniform=this.gl.getUniformLocation(this.shaderProgram,"uPMatrix");this.mvUniform=this.gl.getUniformLocation(this.shaderProgram,"uMVMatrix");this.lightPosUniform=this.gl.getUniformLocation(this.shaderProgram,"lightPosition");this.darknessLevelUniform=this.gl.getUniformLocation(this.shaderProgram,"darknessLevel");this.ambientLightLevel=this.gl.getUniformLocation(this.shaderProgram,"ambientLightLevel");this.fogActive=!0;this.gl.uniform1i(this.gl.getUniformLocation(this.shaderProgram,"uUseFog"),this.fogActive);this.gl.uniform1f(this.alphaUniform,1);this.gl.uniform1f(this.darknessLevelUniform,this.defaultDarknessLevel);this.gl.uniform1f(this.ambientLightLevel,this.defaultAmbientLightLevel);this.gl.uniform3f(this.lightPosUniform,0,0,this.cameraDist/2-50);var CV=document.createElement("canvas"),sz=32,hsz=Bridge.Int.div(sz,2)|0;CV.width=sz;CV.height=sz;G=BNTest.Helper.getContext(CV);G.fillStyle="#FF00FF";G.fillRect(0,0,sz,sz);G.fillStyle="#00FFFF";G.fillRect(0,0,hsz,hsz);G.fillRect(hsz,hsz,hsz,hsz);img=new Image;img.src=CV.toDataURL();texture=this.gl.createTexture();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,img);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0);self=this;this.disableTextures();BNTest.Mesh.init(this.vertexPositionAttribute,this.vertexColorAttribute,this.vertexTextureCoordAttribute)},pushAlpha:function(alpha){this.alphalist.push(this.currentAlpha);alpha=Math.min(Math.max(alpha,0),1);this.currentAlpha*=alpha;this.gl.uniform1f(this.alphaUniform,this.currentAlpha)},popAlpha:function(){var alpha=this.alphalist.pop();this.currentAlpha=alpha;this.gl.uniform1f(this.alphaUniform,this.currentAlpha)},setTexture:function(texture){this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0)},enableTextures:function(){this.gl.enableVertexAttribArray(this.vertexTextureCoordAttribute);this.gl.uniform4f(this.colorUniform,0,0,0,0);BNTest.Mesh.texture=!0},disableTextures:function(){this.gl.disableVertexAttribArray(this.vertexTextureCoordAttribute);this.gl.uniform4f(this.colorUniform,1,1,1,1);BNTest.Mesh.texture=!1},setColor:function(color){this.gl.uniform4f(this.colorUniform,color.r,color.g,color.b,color.a)},resetColor:function(){BNTest.Mesh.texture?this.gl.uniform4f(this.colorUniform,0,0,0,0):this.gl.uniform4f(this.colorUniform,1,1,1,1)},_test:function(){var timg=BNTest.AnimationLoader.get("test").getItem(0),img=new Image,texture;img.src=timg.src;texture=this.gl.createTexture();this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,img);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST);this.gl.generateMipmap(this.gl.TEXTURE_2D);this.gl.bindTexture(this.gl.TEXTURE_2D,null);this.gl.activeTexture(this.gl.TEXTURE0);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.uniform1i(this.samplerUniform,0)},getShader:function(gl,id){var shaderScript=document.getElementById(id),theSource,currentChild,shader,st;if(shaderScript==null)return null;for(theSource="",currentChild=shaderScript.firstChild;currentChild!=null;)currentChild.nodeType===3&&(theSource=System.String.concat(theSource,currentChild.textContent)),currentChild=currentChild.nextSibling;if(st=shaderScript.type,Bridge.referenceEquals(st,"x-shader/x-fragment"))shader=gl.createShader(gl.FRAGMENT_SHADER);else if(Bridge.referenceEquals(st,"x-shader/x-vertex"))shader=gl.createShader(gl.VERTEX_SHADER);else return null;return(gl.shaderSource(shader,theSource),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)==null)?(Bridge.global.alert(System.String.concat("An error occurred compiling the shaders: ",gl.getShaderInfoLog(shader))),null):shader},loadIdentity:function(){this.mvMatrix=this.matrix.mvMatrix;this.matrix.loadIdentity();this.matrix.mvMatrix=this.mvMatrix;this.matrix.mvMatrixStack=System.Array.init(0,null)},multMatrix:function(m,flush){flush===void 0&&(flush=!1);this.matrix.multiplyMatrix$1(m);this.matrixNeedsFlush=!0},mvTranslate:function(v){this.matrix.mvTranslate(v)},flushMatrix:function(){if(this.matrixNeedsFlush)this.matrixNeedsFlush=!1,this.flatten$1(this.mvMatrix,this.FA),this.gl.uniformMatrix4fv(this.mvUniform,!1,this.FA)},flatten:function(matrix){var M=matrix.elements;return[M[0][0],M[1][0],M[2][0],M[3][0],M[0][1],M[1][1],M[2][1],M[3][1],M[0][2],M[1][2],M[2][2],M[3][2],M[0][3],M[1][3],M[2][3],M[3][3]]},flatten$2:function(matrix,OUT){var M=matrix.elements,O=OUT,A=M[0],B=M[1],C=M[2],D=M[3];O[0]=A[0];O[1]=B[0];O[2]=C[0];O[3]=D[0];O[4]=A[1];O[5]=B[1];O[6]=C[1];O[7]=D[1];O[8]=A[2];O[9]=B[2];O[10]=C[2];O[11]=D[2];O[12]=A[3];O[13]=B[3];O[14]=C[3];O[15]=D[3]},flatten$1:function(matrix,OUT){var M=matrix.elements,O=OUT,A=M[0],B=M[1],C=M[2],D=M[3];O[0]=A[0];O[1]=B[0];O[2]=C[0];O[3]=D[0];O[4]=A[1];O[5]=B[1];O[6]=C[1];O[7]=D[1];O[8]=A[2];O[9]=B[2];O[10]=C[2];O[11]=D[2];O[12]=A[3];O[13]=B[3];O[14]=C[3];O[15]=D[3]},mvPushMatrix:function(m){m===void 0&&(m=null);this.matrixNeedsFlush=!0;this.matrix.mvPushMatrix();return},mvPopMatrix:function(){return this.matrixNeedsFlush=!0,this.matrix.mvPopMatrix()},mvScale:function(Scale){this.matrix.mvScale(Scale);return}});Bridge.ns("BNTest.GLDemo",$_);Bridge.apply($_.BNTest.GLDemo,{f1:function(E){return Bridge.is(E,BNTest.DonationBox)},f2:function(E){return!Bridge.is(E,BNTest.RisingPlatform)},f3:function(){return!0},f4:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=9},f5:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=2},f6:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=18},f7:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=14},f8:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=8},f9:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=16},f10:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=24},f11:function(){return System.Int32.parse(BNTest.App.storage.MaxLevel)>=32},f12:function(){this.CS.initMenu();this.shop.initMenu();this.shop.visible=!0},f13:function(D){return Bridge.is(D,BNTest.DonationBox)}});Bridge.define("BNTest.GLVec3",{statics:{getOne:function(){return new BNTest.GLVec3.ctor(1,1,1)},mean:function(L){var V2;L===void 0&&(L=[]);for(var V=new BNTest.GLVec3.ctor,i=0,ln=L.length;i<ln;)V2=L[i],V.x+=V2.x,V.y+=V2.y,V.z+=V2.z,i=i+1|0;return V.x/=L.length,V.y/=L.length,V.z/=L.length,V},lerp:function(V1,V2,D){var ret=new BNTest.GLVec3.ctor;return BNTest.GLVec3.lerp$1(V1,V2,D,ret),ret},lerp$1:function(V1,V2,D,OUT){OUT.x=BNTest.MathHelper.lerp(V1.x,V2.x,D);OUT.y=BNTest.MathHelper.lerp(V1.y,V2.y,D);OUT.z=BNTest.MathHelper.lerp(V1.z,V2.z,D)},transform:function(V,M,inv){return inv===void 0&&(inv=!1),BNTest.GLVec3.transformB(V.toVec3(),M.mvMatrix,inv)},transformB:function(a,m,inv){inv===void 0&&(inv=!1);var ret=System.Array.init(3,0),OM=m,me=m.elements;m=inv?BNTest.WGMatrix.flatten(m):BNTest.WGMatrix.flattenB(m);var x=a[0],y=a[1],z=a[2];return ret[0]=m[0]*x+m[4]*y+m[8]*z+m[12],ret[1]=m[1]*x+m[5]*y+m[9]*z+m[13],ret[2]=m[2]*x+m[6]*y+m[10]*z+m[14],new BNTest.GLVec3.ctor(ret[0],ret[1],ret[2])},random:function(length,RND){return RND===void 0&&(RND=null),RND==null&&(RND=new System.Random.ctor),new BNTest.GLVec3.ctor(RND.nextDouble()*length.x,RND.nextDouble()*length.y,RND.nextDouble()*length.z)},createUniform:function(D){return new BNTest.GLVec3.ctor(D,D,D)},min:function(V1,V2){return new BNTest.GLVec3.ctor(Math.min(V1.x,V2.x),Math.min(V1.y,V2.y),Math.min(V1.z,V2.z))},min$1:function(V){var P;V===void 0&&(V=[]);for(var ret=V[0].clone(),i=1,ln=V.length;i<ln;)P=V[i],ret.x=Math.min(ret.x,P.x),ret.y=Math.min(ret.y,P.y),ret.z=Math.min(ret.z,P.z),i=i+1|0;return ret},max:function(V1,V2){return new BNTest.GLVec3.ctor(Math.max(V1.x,V2.x),Math.max(V1.y,V2.y),Math.max(V1.z,V2.z))},max$1:function(V){var P;V===void 0&&(V=[]);for(var ret=V[0].clone(),i=1,ln=V.length;i<ln;)P=V[i],ret.x=Math.max(ret.x,P.x),ret.y=Math.max(ret.y,P.y),ret.z=Math.max(ret.z,P.z),i=i+1|0;return ret},floor:function(V){return new BNTest.GLVec3.ctor(Math.floor(V.x),Math.floor(V.y),Math.floor(V.z))},getCenter:function(V1,V2){var X=V1.x+(V2.x-V1.x)*.5,Y=V1.y+(V2.y-V1.y)*.5,Z=V1.z+(V2.z-V1.z)*.5;return new BNTest.GLVec3.ctor(X,Y,Z)},getCenter$1:function(V1,V2,OUT){var X=V1.x+(V2.x-V1.x)*.5,Y=V1.y+(V2.y-V1.y)*.5,Z=V1.z+(V2.z-V1.z)*.5;OUT.x=X;OUT.y=Y;OUT.z=Z},op_Addition$1:function(V1,Vec2){return new BNTest.GLVec3.ctor(V1.x+Vec2.x,V1.y,V1.z+Vec2.y)},op_Addition:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x+V2.x,V1.y+V2.y,V1.z+V2.z)},op_Subtraction:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x-V2.x,V1.y-V2.y,V1.z-V2.z)},op_UnaryNegation:function(V){return new BNTest.GLVec3.ctor(-V.x,-V.y,-V.z)},op_Multiply:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x*V2.x,V1.y*V2.y,V1.z*V2.z)},op_Multiply$1:function(V1,scale){return new BNTest.GLVec3.ctor(V1.x*scale,V1.y*scale,V1.z*scale)},op_Division:function(V1,V2){return new BNTest.GLVec3.ctor(V1.x/V2.x,V1.y/V2.y,V1.z/V2.z)},op_Division$1:function(V1,scale){return new BNTest.GLVec3.ctor(V1.x/scale,V1.y/scale,V1.z/scale)},op_LessThan:function(V1,V2){return V1.x<V2.x&&V1.y<V2.y&&V1.z<V2.z},op_GreaterThan:function(V1,V2){return V1.x>V2.x&&V1.y>V2.y&&V1.z>V2.z},op_LessThanOrEqual:function(V1,V2){return V1.x<=V2.x&&V1.y<=V2.y&&V1.z<=V2.z},op_GreaterThanOrEqual:function(V1,V2){return V1.x>=V2.x&&V1.y>=V2.y&&V1.z>=V2.z}},x:0,y:0,z:0,$ctor1:function(vec3){this.$initialize();this.x=vec3[0];this.y=vec3[1];this.z=vec3[2]},ctor:function(X,Y,Z){X===void 0&&(X=0);Y===void 0&&(Y=0);Z===void 0&&(Z=0);this.$initialize();this.x=X;this.y=Y;this.z=Z},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},getEstimatedLength:function(){var A=Math.abs(this.x),B=Math.abs(this.y),C=Math.abs(this.z),M=Math.max(A,B,C),D=.34;return(A===M&&B===M||B===M&&C===M||A===M&&C===M)&&(D+=.15,M=-1),A!==M&&(A*=D),B!==M&&(B*=D),C!==M&&(C*=D),A+B+C},getRoughLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},copyFrom:function(V){this.x=V.x;this.y=V.y;this.z=V.z},set:function(X,Y,Z){X===void 0&&(X=0);Y===void 0&&(Y=0);Z===void 0&&(Z=0);this.x=X;this.y=Y;this.z=Z},syncCopy:function(V,dimension){dimension===void 0&&(dimension=0);var X=this.x,Y=this.y,Z=this.z;return dimension===0?X=V.x:dimension===1?Y=V.y:dimension===2&&(Z=V.z),new BNTest.GLVec3.ctor(X,Y,Z)},distance:function(V){var X=this.x-V.x,Y=this.y-V.y,Z=this.z-V.z;return Math.sqrt(X*X+Y*Y+Z*Z)},roughDistance:function(V){return Math.abs(this.x-V.x)+Math.abs(this.y-V.y)+Math.abs(this.z-V.z)},toVec3:function(){var ret=System.Array.init(3,0);return ret[0]=this.x,ret[1]=this.y,ret[2]=this.z,ret},normalize:function(length){length===void 0&&(length=1);var D=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)/length,V=new BNTest.GLVec3.ctor;return V.x=this.x/D,V.y=this.y/D,V.z=this.z/D,V},equals:function(o){return o!=null&&o.x===this.x&&o.y===this.y&&o.z===this.z},toVector2:function(){return new BNTest.Vector2(this.x,this.z)},clone:function(){return new BNTest.GLVec3.ctor(this.x,this.y,this.z)},toString:function(){return System.String.concat(System.String.concat(System.String.concat(System.String.concat(System.String.concat("X:",System.Double.format(this.x,"G"))," Y:"),System.Double.format(this.y,"G"))," Z:"),System.Double.format(this.z,"G"))},alignedAxis:function(V){var ret=0;return this.x===V.x&&(ret=ret+1|0),this.y===V.y&&(ret=ret+1|0),this.z===V.z&&(ret=ret+1|0),ret},min$1:function(VX,VY,VZ){this.x=Math.min(this.x,VX);this.y=Math.min(this.y,VY);this.z=Math.min(this.z,VZ)},min:function(V){this.x=Math.min(this.x,V.x);this.y=Math.min(this.y,V.y);this.z=Math.min(this.z,V.z)},max$1:function(VX,VY,VZ){this.x=Math.max(this.x,VX);this.y=Math.max(this.y,VY);this.z=Math.max(this.z,VZ)},max:function(V){this.x=Math.max(this.x,V.x);this.y=Math.max(this.y,V.y);this.z=Math.max(this.z,V.z)},floor:function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)},round:function(){this.x=Bridge.Math.round(this.x,0,6);this.y=Bridge.Math.round(this.y,0,6);this.z=Bridge.Math.round(this.z,0,6)},ceiling:function(){this.x=Math.ceil(this.x);this.y=Math.ceil(this.y);this.z=Math.ceil(this.z)},add:function(position){this.x+=position.x;this.y+=position.y;this.z+=position.z},add$1:function(X,Y,Z){Y===void 0&&(Y=0);Z===void 0&&(Z=0);this.x+=X;this.y+=Y;this.z+=Z},subtract:function(position){this.x-=position.x;this.y-=position.y;this.z-=position.z},multiply:function(position){this.x*=position.x;this.y*=position.y;this.z*=position.z},multiply$1:function(X,Y,Z){Y===void 0&&(Y=0);Z===void 0&&(Z=0);this.x*=X;this.y*=Y;this.z*=Z},divide:function(position){this.x/=position.x;this.y/=position.y;this.z/=position.z},xZAngle:function(){return Math.atan2(this.z,this.x)}});Bridge.define("BNTest.Helper",{statics:{_namespaces:null,config:{init:function(){this._namespaces=new(System.Collections.Generic.Dictionary$2(String,Object))}},getRandomString:function(){return(Math.random()*(new Date).getTime()).toString(36)},getType:function(FullName){var name=FullName,s,i,obj;if(Bridge.referenceEquals(name,"")||name==null||!System.String.contains(name,"."))return null;for(s=name.split("."),i=1,BNTest.Helper._namespaces.containsKey(s[0])?obj=BNTest.Helper._namespaces.get(s[0]):(obj=eval(s[0]),BNTest.Helper._namespaces.set(s[0],obj));i<s.length;){if(!obj)return null;obj=obj[s[i]];i=i+1|0}return obj},addMultiple:function(T,array,item,number){while(number>0)array.push(item),number=number-1|0},cloneCanvas:function(C){var ret=document.createElement("canvas"),g;return ret.width=C.width,ret.height=C.height,g=ret.getContext("2d"),g.drawImage(C,0,0),ret},getContext:function(C){return C.getContext("2d")},getField:function(target,fieldName){var O=target,s;if(BNTest.Helper.has(O,fieldName))return O[fieldName];if(O[System.String.concat("get",fieldName)])return O[System.String.concat("get",fieldName)]();s="";try{s=System.String.concat(System.String.concat(System.String.concat('Helper get field: Field "',fieldName),'" was not in ')+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat(System.String.concat(System.String.concat('Helper get field: Field "',fieldName),'" was not in ')+target,".")}return console.log(s),null},has:function(target,fieldName){return typeof target[fieldName]!="undefined"},reloadPage:function(){window.location.href=window.location.href},setField:function(target,fieldName,data){var O=target,s;if(BNTest.Helper.has(O,fieldName)){O[fieldName]=data;return}if(O[System.String.concat("set",fieldName)]){O[System.String.concat("set",fieldName)](data);return}s="";try{s=System.String.concat(System.String.concat(System.String.concat('Helper set field: Field "',fieldName),'" was not in ')+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat(System.String.concat(System.String.concat('Helper set field: Field "',fieldName),'" was not in ')+target,".")}console.log(s)},copyFields:function(source,target,Fields){var i,f;for(Fields===void 0&&(Fields=null),Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[i],BNTest.Helper.setField(target,f,BNTest.Helper.getField(source,f)),i=i+1|0},keyCodeToString:function(keycode){var codenames=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];return keycode>=0&&keycode<codenames.length?codenames[keycode]:String.fromCharCode(keycode)},makeShallowCopy:function(source,fieldNames){var target,Fields,i,f;for(fieldNames===void 0&&(fieldNames=null),target={},Fields=fieldNames,Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[i],target[f]=BNTest.Helper.getField(source,f),i=i+1|0;return target}}});Bridge.define("BNTest.HelperExtensions",{statics:{pick:function(T,list,RND){var $t,L,item;for(RND===void 0&&(RND=null),RND==null&&(RND=new System.Random.ctor),L=new(System.Collections.Generic.List$1(T)),$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),L.add(item);return L.getItem(RND.next$1(L.getCount()))},forEach:function(T,list,action){for(var item,$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),action(item)},forEach$1:function(T,list,methodName){for(var item,A,$t=Bridge.getEnumerator(list);$t.moveNext();)item=$t.getCurrent(),A=item[methodName],A()},addIfNew:function(T,list,item){list.contains(item)||list.add(item)},removeAll:function(T,list,predicate){for(var i=0,item;i<list.getCount();)item=list.getItem(i),predicate(item)&&(list.remove(item),i=i-1|0),i=i+1|0},pushIfNew:function(T,list,val){System.Array.contains(list,val,T)||list.push(val)},pushRange:function(T,list,val){val===void 0&&(val=[]);for(var i=0;i<val.length;)list.push(val[i]),i=i+1|0},clear$1:function(T,list){for(var i=list.length;Bridge.identity(i,i=i-1|0)>0;)list.pop()},clear:function(G){var C=G.canvas;G.clearRect(0,0,C.width,C.height)},replaceAll:function(T,list,Source,Destination){for(var i=-1,j,i=BNTest.HelperExtensions.indexOf(T,list,Source,i+1|0,3),ln=Source.length;i>=0;){for(j=0;j<ln;)list[i+j|0]=Destination[j],j=j+1|0;i=BNTest.HelperExtensions.indexOf(T,list,Source,i+1|0,3)}},indexOf:function(T,list,Value,index,structureSize){var k,l,ok;index===void 0&&(index=0);structureSize===void 0&&(structureSize=1);for(var i=index,ln=list.length,vln=Value.length,O=Value[0],A,B;i<ln&&i>=0;){for(i=list.indexOf(O,i+1|0);i>=0&&i%structureSize>0;)i=list.indexOf(O,i+1|0);if(i===-1)return-1;if(k=1,l=i+1|0,i<ln&&i>=0){for(ok=!0;ok&&k<vln;)A=list[l],B=Value[k],Bridge.referenceEquals(A,B)||(ok=!1),k=k+1|0,l=l+1|0;if(ok)return i}}return-1},identical:function(T,list,list2){var ln,i,A,B;if(Bridge.referenceEquals(list,list2))return!0;if(list==null||list2==null)return!1;if(ln=list.length,ln===list2.length){for(i=0;i<ln;){if(A=list[i],B=list2[i],!Bridge.referenceEquals(A,B))return!1;i=i+1|0}return!0}return!1},reverseOrderWithStructure:function(T,list,size){for(var ret=new(System.Collections.Generic.List$1(T)),i=0,ln=list.length,j;i<ln;){for(j=0;j<size;)ret.insert(0,list[(size-1|0)-j|0]),j=j+1|0;i=i+size|0}}}});Bridge.define("BNTest.ICombatant",{$kind:"interface"});Bridge.define("BNTest.IHarmfulEntity",{$kind:"interface"});Bridge.define("BNTest.InputController",{statics:{numberOfActions:8,GM:null},inputMapping:null,config:{properties:{id:null}},ctor:function(id){id===void 0&&(id="Keyboard");this.$initialize();this.setid(id);this.inputMapping=new(System.Collections.Generic.List$1(BNTest.InputMap));Bridge.referenceEquals(id,"Keyboard")?this.initkeyboard():Bridge.referenceEquals(id,"KeyboardMouse")?(this.setid("Keyboard"),this.initkeyboardmouse()):this.initgamepad();BNTest.InputController.GM==null&&(BNTest.GamePadManager._this==null&&(BNTest.GamePadManager._this=new BNTest.GamePadManager),BNTest.InputController.GM=BNTest.GamePadManager._this)},copyMap:function(){for(var fields=["map","antimap","name","axis","controllerID"],ret=System.Array.init(this.inputMapping.getCount(),null),i=0;i<ret.length;)ret[i]=BNTest.Helper.makeShallowCopy(this.inputMapping.getItem(i),fields),i=i+1|0;return ret},copyFromMap:function(Map){for(var fields=["map","antimap","name","axis","controllerID"],i=0,IM;i<Map.length;)i>=this.inputMapping.getCount()&&this.inputMapping.add(new BNTest.InputMap.ctor),IM=this.inputMapping.getItem(i),BNTest.Helper.copyFields(Map[i],IM,fields),i=i+1|0},initkeyboardmouse:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=68,map.antimap=65),i===1&&(map.map=83,map.antimap=87),i===2&&(map.map=32),i===3&&(map.map=0,map.controllerID="Mouse"),i===4&&(map.map=2,map.controllerID="Mouse"),i===5&&(map.map=13),this.inputMapping.add(map),i=i+1|0},initkeyboard:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=68,map.antimap=65),i===1&&(map.map=83,map.antimap=87),i===2&&(map.map=32),i===3&&(map.map=90),i===4&&(map.map=88),i===5&&(map.map=13),this.inputMapping.add(map),i=i+1|0},initgamepad:function(){for(var i=0,map;i<BNTest.InputController.numberOfActions;)map=new BNTest.InputMap.$ctor1(-1),i===0&&(map.map=0,map.axis=!0),i===1&&(map.map=1,map.axis=!0),i>1&&(map.map=i-2|0),this.inputMapping.add(map),i=i+1|0},getState:function(action,map){map===void 0&&(map=null);map==null&&(map=this.inputMapping.getItem(action));var TID=this.getid();return Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),Bridge.referenceEquals(TID,"Keyboard")?this.getKeyboardMapState(map):Bridge.referenceEquals(TID,"Mouse")?this.getMouseMapState(map):this.getGamepadMapState(map)},getPressed:function(action,map){return map===void 0&&(map=null),this.getState(action,map)>=.7},findAnyPressedGamePadInput:function(){var ret=new BNTest.InputMap.ctor,L=BNTest.GamePadManager._this.getactiveGamepads();return(BNTest.HelperExtensions.forEach(BNTest.GamePad,L,function(G){var GB,tmp,i;if(ret.map===-1)if(ret.controllerID=G.id,GB=System.Linq.Enumerable.from(G.buttons).where($_.BNTest.InputController.f1).toArray(),GB.length>0)ret.axis=!1,tmp=GB[0],ret.map=new(System.Collections.Generic.List$1(BNTest.GamePadButton))(G.buttons).indexOf(tmp);else for(i=0;i<G.axes.length&&ret.map===-1;)Math.abs(G.axes[i])>.7&&Math.abs(G.axes[i])<2&&(ret.axis=!0,ret.map=i,G.axes[i]<0&&(ret.name="anti",ret.antimap=i)),i=i+1|0}),ret.map!==-1)?ret:null},getMapControllerID:function(map){return Bridge.referenceEquals(map.controllerID,"")?this.getid():map.controllerID},getMapControllerID$1:function(action){return this.getMapControllerID(this.inputMapping.getItem(action))},getGamepadMapState:function(map){var TID=this.getid(),P;return(Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),P=BNTest.GamePadManager._this.getPad(TID),P==null||!P.connected)?0:map.axis?P.axes[map.map]:P.buttons[map.map].pressed?1:map.antimap>=0&&P.buttons[map.antimap].pressed?-1:0},getKeyboardMapState:function(map){var L=BNTest.KeyboardManager.get_this().pressedButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0},getMouseMapState:function(map){var L=BNTest.KeyboardManager.get_this().pressedMouseButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0}});Bridge.ns("BNTest.InputController",$_);Bridge.apply($_.BNTest.InputController,{f1:function(B){return B.pressed}});Bridge.define("BNTest.InputControllerManager",{statics:{__this:null,get_this:function(){return BNTest.InputControllerManager.__this==null&&(BNTest.InputControllerManager.__this=new BNTest.InputControllerManager),BNTest.InputControllerManager.__this},init:function(){BNTest.InputControllerManager.__this==null&&(BNTest.InputControllerManager.__this=new BNTest.InputControllerManager)}},controllers:null,ctor:function(){this.$initialize();this.controllers=new(System.Collections.Generic.List$1(BNTest.InputController));this.controllers.add(new BNTest.InputController);for(var gamepads=BNTest.GamePadManager._this.getactiveGamepads(),i=0;i<gamepads.getCount();)this.controllers.add(new BNTest.InputController(gamepads.getItem(i).id)),i=i+1|0}});Bridge.define("BNTest.InputMap",{map:-1,antimap:-1,name:"",axis:!1,controllerID:"",ctor:function(){this.$initialize();this.axis=!1},$ctor1:function(map,antimap,axis){antimap===void 0&&(antimap=-1);axis===void 0&&(axis=!1);this.$initialize();this.map=map;this.antimap=antimap;this.axis=axis}});Bridge.define("BNTest.KeyboardManager",{statics:{allowRightClick:!1,__this:null,get_this:function(){return BNTest.KeyboardManager.__this==null&&(BNTest.KeyboardManager.__this=new BNTest.KeyboardManager),BNTest.KeyboardManager.__this},init:function(){BNTest.KeyboardManager.__this==null&&(BNTest.KeyboardManager.__this=new BNTest.KeyboardManager)},update:function(){BNTest.KeyboardManager.__this.tappedButtons.clear();BNTest.KeyboardManager.__this.tappedMouseButtons.clear();BNTest.KeyboardManager.__this.mouseDelta=0},neverinBounds:function(){return BNTest.KeyboardManager.allowRightClick||!BNTest.App.screenBounds.containsPoint$1(BNTest.KeyboardManager.get_this().cMouse.x,BNTest.KeyboardManager.get_this().cMouse.y)},onKeyDown:function(evt){var keyCode=evt.keyCode;return(BNTest.KeyboardManager.__this.pressedButtons.contains(keyCode)||(BNTest.KeyboardManager.__this.pressedButtons.add(keyCode),BNTest.KeyboardManager.__this.tappedButtons.add(keyCode)),keyCode>=37&&keyCode<=40||keyCode===32||keyCode===112)?!1:!0},onKeyUp:function(evt){var keyCode=evt.keyCode;BNTest.KeyboardManager.__this.pressedButtons.contains(keyCode)&&BNTest.KeyboardManager.__this.pressedButtons.remove(keyCode)},onMouseDown:function(evt){var btn=evt.button;return BNTest.KeyboardManager.__this.pressedMouseButtons.contains(btn)||(BNTest.KeyboardManager.__this.pressedMouseButtons.add(btn),BNTest.KeyboardManager.__this.tappedMouseButtons.add(btn)),btn<1},onMouseUp:function(evt){var btn=evt.button;return BNTest.KeyboardManager.__this.pressedMouseButtons.contains(btn)&&BNTest.KeyboardManager.__this.pressedMouseButtons.remove(btn),btn<1},onMouseWheel:function(evt){return BNTest.KeyboardManager.get_this().mouseDelta+=evt.detail,!0},onMouseMove:function(evt){BNTest.KeyboardManager.get_this().mousePosition=new BNTest.Vector2(evt.clientX,evt.clientY);var left=System.Single.parse(System.String.replaceAll(BNTest.App.div.style.left,"px","")),x=evt.clientX-left,y=evt.clientY,scale=BNTest.App.canvas.width/System.Single.parse(System.String.replaceAll(BNTest.App.div.style.width,"px",""));BNTest.KeyboardManager.get_this().cMouse=new BNTest.Vector2(x*scale,y*scale)}},pressedButtons:null,tappedButtons:null,pressedMouseButtons:null,tappedMouseButtons:null,mousePosition:null,cMouse:null,mouseDelta:0,config:{init:function(){this.mousePosition=new BNTest.Vector2;this.cMouse=new BNTest.Vector2}},ctor:function(){var KD,KU,MM,MD,MU,MW,NB;this.$initialize();this.pressedButtons=new(System.Collections.Generic.List$1(System.Int32));this.tappedButtons=new(System.Collections.Generic.List$1(System.Int32));this.pressedMouseButtons=new(System.Collections.Generic.List$1(System.Int32));this.tappedMouseButtons=new(System.Collections.Generic.List$1(System.Int32));KD=BNTest.KeyboardManager.onKeyDown;document.onkeydown=KD;KU=BNTest.KeyboardManager.onKeyUp;document.onkeyup=KU;MM=BNTest.KeyboardManager.onMouseMove;document.onmousemove=MM;MD=BNTest.KeyboardManager.onMouseDown;document.onmousedown=MD;MU=BNTest.KeyboardManager.onMouseUp;document.onmouseup=MU;MW=BNTest.KeyboardManager.onMouseWheel;document.onmousewheel=MW;document.onDomMouseScroll=MW;window.addEventListener("mousewheel",$_.BNTest.KeyboardManager.f1);window.addEventListener("DOMMouseScroll",$_.BNTest.KeyboardManager.f1);document.onmousewheel=$_.BNTest.KeyboardManager.f1;NB=BNTest.KeyboardManager.neverinBounds;document.oncontextmenu=NB}});Bridge.ns("BNTest.KeyboardManager",$_);Bridge.apply($_.BNTest.KeyboardManager,{f1:function(M){BNTest.KeyboardManager.onMouseWheel(M)}});Bridge.define("BNTest.MathHelper",{statics:{PI:3.14159274,PI2:6.28318548,PIOver2:1.57079637,distanceBetweenPoints:function(A,B){return BNTest.MathHelper.distanceBetweenPoints$1(A.x,A.y,B.x,B.y)},distanceBetweenPoints$1:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))},clamp$1:function(value,min,max){return Math.min(max,Math.max(min,value))},clamp:function(value,min,max){return min===void 0&&(min=0),max===void 0&&(max=1),Math.min(max,Math.max(min,value))},lerp$1:function(value1,value2,amount){return value1+(value2-value1)*amount},lerp:function(D1,D2,lerp){return lerp=BNTest.MathHelper.clamp(lerp),D1*(1-lerp)+D2*lerp},degreesToRadians:function(degrees){return degrees*.0174532924},radiansToDegrees:function(radians){return radians*57.29578},getAngle$1:function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)},getAngle:function(a){return Math.atan2(a.y,a.x)},roughDistanceBetweenPoints:function(a,b){return BNTest.Vector2.op_Subtraction(a,b).getRoughLength()},magnitudeOfRectangle:function(R){return R.width+R.height},wrapRadians:function(radian){while(radian<-3.14159274)radian+=BNTest.MathHelper.PI2;while(radian>=BNTest.MathHelper.PI)radian-=BNTest.MathHelper.PI2;return radian},incrementTowards:function(current,destination,speed){return current<destination&&(current+=speed,current>destination&&(current=destination)),current>destination&&(current-=speed,current<destination&&(current=destination)),current},incrementTowards$1:function(current,destination,incspeed,decspeed){return current<destination&&(current+=incspeed,current>destination&&(current=destination)),current>destination&&(current-=decspeed,current<destination&&(current=destination)),current},radianToVector:function(radian){return new BNTest.Vector2(Math.cos(radian),Math.sin(radian))},within:function(val,min,max){return val>=min&&val<=max},mean:function(val){val===void 0&&(val=[]);for(var ret=0,i=0;i<val.length;)ret+=val[i],i=i+1|0;return ret/val.length}}});Bridge.define("BNTest.Mesh",{statics:{texture:!0,lastDrawn:null,allowInterpolation:!0,enabled:!0,correctTextures:!1,cullTest:!1,config:{properties:{vertexPositionAttribute:0,vertexColorAttribute:0,vertexTextureCoord:0}},init:function(vertexPositionAttribute,vertexColorAttribute,vertexTextureCoord){BNTest.Mesh.setvertexPositionAttribute(vertexPositionAttribute);BNTest.Mesh.setvertexColorAttribute(vertexColorAttribute);BNTest.Mesh.setvertexTextureCoord(vertexTextureCoord);console.log("position:"+vertexPositionAttribute);console.log("color:"+vertexColorAttribute)},smoothen:function(ToMorph,strength){var NV,rl,EV;strength===void 0&&(strength=.35);for(var list=System.Array.init(0,null),i=0,L=ToMorph,ln=L.length;i<ln;){for(var V=L[i],k=0,R=System.Array.init(0,null);k<ln;)NV=L[k],rl=NV.roughDistance(V),rl>.0005&&rl<3&&R.push(NV),k=k+1|0;R.push(V);EV=BNTest.GLVec3.mean(R);BNTest.GLVec3.lerp$1(V,BNTest.GLVec3.mean(R),strength,EV);list.push(EV);i=i+1|0}return list},smoothenB:function(ToMorph,strength){var NV,rl,VL,ND,EV;strength===void 0&&(strength=.35);for(var list=System.Array.init(0,null),i=0,L=ToMorph,ln=L.length;i<ln;){for(var V=L[i],k=0,R=System.Array.init(0,0);k<ln;)NV=L[k],rl=NV.roughDistance(V),rl>.0005&&rl<3&&R.push(NV.getLength()),k=k+1|0;VL=V.getLength();R.push(VL);ND=BNTest.MathHelper.lerp(VL,BNTest.MathHelper.mean(R),strength);EV=V.normalize(ND);list.push(EV);i=i+1|0}return list},pushColor:function(array,C){BNTest.Mesh.pushValue(array,[C.r,C.g,C.b,C.a])},pushValue:function(array,values){values===void 0&&(values=[]);for(var i=0,v=0,ln=values.length;i<ln;)v=values[i],array.push(v),i=i+1|0}},cubeVerticesBuffer:null,cubeVerticesColorBuffer:null,cubeVerticesIndexBuffer:null,cubeVerticesTextureCoordBuffer:null,textureActive:!1,verticies:null,colors:null,textureCoords:null,indices:null,needsUpdate:!0,hasBuffer:!1,clonedBuffer:!1,offset:null,rotation:null,scale:null,min:null,max:null,doNotUnload:!1,transformation:null,transformed:!1,QV3:0,qV3Set:!1,TGV:null,config:{properties:{gl:null,GD:null},init:function(){this.verticies=[];this.colors=[];this.textureCoords=[];this.indices=[];this.offset=new BNTest.GLVec3.ctor;this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1);this.min=new BNTest.GLVec3.ctor(System.Double.max,System.Double.max,System.Double.max);this.max=new BNTest.GLVec3.ctor(System.Double.min,System.Double.min,System.Double.min);this.TGV=System.Array.init(8,null)}},ctor:function(GD){this.$initialize();this.setgl(GD.gl);this.setGD(GD);this.transformation=new BNTest.WGMatrix},getSize:function(){return BNTest.GLVec3.op_Subtraction(this.max,this.min)},flattenGeometry:function(){this.updateTranformation();this.morphGeometry(this.transformation);this.resetTransformation()},resetTransformation:function(){this.transformation.clear();this.offset=new BNTest.GLVec3.ctor;this.scale=BNTest.GLVec3.getOne();this.rotation=new BNTest.GLVec3.ctor},morphGeometry:function(M){var V,i;if(this.verticies.length>0)for(V=this.verticies,this.needsUpdate=!0,i=0;i<V.length;)this.transformVert(i,M),i=i+3|0},transformVert:function(index,M){var i=index,V=this.verticies,T1=new BNTest.GLVec3.ctor(V[Bridge.identity(i,i=i+1|0)],V[Bridge.identity(i,i=i+1|0)],V[Bridge.identity(i,i=i+1|0)]),T=BNTest.GLVec3.transform(T1,M,!0);i=index;V[Bridge.identity(i,i=i+1|0)]=T.x;V[Bridge.identity(i,i=i+1|0)]=T.y;V[Bridge.identity(i,i=i+1|0)]=T.z},render:function(){var G,GL_Float;this.indices.length<=0||(this.needsUpdate&&this.update(),this.cubeVerticesBuffer!=null&&(G=this.getgl(),Bridge.referenceEquals(BNTest.Mesh.lastDrawn,this)||(GL_Float=G.FLOAT,G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesBuffer),G.vertexAttribPointer(BNTest.Mesh.getvertexPositionAttribute(),3,GL_Float,!1,0,0),G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesColorBuffer),G.vertexAttribPointer(BNTest.Mesh.getvertexColorAttribute(),4,GL_Float,!1,0,0),BNTest.Mesh.texture&&this.textureActive&&(G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesTextureCoordBuffer),G.vertexAttribPointer(BNTest.Mesh.getvertexTextureCoord(),2,GL_Float,!1,0,0)),G.bindBuffer(G.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer),BNTest.Mesh.lastDrawn=this),this.draw()))},replaceAllColors:function(NewColor,keepAlpha){keepAlpha===void 0&&(keepAlpha=!1);for(var N=System.Array.init(0,0),i=0;i<this.colors.length;)N.push(NewColor.r),N.push(NewColor.g),N.push(NewColor.b),keepAlpha?N.push(NewColor.a):N.push(NewColor.a),i=i+4|0;this.colors=N;this.needsUpdate=!0},randomShift:function(rate){for(var i=0,r2=rate*2,V=System.Array.init(0,0),V2=System.Array.init(0,0),ln=this.verticies.length;i<ln;)V[0]=this.verticies[i],V[1]=this.verticies[i+1|0],V[2]=this.verticies[i+2|0],V2[0]=V[0]+(-rate+r2*Math.random()),V2[1]=V[1]+(-rate+r2*Math.random()),V2[2]=V[2]+(-rate+r2*Math.random()),BNTest.HelperExtensions.replaceAll(System.Double,this.verticies,V,V2),i=i+3|0;this.needsUpdate=!0},combine:function(M,respectOffsets){var offset,i,P,N;if(respectOffsets===void 0&&(respectOffsets=!1),M.indices.length>0){if(offset=Bridge.Int.div(this.verticies.length,3)|0,i=0,respectOffsets)for(P=BNTest.GLVec3.op_Subtraction(M.offset,this.offset),i=0;i<M.verticies.length;)N=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(M.verticies[Bridge.identity(i,i=i+1|0)],M.verticies[Bridge.identity(i,i=i+1|0)],M.verticies[Bridge.identity(i,i=i+1|0)]),P),this.updateMinMax$1(N),this.verticies.push(N.x),this.verticies.push(N.y),this.verticies.push(N.z);else this.updateMinMax$4(M.verticies),BNTest.HelperExtensions.pushRange(System.Double,this.verticies,M.verticies);for(BNTest.HelperExtensions.pushRange(System.Double,this.colors,M.colors),BNTest.HelperExtensions.pushRange(System.Double,this.textureCoords,M.textureCoords),i=0;i<M.indices.length;)this.indices.push(M.indices[i]+offset|0),i=i+1|0;this.needsUpdate=!0}},updateTranformation:function(){if(this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0,this.transformed){this.transformation.clear();var M=this.transformation,scaled=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1),offseted=this.offset.getRoughLength()!==0;scaled&&(offseted?M.setPositionThenScale(this.offset,this.scale):M.mvScale(this.scale));this.rotation.getRoughLength()!==0&&(this.rotation.y!==0&&M.rotateY(this.rotation.y*.01745329251),this.rotation.x!==0&&M.rotateX(this.rotation.x*.01745329251),this.rotation.z!==0&&M.rotateZ(this.rotation.z*.01745329251));!scaled&&offseted&&M.setTranslation(this.offset)}},drawElements:function(){var G=this.getgl();G.drawElements(G.TRIANGLES,this.indices.length,G.UNSIGNED_SHORT,0)},draw:function(){this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0;this.transformed&&(this.updateTranformation(),this.getGD().mvPushMatrix(),this.getGD().multMatrix(this.transformation.mvMatrix,!0));this.getGD().flushMatrix();BNTest.Mesh.enabled&&this.drawElements();this.transformed&&this.getGD().mvPopMatrix()},update:function(){if(this.needsUpdate){if(BNTest.Mesh.enabled){var G=this.getgl();(!this.hasBuffer||this.clonedBuffer)&&(this.cubeVerticesBuffer=G.createBuffer(),this.cubeVerticesColorBuffer=G.createBuffer(),this.cubeVerticesIndexBuffer=G.createBuffer(),this.cubeVerticesTextureCoordBuffer=G.createBuffer(),this.hasBuffer=!0,this.clonedBuffer=!1);G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesBuffer);G.bufferData(G.ARRAY_BUFFER,new Float32Array(this.verticies),G.STATIC_DRAW);G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesColorBuffer);G.bufferData(G.ARRAY_BUFFER,new Float32Array(this.colors),G.STATIC_DRAW);G.bindBuffer(G.ELEMENT_ARRAY_BUFFER,this.cubeVerticesIndexBuffer);G.bufferData(G.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),G.STATIC_DRAW);G.bindBuffer(G.ARRAY_BUFFER,this.cubeVerticesTextureCoordBuffer);G.bufferData(G.ARRAY_BUFFER,new Float32Array(this.textureCoords),G.STATIC_DRAW)}this.needsUpdate=!1}},getVerticies:function(){for(var ret=System.Array.init(0,null),i=0,X,Y,Z;i<this.verticies.length;)X=this.verticies[i],i=i+1|0,Y=this.verticies[i],i=i+1|0,Z=this.verticies[i],i=i+1|0,ret.push(new BNTest.GLVec3.ctor(X,Y,Z));return ret},setVerticies:function(V){this.verticies=System.Array.init(0,0);for(var i=0;i<V.length;)this.verticies.push(V[i].x),this.verticies.push(V[i].y),this.verticies.push(V[i].z),i=i+1|0;this.needsUpdate=!0},getIndicies:function(){for(var ret=System.Array.init(0,null),k=0,i,X,Y,Z;k<this.indices.length;)i=this.indices[k]*3|0,X=this.verticies[i],i=i+1|0,Y=this.verticies[i],i=i+1|0,Z=this.verticies[i],i=i+1|0,ret.push(new BNTest.GLVec3.ctor(X,Y,Z));return ret},smoothen$1:function(iterations,strength){strength===void 0&&(strength=.35);for(var L=this.getVerticies();iterations>0;)iterations=iterations-1|0,L=BNTest.Mesh.smoothen(L,strength);this.setVerticies(L)},smoothen:function(strength){strength===void 0&&(strength=.35);this.setVerticies(BNTest.Mesh.smoothen(this.getVerticies(),strength))},smoothenB:function(strength){strength===void 0&&(strength=.35);this.setVerticies(BNTest.Mesh.smoothenB(this.getVerticies(),strength))},applyPalette:function(palette){var Keys=System.Linq.Enumerable.from(palette.getKeys()).toList(BNTest.GLColor),Vals=System.Linq.Enumerable.from(palette.getValues()).toList(BNTest.GLColor),C,k,t,ind;if(!(Keys.getCount()<=0)){for(var kln=Keys.getCount(),key,i=0,ln=this.colors.length,LC=null,VC=null;i<ln;){if(C=new BNTest.GLColor(this.colors[i],this.colors[i+1|0],this.colors[i+2|0],this.colors[i+3|0]),key=null,LC!=null&&C.equals(LC)){VC!=null&&(this.colors[i]=VC.r,this.colors[i+1|0]=VC.g,this.colors[i+2|0]=VC.b,this.colors[i+3|0]=VC.a);i=i+4|0;continue}if(C!=null&&C.a>0){for(k=0;k<kln;)t=Keys.getItem(k),t.similar(C)&&(key=t,k=ln),k=k+1|0;key!=null?(ind=Keys.indexOf(key),ind>=0?(VC=Vals.getItem(ind),this.colors[i]=VC.r,this.colors[i+1|0]=VC.g,this.colors[i+2|0]=VC.b,this.colors[i+3|0]=VC.a):VC=null):VC=null}i=i+4|0;LC=C}this.needsUpdate=!0}},clone:function(shallow){var M,i;return shallow===void 0&&(shallow=!1),M=new BNTest.Mesh(this.getGD()),shallow?(M.verticies=this.verticies,M.colors=this.colors,M.indices=this.indices,M.textureCoords=this.textureCoords,M.needsUpdate=this.needsUpdate,M.cubeVerticesBuffer=this.cubeVerticesBuffer,M.cubeVerticesColorBuffer=this.cubeVerticesColorBuffer,M.cubeVerticesIndexBuffer=this.cubeVerticesIndexBuffer,M.cubeVerticesTextureCoordBuffer=this.cubeVerticesTextureCoordBuffer,M.hasBuffer=this.hasBuffer,M.clonedBuffer=!0,M.min=this.min,M.max=this.max,M.offset=this.offset,M.rotation=this.rotation,M.scale=this.scale):(i=0,M.verticies=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.verticies,this.verticies),M.colors=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.colors,this.colors),M.indices=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Int32,M.indices,this.indices),M.textureCoords=System.Array.init(0,0),BNTest.HelperExtensions.pushRange(System.Double,M.textureCoords,this.textureCoords),M.min=this.min.clone(),M.max=this.max.clone(),M.offset=this.offset.clone(),M.rotation=this.rotation.clone(),M.scale=this.scale.clone(),M.cubeVerticesBuffer=this.cubeVerticesBuffer,M.cubeVerticesColorBuffer=this.cubeVerticesColorBuffer,M.cubeVerticesIndexBuffer=this.cubeVerticesIndexBuffer,M.cubeVerticesTextureCoordBuffer=this.cubeVerticesTextureCoordBuffer,M.hasBuffer=this.hasBuffer,M.clonedBuffer=!0,M.doNotUnload=this.doNotUnload),M},unloadBuffers:function(){!this.hasBuffer||this.clonedBuffer||this.doNotUnload||(this.clearBuffers(),this.needsUpdate=!0)},clearBuffers:function(){!this.hasBuffer||this.clonedBuffer||this.doNotUnload||(this.getgl().deleteBuffer(this.cubeVerticesBuffer),this.getgl().deleteBuffer(this.cubeVerticesColorBuffer),this.getgl().deleteBuffer(this.cubeVerticesIndexBuffer),this.getgl().deleteBuffer(this.cubeVerticesTextureCoordBuffer),console.log("Cleared mesh buffer."),this.hasBuffer=!1)},addTextureRect:function(times){for(times===void 0&&(times=1);times>0;)times=times-1|0,this.textureCoords.push(0,0,0,1,1,0,1,1)},addVoxelMap:function(VM,interpolate,center,toplayeronly){var C;interpolate===void 0&&(interpolate=!1);center===void 0&&(center=!0);toplayeronly===void 0&&(toplayeronly=!1);interpolate&&!BNTest.Mesh.allowInterpolation&&(interpolate=!1);var Map=VM.map,X=0,Y=0,Z=0,SV=new BNTest.GLVec3.ctor(0,0,0);center&&(SV=BNTest.GLVec3.op_Addition(SV,new BNTest.GLVec3.ctor((-System.Array.getLength(Map,0)|0)/2,(-System.Array.getLength(Map,1)|0)/2,(-System.Array.getLength(Map,2)|0)/2)));var V=BNTest.GLVec3.op_Addition(SV,new BNTest.GLVec3.ctor),VB=new BNTest.GLVec3.ctor(1,1,1),VB2=new BNTest.GLVec3.ctor(1,1,2),CV=new BNTest.GLVec3.ctor,MX=System.Array.getLength(Map,0),MY=System.Array.getLength(Map,1),MZ=System.Array.getLength(Map,2);this.qV3Set=!0;this.QV3=Bridge.Int.div(this.verticies.length,3)|0;for(var M=Map,ind=0,sides=null,sides2=null,interpolation=null,interpolation2=null;X<MX;){while(Y<MY){while(Z<MZ)C=M[ind],VM.valid(C)&&(toplayeronly?(CV.copyFrom(V),CV.add$1(1,0,1),this.addRectangle(V,CV,C)):(interpolate&&(interpolation=VM.getValidQuadrants(X,Y,Z,interpolation)),sides=VM.getInvisibleSides(X,Y,Z,sides),BNTest.Mesh.correctTextures||(Z+1|0)>=MZ||!0?(CV.copyFrom(V),CV.add(VB),this.addCube2(V,CV,C,sides,interpolation)):(interpolate&&(interpolation2=VM.getValidQuadrants(X,Y,Z+1|0,interpolation2)),sides2=VM.getInvisibleSides(X,Y,Z+1|0,sides2),BNTest.HelperExtensions.identical(Boolean,interpolation,interpolation2)&&BNTest.HelperExtensions.identical(Boolean,sides,sides2)&&Bridge.referenceEquals(C,M[ind+1|0])?(CV.copyFrom(V),CV.add(VB2),this.addCube2(V,CV,C,sides,interpolation),V.z+=1,Z=Z+1|0,ind=ind+1|0):(CV.copyFrom(V),CV.add(VB),this.addCube2(V,CV,C,sides,interpolation))))),V.z+=1,Z=Z+1|0,ind=ind+1|0;V.z=SV.z;V.y+=1;Z=0;Y=Y+1|0}V.z=SV.z;V.y=SV.y;V.x+=1;Y=0;Z=0;X=X+1|0}this.qV3Set=!1},addVert:function(V,C){BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);BNTest.Mesh.pushValue(this.indices,[Bridge.Int.div(this.indices.length,3)|0]);this.needsUpdate=!0},addCube1:function(Min,Max,C){var GV=this.TGV;GV[0]=new BNTest.GLVec3.ctor(Min.x,Min.y,Min.z);GV[1]=new BNTest.GLVec3.ctor(Max.x,Min.y,Min.z);GV[2]=new BNTest.GLVec3.ctor(Min.x,Max.y,Min.z);GV[3]=new BNTest.GLVec3.ctor(Max.x,Max.y,Min.z);GV[4]=new BNTest.GLVec3.ctor(Min.x,Min.y,Max.z);GV[5]=new BNTest.GLVec3.ctor(Max.x,Min.y,Max.z);GV[6]=new BNTest.GLVec3.ctor(Min.x,Max.y,Max.z);GV[7]=new BNTest.GLVec3.ctor(Max.x,Max.y,Max.z);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[1],GV[2],GV[3],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[4],GV[5],GV[6],GV[7],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[2],GV[4],GV[6],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[1],GV[3],GV[5],GV[7],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[0],GV[1],GV[4],GV[5],C);C=BNTest.GLColor.random();this.addRectangle$1(GV[2],GV[3],GV[6],GV[7],C)},reverseVerticeOrder:function(){for(var ln=Bridge.Int.div(this.verticies.length,3)|0,ind=System.Array.init(0,0),i=0;i<this.indices.length;)ind.push((ln-1|0)-this.indices[i]|0),i=i+1|0;this.indices=ind;BNTest.HelperExtensions.reverseOrderWithStructure(System.Double,this.verticies,3);BNTest.HelperExtensions.reverseOrderWithStructure(System.Double,this.colors,4);BNTest.HelperExtensions.reverseOrderWithStructure(System.Double,this.textureCoords,2);this.needsUpdate=!0},addCube2:function(Min,Max,C,invisible,interpolation){var GV,quarter,center,GVL,V,ind;interpolation===void 0&&(interpolation=null);invisible==null&&(invisible=System.Array.init(6,!1));GV=this.TGV;GV[0]==null&&(GV[0]=new BNTest.GLVec3.ctor,GV[1]=new BNTest.GLVec3.ctor,GV[2]=new BNTest.GLVec3.ctor,GV[3]=new BNTest.GLVec3.ctor,GV[4]=new BNTest.GLVec3.ctor,GV[5]=new BNTest.GLVec3.ctor,GV[6]=new BNTest.GLVec3.ctor,GV[7]=new BNTest.GLVec3.ctor);GV[0].set(Min.x,Min.y,Min.z);GV[1].set(Max.x,Min.y,Min.z);GV[2].set(Min.x,Max.y,Min.z);GV[3].set(Max.x,Max.y,Min.z);GV[4].set(Min.x,Min.y,Max.z);GV[5].set(Max.x,Min.y,Max.z);GV[6].set(Min.x,Max.y,Max.z);GV[7].set(Max.x,Max.y,Max.z);for(var temp=new BNTest.GLVec3.ctor,swap,i=0,total=0,i=0;i<6;)invisible[i]||(total=total+1|0),i=i+1|0;if(interpolation!=null)for(quarter=!0,center=BNTest.GLVec3.getCenter(Min,Max),i=0,GVL=GV.length;i<GVL;)interpolation[i]||(quarter?(swap=GV[i],BNTest.GLVec3.getCenter$1(swap,center,temp),GV[i]=temp,temp=swap):total<4&&(GV[i]=center)),i=i+1|0;this.qV3Set||(this.QV3=Bridge.Int.div(this.verticies.length,3)|0);BNTest.Mesh.cullTest?(C=new BNTest.GLColor(0,1,0),invisible[0]||this.quickAddRectangle(GV[0],GV[1],GV[2],GV[3],C,!0),invisible[1]||this.quickAddRectangle(GV[4],GV[5],GV[6],GV[7],C),C=new BNTest.GLColor(0,0,1),invisible[2]||this.quickAddRectangle(GV[0],GV[2],GV[4],GV[6],C,!0),invisible[3]||this.quickAddRectangle(GV[1],GV[3],GV[5],GV[7],C),C=new BNTest.GLColor(1,0,0),invisible[5]||this.quickAddRectangle(GV[2],GV[3],GV[6],GV[7],C,!0),invisible[4]||this.quickAddRectangle(GV[0],GV[1],GV[4],GV[5],C)):total<=1||BNTest.Mesh.correctTextures||!0?(invisible[0]||this.quickAddRectangle(GV[0],GV[1],GV[2],GV[3],C,!0),invisible[1]||this.quickAddRectangle(GV[4],GV[5],GV[6],GV[7],C),invisible[2]||this.quickAddRectangle(GV[0],GV[2],GV[4],GV[6],C,!0),invisible[3]||this.quickAddRectangle(GV[1],GV[3],GV[5],GV[7],C),invisible[5]||this.quickAddRectangle(GV[2],GV[3],GV[6],GV[7],C,!0),invisible[4]||this.quickAddRectangle(GV[0],GV[1],GV[4],GV[5],C)):(V=GV[0],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[1],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[2],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[3],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]),V=GV[4],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[5],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[6],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),V=GV[7],BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]),BNTest.Mesh.pushColor(this.colors,C),BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]),ind=this.QV3,invisible[0]||this.quickAddRectangle$1(ind+0|0,ind+1|0,ind+2|0,ind+3|0,C,!0),invisible[1]||this.quickAddRectangle$1(ind+4|0,ind+5|0,ind+6|0,ind+7|0,C),invisible[2]||this.quickAddRectangle$1(ind+0|0,ind+2|0,(ind+0|0)+4|0,(ind+2|0)+4|0,C,!0),invisible[3]||this.quickAddRectangle$1(ind+1|0,ind+3|0,(ind+1|0)+4|0,(ind+3|0)+4|0,C),invisible[5]||this.quickAddRectangle$1(ind+2|0,ind+3|0,(ind+2|0)+4|0,(ind+3|0)+4|0,C,!0),invisible[4]||this.quickAddRectangle$1(ind+0|0,ind+1|0,(ind+0|0)+4|0,(ind+1|0)+4|0,C),this.QV3=this.QV3+8|0)},addCube:function(Min,Max,C){this.addCube1(Min,Max,C);return},addRectangle:function(Min,Max,C){var V1=Min,V2=new BNTest.GLVec3.ctor(Max.x,Min.y,Min.z),V3=new BNTest.GLVec3.ctor(Min.x,Max.y,Max.z),V4=Max;this.addRectangle$1(V1,V2,V3,V4,C)},addRectangle$1:function(V1,V2,V3,V4,C){var ind=Bridge.Int.div(this.verticies.length,3)|0,V;V=V1;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V2;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V3;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V4;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);this.updateMinMax$2([V1,V2,V3,V4]);BNTest.Mesh.pushValue(this.indices,[ind,ind+1|0,ind+2|0,ind+2|0,ind+1|0,ind+3|0]);BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]);this.needsUpdate=!0},updateMinMax:function(){for(var i=0,V=this.verticies;i<V.length;)this.updateMinMax$3(V[i],V[i+1|0],V[i+2|0]),i=i+3|0},updateMinMax$2:function(V){V===void 0&&(V=[]);for(var i=0,ln=V.length;i<ln;)this.updateMinMax$1(V[i]),i=i+1|0},updateMinMax$4:function(V){var i,ln,N;for(V===void 0&&(V=[]),i=0,ln=V.length;i<ln;)N=new BNTest.GLVec3.ctor(V[i],V[i+1|0],V[i+2|0]),this.updateMinMax$1(N),i=i+3|0},updateMinMax$1:function(V){this.min.min(V);this.max.max(V)},updateMinMax$3:function(X,Y,Z){this.min.min$1(X,Y,Z);this.max.max$1(X,Y,Z)},quickAddRectangle$1:function(V1,V2,V3,V4,C,inv){inv===void 0&&(inv=!1);inv?BNTest.Mesh.pushValue(this.indices,[V3,V2,V1,V4,V2,V3]):BNTest.Mesh.pushValue(this.indices,[V1,V2,V3,V3,V2,V4])},quickAddRectangle:function(V1,V2,V3,V4,C,inv){inv===void 0&&(inv=!1);var ind=this.QV3,V;V=V1;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V2;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V3;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);V=V4;BNTest.Mesh.pushValue(this.verticies,[V.x,V.y,V.z]);BNTest.Mesh.pushColor(this.colors,C);this.updateMinMax$2([V1,V2,V3,V4]);inv?BNTest.Mesh.pushValue(this.indices,[ind+2|0,ind+1|0,ind,ind+3|0,ind+1|0,ind+2|0]):BNTest.Mesh.pushValue(this.indices,[ind,ind+1|0,ind+2|0,ind+2|0,ind+1|0,ind+3|0]);BNTest.Mesh.pushValue(this.textureCoords,[0,0,1,0,0,1,1,1]);this.QV3=this.QV3+4|0;this.needsUpdate=!0}});Bridge.define("BNTest.MeshUtils",{statics:{laplacianFilter:function(sv,t){for(var ln,j,avj,wv=System.Array.init(sv.length,null),adjacentVertices=System.Array.init(0,null),dx=0,dy=0,dz=0,svln=sv.length,vi=0;vi<svln;vi=vi+1|0)if(adjacentVertices=BNTest.MeshUtils.findAdjacentNeighbors(sv,t,sv[vi]),ln=adjacentVertices.length,ln!==0){for(dx=0,dy=0,dz=0,j=0;j<ln;j=j+1|0)avj=adjacentVertices[j],dx+=avj.x,dy+=avj.y,dz+=avj.z;wv[vi]=new BNTest.GLVec3.ctor;wv[vi].x=dx/ln;wv[vi].y=dy/ln;wv[vi].z=dz/ln}return wv},hcFilter:function(sv,pv,t,alpha,beta){for(var wv=System.Array.init(sv.length,null),bv=System.Array.init(sv.length,null),bvi,wvi,svi,j,k,bvak,wv=BNTest.MeshUtils.laplacianFilter(sv,t),i=0;i<wv.length;i=i+1|0)bvi=new BNTest.GLVec3.ctor,bv[i]=bvi,wvi=wv[i],svi=sv[i],alpha>0?(bvi.x=wvi.x-(alpha*svi.x+(1-alpha)*svi.x),bvi.y=wvi.y-(alpha*svi.y+(1-alpha)*svi.y),bvi.z=wvi.z-(alpha*svi.z+(1-alpha)*svi.z)):(bvi.x=wvi.x-svi.x,bvi.y=wvi.y-svi.y,bvi.z=wvi.z-svi.z);var adjacentIndexes=new(System.Collections.Generic.List$1(System.Int32)),dx=0,dy=0,dz=0,ln=bv.length;for(j=0;j<ln;j=j+1|0){for(adjacentIndexes.clear(),adjacentIndexes=BNTest.MeshUtils.findAdjacentNeighborIndexes(sv,t,sv[j]),dx=0,dy=0,dz=0,k=0;k<adjacentIndexes.getCount();k=k+1|0)bvak=bv[adjacentIndexes.getItem(k)],dx+=bvak.x,dy+=bvak.y,dz+=bvak.z;var wvj=wv[j],bvj=bv[j],betac=(1-beta)/adjacentIndexes.getCount();wvj.x-=beta*bvj.x+betac*dx;wvj.y-=beta*bvj.y+betac*dy;wvj.z-=beta*bvj.z+betac*dz}return wv},findAdjacentNeighbors:function(v,t,vertex){for(var vi,k,adjacentV=System.Array.init(0,null),facemarker=new(System.Collections.Generic.List$1(System.Int32)),facecount=0,i=0;i<v.length;i=i+1|0)if(vi=v[i],BNTest.MeshUtils.approximately$1(vertex.x,vi.x)&&BNTest.MeshUtils.approximately$1(vertex.y,vi.y)&&BNTest.MeshUtils.approximately$1(vertex.z,vi.z)){var v1=0,v2=0,marker=!1;for(k=0;k<t.length;k=k+3|0)facemarker.contains(k)===!1&&(v1=0,v2=0,marker=!1,i===t[k]&&(v1=t[k+1|0],v2=t[k+2|0],marker=!0),i===t[k+1|0]&&(v1=t[k],v2=t[k+2|0],marker=!0),i===t[k+2|0]&&(v1=t[k],v2=t[k+1|0],marker=!0),facecount=facecount+1|0,marker&&(facemarker.add(k),BNTest.MeshUtils.isVertexExist(adjacentV,v[v1])===!1&&adjacentV.push(v[v1]),BNTest.MeshUtils.isVertexExist(adjacentV,v[v2])===!1&&adjacentV.push(v[v2]),marker=!1))}return adjacentV},findAdjacentNeighborIndexes:function(v,t,vertex){for(var k,adjacentIndexes=new(System.Collections.Generic.List$1(System.Int32)),adjacentV=System.Array.init(0,null),facemarker=new(System.Collections.Generic.List$1(System.Int32)),facecount=0,i=0;i<v.length;i=i+1|0)if(BNTest.MeshUtils.approximately(vertex,v[i])){var v1=0,v2=0,marker=!1,ln=t.length;for(k=0;k<ln;k=k+3|0)facemarker.contains(k)===!1&&(v1=0,v2=0,marker=!1,i===t[k]&&(v1=t[k+1|0],v2=t[k+2|0],marker=!0),i===t[k+1|0]&&(v1=t[k],v2=t[k+2|0],marker=!0),i===t[k+2|0]&&(v1=t[k],v2=t[k+1|0],marker=!0),facecount=facecount+1|0,marker&&(facemarker.add(k),BNTest.MeshUtils.isVertexExist(adjacentV,v[v1])===!1&&(adjacentV.push(v[v1]),adjacentIndexes.add(v1)),BNTest.MeshUtils.isVertexExist(adjacentV,v[v2])===!1&&(adjacentV.push(v[v2]),adjacentIndexes.add(v2)),marker=!1))}return adjacentIndexes},isVertexExist:function(adjacentV,v){for(var marker=!1,i=0,vec;i<adjacentV.length;){if(vec=adjacentV[i],BNTest.MeshUtils.approximately(vec,v)){marker=!0;break}i=i+1|0}return marker},approximately$1:function(x,x2){return Math.abs(x-x2)<.0005},approximately:function(v,v2){return Math.abs(v.x-v2.x)<.0005&&Math.abs(v.y-v2.y)<.0005&&Math.abs(v.z-v2.z)<.0005}}});Bridge.define("BNTest.Model",{meshes:null,children:null,offset:null,rotation:null,scale:null,transformation:null,transformed:!1,inView:!0,forceRender:!1,customBoundingBox:null,alpha:1,color:null,bleedThrough:!1,znearRate:-1,drawOrder:0,drawn:!1,config:{properties:{gl:null,GD:null,Visible:!0},init:function(){this.offset=new BNTest.GLVec3.ctor;this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1);this.color=new BNTest.GLColor(1,1,1)}},ctor:function(GD){this.$initialize();this.setGD(GD);this.setgl(GD.gl);this.meshes=new(System.Collections.Generic.List$1(BNTest.Mesh));this.children=new(System.Collections.Generic.List$1(BNTest.Model));this.transformation=new BNTest.WGMatrix},getBoundingBox:function(){var O,B;if(this.customBoundingBox!=null)return BNTest.BoundingBox.op_Addition(this.customBoundingBox,this.offset);O=this.offset;this.offset=new BNTest.GLVec3.ctor;this.updateTransform();this.offset=O;for(var Min=new BNTest.GLVec3.ctor(System.Double.max,System.Double.max,System.Double.max),Max=new BNTest.GLVec3.ctor(System.Double.min,System.Double.min,System.Double.min),T=this.transformation,i=0,ln=this.meshes.getCount();i<ln;){var Mmn=BNTest.GLVec3.transform(this.meshes.getItem(i).min,T),Mmx=BNTest.GLVec3.transform(this.meshes.getItem(i).max,T),tmp=new BNTest.BoundingBox.$ctor1(this.meshes.getItem(i).min,this.meshes.getItem(i).max);Min.min(Mmn);Max.max(Mmx);i=i+1|0}for(i=0,ln=this.children.getCount();i<ln;)B=this.children.getItem(i).getBoundingBox(),Min.min(B.min),Max.max(B.max),i=i+1|0;return Min.add(this.offset),Max.add(this.offset),new BNTest.BoundingBox.$ctor1(Min,Max)},clear:function(){this.unloadBuffers();this.meshes=new(System.Collections.Generic.List$1(BNTest.Mesh));this.children=new(System.Collections.Generic.List$1(BNTest.Model));this.rotation=new BNTest.GLVec3.ctor;this.scale=new BNTest.GLVec3.ctor(1,1,1)},unloadBuffers:function(){BNTest.HelperExtensions.forEach(BNTest.Mesh,this.meshes,$_.BNTest.Model.f1);BNTest.HelperExtensions.forEach(BNTest.Model,this.children,$_.BNTest.Model.f2)},updateTransform:function(){if(this.transformed=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1)||this.rotation.getRoughLength()!==0||this.offset.getRoughLength()!==0,this.transformed){this.transformation.clear();var M=this.transformation,scaled=!(this.scale.x===1&&this.scale.y===1&&this.scale.z===1),offseted=this.offset.getRoughLength()!==0;scaled&&(offseted?M.setPositionThenScale(this.offset,this.scale):M.mvScale(this.scale));this.rotation.getRoughLength()!==0&&(this.rotation.y!==0&&M.rotateY(this.rotation.y*.01745329251),this.rotation.x!==0&&M.rotateX(this.rotation.x*.01745329251),this.rotation.z!==0&&M.rotateZ(this.rotation.z*.01745329251));!scaled&&offseted&&M.setTranslation(this.offset)}},clone:function(){var ret=new BNTest.Model(this.getGD());return ret.copyFrom(this),ret},getMeshes:function(OUT){OUT===void 0&&(OUT=null);OUT==null&&(OUT=System.Array.init(0,null));BNTest.HelperExtensions.pushRange(BNTest.Mesh,OUT,this.meshes.items);for(var i=0,ln=this.children.getCount();i<ln;)this.children.getItem(i).getMeshes(OUT),i=i+1|0;return OUT},countElements:function(OUT){var ret,i,ln,M,C,R;if(OUT===void 0&&(OUT=null),ret=OUT,ret==null&&(ret=System.Array.init(0,0),ret[0]=0,ret[1]=0),!this.drawn)return ret;for(i=0,ln=this.meshes.getCount();i<ln;)M=this.meshes.getItem(i),ret[0]=ret[0]+1|0,ret[1]=ret[1]+M.indices.length|0,i=i+1|0;for(i=0,ln=this.children.getCount();i<ln;)C=this.children.getItem(i),R=C.countElements(ret),i=i+1|0;return ret},copyFrom:function(source,shallow){shallow===void 0&&(shallow=!1);var M=source;shallow?(this.meshes=M.meshes,this.children=M.children):(BNTest.HelperExtensions.forEach(BNTest.Mesh,M.meshes,Bridge.fn.bind(this,$_.BNTest.Model.f3)),BNTest.HelperExtensions.forEach(BNTest.Model,M.children,Bridge.fn.bind(this,$_.BNTest.Model.f4)));this.bleedThrough=M.bleedThrough;this.color=M.color;this.alpha=M.alpha;this.scale=M.scale},smoothen:function(strength){if(strength===void 0&&(strength=1),this.getGD().smooth){for(var i=0;i<this.meshes.getCount();)this.meshes.getItem(i).smoothenB(.5*strength),this.meshes.getItem(i).smoothen(.21*strength),i=i+1|0;for(i=0;i<this.children.getCount();)this.children.getItem(i).smoothen(),i=i+1|0}},update:function(){for(var i=0,ln=this.meshes.getCount();i<ln;)this.meshes.getItem(i).update(),i=i+1|0;for(ln=this.children.getCount();i<ln;)this.children.getItem(i).update(),i=i+1|0},render:function(){var col,i,ln;if(this.drawn=!1,this.updateTransform(),this.getVisible()&&(this.inView||this.forceRender)){for(this.transformed&&(this.getGD().mvPushMatrix(),this.getGD().multMatrix(this.transformation.mvMatrix,!0)),this.alpha<1&&this.getGD().pushAlpha(this.alpha),col=!this.color.equals(BNTest.GLColor.white),col&&this.getGD().setColor(this.color),this.bleedThrough&&this.getGD().setDepthTest(!1),this.znearRate>0&&this.getGD().setPerspective(this.znearRate),i=0,ln=this.meshes.getCount();i<ln;)this.meshes.getItem(i).render(),i=i+1|0;for(ln=this.children.getCount();i<ln;)this.children.getItem(i).render(),i=i+1|0;this.znearRate>0&&this.getGD().setPerspective();this.bleedThrough&&this.getGD().setDepthTest(!0);col&&this.getGD().resetColor();this.alpha<1&&this.getGD().popAlpha();this.transformed&&this.getGD().mvPopMatrix();this.drawn=!0}}});Bridge.ns("BNTest.Model",$_);Bridge.apply($_.BNTest.Model,{f1:function(M){M.unloadBuffers()},f2:function(C){C.unloadBuffers()},f3:function(msh){this.meshes.add(msh.clone())},f4:function(mdl){this.children.add(mdl.clone())}});Bridge.define("BNTest.ModelCache",{statics:{__this:null,config:{init:function(){this.__this=new BNTest.ModelCache}},get_this:function(){return BNTest.ModelCache.__this}},data:null,config:{init:function(){this.data=new(System.Collections.Generic.Dictionary$2(String,BNTest.Model))}},get:function(modelName,clone){return(clone===void 0&&(clone=!0),this.data.containsKey(modelName))?clone?this.data.get(modelName).clone():this.data.get(modelName):null},set:function(modelName,mesh){var M=new BNTest.Model(mesh.getGD());M.meshes.add(mesh.clone());this.set$1(modelName,M)},set$1:function(modelName,model){model.update();var NM=model.clone();this.data.set(modelName,NM);BNTest.HelperExtensions.forEach(BNTest.Mesh,NM.getMeshes(),$_.BNTest.ModelCache.f1);BNTest.HelperExtensions.forEach(BNTest.Mesh,model.getMeshes(),$_.BNTest.ModelCache.f2)}});Bridge.ns("BNTest.ModelCache",$_);Bridge.apply($_.BNTest.ModelCache,{f1:function(msh){msh.clonedBuffer=!1},f2:function(msh){msh.clonedBuffer=!0}});Bridge.define("BNTest.NetPlay",{statics:{room_prefix:null,_this:null,config:{init:function(){this.room_prefix=System.String.concat(System.String.concat("RSG_NetPlay_TouhouVoxelBattles",System.String.replaceAll(BNTest.App.gameVersion,".","_")),"_")}}},channel:null,onOpen:null,onClose:null,onError:null,onMessage:null,onLeave:null,data:null,me:null,config:{properties:{users:null,roomID:null}},ctor:function(roomID,userName){userName===void 0&&(userName=null);this.$initialize();this.setroomID(System.String.concat(BNTest.NetPlay.room_prefix,roomID));this.data=new(System.Collections.Generic.List$1(Object));this.setusers(new(System.Collections.Generic.List$1(BNTest.NetPlayUser)));BNTest.NetPlay._this=this;userName!=null&&(userName=System.String.replaceAll(System.String.replaceAll(System.String.replaceAll(System.String.replaceAll(userName,".","")," ",""),"/",""),"-",""),userName=System.String.concat(System.String.concat(System.String.concat("User-",userName),"-"),Bridge.Int.clip32(Math.random())*1e5|0));this.init(userName)},getHoster:function(){return this.channel.isNewSessionOpened},init:function(userName){var self,extras,ch;userName===void 0&&(userName=null);self=this;extras={};extras.firebase="intense-torch-6778";userName!=null&&(extras.userid=userName);Bridge.Console.log(System.String.concat("NetPlay room:",this.getroomID()));this.channel=new DataChannel(self.roomID,extras);ch=this.channel;ch.onopen=function(userId){self._onOpen(userId)};ch.onleave=function(userId){self._onLeave(userId)};ch.onclose=function(evt){self._onClose(evt)};ch.onerror=function(evt){self._onError(evt)};ch.onmessage=function(message,userId,latency){self._onMessage(message,userId,latency)};ch.connect();this.me=new BNTest.NetPlayUser(this.channel.userid,!0);this.getusers().add(this.me)},close:function(){this.channel.leave()},_onOpen:function(userID){var user=this.getUserByName(userID,!0);if(user.connected=!0,this.onOpen)this.onOpen(user)},_onClose:function(evt){if(this.onClose)this.onClose(evt)},_onError:function(evt){if(Bridge.Console.log(System.String.concat("DataChannel error:",evt)),this.onError)this.onError(evt)},_onMessage:function(message,userID,latency){var user=this.getUserByName(userID,!0),L,i;if(user.messagePosted(),this.onMessage)for(L=message,i=0;i<L.length;){this.onMessage(L[i],user,latency);i=i+1|0}},_onLeave:function(userID){var user=this.getUserByName(userID,!0);if(user!=null&&(user.connected=!1,this.getusers().remove(user)),this.onLeave)this.onLeave(user)},send:function(message){this.data.add(message)},flush:function(){this.data.getCount()>0&&(this.channel.send(this.data.toArray()),this.data.clear())},addUser:function(userID){this.getUserByName(userID,!0)},getUserByName:function(userID,autoCreate){var L,ret;return(autoCreate===void 0&&(autoCreate=!1),L=new(System.Collections.Generic.List$1(BNTest.NetPlayUser))(System.Linq.Enumerable.from(this.getusers()).where(function(user){return Bridge.referenceEquals(user.userID,userID)})),L.getCount()>0)?L.getItem(0):autoCreate?(ret=new BNTest.NetPlayUser(userID),this.getusers().add(ret),ret):null}});Bridge.define("BNTest.NetPlayUser",{userID:null,connected:!1,_isMe:!1,config:{init:function(){this.lastMessagePost=new Date(-864e13)}},ctor:function(userID,isMe){isMe===void 0&&(isMe=!1);this.$initialize();this.userID=userID;this.connected=!0;this.lastMessagePost=new Date;this._isMe=isMe},getIsMe:function(){return this._isMe},gettimeSinceLastMessage:function(){return Bridge.Date.subdd(new Date,this.lastMessagePost)},messagePosted:function(){this.lastMessagePost=new Date},getName:function(){var parts=this.userID.split("-");return parts.length>2&&Bridge.referenceEquals(parts[0],"User")?parts[1]:""}});Bridge.define("BNTest.Octree",{children:null,nodeSize:0,nodeDepth:1,ctor:function(NodeSize,NodeDepth){this.$initialize();this.children=new(System.Collections.Generic.List$1(BNTest.OctreeNode));var sz=NodeSize;for(this.nodeDepth=NodeDepth;NodeDepth>0;)sz=sz+sz|0,NodeDepth=NodeDepth-1|0;this.nodeSize=sz},generateNode:function(X,Y,Z){var ret=new BNTest.OctreeNode,P=new BNTest.GLVec3.ctor(X*this.nodeSize|0,Y*this.nodeSize|0,Z*this.nodeSize|0);return ret.box=new BNTest.BoundingBox.$ctor1(P,BNTest.GLVec3.op_Addition(P,BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.getOne(),this.nodeSize))),ret.makeSubdivisions$1(this.nodeDepth),this.children.add(ret),ret},getChild:function(Position){var B=new BNTest.BoundingBox.$ctor1(Position,BNTest.GLVec3.op_Addition(Position,BNTest.GLVec3.getOne())),L=System.Linq.Enumerable.from(this.children).where(function(ON){return ON.box.intersection$2(B)}).toList(BNTest.OctreeNode),P;return L.getCount()>0?L.getItem(0):(P=BNTest.GLVec3.floor(BNTest.GLVec3.op_Division$1(Position,this.nodeSize)),this.generateNode(Bridge.Int.clip32(P.x),Bridge.Int.clip32(P.y),Bridge.Int.clip32(P.z)))},getNodes:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ret.addRange(ON.getNodes(collision))}),ret},getAllNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},getBottomMostNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},clear:function(){var L=this.getBottomMostNodes();BNTest.HelperExtensions.forEach(BNTest.OctreeNode,L,$_.BNTest.Octree.f1)},update:function(entitiesToPlace){this.clear();BNTest.HelperExtensions.forEach(BNTest.Entity,entitiesToPlace,Bridge.fn.bind(this,$_.BNTest.Octree.f2))},placeEntity:function(E){var L=this.getNodes(E.lastBB),N;L.getCount()===0&&(N=this.getChild(E.lastBB.min),BNTest.HelperExtensions.forEach(BNTest.OctreeNode,N.children,function(ON){L.addRange(ON.getNodes(E.lastBB))}));BNTest.HelperExtensions.forEach(BNTest.OctreeNode,L,function(ON){BNTest.HelperExtensions.addIfNew(BNTest.Entity,ON.entities,E)})}});Bridge.ns("BNTest.Octree",$_);Bridge.apply($_.BNTest.Octree,{f1:function(ON){ON.entities.clear()},f2:function(E){this.placeEntity(E)}});Bridge.define("BNTest.OctreeNode",{box:null,children:null,entities:null,config:{init:function(){this.entities=new(System.Collections.Generic.List$1(BNTest.Entity))}},makeSubdivisions$1:function(depth){depth>0&&(depth=depth-1|0,this.makeSubdivisions(),depth>0&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ON.makeSubdivisions$1(depth-1|0)}))},makeSubdivisions:function(){var B,Sz,ON;this.children==null&&this.box!=null&&(this.children=new(System.Collections.Generic.List$1(BNTest.OctreeNode)),B=this.box.clone(),B.setSize(BNTest.GLVec3.op_Multiply$1(B.getSize(),.5)),Sz=B.getSize(),ON=null,ON=new BNTest.OctreeNode,ON.box=B.clone(),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,0,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(0,0,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,0,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,0)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(0,Sz.y,Sz.z)),this.children.add(ON),ON=new BNTest.OctreeNode,ON.box=BNTest.BoundingBox.op_Addition(B,new BNTest.GLVec3.ctor(Sz.x,Sz.y,Sz.z)),this.children.add(ON))},findCollisions:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.Entity)),N=this.getNodes(collision);return BNTest.HelperExtensions.forEach(BNTest.OctreeNode,N,function(ON){BNTest.HelperExtensions.forEach(BNTest.Entity,ON.entities,function(E){E.lastBB.intersection$2(collision)&&BNTest.HelperExtensions.addIfNew(BNTest.Entity,ret,E)})}),ret},getAllNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return ret.add(this),this.children!=null&&BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}),ret},getBottomMostNodes:function(){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return this.children!=null?BNTest.HelperExtensions.forEach(BNTest.OctreeNode,ret,function(ON){ret.addRange(ON.getAllNodes())}):ret.add(this),ret},getNodes:function(collision){var ret=new(System.Collections.Generic.List$1(BNTest.OctreeNode));return(this.box==null||this.box.intersection$2(collision))&&(this.children==null?ret.add(this):BNTest.HelperExtensions.forEach(BNTest.OctreeNode,this.children,function(ON){ret.addRange(ON.getNodes(collision))})),ret}});Bridge.define("BNTest.Player",{ID:0,character:null,networkID:null,score:0,CPU:!1,lives:3,minion:!1,config:{properties:{local:!1}},ctor:function(local,CPU,minion){minion===void 0&&(minion=!1);this.$initialize();this.setlocal(local);this.CPU=CPU;this.minion=minion}});Bridge.define("BNTest.Quad",{V1:null,V2:null,V3:null,V4:null,reversed:!1,ctor:function(){this.$initialize()},$ctor1:function(Min,Max){this.$initialize();this.V1=Min;var MnP=Min.position,MxP=Max.position,C=Min.color;this.V2=new BNTest.Vertex.$ctor1(new BNTest.GLVec3.ctor(MxP.x,MnP.y,MnP.z),new BNTest.Vector2(Max.textureCoord.x,Min.textureCoord.y),C);this.V3=new BNTest.Vertex.$ctor1(new BNTest.GLVec3.ctor(MnP.x,MxP.y,MxP.z),new BNTest.Vector2(Min.textureCoord.x,Max.textureCoord.y),C);this.V4=Max},getCenter:function(){var V=[this.V1.position,this.V2.position,this.V3.position,this.V4.position],min=BNTest.GLVec3.min$1(V),max=BNTest.GLVec3.max$1(V),X=(max.x-min.x)*.5,Y=(max.y-min.y)*.5,Z=(max.z-min.z)*.5;return new BNTest.GLVec3.ctor(min.x+X,min.y+Y,min.z+Z)},getMinMax:function(){var V=[this.V1.position,this.V2.position,this.V3.position,this.V4.position];return[BNTest.GLVec3.min$1(V),BNTest.GLVec3.max$1(V)]},isCombinable:function(Q){var R=0,QC;return(R=R+this.V1.position.alignedAxis(Q.V1.position)|0,R=R+this.V2.position.alignedAxis(Q.V2.position)|0,R=R+this.V3.position.alignedAxis(Q.V3.position)|0,R=R+this.V4.position.alignedAxis(Q.V4.position)|0,R>=8&&(QC=Q.getCenter(),this.V1.position.roughDistance(QC)===1||this.V2.position.roughDistance(QC)===1||this.V3.position.roughDistance(QC)===1||this.V4.position.roughDistance(QC)===1))?!0:!1},combine:function(Q){var V1=this.getMinMax(),V2=Q.getMinMax(),min=BNTest.GLVec3.min(V1[0],V2[0]),max=BNTest.GLVec3.max(V1[0],V2[0]);this.setMinMax(min,max)},setMinMax:function(min,max){this.V1.position=min.clone();this.V2.position.x=max.x;this.V2.position.y=min.y;this.V2.position.z=min.z;this.V2.position.equals(this.V1.position)&&(this.V2.position.z=max.z);this.V3.position.x=min.x;this.V3.position.y=max.y;this.V3.position.z=max.z;this.V4.position=max.clone()}});Bridge.define("BNTest.Rectangle",{x:0,y:0,width:0,height:0,ctor:function(x,y,width,height){x===void 0&&(x=0);y===void 0&&(y=0);width===void 0&&(width=0);height===void 0&&(height=0);this.$initialize();this.x=x;this.y=y;this.width=width;this.height=height},getleft:function(){return this.x},setleft:function(value){this.x=value},gettop:function(){return this.y},settop:function(value){this.y=value},getright:function(){return this.x+this.width},setright:function(value){this.width=value-this.x},getbottom:function(){return this.y+this.height},setbottom:function(value){this.height=value-this.y},getpoints:function(){var ret=System.Array.init(8,0),i=0;return ret[Bridge.identity(i,i=i+1|0)]=this.x,ret[Bridge.identity(i,i=i+1|0)]=this.y,ret[Bridge.identity(i,i=i+1|0)]=this.getright(),ret[Bridge.identity(i,i=i+1|0)]=this.y,ret[Bridge.identity(i,i=i+1|0)]=this.getright(),ret[Bridge.identity(i,i=i+1|0)]=this.getbottom(),ret[Bridge.identity(i,i=i+1|0)]=this.x,ret[Bridge.identity(i,i=i+1|0)]=this.getbottom(),ret},getCenter:function(){return new BNTest.Vector2(this.getleft()+this.width/2,this.gettop()+this.height/2)},getMin:function(){return new BNTest.Vector2(this.x,this.y)},setMin:function(value){BNTest.Vector2.op_Equality(value,null)||(this.x=value.x,this.y=value.y)},getMax:function(){return new BNTest.Vector2(this.getright(),this.getbottom())},setMax:function(value){BNTest.Vector2.op_Equality(value,null)||(this.setright(value.x),this.setbottom(value.y))},containsPoint$1:function(x,y){return x>=this.x&&y>=this.y&&x<=this.getright()&&y<=this.getbottom()?!0:!1},containsPoint:function(point){return point.x>=this.x&&point.y>=this.y&&point.x<=this.getright()&&point.y<=this.getbottom()?!0:!1},intersects:function(R){for(var p=R.getpoints(),contain=!1,outside=!1,i=0;i<p.length;)this.containsPoint$1(p[Bridge.identity(i,i=i+1|0)],p[Bridge.identity(i,i=i+1|0)])?contain=!0:outside=!0;return contain&&outside?!0:R.getleft()<this.getleft()&&R.getright()>this.getright()&&(this.gettop()<=R.gettop()&&this.getbottom()>=R.gettop()||this.gettop()<=R.getbottom()&&this.getbottom()>=R.getbottom())?!0:R.gettop()<this.gettop()&&R.getbottom()>this.getbottom()&&(this.getleft()<=R.getleft()&&this.getright()>=R.getleft()||this.getleft()<=R.getright()&&this.getright()>=R.getright())?!0:!1},isTouching:function(R){if(R==null)return!1;for(var p=R.getpoints(),i=0;i<p.length;)if(this.containsPoint$1(p[Bridge.identity(i,i=i+1|0)],p[Bridge.identity(i,i=i+1|0)]))return!0;return this.intersects(R)?!0:!1}});Bridge.define("BNTest.TextureLoader",{statics:{createTexture:function(gl,img){var texture=gl.createTexture();return gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null),texture}},gl:null,textures:null,images:null,loading:null,config:{init:function(){this.textures=new(System.Collections.Generic.Dictionary$2(HTMLImageElement,Bridge.WebGL.WebGLTexture));this.images=new(System.Collections.Generic.Dictionary$2(String,HTMLImageElement));this.loading=new(System.Collections.Generic.List$1(HTMLImageElement))}},get$1:function(path,callback){if(this.images.containsKey(path)&&!this.loading.contains(this.images.get(path)))callback(this.get(this.images.get(path)));else{var I=this.getImage(path);I.onload=Bridge.fn.bind(this,function(E){this.loading.remove(E.currentTarget);callback(this.get(I))})}},get:function(image){if(this.textures.containsKey(image))return this.textures.get(image);var ret=BNTest.TextureLoader.createTexture(this.gl,image);return this.textures.set(image,ret),ret},getImage:function(path){if(this.images.containsKey(path))return this.images.get(path);var ret=new Image;return ret.src=path,this.images.set(path,ret),this.loading.add(ret),ret.onload=Bridge.fn.bind(this,$_.BNTest.TextureLoader.f1),ret}});Bridge.ns("BNTest.TextureLoader",$_);Bridge.apply($_.BNTest.TextureLoader,{f1:function(E){this.loading.remove(E.currentTarget)}});Bridge.define("BNTest.Vector2",{statics:{getEmpty:function(){return new BNTest.Vector2},fromRadian:function(radian){return BNTest.MathHelper.radianToVector(radian)},op_Equality:function(A,B){var OA=A,OB=B;return(OA==null||OB==null)&&(OA!=null||OB!=null)?!1:OA==null&&OB==null?!0:A.x===B.x&&A.y===B.y},op_Inequality:function(A,B){return!BNTest.Vector2.op_Equality(A,B)},op_Multiply:function(A,scale){return new BNTest.Vector2(A.x*scale,A.y*scale)},op_Division:function(A,scale){return new BNTest.Vector2(A.x/scale,A.y/scale)},op_Addition:function(A,B){return new BNTest.Vector2(A.x+B.x,A.y+B.y)},op_Subtraction:function(A,B){return new BNTest.Vector2(A.x-B.x,A.y-B.y)}},x:0,y:0,ctor:function(x,y){x===void 0&&(x=0);y===void 0&&(y=0);this.$initialize();this.x=x;this.y=y},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},getEstimatedLength:function(){var A=Math.abs(this.x),B=Math.abs(this.y),tmp;return B>A&&(tmp=A,A=B,B=tmp),B*=.34,A+B},getRoughLength:function(){return Math.abs(this.x)+Math.abs(this.y)},multiply:function(f){this.x*=f;this.y*=f},roughNormalize:function(length){length===void 0&&(length=1);var D=this.getLength()/length;return new BNTest.Vector2(this.x/D,this.y/D)},normalize:function(length){length===void 0&&(length=1);var distance=Math.sqrt(this.x*this.x+this.y*this.y),V=new BNTest.Vector2;return V.x=this.x/distance,V.y=this.y/distance,V.x*=length,V.y*=length,V},toCardinal:function(){var x=this.x,y=this.y,A=Math.abs(this.x),B=Math.abs(this.y);return B>A?x=0:A>B&&(y=0),new BNTest.Vector2(x,y)},equals:function(o){var B=o;return BNTest.Vector2.op_Inequality(this,B)&&BNTest.Vector2.op_Equality(B,null)?!1:B.x===this.x&&B.y===this.y},equals$1:function(o){if(Bridge.is(o,BNTest.Vector2)){var B=Bridge.cast(o,BNTest.Vector2);return BNTest.Vector2.op_Inequality(this,B)&&BNTest.Vector2.op_Equality(B,null)?!1:B.x===this.x&&B.y===this.y}return Bridge.equals(this,o)},toAngle:function(){return BNTest.MathHelper.wrapRadians(BNTest.MathHelper.getAngle(this))},clone:function(){return new BNTest.Vector2(this.x,this.y)},rotate:function(radian){var angle=this.toAngle()+radian;return BNTest.Vector2.fromRadian(angle).normalize(this.getLength())}});Bridge.define("BNTest.Vertex",{position:null,textureCoord:null,color:null,ctor:function(){this.$initialize()},$ctor1:function(Position,TextureCoord,Color){this.$initialize();this.position=Position;this.textureCoord=TextureCoord;this.color=Color},equals:function(V){return this.position.equals(V.position)&&this.textureCoord.equals(V.textureCoord)&&this.color.equals(V.color)}});Bridge.define("BNTest.VoxelMap",{statics:{maps:null,config:{init:function(){this.maps=new(System.Collections.Generic.Dictionary$2(String,BNTest.VoxelMap))}},generateTree:function(size,color,smoothness){var S,E;smoothness===void 0&&(smoothness=.95);var hsz=Bridge.Int.div(size,2)|0,hhsz=Bridge.Int.div(hsz,2)|0,VM=new BNTest.VoxelMap.ctor;return VM.map=System.Array.create(null,null,hsz,size,hsz),S=new BNTest.GLVec3.ctor(hhsz-1|0,size-1|0,hhsz),E=S.clone(),E.y=0,VM.drawMessyGrowLine(S,E,1,BNTest.GLVec3.op_Subtraction(E,S).normalize(10),color,(Bridge.Int.div(hhsz,4)|0)-1|0,smoothness,!0),VM.grow(Bridge.Int.clip32(S.x),Bridge.Int.clip32(S.y),Bridge.Int.clip32(S.z),color,Bridge.Int.clip32(hhsz/3.5)-1|0,smoothness,!0,!1),VM.outline(color,!0,1),VM},generateRock:function(size,color,smoothness){smoothness===void 0&&(smoothness=.9);var hsz=Bridge.Int.div(size,2)|0,VM=new BNTest.VoxelMap.ctor;return VM.map=System.Array.create(null,null,size,hsz,size),VM.drawPyramid(0,0,0,hsz,color),VM},fromAnimationCombo:function(animations){animations===void 0&&(animations=[]);for(var S=animations[0],i=1;i<animations.length;)S=System.String.concat(System.String.concat(S,"|"),animations[i]),i=i+1|0;return BNTest.VoxelMap.fromImages$1(S)},fromImages$1:function(animation){var VM,A;if(BNTest.VoxelMap.maps.containsKey(animation))return BNTest.VoxelMap.maps.get(animation).clone();if(System.String.contains(animation,"|")){for(var An=animation.split("|"),i=0,ret=null;i<An.length;)VM=BNTest.VoxelMap.fromImages$1(An[i]),ret==null?ret=VM:ret.combine(VM),i=i+1|0;return ret}return A=BNTest.VoxelMap.fromImages(BNTest.AnimationLoader.get(animation)),BNTest.VoxelMap.maps.set(animation,A),A.clone()},fromImages:function(images){var ret=new BNTest.VoxelMap.ctor,ln=images.getCount(),i;for(ret.map=System.Array.create(null,null,images.getItem(0).width,images.getItem(0).height,ln),i=0;i<ln;)ret.importImageLayer(images.getItem(i),i),i=i+1|0;return ret},gen:function(size,sizey,sizez,holes,transparent,bottomsolid,winter){size===void 0&&(size=2);sizey===void 0&&(sizey=0);sizez===void 0&&(sizez=0);holes===void 0&&(holes=!0);transparent===void 0&&(transparent=!0);bottomsolid===void 0&&(bottomsolid=!1);winter===void 0&&(winter=!1);sizey===0&&(sizey=size);sizez===0&&(sizez=size);var ret=new BNTest.VoxelMap.ctor;return ret.map=System.Array.create(null,null,size,sizey,sizez),ret.randomize(holes,transparent,bottomsolid,winter),ret},sameSize:function(A,B){return System.Array.getLength(A.map,0)===System.Array.getLength(B.map,0)&&System.Array.getLength(A.map,1)===System.Array.getLength(B.map,1)&&System.Array.getLength(A.map,2)===System.Array.getLength(B.map,2)?!0:!1},getMaxSize:function(A,B){return[Math.max(System.Array.getLength(A.map,0),System.Array.getLength(B.map,0)),Math.max(System.Array.getLength(A.map,1),System.Array.getLength(B.map,1)),Math.max(System.Array.getLength(A.map,2),System.Array.getLength(B.map,2))]}},map:null,growVA:null,ctor:function(){this.$initialize()},$ctor2:function(size){this.$initialize();this.map=System.Array.create(null,null,size,size,size)},$ctor1:function(size){this.$initialize();this.map=System.Array.create(null,null,Bridge.Int.clip32(size.x),Bridge.Int.clip32(size.y),Bridge.Int.clip32(size.z))},getVoxel:function(X,Y,Z){return X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)?this.map.get([X,Y,Z]):null},inBounds:function(X,Y,Z){return X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)?!0:!1},getSizeAsBoundingBox:function(){return new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor,new BNTest.GLVec3.ctor(System.Array.getLength(this.map,0),System.Array.getLength(this.map,1),System.Array.getLength(this.map,2)))},randomize:function(holes,transparent,bottomsolid,winter){var C,ok;holes===void 0&&(holes=!0);transparent===void 0&&(transparent=!0);bottomsolid===void 0&&(bottomsolid=!1);winter===void 0&&(winter=!1);for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),X=0,Y=0,Z=0,VA=new BNTest.VoxelMapAccessor(this);X<MX;){while(Y<MY){while(Z<MZ)C=null,C=winter?BNTest.GLColor.randomB(.77,.82,.87,.87,.92,1):BNTest.GLColor.randomB(0,.54,.09,.27,.81,.36),ok=Y<(System.Array.getLength(this.map,1)-1|0)||!bottomsolid,Math.random()<.3&&holes&&ok?C.a=0:Math.random()<.4&&transparent&&ok&&(C.a=.5),VA.setcurrentVoxel(C),Z=Z+1|0,VA.incrZ();Z=0;VA.setZ(0);Y=Y+1|0;VA.incrY()}Y=0;VA.setY(0);X=X+1|0;VA.incrX()}},copyFrom:function(VM){for(var i=0,ln=this.map.length,M=this.map,M2=VM.map;i<ln;)M[i]=M2[i],i=i+1|0},setColor:function(color,visibleOnly){visibleOnly===void 0&&(visibleOnly=!0);for(var i=0,ln=this.map.length,M=this.map;i<ln;)(this.valid(M[i])||!visibleOnly)&&(M[i]=color),i=i+1|0},flipX:function(){for(var N=System.Array.create(null,null,System.Array.getLength(this.map,0),System.Array.getLength(this.map,1),System.Array.getLength(this.map,2)),X=0,Y=0,Z=0;X<System.Array.getLength(this.map,0);){while(Y<System.Array.getLength(this.map,1)){while(Z<System.Array.getLength(this.map,2))N.set([System.Array.getLength(this.map,0)-(X+1|0)|0,Y,Z],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}this.map=N},flatten:function(){for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,1,MZ),X=0,Y=0,Z=0;X<MX;){while(Y<MY){while(Z<MZ)N.set([X,0,Z],this.map.get([X,Y,Z])),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}this.map=N},addStripes:function(strength,coverage,verticalStride){var C;coverage===void 0&&(coverage=1);verticalStride===void 0&&(verticalStride=0);for(var X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),m2=strength+strength,M=this.map,VA=new BNTest.VoxelMapAccessor(this);X<MX;){while(Y<MY){while(Z<MZ)C=VA.getcurrentVoxel(),this.valid(C)&&((X&1)>0||(Z&1)>0||verticalStride>0&&((Y+X|0)+Z|0)%verticalStride==0)&&(coverage>=1||Math.random()>coverage)&&(C=BNTest.GLColor.op_Multiply(C,1-strength),VA.setcurrentVoxel(C)),Z=Z+1|0,VA.incrZ();Z=0;VA.setZ(0);Y=Y+1|0;VA.incrY()}Y=0;VA.setY(0);X=X+1|0;VA.incrX()}},addNoise:function(strength,coverage){var C;coverage===void 0&&(coverage=1);for(var m2=strength+strength,i=0,ln=this.map.length,M=this.map;i<ln;)C=M[i],this.valid(C)&&(coverage>=1||Math.random()>coverage)&&(C=BNTest.GLColor.op_Addition(C,new BNTest.GLColor(-strength+m2*Math.random(),-strength+m2*Math.random(),-strength+m2*Math.random())),M[i]=C),i=i+1|0},drawGrowLine:function(start,end,color,Depth,chance,corners){var i;chance===void 0&&(chance=1);corners===void 0&&(corners=!1);var V=start.clone(),spd=BNTest.GLVec3.op_Subtraction(end,start),len=spd.getLength();for(spd=spd.normalize(1),i=0;i<len;)this.grow(Bridge.Int.clip32(V.x),Bridge.Int.clip32(V.y),Bridge.Int.clip32(V.z),color,Depth,chance,corners),V=BNTest.GLVec3.op_Addition(V,spd),i=i+1|0},drawLine:function(start,end,color){for(var V=start.clone(),spd=BNTest.GLVec3.op_Subtraction(end,start),len=spd.getLength(),spd=spd.normalize(1),i=0;i<len;)this.setVoxel(V,color),V=BNTest.GLVec3.op_Addition(V,spd),i=i+1|0},entropy:function(noise,holes){for(var n2=noise+noise,X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),i=0,ln=this.map.length,M=this.map,NC=null,trans=new BNTest.GLColor(0,0,0,0),C;i<ln;)C=M[i],(X===0||Y===0||Z===0||X>=(MX-1|0)||Y>=(MY-1|0)||Z>=(MZ-1|0))&&(holes>0&&Math.random()<holes?M[i]=trans:this.valid(C)&&(NC=new BNTest.GLColor(C.r,C.g,C.b,C.a),NC.add$1(-noise+n2*Math.random(),-noise+n2*Math.random(),-noise+n2*Math.random()),M[i]=NC)),i=i+1|0,Z=Z+1|0,Z>=MZ&&(Z=Z-MZ|0,Y=Y+1|0,Y>=MY&&(Y=Y-MY|0,X=X+1|0))},addHoles:function(chance){for(var i=0,ln=this.map.length,M=this.map,C;i<ln;)C=M[i],Math.random()<chance&&(M[i]=null),i=i+1|0},drawMessyGrowLine:function(start,generalDestination,maxSegmentLength,momentum,color,Depth,chance,corners){var LL;chance===void 0&&(chance=1);corners===void 0&&(corners=!1);for(var V=start.clone(),dist=BNTest.GLVec3.op_Subtraction(generalDestination,start),len=dist.getLength(),total=len*1.1,i=0,msl2=maxSegmentLength+maxSegmentLength,hsz=BNTest.GLVec3.createUniform(msl2),tries=0;i<total&&tries<20;){var line=new BNTest.GLVec3.ctor(-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength();tries=tries+1|0;ND<len&&(tries=0,momentum!=null&&(line=BNTest.GLVec3.op_Addition(line,momentum),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength()),LL=line.getLength(),this.drawGrowLine(V,N,color,Depth,chance,corners),V=N,len=ND,i+=LL)}},drawMessyLine:function(start,generalDestination,maxSegmentLength,momentum,color){for(var V=start.clone(),dist=BNTest.GLVec3.op_Subtraction(generalDestination,start),len=dist.getLength(),total=len,i=0,msl2=maxSegmentLength+maxSegmentLength,hsz=BNTest.GLVec3.createUniform(msl2),tries=0,LL;i<total&&tries<20;){var line=new BNTest.GLVec3.ctor(-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2,-maxSegmentLength+Math.random()*msl2),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength();tries=tries+1|0;ND<len&&(tries=0,LL=line.getLength(),momentum!=null&&(line=BNTest.GLVec3.op_Addition(line,momentum),N=BNTest.GLVec3.op_Addition(V,line),ND=BNTest.GLVec3.op_Subtraction(generalDestination,N).getLength()),this.drawLine(V,N,color),V=N,len=ND,i+=LL)}},drawPyramid:function(X,Y,Z,size,color){for(var XX=X,YY=Y+(size-1|0)|0,ZZ=Z;size>0;)this.fill$2(XX,YY,ZZ,size,1,size,color),XX=XX+1|0,ZZ=ZZ+1|0,YY=YY-1|0,size=size-2|0},grow:function(X,Y,Z,color,Depth,chance,first,corners){(chance===void 0&&(chance=1),first===void 0&&(first=!0),corners===void 0&&(corners=!1),this.inBounds(X,Y,Z))&&(first&&(this.growVA=new BNTest.VoxelMapAccessor(this)),this.growVA.setX(X),this.growVA.setY(Y),this.growVA.setZ(Z),this.growVA.setcurrentVoxel(color),Depth=Depth-1|0,(first||chance>=1||Math.random()<chance)&&Depth>0&&(this.grow(X-1|0,Y,Z,color,Depth,chance,!1,corners),this.grow(X+1|0,Y,Z,color,Depth,chance,!1,corners),this.grow(X,Y-1|0,Z,color,Depth,chance,!1,corners),this.grow(X,Y+1|0,Z,color,Depth,chance,!1,corners),this.grow(X,Y,Z-1|0,color,Depth,chance,!1,corners),this.grow(X,Y,Z+1|0,color,Depth,chance,!1,corners),corners&&(this.grow(X-1|0,Y-1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y-1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y-1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y-1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y+1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y+1|0,Z-1|0,color,Depth,chance,!1,corners),this.grow(X-1|0,Y+1|0,Z+1|0,color,Depth,chance,!1,corners),this.grow(X+1|0,Y+1|0,Z+1|0,color,Depth,chance,!1,corners))))},outline:function(C,smooth,chance){var min,max,CT,adj,col;C===void 0&&(C=null);smooth===void 0&&(smooth=!1);chance===void 0&&(chance=1);min=1;max=1e3;smooth&&(min=2);for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,MY,MZ),NN=N,X=0,Y=0,Z=0,VA=new BNTest.VoxelMapAccessor(this);X<MX;){while(Y<MY){while(Z<MZ)CT=VA.getcurrentVoxel(),this.valid(CT)||(adj=VA.adjacentVoxels(),adj>=min&&adj<=max&&(chance>=1||Math.random()>chance)&&(col=C,C==null&&(col=VA.findAdjacentVoxel()),CT=col)),NN[VA.index]=CT,Z=Z+1|0,VA.incrZ();Z=0;VA.setZ(0);Y=Y+1|0;VA.incrY()}Y=0;Z=0;VA.setY(0);X=X+1|0;VA.incrX()}this.map=N},adjacentVoxels:function(X,Y,Z){var i=0,C=this.getVoxel(X-1|0,Y,Z);return this.valid(C)&&(i=i+1|0),C=this.getVoxel(X+1|0,Y,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y-1|0,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y+1|0,Z),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y,Z-1|0),this.valid(C)&&(i=i+1|0),C=this.getVoxel(X,Y,Z+1|0),this.valid(C)&&(i=i+1|0),i},findAdjacentVoxel:function(X,Y,Z){var C=this.getVoxel(X-1|0,Y,Z);return this.valid(C)?C:(C=this.getVoxel(X+1|0,Y,Z),this.valid(C))?C:(C=this.getVoxel(X,Y-1|0,Z),this.valid(C))?C:(C=this.getVoxel(X,Y+1|0,Z),this.valid(C))?C:(C=this.getVoxel(X,Y,Z-1|0),this.valid(C))?C:(C=this.getVoxel(X,Y,Z+1|0),this.valid(C))?C:null},clone:function(){for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,MY,MZ),M=this.map,NM=N,i=0,ln=this.map.length,VM;i<ln;)NM[i]=M[i],i=i+1|0;return VM=new BNTest.VoxelMap.ctor,VM.map=N,VM},importImageLayer:function(image,z){var C;z===void 0&&(z=0);var X=0,Y=0,i=0,P=BNTest.AnimationLoader.getPixels(image),H=image.height,W=image.width,A=0,R=0,G=0,B=0,VA=new BNTest.VoxelMapAccessor(this);for(VA.setZ(z);Y<H;){while(X<W)R=P[Bridge.identity(i,i=i+1|0)]/255,G=P[Bridge.identity(i,i=i+1|0)]/255,B=P[Bridge.identity(i,i=i+1|0)]/255,A=P[Bridge.identity(i,i=i+1|0)]/255,C=new BNTest.GLColor(R,G,B,A),VA.setcurrentVoxel(C),X=X+1|0,X<W&&VA.incrX();X=0;VA.setX(X);Y=Y+1|0;Y<H&&VA.incrY()}},valid:function(C){return C!=null&&C.a>0},opaque:function(C){return BNTest.GLDemo.allowAlpha?C!=null&&C.a>=1:this.valid(C)},getInvisibleSides:function(X,Y,Z,OUT){OUT===void 0&&(OUT=null);var ret=OUT;return ret==null&&(ret=System.Array.init(6,!1)),ret[0]=this.opaque(this.getVoxel(X,Y,Z-1|0)),ret[1]=this.opaque(this.getVoxel(X,Y,Z+1|0)),ret[2]=this.opaque(this.getVoxel(X-1|0,Y,Z)),ret[3]=this.opaque(this.getVoxel(X+1|0,Y,Z)),ret[4]=this.opaque(this.getVoxel(X,Y-1|0,Z)),ret[5]=this.opaque(this.getVoxel(X,Y+1|0,Z)),ret},applyPalette:function(palette){var Keys=System.Linq.Enumerable.from(palette.getKeys()).toList(BNTest.GLColor),Vals=System.Linq.Enumerable.from(palette.getValues()).toList(BNTest.GLColor),C,t,ind;if(!(Keys.getCount()<=0))for(var X=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),key=null,M=this.map,i=0,Xln=this.map.length,ln=Keys.getCount();X<Xln;){if(C=M[X],C!=null&&C.a>0){for(key=null,i=0;i<ln;)t=Keys.getItem(i),t.similar(C)&&(key=t,i=ln),i=i+1|0;key!=null&&(ind=Keys.indexOf(key),ind>=0&&(M[X]=Vals.getItem(ind)))}X=X+1|0}},swapYZ:function(){var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),N=System.Array.create(null,null,MX,MZ,MY),X=0,Y=0,Z=0,i=0,M=this.map,tmp=new BNTest.VoxelMap.ctor,VA;for(tmp.map=N,VA=new BNTest.VoxelMapAccessor(tmp);X<MX;){while(Y<MY){while(Z<MZ)VA.setcurrentVoxel(M[Bridge.identity(i,i=i+1|0)]),Z=Z+1|0,VA.incrY();Z=0;VA.setY(0);Y=Y+1|0;VA.incrZ()}Y=0;VA.setZ(0);X=X+1|0;VA.incrX()}this.map=N},getPalette:function(){for(var ret=System.Array.init(0,null),i=0,ln=this.map.length,M=this.map,C;i<ln;)C=M[i],C!=null&&(System.Array.contains(ret,C,BNTest.GLColor)||ret.push(C)),i=i+1|0;return ret},resize:function(NewDimensions){var NX=NewDimensions[0],NY=NewDimensions[1],NZ=NewDimensions[2],MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),OV;if(MX<NX||MY<NY||MZ<NZ){for(var NM=System.Array.create(null,null,NX,NY,NZ),XOffset=(NX-MX|0)>>1,YOffset=(NY-MY|0)>>1,ZOffset=(NZ-MZ|0)>>1,X=0,Y=0,Z=0;X<NX;){while(Y<NY){while(Z<NZ)OV=this.getVoxel(X-XOffset|0,Y-YOffset|0,Z-ZOffset|0),NM.set([X,Y,Z],OV),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}return this.map=NM,!0}return!1},fill:function(box,C){var sz=box.getSize();this.fill$2(Bridge.Int.clip32(box.min.x),Bridge.Int.clip32(box.min.y),Bridge.Int.clip32(box.min.z),Bridge.Int.clip32(sz.x),Bridge.Int.clip32(sz.y),Bridge.Int.clip32(sz.z),C)},fill$1:function(box,ColorSetter){var sz=box.getSize();this.fill$3(Bridge.Int.clip32(box.min.x),Bridge.Int.clip32(box.min.y),Bridge.Int.clip32(box.min.z),Bridge.Int.clip32(sz.x),Bridge.Int.clip32(sz.y),Bridge.Int.clip32(sz.z),ColorSetter)},fill$2:function(X,Y,Z,Width,Height,Depth,C){for(var SX=X,SY=Y,SZ=Z,X2=SX+Width|0,Y2=SY+Height|0,Z2=SZ+Depth|0;X<X2;){while(Y<Y2){while(Z<Z2)this.setVoxel$1(X,Y,Z,C),Z=Z+1|0;Z=SZ;Y=Y+1|0}Y=SY;X=X+1|0}},fill$3:function(X,Y,Z,Width,Height,Depth,ColorSetter){for(var MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2),SX=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(X,0,MX)),SY=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(Y,0,MY)),SZ=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(Z,0,MZ)),X2=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(SX+Width|0,0,MX)),Y2=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(SY+Height|0,0,MY)),Z2=Bridge.Int.clip32(BNTest.MathHelper.clamp$1(SZ+Depth|0,0,MZ)),VA=new BNTest.VoxelMapAccessor(this),C;X<X2;){while(Y<Y2){while(Z<Z2)C=new BNTest.GLColor(1,1,1),ColorSetter(C),VA.setcurrentVoxel(C),Z=Z+1|0,VA.incrZ();Z=SZ;VA.setZ(Z);Y=Y+1|0;VA.incrY()}Y=SY;VA.setY(Y);X=X+1|0;VA.incrX()}},setVoxel:function(V,C){return this.setVoxel$1(Bridge.Int.clip32(V.x),Bridge.Int.clip32(V.y),Bridge.Int.clip32(V.z),C)},setVoxel$1:function(X,Y,Z,C){if(X>=0&&Y>=0&&Z>=0&&X<System.Array.getLength(this.map,0)&&Y<System.Array.getLength(this.map,1)&&Z<System.Array.getLength(this.map,2)){var M=this.map,ind=System.Array.toIndex(M,[X,Y,Z]);if(!Bridge.referenceEquals(M[ind],C))return M[ind]=C,!0}return!1},crop$1:function(){},crop:function(X,Y,Z,MaxX,MaxY,MaxZ){var N=System.Array.create(null,null,MaxX-X|0,MaxY-Y|0,MaxZ-Z|0),VM=new BNTest.VoxelMap.ctor;return VM.map=N,VM.combine(this,X,Y,Z,!1),VM},combine:function(VM,XOffset,YOffset,ZOffset,autoresize){var directcopy,ND,ln,OV,V,Zind,ind,OV1,V1;XOffset===void 0&&(XOffset=0);YOffset===void 0&&(YOffset=0);ZOffset===void 0&&(ZOffset=0);autoresize===void 0&&(autoresize=!0);directcopy=!0;BNTest.VoxelMap.sameSize(this,VM)||(autoresize?(ND=BNTest.VoxelMap.getMaxSize(this,VM),this.resize(ND),VM.resize(ND)):directcopy=!1);var M=this.map,RVM=VM.map,i=0;if(XOffset===0&&YOffset===0&&ZOffset===0&&directcopy){for(ln=this.map.length;i<ln;)OV=M[i],V=RVM[i],(OV==null||V!=null&&V.a>=OV.a)&&(M[i]=V),i=i+1|0;return}var X=0,Y=0,Z=0,MX=System.Array.getLength(this.map,0),MY=System.Array.getLength(this.map,1),MZ=System.Array.getLength(this.map,2);for(i=0,Zind=System.Array.toIndex(M,[0,0,1]);X<MX;){while(Y<MY){for(ind=System.Array.toIndex(M,[XX,YY,ZZ]);Z<MZ;){var XX=X+XOffset|0,YY=Y+YOffset|0,ZZ=Z+ZOffset|0;XX>=0&&YY>=0&&ZZ>=0&&XX<MX&&YY<MY&&ZZ<MZ&&(OV1=M[ind],V1=RVM[i],(OV1==null||V1!=null&&V1.a>=OV1.a)&&(M[ind]=V1));ind=ind+Zind|0;i=i+1|0;Z=Z+1|0}Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}},getValidQuadrants:function(X,Y,Z,OUT){var $t,$t1,$t2,$t3,$t4,$t5,ret;return OUT===void 0&&(OUT=null),ret=OUT,ret==null&&(ret=System.Array.init(8,!1)),ret[0]=this.isValidQuadrants(X,Y,Z,!1,!1,!1),ret[1]=this.isValidQuadrants(X,Y,Z,!0,!1,!1),ret[2]=this.isValidQuadrants(X,Y,Z,!1,!0,!1),ret[3]=this.isValidQuadrants(X,Y,Z,!0,!0,!1),ret[4]=this.isValidQuadrants(X,Y,Z,!1,!1,!0),ret[5]=this.isValidQuadrants(X,Y,Z,!0,!1,!0),ret[6]=this.isValidQuadrants(X,Y,Z,!1,!0,!0),ret[7]=this.isValidQuadrants(X,Y,Z,!0,!0,!0),System.Array.contains(ret,!0,Boolean)||(ret[0]=($t=($t1=($t2=($t3=($t4=($t5=(ret[7]=!1,!1),ret[6]=$t5,$t5),ret[5]=$t4,$t4),ret[4]=$t3,$t3),ret[3]=$t2,$t2),ret[2]=$t1,$t1),ret[1]=$t,$t)),ret},isValidQuadrants:function(X,Y,Z,sx,sy,sz){var TX=X-1|0,TY,TZ;sx&&(TX=TX+1|0);TY=Y-1|0;sy&&(TY=TY+1|0);TZ=Z-1|0;sz&&(TZ=TZ+1|0);for(var XX=0,YY=0,ZZ=0;XX<2;){while(YY<2){while(ZZ<2){var FX=TX+XX|0,FY=TY+YY|0,FZ=TZ+ZZ|0;if(!(FX===X&&FY===Y&&FZ===Z)&&this.valid(this.getVoxel(FX,FY,FZ)))return!0;ZZ=ZZ+1|0}ZZ=0;YY=YY+1|0}YY=0;XX=XX+1|0}return!1}});Bridge.define("BNTest.VoxelMapAccessor",{rawMap:null,map:null,VM:null,index:0,xind:0,yind:0,zind:0,xpos:0,ypos:0,zpos:0,MX:0,MY:0,MZ:0,ctor:function(Map){this.$initialize();this.VM=Map;this.map=this.VM.map;this.rawMap=this.map;var M=this.VM.map;this.MX=System.Array.getLength(this.map,0);this.MY=System.Array.getLength(this.map,1);this.MZ=System.Array.getLength(this.map,2);this.zind=1;this.yind=this.MZ;this.xind=this.yind*this.MY|0},getX:function(){return this.xpos},setX:function(value){if(value>=0&&value<this.MX&&this.xpos!==value){var NV=value-this.xpos|0;this.xpos=value;this.index=this.index+(NV*this.xind|0)|0}},getY:function(){return this.ypos},setY:function(value){if(value>=0&&value<this.MY&&this.ypos!==value){var NV=value-this.ypos|0;this.ypos=value;this.index=this.index+(NV*this.yind|0)|0}},getZ:function(){return this.zpos},setZ:function(value){if(value>=0&&value<this.MZ&&this.zpos!==value){var NV=value-this.zpos|0;this.zpos=value;this.index=this.index+NV|0}},getcurrentVoxel:function(){return this.rawMap[this.index]},setcurrentVoxel:function(value){this.rawMap[this.index]=value},getNeighbor:function(X,Y,Z){if(BNTest.MathHelper.within(this.xpos+X|0,0,this.MX)&&BNTest.MathHelper.within(this.ypos+Y|0,0,this.MY)&&BNTest.MathHelper.within(this.zpos+Z|0,0,this.MZ)){var ind=this.index;return X===-1&&(ind=ind-this.xind|0),X===1&&(ind=ind+this.xind|0),Y===-1&&(ind=ind-this.yind|0),Y===1&&(ind=ind+this.yind|0),ind=ind+Z|0,this.rawMap[ind]}return null},valid:function(C){return C!=null&&C.a>0},adjacentVoxels:function(){var i=0,C=this.getNeighbor(-1,0,0);return this.valid(C)&&(i=i+1|0),C=this.getNeighbor(1,0,0),this.valid(C)&&(i=i+1|0),C=this.getNeighbor(0,-1,0),this.valid(C)&&(i=i+1|0),C=this.getNeighbor(0,1,0),this.valid(C)&&(i=i+1|0),C=this.getNeighbor(0,0,-1),this.valid(C)&&(i=i+1|0),C=this.getNeighbor(0,0,1),this.valid(C)&&(i=i+1|0),i},findAdjacentVoxel:function(){var C=this.getNeighbor(-1,0,0);return this.valid(C)?C:(C=this.getNeighbor(1,0,0),this.valid(C))?C:(C=this.getNeighbor(0,-1,0),this.valid(C))?C:(C=this.getNeighbor(0,1,0),this.valid(C))?C:(C=this.getNeighbor(0,0,-1),this.valid(C))?C:(C=this.getNeighbor(0,0,1),this.valid(C))?C:null},incrX:function(){(this.xpos+1|0)<this.MX&&(this.xpos=this.xpos+1|0,this.index=this.index+this.xind|0)},incrY:function(){(this.ypos+1|0)<this.MY&&(this.ypos=this.ypos+1|0,this.index=this.index+this.yind|0)},incrZ:function(){(this.zpos+1|0)<this.MZ&&(this.zpos=this.zpos+1|0,this.index=this.index+this.zind|0)},decrX:function(){this.xpos>0&&(this.xpos=this.xpos-1|0,this.index=this.index-this.xind|0)},decrY:function(){this.ypos>0&&(this.ypos=this.ypos-1|0,this.index=this.index-this.yind|0)},decrZ:function(){this.zpos>0&&(this.zpos=this.zpos-1|0,this.index=this.index-this.zind|0)},hasNext:function(){return(this.index+1|0)<this.rawMap.length},next:function(){return(this.zpos=this.zpos+1|0,this.index=this.index+this.zind|0,this.zpos>=this.MZ&&(this.zpos=this.zpos-this.MZ|0,this.index=this.index-(this.MZ*this.zind|0)|0,this.ypos=this.ypos+1|0,this.index=this.index+this.yind|0,this.ypos>=this.MY&&(this.ypos=this.ypos-this.MY|0,this.index=this.index-(this.MY*this.yind|0)|0,this.xind=this.xind+1|0,this.index=this.index+this.xind|0)),this.index>=0&&this.index<this.rawMap.length)?this.getcurrentVoxel():null},iterate:function(action,Area){this.iterate$2(action,Area)},iterate$2:function(action,Area){var M=this.rawMap,ln,C;Area.min=BNTest.GLVec3.max(Area.min,new BNTest.GLVec3.ctor);Area.max=BNTest.GLVec3.min(Area.max,this.VM.getSizeAsBoundingBox().max);var Min=Area.min,Max=Area.max,SX=Bridge.Int.clip32(Min.x),SY=Bridge.Int.clip32(Min.y),SZ=Bridge.Int.clip32(Min.z),X=SX,Y=SY,Z=SZ,i=0;for(i=X*this.xind|0,i=i+(Y*this.yind|0)|0,i=i+Z|0,ln=M.length;X<Max.x;){while(Y<Max.y){while(Z<Max.z)i>=0&&i<ln&&(C=M[i],C=C==null?new BNTest.GLColor(0,0,0,0):C.clone(),action(C,X,Y,Z),M[i]=C),Z=Z+1|0,i=i+1|0;i=i-(Z-SZ|0)|0;Z=SZ;Y=Y+1|0;i=i+this.yind|0}i=i-((Y-SY|0)*this.yind|0)|0;Y=SY;X=X+1|0;i=i+this.xind|0}},iterate$1:function(action){for(var X=0,Y=0,Z=0,i=0,M=this.rawMap,ln=M.length,C;i<ln;)C=M[i],C=C==null?new BNTest.GLColor(0,0,0,0):C.clone(),action(C,X,Y,Z),M[i]=C,i=i+1|0,Z=Z+1|0,Z>=this.MZ&&(Z=Z-this.MZ|0,Y=Y+1|0,Y>=this.MY&&(Y=Y-this.MY|0,X=X+1|0))}});Bridge.define("BNTest.VoxelMapAsset",{statics:{fromImages:function(animation){return new BNTest.VoxelMapAsset(BNTest.VoxelMap.fromImages$1(animation))},fromImages$2:function(animation,Pallette){return new BNTest.VoxelMapAsset(BNTest.VoxelMap.fromImages$1(animation),Pallette)},fromImages$1:function(animation,Pallette){for(var ret=new BNTest.VoxelMapAsset(BNTest.VoxelMap.fromImages$1(animation)),i=0;i<Pallette.length;)ret.setItem(i,Pallette[i]),i=i+1|0;return ret},combine:function(Assets){for(var i=0,ret=null,A,VM;i<Assets.length;)A=Assets[i],VM=A.map,A.pallette!=null&&VM.applyPalette(A.pallette),ret==null?ret=VM:ret.combine(VM),i=i+1|0;return ret}},map:null,pallette:null,_Colors:null,ctor:function(Map,Pallette){Pallette===void 0&&(Pallette=null);this.$initialize();this.map=Map;Pallette==null&&(Pallette=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)));this.pallette=Pallette},getColors:function(){return this._Colors==null&&(this._Colors=this.map.getPalette()),this._Colors},setItem:function(Color,value){this.setColor(Color,value)},setColor:function(Color,value){this.pallette.set(this.getColors()[Color],value)}});Bridge.define("BNTest.VoxelMapAssetEntry",{statics:{combine:function(entries){for(var VMA=System.Array.init(0,null),i=0;i<entries.length;)VMA.push(BNTest.VoxelMapAsset.fromImages$1(entries[i].animation,entries[i].pallete)),i=i+1|0;return BNTest.VoxelMapAsset.combine(VMA)},fromArray$2:function(animations,Pallettes){var ret,i,R;for(Pallettes===void 0&&(Pallettes=null),ret=System.Array.init(0,null),i=0;i<animations.length;)R=new BNTest.VoxelMapAssetEntry(animations[i]),Pallettes!=null&&i<Pallettes.length&&(R.pallete=Pallettes[i]),ret.push(R),i=i+1|0;return ret},fromArray$1:function(animations){var ret,i,R;for(animations===void 0&&(animations=[]),ret=System.Array.init(0,null),i=0;i<animations.length;)R=new BNTest.VoxelMapAssetEntry(animations[i]),ret.push(R),i=i+1|0;return ret},fromArray:function(Pallette,animations){var ret,i,R;for(animations===void 0&&(animations=[]),ret=System.Array.init(0,null),i=0;i<animations.length;)R=new BNTest.VoxelMapAssetEntry(animations[i]),R.pallete=Pallette,ret.push(R),i=i+1|0;return ret}},animation:null,pallete:null,ctor:function(animation,Pallete){Pallete===void 0&&(Pallete=null);this.$initialize();this.animation=animation;Pallete==null&&(Pallete=System.Array.init(0,null));this.pallete=Pallete}});Bridge.define("BNTest.WGMatrix",{statics:{tmatrix:null,tbmatrix:null,t2matrix:null,tmatobj:null,T1:null,T2:null,T3:null,T4:null,config:{init:function(){this.T1=System.Array.init(16,0);this.T2=System.Array.init(16,0);this.T3=System.Array.init(16,0);this.T4=System.Array.init(16,0)}},init:function(){var c,m;BNTest.WGMatrix.tmatrix==null&&(c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),BNTest.WGMatrix.tmatrix=c,c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),BNTest.WGMatrix.tbmatrix=c,c=System.Array.init(4,null),c[0]=System.Array.init(4,0),c[1]=System.Array.init(4,0),c[2]=System.Array.init(4,0),c[3]=System.Array.init(4,0),m={},m.elements=c,BNTest.WGMatrix.tmatobj=m,BNTest.WGMatrix.t2matrix=c)},flatten:function(matrix){var M=matrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return[A[0],B[0],C[0],D[0],A[1],B[1],C[1],D[1],A[2],B[2],C[2],D[2],A[3],B[3],C[3],D[3]]},flatten$1:function(matrix,OUT){var M=matrix.elements,O=OUT,A=M[0],B=M[1],C=M[2],D=M[3];O[0]=A[0];O[1]=B[0];O[2]=C[0];O[3]=D[0];O[4]=A[1];O[5]=B[1];O[6]=C[1];O[7]=D[1];O[8]=A[2];O[9]=B[2];O[10]=C[2];O[11]=D[2];O[12]=A[3];O[13]=B[3];O[14]=C[3];O[15]=D[3]},flattenB:function(matrix){var M=matrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return[A[0],A[1],A[2],A[3],B[0],B[1],B[2],B[3],C[0],C[1],C[2],C[3],D[0],D[1],D[2],D[3]]},copyFrom:function(source,destination){var a=source.elements,b=destination.elements;BNTest.WGMatrix.copyFromRaw(a,b)},copyFromRaw:function(source,destination){var a=source,b=destination,t=b[0],t2=a[0];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[1];t2=a[1];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[2];t2=a[2];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3];t=b[3];t2=a[3];t[0]=t2[0];t[1]=t2[1];t[2]=t2[2];t[3]=t2[3]},copyFromInverted:function(source,destination){var M=source,b=destination,A=M[0],B=M[1],C=M[2],D=M[3],t=b[0];t[0]=A[0];t[1]=B[0];t[2]=C[0];t[3]=D[0];t=b[1];t[0]=A[1];t[1]=B[1];t[2]=C[1];t[3]=D[1];t=b[2];t[0]=A[2];t[1]=B[2];t[2]=C[2];t[3]=D[2];t=b[3];t[0]=A[3];t[1]=B[3];t[2]=C[3];t[3]=D[3]},mat4MultMatrix:function(matrix1,matrix2){BNTest.WGMatrix.flatten$1(matrix1,BNTest.WGMatrix.T1);BNTest.WGMatrix.flatten$1(matrix2,BNTest.WGMatrix.T2);var a=BNTest.WGMatrix.T1,b=BNTest.WGMatrix.T2,c=BNTest.WGMatrix.T4;mat4mult(c,a,b);BNTest.WGMatrix.deflat(BNTest.WGMatrix.T4,matrix1.elements)},deflat:function(M,destination){var D=destination[0];D[0]=M[0];D[1]=M[1];D[2]=M[2];D[3]=M[3];D=destination[1];D[0]=M[4];D[1]=M[5];D[2]=M[6];D[3]=M[7];D=destination[2];D[0]=M[8];D[1]=M[9];D[2]=M[10];D[3]=M[11];D=destination[3];D[0]=M[12];D[1]=M[13];D[2]=M[14];D[3]=M[15]},multMatrix:function(matrix1,matrix2,l){var a,b,c,ci,ai,bj,i,j;for(l===void 0&&(l=3),a=matrix1.elements,BNTest.WGMatrix.copyFromInverted(matrix2.elements,BNTest.WGMatrix.tbmatrix),b=BNTest.WGMatrix.tbmatrix,c=BNTest.WGMatrix.tmatrix,i=0;i<l;i=i+1|0){ci=c[i];ai=a[i];var ai0=ai[0],ai1=ai[1],ai2=ai[2],ai3=ai[3];for(j=0;j<4;j=j+1|0)bj=b[j],ci[j]=ai0*bj[0]+ai1*bj[1]+ai2*bj[2]+ai3*bj[3]}matrix1.elements=c;BNTest.WGMatrix.tmatrix=a},oldMultMatrix:function(matrix1,matrix2){for(var j,a=matrix1.elements,b=matrix2.elements,c=BNTest.WGMatrix.tmatrix,ci,ai,i=0;i<3;i=i+1|0){ci=c[i];ai=a[i];var ai0=ai[0],ai1=ai[1],ai2=ai[2],ai3=ai[3];for(j=0;j<4;j=j+1|0)ci[j]=ai0*b[0][j]+ai1*b[1][j]+ai2*b[2][j]+ai3*b[3][j]}matrix1.elements=c;BNTest.WGMatrix.tmatrix=a},clear:function(matrix){var $t,$t1,$t2,$t3,$t4,$t5,$t6,$t7,$t8,$t9,$t10,$t11,D=matrix,D0=D[0],D1=D[1],D2=D[2],D3=D[3];D0[1]=($t=($t1=($t2=($t3=($t4=($t5=($t6=($t7=($t8=($t9=(D3[2]=0,0),D3[1]=$t9,$t9),D3[0]=$t8,$t8),D2[3]=$t7,$t7),D2[1]=$t6,$t6),D2[0]=$t5,$t5),D1[3]=$t4,$t4),D1[2]=$t3,$t3),D1[0]=$t2,$t2),D0[3]=$t1,$t1),D0[2]=$t,$t);D0[0]=($t10=($t11=(D3[3]=1,1),D2[2]=$t11,$t11),D1[1]=$t10,$t10)}},mvMatrix:null,identity:!0,freeMatrix:null,mvMatrixStack:null,config:{init:function(){this.freeMatrix=System.Array.init(0,null);this.mvMatrixStack=System.Array.init(0,null)}},ctor:function(){this.$initialize();this.mvMatrix={};this.newIdentity()},loadIdentity:function(){this.clear()},newIdentity:function(){var c=System.Array.init(4,null);c[0]=System.Array.init(4,0);c[1]=System.Array.init(4,0);c[2]=System.Array.init(4,0);c[3]=System.Array.init(4,0);this.mvMatrix.elements=c;this.clear()},isIdentity:function(){var M=this.mvMatrix.elements,A=M[0],B=M[1],C=M[2],D=M[3];return A[0]===1&&B[1]===1&&C[2]===1&&A[1]===0&&A[2]===0&&A[3]===0&&B[0]===0&&B[2]===0&&B[3]===0&&C[0]===0&&C[1]===0&&C[3]===0&&D[0]===0&&D[1]===0&&D[2]===0},getMatrix:function(){var M=this.mvMatrix.elements,b=System.Array.init(4,null);return b[0]=[M[0][0],M[0][1],M[0][2],M[0][3]],b[1]=[M[1][0],M[1][1],M[1][2],M[1][3]],b[2]=[M[2][0],M[2][1],M[2][2],M[2][3]],b[3]=[M[3][0],M[3][1],M[3][2],M[3][3]],b},multiplyMatrix:function(matrix){if(this.identity&&!matrix.identity){this.copyFrom(matrix);this.identity=!1;return}(this.identity||!matrix.identity)&&(BNTest.WGMatrix.multMatrix(this.mvMatrix,matrix.mvMatrix),this.identity&&(this.identity=this.isIdentity()))},multiplyMatrix$1:function(matrix){this.identity?this.copyFrom$1(matrix):BNTest.WGMatrix.multMatrix(this.mvMatrix,matrix);this.identity&&(this.identity=this.isIdentity())},copyFrom:function(source){BNTest.WGMatrix.copyFrom(source.mvMatrix,this.mvMatrix)},copyFrom$1:function(source){BNTest.WGMatrix.copyFrom(source,this.mvMatrix)},cleanW:function(){var $t,a=this.mvMatrix.elements,b=a[3];b[0]=($t=(b[2]=0,0),b[1]=$t,$t);b[3]=1},mat4MultMatrix:function(matrix){BNTest.WGMatrix.mat4MultMatrix(this.mvMatrix,matrix.mvMatrix)},mat4MultMatrix$1:function(matrix){BNTest.WGMatrix.mat4MultMatrix(this.mvMatrix,matrix)},mvTranslate:function(v){var D=BNTest.WGMatrix.t2matrix;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);BNTest.WGMatrix.t2matrix[0][3]=v[0];BNTest.WGMatrix.t2matrix[1][3]=v[1];BNTest.WGMatrix.t2matrix[2][3]=v[2];this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},mvPushMatrix:function(){if(this.freeMatrix.length>0){var F=this.freeMatrix.pop();BNTest.WGMatrix.copyFromRaw(this.mvMatrix.elements,F);this.mvMatrixStack.push(F)}else this.mvMatrixStack.push(this.getMatrix())},mvPopMatrix:function(){this.freeMatrix.push(this.mvMatrix.elements);var D=this.mvMatrixStack.pop();return this.mvMatrix.elements=D,this.identity=this.isIdentity(),this.mvMatrix},equals:function(o){if(Bridge.is(o,BNTest.WGMatrix)){for(var D=this.mvMatrix,D2=o.mvMatrix,i=0;i<16;){if(D[i]!==D2[i])return!1;i=i+1|0}return!0}return Bridge.equals(this,o)},clear:function(){var $t,$t1,$t2,$t3,$t4,$t5,$t6,$t7,$t8,$t9,$t10,$t11,D=this.mvMatrix.elements,D0=D[0],D1=D[1],D2=D[2],D3=D[3];D0[1]=($t=($t1=($t2=($t3=($t4=($t5=($t6=($t7=($t8=($t9=(D3[2]=0,0),D3[1]=$t9,$t9),D3[0]=$t8,$t8),D2[3]=$t7,$t7),D2[1]=$t6,$t6),D2[0]=$t5,$t5),D1[3]=$t4,$t4),D1[2]=$t3,$t3),D1[0]=$t2,$t2),D0[3]=$t1,$t1),D0[2]=$t,$t);D0[0]=($t10=($t11=(D3[3]=1,1),D2[2]=$t11,$t11),D1[1]=$t10,$t10);this.identity=!0},setTranslation:function(V){var D=this.mvMatrix.elements;D[0][3]=V.x;D[1][3]=V.y;D[2][3]=V.z},setPositionThenScale:function(Position,Scale){var D=this.mvMatrix.elements,A=D[0],B=D[1],C=D[2];A[0]=Scale.x;B[1]=Scale.y;C[2]=Scale.z;A[3]=Position.x;B[3]=Position.y;C[3]=Position.z;this.identity=this.isIdentity()},setScale:function(S){var D=this.mvMatrix.elements;D[0][0]=S.x;D[1][1]=S.y;D[2][2]=S.z},getTranslation:function(){var D=this.mvMatrix;return new BNTest.GLVec3.ctor(D[12],D[13],D[14])},clone:function(){var ret=new BNTest.WGMatrix;return ret.copyFrom(this),ret},mvScale:function(Scale){var s=Scale,m=BNTest.WGMatrix.tmatobj;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);BNTest.WGMatrix.t2matrix[0][0]=s.x;BNTest.WGMatrix.t2matrix[1][1]=s.y;BNTest.WGMatrix.t2matrix[2][2]=s.z;this.multiplyMatrix$1(m)},mvRotate:function(angle,Direction){this.mvRotate$1(angle,[Direction.x,Direction.y,Direction.z])},mvRotate$1:function(angle,v){var inRadians=angle*.01745329251,m=Matrix.Rotation(inRadians,$V([v[0],v[1],v[2]])).ensure4x4();this.multiplyMatrix$1(m)},rotateX:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[1][1]=C;D[1][2]=S;D[2][1]=-S;D[2][2]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},rotateY:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[0][0]=C;D[0][2]=-S;D[2][0]=S;D[2][2]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)},rotateZ:function(radians){var D=BNTest.WGMatrix.t2matrix,C,S;BNTest.WGMatrix.clear(BNTest.WGMatrix.t2matrix);C=Math.cos(radians);S=Math.sin(radians);D[0][0]=C;D[0][1]=S;D[1][0]=-S;D[1][1]=C;this.multiplyMatrix$1(BNTest.WGMatrix.tmatobj)}});Bridge.define("BNTest.World",{statics:{viewDistance:100,viewDistanceS:75,blank:null,config:{init:function(){this.blank=new(System.Collections.Generic.List$1(BNTest.Entity))}}},model:null,game:null,entities:null,platforms:null,octree:null,cam:null,TE:null,config:{init:function(){this.cam=new BNTest.GLVec3.ctor;this.TE=System.Array.init(0,null)}},ctor:function(Game){this.$initialize();this.game=Game;this.model=new BNTest.Model(Game);this.entities=new(System.Collections.Generic.List$1(BNTest.Entity));this.platforms=new(System.Collections.Generic.List$1(BNTest.Entity));this.octree=new BNTest.Octree(300,4)},getOffset:function(){return this.model.offset},setOffset:function(value){this.model.offset=value},add:function(E){Bridge.referenceEquals(E.world,this)||E.world==null||E.world.remove(E);this.entities.contains(E)||(E.char||this.platforms.add(E),this.entities.add(E));E.model!=null&&this.add$1(E.model);E.world=this},add$1:function(M){M==null||this.model.children.contains(M)||this.model.children.add(M)},remove:function(E){this.entities.contains(E)&&(E.char||this.platforms.remove(E),this.entities.remove(E));E.model!=null&&this.remove$1(E.model);E.world=null},remove$1:function(M){M!=null&&this.model.children.contains(M)&&(this.model.children.remove(M),M.unloadBuffers())},update:function(){var i,E;for(BNTest.World.viewDistance=this.game.cameraDist*4,BNTest.World.viewDistanceS=BNTest.World.viewDistance*.67,this.cam=BNTest.GLVec3.op_UnaryNegation(this.getOffset()),i=0;i<this.entities.getCount();)E=this.entities.getItem(i),E.update(),E.alive||(this.remove(E),i=i-1|0),i=i+1|0;this.updateCollisions()},findAnyCollision:function(box,exclusion){var E,EL;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],EL=E.lastBB,E!=exclusion&&EL!=null&&!EL.getEmpty()&&EL.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findObstructionCollision:function(box,exclusion){var E,EB;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],EB=E.lastBB,(E.solid||E.obstruction)&&E!=exclusion&&EB!=null&&!EB.getEmpty()&&EB.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findObstructionCollision$1:function(Position,exclusion){var EB;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.entities.items,i=0,ln=Ent.length,E;i<ln;)E=Ent[i],EB=E.lastBB,(E.solid||E.obstruction)&&E!=exclusion&&EB!=null&&!EB.getEmpty()&&EB.contains(Position)&&ret.push(E),i=i+1|0;return ret},findPlatformCollision:function(box,exclusion){var EB;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.platforms.items,i=0,ln=Ent.length,E;i<ln;)E=Ent[i],EB=E.lastBB,E.solid&&E!=exclusion&&E.lastBB!=null&&!EB.getEmpty()&&EB.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findPlatformCollision$1:function(Position,exclusion){var E,EB;exclusion===void 0&&(exclusion=null);for(var ret=[],Ent=this.platforms.items,i=0,ln=Ent.length;i<ln;)E=Ent[i],EB=E.lastBB,E.solid&&E!=exclusion&&EB!=null&&!EB.getEmpty()&&EB.contains(Position)&&ret.push(E),i=i+1|0;return ret},findSolidCollision:function(box,exclusion,OUT){var none,ret,E;exclusion===void 0&&(exclusion=null);OUT===void 0&&(OUT=null);none=!0;ret=OUT!=null?OUT:this.TE;Bridge.referenceEquals(ret,this.TE)&&BNTest.HelperExtensions.clear$1(BNTest.Entity,this.TE);for(var Ent=this.entities.items,i=0,ln=Ent.length,EL;i<ln;)E=Ent[i],EL=E.lastBB,E.solid&&E!=exclusion&&EL!=null&&!EL.getEmpty()&&EL.intersection$2(box)&&ret.push(E),i=i+1|0;return ret},findSolidCollision$2:function(Position,exclusion,OUT){var ret,E;exclusion===void 0&&(exclusion=null);OUT===void 0&&(OUT=null);ret=OUT!=null?OUT:this.TE;Bridge.referenceEquals(ret,this.TE)&&BNTest.HelperExtensions.clear$1(BNTest.Entity,this.TE);for(var Ent=this.entities.items,i=0,ln=Ent.length,EL;i<ln;)E=Ent[i],EL=E.lastBB,E.solid&&E!=exclusion&&EL!=null&&!EL.getEmpty()&&EL.contains(Position)&&ret.push(E),i=i+1|0;return ret},findSolidCollision$1:function(entity){return entity.lastBB==null?[]:this.findSolidCollision(entity.lastBB)},updateCollisions:function(){this.updateAttackCollisions()},prepareRender:function(){BNTest.Mesh.lastDrawn=null;(this.game.frame&1)>0&&this.model.children.sort($_.BNTest.World.f1)},updateAttackCollisions:function(){for(var i=0,LHE=System.Array.init(0,null),LC=System.Array.init(0,null),ln=this.entities.getCount(),Ent=this.entities.items,E,li,jli,C,CE,CB;i<ln;)E=Ent[i],E.getTargetPriority&&LC.push(E),E.gettouchDamage&&LHE.push(E),i=i+1|0;for(i=0,li=LHE.length,jli=LC.length;i<li;){for(var ji=0,HE=LHE[i],THE=HE,B=THE.lastBB;ji<jli;)C=LC[ji],HE.BNTest$IHarmfulEntity$getAttacker().sameTeam(C)||(CE=C,CB=CE.lastBB,B.intersection$2(CB)&&HE.BNTest$IHarmfulEntity$ontouchDamage(C)&&this.game.attack(C,HE)),ji=ji+1|0;i=i+1|0}}});Bridge.ns("BNTest.World",$_);Bridge.apply($_.BNTest.World,{f1:function(M1,M2){return Bridge.compare(M1.drawOrder,M2.drawOrder)}});Bridge.define("BNTest.AimedWandering",{inherits:[BNTest.EntityBehavior],target:null,target2:null,focus:.95,range:120,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},update:function(){var N=this.entity.getBehavior(BNTest.NavigatorAI),T,V,Nrelative;if(N==null&&(N=new BNTest.NavigatorAI(this.entity),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),T=this.target2,T==null&&this.target!=null&&this.target.getPosition()!=null&&(T=this.target.getPosition()),T!=null){for(var relative=BNTest.GLVec3.op_Subtraction(this.entity.getPosition(),T),dist=relative.getRoughLength(),maxrange=this.range,mr2=maxrange+maxrange,ok=!1;!ok;)V=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(-maxrange+Math.random()*mr2,0,-maxrange+Math.random()*mr2),this.entity.getPosition()),Nrelative=BNTest.GLVec3.op_Subtraction(V,T),(Nrelative.getRoughLength()<dist||Math.random()>this.focus)&&(N.requestMoveTo(V,.42,!0),ok=!0);BNTest.EntityBehavior.prototype.update.call(this)}}});Bridge.define("BNTest.AirDash",{inherits:[BNTest.EntityBehavior],_platformer:null,dashes:0,maxDashes:1,activeTime:0,maxActiveTime:10,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this._platformer=entity},update:function(){var controller=this._platformer.controller,lcontroller=this._platformer.lController,Floor=this._platformer.floor,V;Floor!=null&&this._platformer.onGround&&(this.dashes=this.maxDashes);Floor!=null&&this._platformer.onGround||this.dashes<this.maxDashes&&(this.activeTime=this.activeTime+1|0,this.activeTime===this.maxActiveTime&&(this._platformer.speed.x*=.35,this._platformer.speed.z*=.35));this._platformer.onGround||controller[4]&&!lcontroller[4]&&this.dashes>0&&(V=BNTest.Vector2.fromRadian(BNTest.MathHelper.degreesToRadians(this._platformer.model.rotation.y+90)),(controller[0]||controller[1]||controller[2]||controller[3])&&(V.x=0,V.y=0,controller[0]?V.x=-1:controller[1]&&(V.x=1),controller[2]?V.y=-1:controller[3]&&(V.y=1)),this._platformer.speed=BNTest.GLVec3.op_Addition$1(this._platformer.speed,V.normalize(9)),this._platformer.speed.y=-2,this._platformer.playSound("zoom"),this.activeTime=0,this.dashes=this.dashes-1|0);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.Barrier",{inherits:[BNTest.Entity],ctor:function(world,size){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.solid=!0;this.model.forceRender=!0;var M=new BNTest.Mesh(this.game);M.addCube2(new BNTest.GLVec3.ctor,size,new BNTest.GLColor(0,0,0,.3),null);this.model.meshes.add(M);this.cacheBoundingBox()},update:function(){BNTest.Entity.prototype.update.call(this);this.model.drawOrder=1},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.BasicSword",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:0,bulletLifeSpan:6,bulletGraphic:null,speed:null,forcedAngle:0,minCoolDown:22,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);entity.useSwingAnimation=!0},getEnergyCost:function(){return 9.2},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,40);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P=new BNTest.Projectile(this.entity.world,this.entity),M,size,HSZ,lifespan;P.solid=!1;P.multiHit=!0;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(80);M.rotation.y=evt.A;size=30;HSZ=new BNTest.GLVec3.ctor(size,size,size);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.setScale(BNTest.GLVec3.createUniform(3));lifespan=this.bulletLifeSpan;lifespan=lifespan+3|0;P.obstruction=!0;P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY).normalize(2.5));P.speed=BNTest.GLVec3.op_Addition(P.speed,this.entity.speed.clone());P.addBehavior(new BNTest.LifeSpan(P,lifespan));this.entity.world.add(P);this.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));P.setPosition(BNTest.GLVec3.op_Addition(P.getPosition(),BNTest.GLVec3.op_Multiply$1(this.speed,.5)))},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.ButtonSprite",{inherits:[BNTest.Sprite],_buttonNeedsRerender:!1,_buttonBuffer:null,_buttonGraphic:null,data:null,_contents:null,_borderSize:0,_borderColor:null,lockedClickSound:"hit",clickSound:"select",_buttonColor:null,colorSchemes:null,locked:!1,onClick:null,lContentSize:null,config:{init:function(){this.lContentSize=new BNTest.Vector2}},$ctor1:function(Text,FontSize,borderSize,borderColor,buttonColor,data){var T,contents;borderSize===void 0&&(borderSize=2);borderColor===void 0&&(borderColor="#00AA33");buttonColor===void 0&&(buttonColor="#11CC55");data===void 0&&(data=null);this.$initialize();BNTest.Sprite.ctor.call(this);T=new BNTest.TextSprite;T.setText(Text);T.setFontSize(FontSize);contents=T;this.setContents(contents);this.setBorderSize(borderSize);this.setBorderColor(borderColor);this.setButtonColor(buttonColor);this._buttonBuffer=new BNTest.Sprite;this._buttonBuffer.setSize(contents.getSize());this._buttonGraphic=this._buttonBuffer.getGraphics();this._buttonNeedsRerender=!0;this.colorSchemes=new(System.Collections.Generic.List$1(BNTest.ButtonSprite.ColorScheme));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme(borderColor,buttonColor));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme("#FFFFFF","#FF0000"));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme("#777777","#CCCCCC"));this.data=data;data==null&&Bridge.hasValue(contents)&&(this.data=contents.getText());this.draw(null)},ctor:function(contents,borderSize,borderColor,buttonColor,data){borderSize===void 0&&(borderSize=2);borderColor===void 0&&(borderColor="#00AA33");buttonColor===void 0&&(buttonColor="#11CC55");data===void 0&&(data=null);this.$initialize();BNTest.Sprite.ctor.call(this);this.setContents(contents);this.setBorderSize(borderSize);this.setBorderColor(borderColor);this.setButtonColor(buttonColor);this._buttonBuffer=new BNTest.Sprite;this._buttonBuffer.setSize(contents.getSize());this._buttonGraphic=this._buttonBuffer.getGraphics();this._buttonNeedsRerender=!0;this.colorSchemes=new(System.Collections.Generic.List$1(BNTest.ButtonSprite.ColorScheme));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme(borderColor,buttonColor));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme("#FFFFFF","#FF0000"));this.colorSchemes.add(new BNTest.ButtonSprite.ColorScheme("#777777","#CCCCCC"));this.data=data;data==null&&Bridge.is(contents,BNTest.TextSprite)&&(this.data=Bridge.cast(contents,BNTest.TextSprite).getText());this.draw(null)},getContents:function(){return this._contents},setContents:function(value){Bridge.referenceEquals(this._contents,value)||(this._contents=value,this._buttonNeedsRerender=!0)},getBorderSize:function(){return this._borderSize},setBorderSize:function(value){this._borderSize!==value&&(this._borderSize=value,this._buttonNeedsRerender=!0)},getBorderColor:function(){return this._borderColor},setBorderColor:function(value){Bridge.referenceEquals(this._borderColor,value)||(this._borderColor=value,this._buttonNeedsRerender=!0)},getButtonColor:function(){return this._buttonColor},setButtonColor:function(value){Bridge.referenceEquals(this._buttonColor,value)||(this._buttonColor=value,this._buttonNeedsRerender=!0)},setColorScheme:function(scheme){this.setBorderColor(scheme.borderColor);this.setButtonColor(scheme.buttonColor)},setColorScheme$1:function(index){var C=this.colorSchemes.getItem(index);this.setColorScheme(C)},drawButton:function(){var g=this._buttonGraphic,sz=this._borderSize+this._borderSize|0,size;this._buttonBuffer.setSize(BNTest.Vector2.op_Addition(this.getContents().getSize(),new BNTest.Vector2(sz,sz)));size=this._buttonBuffer.getSize();g.fillStyle=this._borderColor;g.fillRect(0,0,size.x,size.y);g.fillStyle=this.getButtonColor();g.fillRect(this._borderSize,this._borderSize,Bridge.Int.clip32(size.x)-sz|0,Bridge.Int.clip32(size.y)-sz|0);var color="rgba(255,255,255,0)",grd=g.createLinearGradient(0,0,0,size.y);grd.addColorStop(0,color);grd.addColorStop(.4,"rgba(255,255,255,0.7)");grd.addColorStop(1,color);g.fillStyle=grd;g.fillRect(0,0,this._buttonBuffer.getSize().x,this._buttonBuffer.getSize().y)},lock:function(setcolorscheme){(setcolorscheme===void 0&&(setcolorscheme=!0),this.locked)||(this.locked=!0,setcolorscheme&&this.setColorScheme$1(2))},unlock:function(setcolorscheme){(setcolorscheme===void 0&&(setcolorscheme=!0),this.locked)&&(this.locked=!1,setcolorscheme&&this.setColorScheme$1(0))},checkClick:function(mousePosition){var clicked,tmp;return(mousePosition===void 0&&(mousePosition=null),BNTest.Vector2.op_Equality(mousePosition,null)&&(mousePosition=BNTest.KeyboardManager.get_this().cMouse,clicked=BNTest.KeyboardManager.get_this().tappedMouseButtons.contains(0),!clicked))?!1:this.visible&&this.getBounds().containsPoint(mousePosition)?this.locked?(Bridge.referenceEquals(this.lockedClickSound,"")||this.lockedClickSound==null||BNTest.AudioManager.get_this().blast(System.String.concat(System.String.concat("SFX/",this.lockedClickSound),".ogg")),!1):(Bridge.referenceEquals(this.clickSound,"")||this.clickSound==null||BNTest.AudioManager.get_this().blast(System.String.concat(System.String.concat("SFX/",this.clickSound),".ogg")),tmp=this.onClick,tmp&&this.onClick(),!0):!1},draw:function(g){(this._contents.getSize().x!==this.lContentSize.x||this._contents.getSize().y!==this.lContentSize.y)&&(this._buttonNeedsRerender=!0,this.lContentSize=this._contents.getSize().clone());this._buttonNeedsRerender&&(this.drawButton(),this._buttonNeedsRerender=!1);this.setSize(this._buttonBuffer.getSize().clone());this._buttonBuffer.draw(this.spriteGraphics);this.getContents().position=new BNTest.Vector2(this._borderSize,this._borderSize);this.getContents().draw(this.spriteGraphics);g!=null&&BNTest.Sprite.prototype.draw.call(this,g)}});Bridge.define("BNTest.CharacterSelect",{inherits:[BNTest.Sprite],characters:null,menu:null,charCount:0,ctor:function(Characters){this.$initialize();BNTest.Sprite.ctor.call(this);this.characters=Characters;this.initMenu();this.spriteBuffer.width=1024;this.spriteBuffer.height=Bridge.Int.clip32(1024*BNTest.App.targetAspect)},initMenu:function(){var S="",def,L,i,A,B;for(this.menu!=null&&(S=this.menu.getSelectedText()),this.charCount=0,this.menu=new BNTest.ButtonMenu(700,450,46,!0),this.menu.position=new BNTest.Vector2(30,300),def=null,L=this.characters.getItems(),L=System.Linq.Enumerable.from(L).where($_.BNTest.CharacterSelect.f1).toList(BNTest.FeatureItem),i=0;i<L.getCount();)A=L.getItem(i),B=this.menu.addButton(A.name),def==null&&(def=B),this.charCount=this.charCount+1|0,i=i+1|0;this.menu.finish(Bridge.Int.clip32(Math.ceil(this.menu.getAllButtons().getCount()/3)));this.menu.select(def);this.charCount===1&&(def.visible=!1);Bridge.referenceEquals(S,"")||S==null||this.menu.setSelectedText(S)},update:function(){this.menu.update()},render:function(){BNTest.HelperExtensions.clear(this.spriteGraphics);this.menu.draw(this.spriteGraphics)},draw:function(g){this.render();BNTest.Sprite.prototype.draw.call(this,g)}});Bridge.ns("BNTest.CharacterSelect",$_);Bridge.apply($_.BNTest.CharacterSelect,{f1:function(J){return J.getPurchased()}});Bridge.define("BNTest.Coin",{inherits:[BNTest.Entity],value:10,pickupDelay:0,falling:!0,frame:0,ctor:function(world,lifespan){var smooth,mdl,tmdl,coin,HP;lifespan===void 0&&(lifespan=900);this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(10);mdl="coin";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.model.alpha=1,this.model.setVisible(!0)):(coin="object/coin",BNTest.AnimationLoader.get_this().asyncGet$1([coin],Bridge.fn.bind(this,function(){var off,box,M2,md,M,M3;this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));off=this.model.offset;this.model.clear();this.model.offset=off;this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,.5);box=BNTest.VoxelMap.fromImages$1(coin);M2=new BNTest.Mesh(this.game);M2.addVoxelMap(box,smooth);box.setColor(new BNTest.GLColor);M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);M3=M.clone();md=new BNTest.Model(this.game);md.meshes.add(M3);M3.scale=BNTest.GLVec3.createUniform(1.1);M3.updateTranformation();M3.flattenGeometry();md=new BNTest.Model(this.game);M.scale=new BNTest.GLVec3.ctor(.8,.8,.8);md.meshes.add(M);M.updateTranformation();M.flattenGeometry();M.combine(M3);this.model.children.add(md);md=new BNTest.Model(this.game);md.bleedThrough=!0;md.meshes.add(M2);this.model.children.add(md);this.model.drawOrder=-1;this.model.smoothen();tmdl==null&&BNTest.ModelCache.get_this().set$1("coin",this.model)})));this.solid=!1;HP=new BNTest.LifeSpan(this,lifespan,120);this.addBehavior(HP)},setValue:function(Value){var rank,val,scale,T,C;if(Value<10){this.setScale(BNTest.GLVec3.createUniform((10+Value|0)*.5*.1*.5));this.value=Value;this.customBoundingBox=BNTest.BoundingBox.op_Multiply$1(this.customBoundingBox,this.model.scale.x);return}for(rank=0,val=Value;val>=500;)val*=.002,rank=rank+1|0;scale=1+val*.005;rank>0&&(T=[new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,0,1),new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,0,1)],C=T[rank],this.setColor(C));this.setScale(BNTest.GLVec3.createUniform(scale*.5));this.value=Value;this.customBoundingBox=BNTest.BoundingBox.op_Multiply$1(this.customBoundingBox,this.model.scale.x)},setColor:function(color){var P=this.model.offset,M;this.model=this.model.clone();this.model.offset=P;M=this.model.children.getItem(1);M.meshes.getItem(0).replaceAllColors(color)},update:function(){var player,BS,dist,spd,S,val;this.model.rotation.y+=5;BNTest.Entity.prototype.update.call(this);this.frame=this.frame+1|0;player=this.world.game.localplayer.character;BS=this.lastBB.getSize();this.speed=BNTest.GLVec3.op_Multiply$1(this.speed,.96);!this.falling&&(this.frame&15)!=0||this.world.findSolidCollision$2(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,BS.y+1,0))).length>0?(this.falling=!1,this.speed.y=0):(this.falling=!0,this.speed.y+=.07);this.pickupDelay>0?this.pickupDelay=this.pickupDelay-1|0:player.restTime>=15&&player.invincibilityFrames<=0&&(dist=this.getPosition().roughDistance(player.getPosition()),dist<110&&(spd=2.5-dist*.01,S=BNTest.GLVec3.op_Subtraction(player.getPosition(),this.getPosition()).normalize(spd),this.speed.x=S.x,this.speed.y=S.y,this.speed.z=S.z));this.pickupDelay<=0&&BS.getRoughLength()>0&&player.lastBB.getRoughLength()>0&&player.lastBB.intersection$2(this.lastBB)&&(val=this.value,player.setCoins(player.getCoins()+val|0),this.playSound("powerup"),this.alive=!1)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.ControllableEntity",{inherits:[BNTest.Entity],controller:null,lController:null,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.controller=System.Array.init(7,!1);this.lController=System.Array.init(this.controller.length,!1)}});Bridge.define("BNTest.DonationBox",{inherits:[BNTest.Entity],defaultMaxHP:40,maxHP:0,HP:0,frame:0,coinsToRelease:0,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);var smooth=this.game.smooth;this.solid=!0;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(20);this.customBoundingBox.min.y=-2;this.lastBB=this.customBoundingBox.clone();BNTest.AnimationLoader.get_this().asyncGet$1(["object/donationBox","object/donationBoxTop"],Bridge.fn.bind(this,function(){this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.model.clear();this.HP=this.maxHP=this.defaultMaxHP;world.add$1(this.model);var box=this.game.getVoxelCombo(["object/donationBox","object/donationBoxTop"]),M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);this.model.meshes.add(M)}))},update:function(){var $t,B,PC,i,Val,c,m,m2;if(this.lastBB==null&&(this.lastBB=new BNTest.BoundingBox.ctor),!this.game.ended){if(!this.solid&&!this.model.getVisible()){BNTest.Entity.prototype.update.call(this);return}if(B=BNTest.BoundingBox.op_Multiply$1(this.lastBB,1.5),PC=this.game.localplayer.character,this.frame=this.frame+1|0,(this.frame&1)>0){var L=this.world.findSolidCollision(B,this),P=System.Linq.Enumerable.from(L).where($_.BNTest.DonationBox.f1).toArray(),PL=P.length;PL>0&&(this.HP-=1+(PL*1|0)|0,this.HP<=0&&PC.getCoins()>=10&&(this.coinsToRelease=this.coinsToRelease+1|0,this.HP=this.maxHP))}if(this.coinsToRelease>0&&PC.getCoins()<=0&&(this.coinsToRelease=0),this.coinsToRelease>0){for(i=this.coinsToRelease;i>0;)this.setScale(BNTest.GLVec3.op_Multiply$1(this.getScale(),.96)),i=i-1|0;this.getScale().x<=.6&&(this.coinsToRelease=this.coinsToRelease-1|0,Val=Math.min(PC.getCoins(),10),PC.setCoins(PC.getCoins()-Val|0),c=new BNTest.Coin(this.world),c.setPosition(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,-20,0))),c.solid=!1,m=3,m2=m+m|0,c.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),c.speed.y=-1+(-m|0)*Math.random(),Val!==10&&c.setValue(Val),this.world.add(c),this.getScale().x=($t=(this.getScale().z=1,1),this.getScale().y=$t,$t))}BNTest.Entity.prototype.update.call(this)}},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.ns("BNTest.DonationBox",$_);Bridge.apply($_.BNTest.DonationBox,{f1:function(E){return E.controller!=null&&E.team!==0}});Bridge.define("BNTest.EnemyEngager",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,predict:!0,passive:!1,weapon:5,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),P,E,EP,Pos;if(N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),P=this.entity.getPosition(),this.target!=null&&P.roughDistance(this.target.model.offset)>this.sightRange&&(this.target=null),this.target==null&&!this.passive)for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.sightRange&&(this.target=EP,i=ln)),i=i+1|0;this.target!=null?(controller[this.weapon]=!0,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),N.requestMoveTo(Pos,.5)):controller[this.weapon]=!1;BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.EnemyStrafer",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,predict:!0,passive:!1,attackrange:999999,ang:.1,frame:0,attackType:5,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller,N,P,D,E,EP,PC,Pos,rl,rel,A,NV;if(this.frame=this.frame+1|0,controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),P=this.entity.getPosition(),D=0,this.target!=null&&(D=P.roughDistance(this.target.model.offset),D>this.sightRange&&(this.target=null)),this.target==null&&!this.passive)for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.sightRange&&(this.target=EP,i=ln)),i=i+1|0;this.target!=null?(PC=this.entity,controller[this.attackType]=D<=this.attackrange?!0:!1,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),rl=BNTest.GLVec3.op_Subtraction(Pos,this.entity.getPosition()).toVector2(),rel=BNTest.MathHelper.radiansToDegrees(rl.toAngle()),this.entity.model.rotation.y=rel-90,N.setsAngle=!1,A=this.ang,D>this.attackrange*.75?A=A+A:D<this.sightRange*.6&&(A=-(A+A)),NV=BNTest.GLVec3.op_Addition$1(this.entity.getPosition(),rl.rotate(1.57-A)),N.requestMoveTo(NV,.5)):(controller[this.attackType]=!1,N.setsAngle=!0);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.EntityFollower",{inherits:[BNTest.EntityBehavior],target:null,ctor:function(entity,target){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.target=target},update:function(){var N=this.entity.getBehavior(BNTest.NavigatorAI);N==null&&(N=new BNTest.NavigatorAI(Bridge.cast(this.entity,BNTest.ControllableEntity)),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N));N.requestMoveTo(this.target.getPosition().clone(),.4);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.FivePointShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:5,bulletLifeSpan:18,bulletGraphic:null,minCoolDown:180,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var i,ang,P,M;this.entity.playSound("pew");var scale=4,spd=new BNTest.Vector2(evt.SX,evt.SY),HSZ=BNTest.GLVec3.createUniform(10*scale);for(this.entity.invincibilityFrames=75,i=0,ang=1.256;i<6.28;)P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,P.multiHit=!0,P.obstruction=!0,P.ignoresTerrain=!0,P.knockbackPower=8,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.setScale(BNTest.GLVec3.createUniform(scale)),P.settouchDamage(130),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd.rotate(i)),M.rotation.y=evt.A+BNTest.MathHelper.radiansToDegrees(i),M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X),P.sety(evt.Y+2),P.setz(evt.Z),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),i+=ang},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.Foliage",{inherits:[BNTest.Entity],current:null,ctor:function(world){this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.solid=!1;this.model.setVisible(!1);this.model.forceRender=!0;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(1)},addPatch:function(position,color,size,thickness,scale){var V,VL,amod,mod,M;thickness===void 0&&(thickness=.7);scale===void 0&&(scale=1);for(var VM=new BNTest.VoxelMap.ctor,N=System.Array.create(null,null,size,1,size),X=0,Y=0,Z=0,min=Bridge.Int.div(size,4)|0,max=size-min|0,S=size*.5;X<System.Array.getLength(N,0);){while(Y<System.Array.getLength(N,1)){while(Z<System.Array.getLength(N,2))V=new BNTest.GLVec3.ctor(X-S,0,Z-S),VL=V.getLength(),VL<=S&&(amod=.25,mod=(amod+VL/S)/(amod+1),Math.random()*mod<thickness&&N.set([X,Y,Z],color)),Z=Z+1|0;Z=0;Y=Y+1|0}Y=0;Z=0;X=X+1|0}VM.map=N;VM.addNoise(.15);M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},addFlatShrub:function(position,color,scale){var VM,N,M;scale===void 0&&(scale=1);VM=new BNTest.VoxelMap.ctor;N=System.Array.create(null,null,10,1,10);VM.map=N;VM.fill(new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor,new BNTest.GLVec3.ctor(10,1,10)),color);VM.addNoise(.1);VM.addHoles(.6);M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},addShrub:function(position,color,scale){var VM,T;scale===void 0&&(scale=1);var Char="shrub",tmdl=BNTest.ModelCache.get_this().get(Char,!1),M=null,size=30;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),M=tmdl.meshes.getItem(0).clone()):(VM=BNTest.VoxelMap.generateRock(size,color,.9),VM.addNoise(.07),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,!0),T=new BNTest.Model(this.game),T.meshes.add(M),BNTest.ModelCache.get_this().set$1(Char,T));M.offset=position;M.offset.y-=(Bridge.Int.div(size,4)|0)*scale;M.rotation.y=Math.random()*360;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));this.addFoliage(M)},addFlower:function(position,petal,inner,scale){var $t,$t1,VM,N,M;inner===void 0&&(inner=null);scale===void 0&&(scale=1);inner==null&&(inner=petal.r===petal.g&&petal.b===0&&petal.r>0?new BNTest.GLColor(.7,.7,0):new BNTest.GLColor(1,1));VM=new BNTest.VoxelMap.ctor;N=System.Array.create(null,null,3,1,3);N.set([1,0,0],($t=($t1=(N.set([2,0,1],petal),petal),N.set([0,0,1],$t1),$t1),N.set([1,0,2],$t),$t));N.set([1,0,1],inner);VM.map=N;M=new BNTest.Mesh(this.game);M.addVoxelMap(VM,!1,!0,!0);M.offset=position;scale!==1&&(M.scale=BNTest.GLVec3.op_Multiply$1(M.scale,scale));M.rotation.y=Math.random()*360;this.addFoliage(M)},absorbModel:function(E){this.absorbModel$1(E.model)},absorbModel$1:function(M,baseTransform){var matrix,i,C;for(baseTransform===void 0&&(baseTransform=null),M.updateTransform(),baseTransform==null&&M.transformed?baseTransform=M.transformation.clone():M.transformed&&baseTransform.multiplyMatrix(M.transformation),baseTransform==null&&(baseTransform=new BNTest.WGMatrix),M.setVisible(!1),i=0;i<M.meshes.getCount();)C=M.meshes.getItem(i),matrix=M.transformation.clone(),C.transformation!=null&&C.transformed&&matrix.multiplyMatrix(C.transformation),C.morphGeometry(matrix),this.addFoliage(C),i=i+1|0;for(i=0;i<M.children.getCount();)this.absorbModel$1(M.children.getItem(i),baseTransform.clone()),i=i+1|0},addFoliage:function(M){(this.current==null||(Bridge.Int.div(this.current.verticies.length+M.verticies.length|0,3)|0)>=65535)&&(this.current=new BNTest.Mesh(this.game),this.model.meshes.add(this.current));M.flattenGeometry();this.current.combine(M,!0);this.model.setVisible(!0)},update:function(){BNTest.Entity.prototype.update.call(this)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.HeavyShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:5,bulletLifeSpan:70,bulletGraphic:null,minCoolDown:75,started:!1,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 2},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var pal,icecolor,ang,D,P;if(this.started||this.bulletGraphic==null||(this.started=!0,pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),icecolor=new BNTest.GLColor(1,.1,.1,.9),pal.set(new BNTest.GLColor(1,0,0),icecolor),pal.set(new BNTest.GLColor(1,1,1),icecolor),this.bulletGraphic.applyPalette(pal)),this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.multiHit=!0;P.setScale(BNTest.GLVec3.createUniform(2));P.settouchDamage(260);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=BNTest.GLVec3.createUniform(10*P.getScale().x);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.HPOrb",{inherits:[BNTest.Entity],healing:10,pickupDelay:0,ready:!1,frame:0,falling:!1,ctor:function(world,lifespan){var smooth,mdl,tmdl,coin,HP;lifespan===void 0&&(lifespan=900);this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(10);mdl="redOrb";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.model.alpha=1,this.model.setVisible(!0)):(coin="object/orb",BNTest.AnimationLoader.get_this().asyncGet$1([coin],Bridge.fn.bind(this,function(){var alpha,pal,box,md,M;if(tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.'));this.model.copyFrom(tmdl,!0);this.ready=!0;return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.model.setVisible(!1);world.add$1(this.model);alpha=.54;pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,0,0,alpha));box=this.game.getVoxelCombo([coin]);box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);md.scale=BNTest.GLVec3.createUniform(.6);M.addVoxelMap(box,smooth);md.meshes.add(M.clone());this.model.children.add(md);box=this.game.getVoxelCombo([coin]);pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,0,0,alpha*.4));box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);md.scale=BNTest.GLVec3.createUniform(1);md.meshes.add(M);this.model.children.add(md);this.model.scale=BNTest.GLVec3.createUniform(1);this.model.smoothen();this.ready=!0;tmdl==null&&BNTest.ModelCache.get_this().set$1(mdl,this.model)})));this.solid=!1;HP=new BNTest.LifeSpan(this,lifespan,120);this.addBehavior(HP)},update:function(){var f,player,BS,dist,spd,S;this.model.rotation.y+=5;f=BNTest.MathHelper.clamp(this.model.scale.x*(1+(-.1+.2*Math.random())),.8,1.2);BNTest.Entity.prototype.update.call(this);player=this.world.game.localplayer.character;BS=this.lastBB.getSize();this.speed=BNTest.GLVec3.op_Multiply$1(this.speed,.96);!this.falling&&(this.frame&15)!=0||this.world.findSolidCollision$2(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,BS.y+1,0))).length>0?(this.falling=!1,this.speed.y=0):(this.falling=!0,this.speed.y+=.05);this.pickupDelay>0?this.pickupDelay=this.pickupDelay-1|0:player.restTime>=5&&player.invincibilityFrames<=5&&(dist=this.getPosition().roughDistance(player.getPosition()),dist<110&&(spd=7-dist*.01,S=BNTest.GLVec3.op_Subtraction(player.getPosition(),this.getPosition()).normalize(spd),this.speed=BNTest.GLVec3.lerp(this.speed,S,.07)));this.pickupDelay<=0&&BS.getRoughLength()>0&&player.lastBB.getSize().getRoughLength()>0&&player.lastBB.intersection$2(this.lastBB)&&(player.setHP(Math.min(100,player.getHP()+this.healing)),this.playSound("powerup"),this.alive=!1)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.IceBall",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],active:!1,ready:!0,ball:null,maxActive:90,currentActive:0,releaseForce:1.75,_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:2.5,bulletLifeSpan:100,bulletGraphic:null,minCoolDown:60,started:!1,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},onAttacked:function(){var E=this.entity;this.active&&this.ball!=null&&this.ball.alive&&(this.ball.speed=BNTest.GLVec3.op_Multiply$1(this.ball.speed,1.1));this.active=!1},release:function(){this.ball!=null&&this.ball.alive&&(this.ball.speed=BNTest.GLVec3.op_Multiply$1(this.ball.speed,this.releaseForce),this.ball.knockbackPower+=this.ball.getScale().y*.67);this.entity.speed.x*=.5;this.entity.speed.z*=.5;this.active=!1},update:function(){var pal,icecolor,sz,HSZ,SP,ang,D,P;if(this.started||this.bulletGraphic==null||(this.started=!0,pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),icecolor=new BNTest.GLColor(.7,.7,1,.7),pal.set(new BNTest.GLColor(1,0,0),icecolor),pal.set(new BNTest.GLColor(1,1,1),icecolor),this.bulletGraphic.applyPalette(pal)),this.entity.controller[6]||(this.ready=!0),this.active){if(!this.entity.controller[6]||this.currentActive>=this.maxActive||this.ball!=null&&(this.entity.speed.x!==this.ball.speed.x||this.entity.speed.z!==this.ball.speed.z)){this.release();return}if(this.ball!=null&&this.ball.alive){this.ball.setScale(BNTest.GLVec3.op_Addition(this.ball.getScale(),BNTest.GLVec3.createUniform(.02)));this.ball.settouchDamage(this.ball.gettouchDamage()+1);sz=11*this.ball.getScale().x;HSZ=BNTest.GLVec3.createUniform(sz);this.ball.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);this.ball.getBehavior(BNTest.LifeSpan).HP=this.ball.getBehavior(BNTest.LifeSpan).HP+1|0;this.entity.shootTime++;SP=this.ball.speed.toVector2();SP=SP.normalize(this.ball.model.scale.x*10+5);this.entity.setx(this.ball.model.offset.x-SP.x);this.entity.setz(this.ball.model.offset.z-SP.y);this.currentActive=this.currentActive+1|0;this.entity.animation="pushing";Math.abs(this.ball.gety()-this.entity.gety())>25&&this.release();return}this.release()}else this.entity.forcedAngle=null,this.entity.frictionActive=!0,System.String.equals(this.entity.animation,"pushing")&&(this.entity.animation="idle",this.entity.initModel());if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=-.7;D.SZ=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x+V1.x*5;D.Y=P.y-10;D.Z=P.z+V1.y*5;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var spd=new BNTest.Vector2(evt.SX,evt.SZ),P=new BNTest.Projectile(this.entity.world,this.entity),M,sz,HSZ,C;P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(50);P.setScale(BNTest.GLVec3.createUniform(1.5));P.speed=new BNTest.GLVec3.ctor(evt.SX,evt.SY,evt.SZ);P.obstruction=!0;P.gravity=new BNTest.GLVec3.ctor(0,.12,0);P.rotationSpeed=new BNTest.GLVec3.ctor(3.5,0,0);P.ifriction=.98;P.bounces=!0;P.multiHit=!0;P.knockbackPower=4;M.rotation.y=evt.A;sz=11*P.getScale().x;HSZ=BNTest.GLVec3.createUniform(sz);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P);P.ifriction=1;C=this.entity.controller;C[0]||C[1]||C[2]||C[3]||C[4]||!this.ready?(this.ball=null,this.entity.playSound("pew"),this.ready=!1):(this.ball=P,this.entity.speed.x=P.speed.x,this.entity.speed.z=P.speed.z,this.entity.forcedAngle=BNTest.MathHelper.radiansToDegrees(P.speed.toVector2().toAngle())-90,this.entity.frictionActive=!1,this.active=!0,this.currentActive=0,this.ready=!1)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.Laevatein",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:10,bulletLifeSpan:15,bulletGraphic:null,minCoolDown:85,activetime:0,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this.activetime>0&&(this.activetime=this.activetime-1|0,this.activetime<=0&&(this.entity.forcedAngle=null)),this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.entity.forcedAngle=this._angle;this.activetime=this.bulletLifeSpan;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ,T,repeat;for(this.entity.playSound("woosh2"),P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.ignoresTerrain=!0,P.multiHit=!0,P.setScale(BNTest.GLVec3.createUniform(1.5)),P.anchorRotationSpeed=.25,P.currentAnchorRotation=BNTest.MathHelper.degreesToRadians(this.entity.model.rotation.y),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY)),P.settouchDamage(40),M.rotation.y=evt.A,HSZ=BNTest.GLVec3.createUniform(10*P.model.scale.x),M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X),P.sety(evt.Y+2),P.setz(evt.Z),T=new BNTest.LifeSpan(P,this.bulletLifeSpan),T.fadeTime=5,P.addBehavior(T),repeat=10;repeat>0;)P.anchorDistance+=15,this.entity.world.add(P),P=P.clone(),repeat=repeat-1|0},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.LargeLaser",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:1,_angle:0,bulletSpeed:12,bulletLifeSpan:70,bulletGraphic:null,minCoolDown:150,activetime:0,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,inaccuracy,V;this.activetime>0&&(this.activetime=this.activetime-1|0,this.activetime<=0&&(this.entity.forcedAngle=null));this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()&&(ang=BNTest.MathHelper.degreesToRadians(this._angle+90),D={},D.A=this._angle,inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),D.SX=V.x,D.SY=V.y,this.entity.forcedAngle=this._angle,this.activetime=this.bulletLifeSpan,this.customEvent(D))));BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){this.entity.playSound("laser");var P=new BNTest.Laser(this.entity.world,this.entity,new BNTest.Vector2(evt.SX,evt.SY));P.solid=!1;P.settouchDamage(120);P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.Laser",{inherits:[BNTest.Entity,BNTest.IHarmfulEntity],frame:0,user:null,direction:null,width:35,multiHit:!0,attackFrame:0,attackInterval:20,knockbackPower:3,range:350,_touchDamage:0,config:{alias:["getIsHarmful","BNTest$IHarmfulEntity$getIsHarmful","getAttacker","BNTest$IHarmfulEntity$getAttacker","gettouchDamage","BNTest$IHarmfulEntity$gettouchDamage","settouchDamage","BNTest$IHarmfulEntity$settouchDamage","ontouchDamage","BNTest$IHarmfulEntity$ontouchDamage"]},ctor:function(world,User,Direction){this.$initialize();BNTest.Entity.ctor.call(this,world);this.user=User;this.game=world.game;this.model=new BNTest.Model(this.game);this.solid=!0;this.model.forceRender=!0;var M=new BNTest.Mesh(this.game),M2=new BNTest.Mesh(this.game),W=Bridge.Int.div(this.width,3)|0;W=this.width/2.5;M2.addCube2(new BNTest.GLVec3.ctor(11,-W,-W),new BNTest.GLVec3.ctor(this.range-1,W,W),new BNTest.GLColor(1,1,1,.8),null);W=Bridge.Int.div(this.width,2)|0;M.addCube2(new BNTest.GLVec3.ctor(10,-W,-W),new BNTest.GLVec3.ctor(this.range,W,W),new BNTest.GLColor(1,1,1,.5),null);this.model.meshes.add(M2);this.model.meshes.add(M);this.customBoundingBox=new BNTest.BoundingBox.ctor;this.model.rotation.y=BNTest.MathHelper.radiansToDegrees(Direction.toAngle());this.direction=Direction.normalize();this.attackFrame=this.attackInterval;this.model.meshes.getItem(1).scale=this.model.meshes.getItem(0).scale;this.model.meshes.getItem(0).scale.y=(this.model.meshes.getItem(0).scale.z=.1,.1);this.speed=new BNTest.GLVec3.ctor(Direction.x,0,Direction.y);this.speed=BNTest.GLVec3.op_Multiply$1(this.speed,5)},getIsHarmful:function(){return!0},getAttacker:function(){return this.user},gettouchDamage:function(){return this._touchDamage},settouchDamage:function(value){this._touchDamage=value},update:function(){var $t,$t1,$t2,E,dist,spd;this.model.meshes.getItem(0).scale.y=this.model.alpha>=1?this.model.meshes.getItem(0).scale.y<1?($t=this.model.meshes.getItem(0).scale.z+.075,this.model.meshes.getItem(0).scale.z=$t,$t):(this.model.meshes.getItem(0).scale.z=1,1):this.model.meshes.getItem(0).scale.y>0?($t1=this.model.meshes.getItem(0).scale.z-.065,this.model.meshes.getItem(0).scale.z=$t1,$t1):(this.model.meshes.getItem(0).scale.z=0,0);this.frame=this.frame+1|0;this.setPosition(this.user.getPosition().clone());this.model.meshes.getItem(0).rotation.x=($t2=this.model.meshes.getItem(1).rotation.x+5,this.model.meshes.getItem(1).rotation.x=$t2,$t2);var hue=this.frame*.03%1,C=BNTest.GLColor.colorFromAhsb(128,hue*360,.8,.7);if(this.model.meshes.getItem(1).replaceAllColors(C),this.attackFrame=this.attackFrame+1|0,this.attackFrame<this.attackInterval){BNTest.Entity.prototype.update.call(this);return}this.attackFrame=0;for(var i=0,LE=this.world.entities,ln=LE.getCount(),D=this.direction.clone(),far=BNTest.GLVec3.op_Addition(this.getPosition().clone(),new BNTest.GLVec3.ctor(D.x*1e5,0,D.y*1e5)),mln=this.getPosition().roughDistance(far),Y=this.getPosition().y;i<ln;)E=LE.getItem(i),E.getTargetPriority&&(this.user.sameTeam(E)||E.getPosition().roughDistance(far)<mln&&(dist=BNTest.GLVec3.op_Subtraction(this.getPosition(),E.getPosition()).getLength(),dist<=this.range&&(D.x=this.direction.x,D.y=this.direction.y,D.multiply(dist),D.x+=this.getPosition().x,D.y+=this.getPosition().z,Math.abs(E.getPosition().x-D.x)+Math.abs(E.getPosition().z-D.y)<=this.width&&(Math.abs(E.getPosition().y-Y)<=this.width||Math.abs(E.lastBB.max.y-Y)<=this.width||Math.abs(E.lastBB.min.y-Y)<=this.width)&&this.game.attack(E,this)))),i=i+1|0;spd=this.speed;this.speed=new BNTest.GLVec3.ctor;BNTest.Entity.prototype.update.call(this);this.speed=spd},ontouchDamage:function(){return!0}});Bridge.define("BNTest.LifeSpan",{inherits:[BNTest.EntityBehavior],HP:0,flickerTime:0,frame:0,fadeTime:15,ctor:function(entity,HP,flickerTime){flickerTime===void 0&&(flickerTime=0);this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.HP=HP;this.flickerTime=flickerTime},update:function(){this.HP=this.HP-1|0;this.HP<=0?this.entity.alive=!1:this.flickerTime>0&&this.HP<this.flickerTime&&(this.frame=this.frame+1|0,(this.frame&1)>0&&this.entity.model.setVisible(!this.entity.model.getVisible()));this.HP<this.fadeTime&&(this.entity.model.alpha=this.HP/this.fadeTime);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.LightMuffler",{inherits:[BNTest.EntityBehavior],maximumDist:0,maximumDarkness:0,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.maximumDist=800;this.maximumDarkness=.93},update:function(){var PC,L,level;if(!this.entity.model.getVisible()){BNTest.EntityBehavior.prototype.update.call(this);return}PC=this.entity.game.localplayer.character;L=BNTest.GLVec3.op_Subtraction(PC.getPosition(),this.entity.getPosition()).getLength();L<this.maximumDist&&(level=(this.maximumDist-L)/this.maximumDist,level*=this.maximumDarkness,this.entity.game.lightLevel=Math.min(this.entity.game.lightLevel,1-level));BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.NavigatorAI",{inherits:[BNTest.EntityBehavior],canJump:!0,setsAngle:!0,_lastProgress:System.Int64.toNumber(System.Int64([1874919423,2328306])),_timeSinceLastProgress:0,persistence:45,_movementPriority:0,_moveTo:null,frame:0,TB:null,v:null,relative:null,config:{init:function(){this.TB=new BNTest.BoundingBox.ctor;this.v=new BNTest.GLVec3.ctor;this.relative=new BNTest.GLVec3.ctor}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getMoveTo:function(){return this._moveTo},setMoveTo:function(value){Bridge.referenceEquals(this._moveTo,value)||(this._lastProgress=System.Int64([1874919423,2328306]),this._timeSinceLastProgress=0,this._moveTo=value)},requestMoveTo:function(position,priority,onlyIfHigher){var ok,D;return priority===void 0&&(priority=.5),onlyIfHigher===void 0&&(onlyIfHigher=!1),ok=priority>this._movementPriority,onlyIfHigher||ok||priority!==this._movementPriority||(ok=!0),ok&&(Bridge.referenceEquals(position,this._moveTo)||(this.setMoveTo(position),Bridge.referenceEquals(this.getMoveTo(),position)&&(this._movementPriority=priority,this.entity.getHandledLocally()&&(D={},D.T="MT",D.X=this._moveTo.x,D.Y=this._moveTo.y,D.P=this._movementPriority,this.sendCustomEvent(D,!0),this.entity.getHandledLocally()&&this.entity.refreshBehaviorTick(BNTest.NetworkSync))))),!1},customEvent:function(evt){Bridge.referenceEquals(evt.T,"MT")&&this.requestMoveTo(new BNTest.GLVec3.ctor(evt.X,evt.Y,evt.Z),evt.P);Bridge.referenceEquals(evt.T,"R")&&this.reset()},resetController:function(){var controller=this.entity.controller;controller[0]=!1;controller[1]=!1;controller[2]=!1;controller[3]=!1},reset:function(){this.resetController();this._moveTo=null;this._movementPriority=-1},update:function(){var controller,lcontroller,D,currentProgress,D1,Platformer,D2;if(this._moveTo!=null){if(controller=this.entity.controller,lcontroller=this.entity.lController,this.relative.copyFrom(this._moveTo),this.relative.subtract(this.entity.getPosition()),this.v.copyFrom(this.relative),this.v.multiply$1(.5,.5,.5),this.v.add(this.entity.getPosition()),this.frame=this.frame+1|0,this.TB.min.copyFrom(this.v),this.TB.max.copyFrom(this.v),this.TB.max.add$1(0,100,0),(this.frame&3)==0&&this.entity.world.findSolidCollision(this.TB).length<1){this.entity.getHandledLocally()&&(D={},D.T="R",this.sendCustomEvent(D,!0));this.reset();return}if(this.resetController(),Math.abs(this.relative.z)>1?this.relative.z>0?controller[3]=!0:controller[2]=!0:controller[3]=(controller[2]=!1,!1),Math.abs(this.relative.x)>1?(controller[0]=this.relative.x<0,controller[1]=this.relative.x>0):controller[0]=(controller[0]=!1,!1),currentProgress=this.relative.getRoughLength(),this._lastProgress>currentProgress)this._lastProgress=currentProgress,this._timeSinceLastProgress=0;else if(this._timeSinceLastProgress+=Math.max(1,this.framesPerTick),this._timeSinceLastProgress>this.persistence||currentProgress<4){this.entity.getHandledLocally()&&(D1={},D1.T="R",this.sendCustomEvent(D1,!0));this.reset();return}Bridge.is(this.entity,BNTest.PlatformerEntity)&&(Platformer=this.entity,this.canJump&&(controller[4]=Platformer.cantstep&&Platformer.getPosition().y>-250?!0:!1),this.setsAngle&&(Platformer.model.rotation.y=BNTest.MathHelper.radiansToDegrees(this.relative.xZAngle())-90));(controller[0]&&lcontroller[1]||controller[1]&&lcontroller[0])&&(currentProgress<150?(this.reset(),this.entity.getHandledLocally()&&(D2={},D2.T="R",this.sendCustomEvent(D2,!0))):Math.abs(this.relative.x)<150&&(controller[0]=!1,controller[1]=!1))}BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.NetworkSync",{inherits:[BNTest.EntityBehavior],timer:0,automaticSyncInterval:0,fields:null,lFields:null,needsSync:!1,forcesFlush:!1,updating:!1,updateOnSync:!1,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.fields=new(System.Collections.Generic.List$1(String));this.setBehaviorName("NS")},addField:function(fieldName){return this.fields.contains(fieldName)?!1:(this.fields.add(fieldName),!0)},addFields:function(fieldNames){for(var fieldName,$t=Bridge.getEnumerator(fieldNames);$t.moveNext();)fieldName=$t.getCurrent(),this.addField(fieldName)},_sync:function(){var $t,field,val,i;if(this.entity.getHandledLocally()){var O=this.entity,D={},L=new(System.Collections.Generic.List$1(Object)),ok=!1;for($t=Bridge.getEnumerator(this.fields);$t.moveNext();)field=$t.getCurrent(),val=this.getField(field),D[field]=val,L.add(val),(this.lFields==null||this.lFields.getCount()<L.getCount()||!Bridge.referenceEquals(this.lFields.getItem(L.getCount()-1|0),L.getItem(L.getCount()-1|0)))&&(ok=!0);i=0;ok&&(this.sendCustomEvent(D),this.lFields=L,this.forcesFlush&&(this.entity.game.netPlayNeedsFlush=!0))}},getField:function(fieldName){var O=this.entity;return O[fieldName]?O[fieldName]:O[System.String.concat("get",fieldName)]?O[System.String.concat("get",fieldName)]():(console.log(System.String.concat(System.String.concat(System.String.concat(System.String.concat('NetworkSync: Field "',fieldName),'" was not in '),Bridge.Reflection.getTypeFullName(Bridge.getType(this.entity))),".")),null)},setField:function(fieldName,data){var O=this.entity;if(O[fieldName]){O[fieldName]=data;return}if(O[System.String.concat("set",fieldName)]){O[System.String.concat("set",fieldName)](data);return}console.log(System.String.concat(System.String.concat(System.String.concat(System.String.concat('NetworkSync: Field "',fieldName),'" was not in '),Bridge.Reflection.getTypeFullName(Bridge.getType(this.entity))),"."))},sync:function(){this.needsSync=!0},customEvent:function(evt){var O,field;if(!this.entity.getHandledLocally()){O=this.entity;for(field in evt)this.setField(field,evt[field]);this.updateOnSync&&this.entity.update()}},update:function(){this.updating||(this.updating=!0,this.automaticSyncInterval>0&&(this.timer=this.timer+1|0,this.timer>this.automaticSyncInterval&&(this.needsSync=!0,this.timer=0)),this.needsSync&&(this._sync(),this.needsSync=!1),this.updating=!1)}});Bridge.define("BNTest.Orb",{inherits:[BNTest.Entity],ready:!1,started:!1,entity:null,ctor:function(world,entity){var smooth,mdl,tmdl;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.entity=entity;smooth=this.game.smooth;this.solid=!1;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(20);this.customBoundingBox.min.y=-2;this.lastBB=this.customBoundingBox.clone();mdl="orb";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.ready=!0):BNTest.AnimationLoader.get_this().asyncGet$1(["object/orb"],Bridge.fn.bind(this,function(){var alpha,pal,box,md,M;if(tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.'));this.model.copyFrom(tmdl,!0);this.ready=!0;return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.model.setVisible(!1);world.add$1(this.model);alpha=.36;pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,1,1,.36));box=this.game.getVoxelCombo(["object/orb"]);box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);md.scale=BNTest.GLVec3.createUniform(.6);M.addVoxelMap(box,smooth);md.meshes.add(M.clone());this.model.children.add(md);box=this.game.getVoxelCombo(["object/orb"]);pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,1,1,alpha*.4));box.applyPalette(pal);md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);M.addVoxelMap(box,smooth);md.scale=BNTest.GLVec3.createUniform(1);md.meshes.add(M);this.model.children.add(md);this.model.scale=BNTest.GLVec3.createUniform(1.5);this.model.smoothen();this.ready=!0;tmdl==null&&BNTest.ModelCache.get_this().set$1(mdl,this.model)}))},update:function(){var f,off,P;if(this.lastBB==null&&(this.lastBB=new BNTest.BoundingBox.ctor),this.ready&&!this.started&&this.entity!=null&&(this.started=!0,this.setPosition(this.entity.getPosition().clone())),this.model.drawOrder=1,f=BNTest.MathHelper.clamp(this.model.scale.x*(1+(-.1+.2*Math.random())),1.1,1.9),this.model.scale=BNTest.GLVec3.createUniform(f),this.model.rotation.y=this.entity.model.rotation.y,this.entity!=null){this.model.setVisible(this.entity.model.getVisible());off=new BNTest.Vector2(10,0).rotate(BNTest.MathHelper.degreesToRadians(this.entity.model.rotation.y)-.6);P=BNTest.GLVec3.op_Addition$1(this.entity.getPosition().clone(),off);P.y-=5;var rel=BNTest.GLVec3.op_Subtraction(P,this.getPosition()),spd=1.5,rl=rel.getLength();spd+=rl*.03;this.model.offset=rl<=spd?P.clone():BNTest.GLVec3.op_Addition(this.model.offset,rel.normalize(spd));this.alive=this.entity.alive;this.alive&&(this.world.entities.contains(this.entity)||(this.alive=!1));this.model.setVisible(this.entity.model.getVisible())}else this.alive=!1;BNTest.Entity.prototype.update.call(this)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.PlatformerControls",{inherits:[BNTest.EntityBehavior],_platformer:null,accel:.38,jumpSpeed:3,maxSpeed:2.1,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this._platformer=entity},update:function(){var controller=this._platformer.controller,acc=this.accel,Floor=this._platformer.floor,fric=this._platformer.friction,f;Floor!=null&&(f=Floor.groundFriction,acc*=f);controller[0]&&this._platformer.getHspeed()>-this.maxSpeed&&this._platformer.setHspeed(Math.max(this._platformer.getHspeed()-acc,-this.maxSpeed));controller[1]&&this._platformer.getHspeed()<this.maxSpeed&&this._platformer.setHspeed(Math.min(this._platformer.getHspeed()+acc,this.maxSpeed));controller[2]&&this._platformer.getZspeed()>-this.maxSpeed&&this._platformer.setZspeed(Math.max(this._platformer.getZspeed()-acc,-this.maxSpeed));controller[3]&&this._platformer.getZspeed()<this.maxSpeed&&this._platformer.setZspeed(Math.min(this._platformer.getZspeed()+acc,this.maxSpeed));this._platformer.getVspeed()>=0&&this._platformer.onGround?controller[4]&&this._platformer.ceiling==null&&(this._platformer.setVspeed(-this.jumpSpeed),this._platformer.playSound("jump")):this._platformer.getVspeed()<0&&!this._platformer.onGround&&(controller[4]||this._platformer.setVspeed(this._platformer.getVspeed()*.95));BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.Projectile",{inherits:[BNTest.Entity,BNTest.IHarmfulEntity],_Attacker:null,_IsHarmful:!0,_touchDamage:1,constantDamage:!1,clearTime:0,maxClearTime:15,ignoresTerrain:!1,currentAnchorRotation:0,anchorDistance:0,anchorRotationSpeed:0,knockbackPower:1,gravity:null,bounces:!1,ifriction:1,rotationSpeed:null,multiHit:!1,bounceForce:.9,lastDamaged:null,damaged:null,config:{alias:["getAttacker","BNTest$IHarmfulEntity$getAttacker","getIsHarmful","BNTest$IHarmfulEntity$getIsHarmful","gettouchDamage","BNTest$IHarmfulEntity$gettouchDamage","settouchDamage","BNTest$IHarmfulEntity$settouchDamage","ontouchDamage","BNTest$IHarmfulEntity$ontouchDamage"],init:function(){this.lastDamaged=new(System.Collections.Generic.List$1(BNTest.ICombatant));this.damaged=new(System.Collections.Generic.List$1(BNTest.ICombatant))}},ctor:function(world,shooter){this.$initialize();BNTest.Entity.ctor.call(this,world);this._Attacker=shooter},getAttacker:function(){return this._Attacker},getIsHarmful:function(){return this._IsHarmful},gettouchDamage:function(){return this._touchDamage},settouchDamage:function(value){this._touchDamage=value},clone:function(){var P=new BNTest.Projectile(this.world,this.getAttacker()),T;return P.model=this.model.clone(),P.setPosition(this.getPosition().clone()),P.speed=this.speed.clone(),P.knockbackPower=this.knockbackPower,P.ifriction=this.ifriction,P.rotationSpeed=this.rotationSpeed,P.model.rotation=this.model.rotation,P.multiHit=this.multiHit,P.obstruction=this.obstruction,P.bounces=this.bounces,P.gravity=this.gravity,P.solid=this.solid,P.settouchDamage(this.gettouchDamage()),P.currentAnchorRotation=this.currentAnchorRotation,P.anchorRotationSpeed=this.anchorRotationSpeed,P.anchorDistance=this.anchorDistance,P.ignoresTerrain=this.ignoresTerrain,P.customBoundingBox=this.customBoundingBox,T=this.getBehavior(BNTest.LifeSpan),T!=null&&P.addBehavior(new BNTest.LifeSpan(P,T.HP,T.flickerTime)),P},update:function(){var V,LBS,R,HS,C,Solids,SY,Solids1,Y,D,LD,SPD;if(this.lastBB==null&&(this.lastBB=this.getBoundingBox()),this.lastBB==null){BNTest.Entity.prototype.update.call(this);return}this.anchorRotationSpeed!==0&&(this.currentAnchorRotation+=this.anchorRotationSpeed,V=new BNTest.Vector2(this.anchorDistance).rotate(this.currentAnchorRotation),this.getPosition().x=this.getAttacker().getPosition().x+V.x,this.getPosition().y=this.getAttacker().getPosition().y,this.getPosition().z=this.getAttacker().getPosition().z+V.y,V=V.normalize(this.speed.getLength()),this.speed.x=V.x,this.speed.z=V.y);LBS=this.lastBB.getSize();this.lastBB!=null&&LBS.getRoughLength()>0&&(this.gravity!=null&&(this.speed=BNTest.GLVec3.op_Addition(this.speed,this.gravity)),this.ifriction<1&&(this.speed.x*=this.ifriction,this.speed.y*=this.ifriction),this.rotationSpeed!=null&&(R=this.model.rotation,R.x+=this.rotationSpeed.x,R.y+=this.rotationSpeed.y,R.z+=this.rotationSpeed.z),HS=BNTest.GLVec3.op_Multiply$1(this.speed,.5),C=this.lastBB.getCenter(),this.ignoresTerrain||(this.bounces?(SY=LBS.y,Solids1=System.Linq.Enumerable.from(this.game.world.findSolidCollision(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(this.speed.x,0,this.speed.z)),this)).where(function(E){return E.onKill==null&&E.lastBB.getSize().y>SY}).toList(BNTest.Entity),Solids1.getCount()>0&&(this.speed.x*=-this.bounceForce,this.speed.z*=-this.bounceForce),Y=this.gety(),D=Bridge.compare(0,this.speed.y),Solids1=System.Linq.Enumerable.from(this.game.world.findSolidCollision(BNTest.BoundingBox.op_Addition(this.lastBB,new BNTest.GLVec3.ctor(0,this.speed.y,0)),this)).where(Bridge.fn.bind(this,function(E){return E.onKill==null&&Bridge.compare(this.gety(),E.gety())===D})).toList(BNTest.Entity),Solids1.getCount()>0&&(this.model.offset.y-=this.speed.y,this.speed.y*=-this.bounceForce)):(Solids=System.Linq.Enumerable.from(this.game.world.findObstructionCollision$1(BNTest.GLVec3.op_Addition(C,BNTest.GLVec3.op_Addition(this.speed,HS)),this)).where($_.BNTest.Projectile.f1).toList(BNTest.Entity),Solids.addRange(System.Linq.Enumerable.from(this.game.world.findObstructionCollision$1(C,this)).where($_.BNTest.Projectile.f1)),Solids.getCount()>0&&(this.alive=!1))));LD=this.lastDamaged;this.lastDamaged=this.damaged;this.damaged=LD;this.damaged.clear();this.lastDamaged.getCount()<=0?this.clearTime=0:(this.clearTime=this.clearTime+1|0,this.clearTime>=this.maxClearTime&&(this.lastDamaged.clear(),this.clearTime=0));this.anchorRotationSpeed!==0?(SPD=this.speed,this.speed=new BNTest.GLVec3.ctor,BNTest.Entity.prototype.update.call(this),this.speed=SPD):BNTest.Entity.prototype.update.call(this)},ontouchDamage:function(target){if(this.constantDamage)return!0;var ret=!this.damaged.contains(target);return ret&&this.damaged.add(target),!this.lastDamaged.contains(target)}});Bridge.ns("BNTest.Projectile",$_);Bridge.apply($_.BNTest.Projectile,{f1:function(E){return E.onKill==null}});Bridge.define("BNTest.ProximityAttacker",{inherits:[BNTest.EntityBehavior],target:null,sightRange:400,aggroRange:400,predict:!0,passive:!1,aggroFrames:2,ignore:null,retaliates:!0,config:{init:function(){this.ignore=new(System.Collections.Generic.List$1(BNTest.Entity))}},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},onAttacked:function(source){var E=source.BNTest$IHarmfulEntity$getAttacker();this.retaliates&&!Bridge.referenceEquals(E,this.entity)&&(this.target=E)},update:function(){var controller=this.entity.controller,N=this.entity.getBehavior(BNTest.NavigatorAI),T2=this.entity.getBehavior(BNTest.IWeaponBehavior),P=this.entity.getPosition(),E,EP,ok,PC,Pos,rel;if(this.target!=null&&P.roughDistance(this.target.model.offset)>this.sightRange&&(this.target=null),this.target==null&&!this.passive&&(this.aggroFrames<=1||this.entity.game.frame%this.aggroFrames==0))for(var L=this.entity.world.entities,ln=L.getCount(),i=0;i<ln;)E=L.getItem(i),E.char&&(EP=E,this.entity.sameTeam(EP)||this.ignore.contains(E)||P.roughDistance(EP.model.offset)<=this.aggroRange&&(this.target=EP,i=ln)),i=i+1|0;ok=!0;this.entity.char!=null&&(PC=this.entity,ok=!PC.manaburnout||T2._ammo>0,ok||(ok=PC.ammo+PC.ammoRechargeRate*60>PC.maxAmmo));this.target!=null&&ok?(controller[5]=!0,Pos=this.target.getPosition().clone(),this.predict&&(Pos=BNTest.GLVec3.op_Addition(Pos,BNTest.GLVec3.op_Multiply$1(this.target.speed,30))),rel=BNTest.MathHelper.radiansToDegrees(BNTest.GLVec3.op_Subtraction(this.entity.getPosition(),Pos).toVector2().toAngle()),this.entity.model.rotation.y=rel+90,N.setsAngle=!1):(controller[5]=!1,N.setsAngle=!0);BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.RapidFireGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:7,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:20,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(50);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RapidSniper",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:5,_shotDelay:0,_maxShotDelay:3,_angle:0,bulletSpeed:13,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:25,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.knockbackPower=.5;P.settouchDamage(40);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RapidWideGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:7,_shotDelay:0,_maxShotDelay:3,_angle:0,bulletSpeed:14,bulletLifeSpan:10,bulletGraphic:null,minCoolDown:3,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.6,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P=new BNTest.Projectile(this.entity.world,this.entity),M,HSZ;P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(60);P.knockbackPower=.4;P.model.scale=BNTest.GLVec3.createUniform(2);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=BNTest.GLVec3.createUniform(9);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RingShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:2,bulletLifeSpan:130,bulletGraphic:null,minCoolDown:100,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M;this.entity.playSound("pew");for(var spd=new BNTest.Vector2(evt.SX,evt.SY),HSZ=new BNTest.GLVec3.ctor(7,7,7),i=0;i<6.28;)P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(60),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd.rotate(i)),M.rotation.y=evt.A+BNTest.MathHelper.radiansToDegrees(i),M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X),P.sety(evt.Y+2),P.setz(evt.Z),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),i+=.20933333333333334},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.RisingPlatform",{inherits:[BNTest.Entity],maxY:0,minY:0,active:!0,ctor:function(world,size){var scale,BB,grass,M;this.$initialize();BNTest.Entity.ctor.call(this,world);scale=5;this.model=new BNTest.Model(world.game);var sz=size.getSize(),V=new BNTest.VoxelMap.$ctor1(BNTest.GLVec3.op_Division$1(sz,scale)),dirt=new BNTest.GLColor(.5,.35,.06);V.setColor(dirt,!1);BB=V.getSizeAsBoundingBox();BB.max.y=3;grass=$_.BNTest.RisingPlatform.f1;V.fill$1(BB,grass);V.entropy(.04,.1);this.maxY=-sz.y/2;this.solid=!0;M=new BNTest.Mesh(world.game);M.addVoxelMap(V,!0);this.model.meshes.add(M);this.model.scale=BNTest.GLVec3.createUniform(scale);this.customBoundingBox=size.clone();this.getPosition().y=-this.maxY;this.minY=size.min.y+12},onNextWave:function(){this.active=!1},update:function(){var spd=.5;this.active&&this.getPosition().y>this.minY?this.getPosition().y-=spd:this.active||(this.getPosition().y<-this.maxY?this.getPosition().y+=spd:this.alive=!1);BNTest.Entity.prototype.update.call(this)}});Bridge.ns("BNTest.RisingPlatform",$_);Bridge.apply($_.BNTest.RisingPlatform,{f1:function(C){C.copy(BNTest.GLColor.randomB(0,.6,.1,.3,.9,.4))}});Bridge.define("BNTest.Rock",{inherits:[BNTest.Entity],size:18,ctor:function(world){var smooth,VM;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.solid=!0;var Char="rock",tmdl=BNTest.ModelCache.get_this().get(Char,!1),M=null,size=30;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),M=tmdl.meshes.getItem(0).clone(),this.model.meshes.add(M)):(VM=BNTest.VoxelMap.generateRock(size,BNTest.GLColor.createShade(.75),.9),VM.addNoise(.07),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,smooth),this.model.meshes.add(M),BNTest.ModelCache.get_this().set$1(Char,this.model));this.model.rotation.y=Math.random()*360;this.model.scale=BNTest.GLVec3.createUniform(.7+Math.random()*.65);this.customBoundingBox=new BNTest.BoundingBox.$ctor2(size);this.customBoundingBox=BNTest.BoundingBox.op_Multiply(this.customBoundingBox,this.model.scale);this.customBoundingBox=BNTest.BoundingBox.op_Subtraction(this.customBoundingBox,BNTest.GLVec3.op_Multiply$1(this.customBoundingBox.getSize(),.5))},update:function(){BNTest.Entity.prototype.update.call(this);this.getPosition().y=(-(Bridge.Int.div(this.size,2)|0)|0)+10|0},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.RockDrop",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:1,bulletLifeSpan:160,bulletGraphic:null,minCoolDown:100,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=0,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,120),P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x+V1.x;D.Y=P.y-150;D.Z=P.z+V1.y;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var spd,P,M,sz,HSZ,shadow;this.entity.playSound("pew");spd=new BNTest.Vector2(evt.SX,evt.SZ);P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.setScale(BNTest.GLVec3.createUniform(2.25));P.settouchDamage(200);P.obstruction=!0;P.gravity=new BNTest.GLVec3.ctor(0,.1,0);P.bounceForce*=.5;P.ifriction=.98;P.bounces=!0;P.multiHit=!0;M.rotation.y=evt.A;sz=11*P.getScale().x;HSZ=BNTest.GLVec3.createUniform(sz);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));P.model.rotation.x=90;this.entity.world.add(P);shadow=new BNTest.Shadow(this.entity.world,P);this.entity.world.add(shadow)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.SecondaryResponder",{inherits:[BNTest.EntityBehavior],attemptTime:0,time:0,weapon:6,ctor:function(entity,attemptTime){attemptTime===void 0&&(attemptTime=30);this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity);this.attemptTime=attemptTime},onAttacked:function(){var E=this.entity;E.controller[this.weapon]=!0;this.time=this.attemptTime},update:function(){if(this.time>0)this.time=this.time-1|0;else{var E=this.entity;E.controller[this.weapon]=!1}BNTest.EntityBehavior.prototype.update.call(this)}});Bridge.define("BNTest.Shadow",{inherits:[BNTest.Entity],ready:!1,started:!1,entity:null,frame:0,yoff:0,ctor:function(world,entity){var smooth,mdl,tmdl;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);this.entity=entity;smooth=this.game.smooth;this.solid=!1;this.customBoundingBox=new BNTest.BoundingBox.$ctor2(20);this.customBoundingBox.min.y=-2;this.customBoundingBox.max.y=999999999;this.lastBB=this.customBoundingBox.clone();this.model.setVisible(!1);mdl="shadow";tmdl=BNTest.ModelCache.get_this().get(mdl,!1);this.yoff=.15+Math.random()*.4;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.')),this.model.copyFrom(tmdl,!0),this.ready=!0):BNTest.AnimationLoader.get_this().asyncGet$1(["object/softshadow"],Bridge.fn.bind(this,function(){var pal,box,md,M;if(tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',mdl),'" model from cache.'));this.model.copyFrom(tmdl,!0);this.ready=!0;return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));this.model.setVisible(!1);world.add$1(this.model);pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,1,1,.36));box=this.game.getVoxelCombo(["object/softshadow"]);box.swapYZ();md=new BNTest.Model(this.game);M=new BNTest.Mesh(this.game);md.scale.y=.01;M.addVoxelMap(box,smooth,!0,!0);md.meshes.add(M);this.model.children.add(md);md.alpha=.5;this.ready=!0;tmdl==null&&BNTest.ModelCache.get_this().set$1(mdl,this.model)}))},update:function(){var $t,O,EO,LE,dist,minscale;if(this.lastBB==null&&(this.lastBB=new BNTest.BoundingBox.ctor),this.ready&&!this.started&&this.entity!=null&&(this.started=!0,this.setPosition(this.entity.getPosition().clone()),this.model.scale=this.model.scale.clone()),this.model.drawOrder=2,this.frame=this.frame+1|0,(this.frame&3)>0){this.model.offset.x=this.entity.model.offset.x;this.model.offset.z=this.entity.model.offset.z;return}if(this.lastBB.copyFrom(this.customBoundingBox),(this.frame&7)==0,this.model.setVisible(!1),this.started&&this.entity!=null){if(!this.entity.model.getVisible())return;O=this.model.offset;EO=this.entity.model.offset;O.x=EO.x;O.y=EO.y;O.z=EO.z;this.lastBB.add(O);LE=System.Linq.Enumerable.from(this.world.findPlatformCollision(this.lastBB)).where(function(E){return E.lastBB!=null&&E.lastBB.min.y>O.y}).toList(BNTest.Entity);LE.sort($_.BNTest.Shadow.f1);LE.getCount()>0&&(dist=Math.abs(this.entity.gety()-LE.getItem(0).lastBB.min.y),O.y=LE.getItem(0).lastBB.min.y-this.yoff,minscale=.3,this.model.scale.x=($t=minscale+dist*.003,this.model.scale.z=$t,$t),this.model.alpha=1-(this.model.scale.x-(minscale+.05))*2.5,this.model.alpha*=this.entity.model.alpha,this.model.alpha>0&&this.model.setVisible(!0))}this.entity!=null&&this.entity.alive||(this.alive=!1)},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.ns("BNTest.Shadow",$_);Bridge.apply($_.BNTest.Shadow,{f1:function(E1,E2){return Bridge.compare(E1.lastBB.min.y,E2.lastBB.min.y)}});Bridge.define("BNTest.ShopScreen",{inherits:[BNTest.Sprite],characters:null,menu:null,charCount:0,purchase:null,moneyDisplay:null,messageDisplay:null,exit:null,current:0,ctor:function(Characters){this.$initialize();BNTest.Sprite.ctor.call(this);this.characters=Characters;var self=this;this.spriteBuffer.width=1024;this.spriteBuffer.height=Bridge.Int.clip32(this.spriteBuffer.width*BNTest.App.targetAspect);this.purchase=new BNTest.ButtonSprite.$ctor1("Purchase",40);this.purchase.position=new BNTest.Vector2(800);this.purchase.onClick=function(){self.doPurchase()};this.purchase.clickSound="";this.moneyDisplay=new BNTest.TextSprite;this.moneyDisplay.setFontSize(40);this.moneyDisplay.setTextColor("#FFFFFF");this.messageDisplay=new BNTest.TextSprite;this.messageDisplay.setFontSize(40);this.messageDisplay.setTextColor("#FFFFFF");this.messageDisplay.position=new BNTest.Vector2(150,250);this.messageDisplay.setText("             No characters available.\n(Clear some new waves and check back.)");this.messageDisplay.visible=!1;this.exit=new BNTest.ButtonSprite.$ctor1("Done",50);this.exit.position=new BNTest.Vector2(820,600);this.exit.onClick=function(){self.visible=!1};this.initMenu()},doPurchase:function(){var F=this.menu.getSelectedData(),mon=System.Int32.parse(BNTest.App.storage.Mon);mon>=F.cost&&F.purchase()?(BNTest.AudioManager.get_this().blast("SFX/ok2B.ogg"),this.initMenu(),BNTest.GLDemo._this.CS.initMenu()):BNTest.AudioManager.get_this().blast("SFX/hit.ogg");this.moneyDisplay.setText(System.String.concat("Gems:",BNTest.App.storage.Mon))},initMenu:function(){var def,L,missing,available,i,A,B,rows;for(this.charCount=0,this.menu=new BNTest.ButtonMenu(1e3,450,46,!0),this.menu.position=new BNTest.Vector2(0,300),this.menu.onChoose=Bridge.fn.bind(this,$_.BNTest.ShopScreen.f1),def=null,L=this.characters.getItems(),L=System.Linq.Enumerable.from(L).where($_.BNTest.ShopScreen.f2).toList(BNTest.FeatureItem),missing=L.getCount(),L=System.Linq.Enumerable.from(L).where($_.BNTest.ShopScreen.f3).toList(BNTest.FeatureItem),available=L.getCount(),i=0;i<L.getCount();)A=L.getItem(i),B=this.menu.addButton(System.String.concat(System.String.concat(A.name,"\nCost:"),A.cost)),B.data=A,def==null&&(def=B),this.charCount=this.charCount+1|0,i=i+1|0;this.messageDisplay.visible=this.charCount<=0&&missing>0?!0:!1;rows=Bridge.Int.clip32(Math.ceil(this.menu.getAllButtons().getCount()/4));rows<1&&(rows=1);this.menu.finish(rows);this.menu.select(def);this.charCount===0?this.purchase.lock():this.purchase.unlock();this.moneyDisplay.setText(System.String.concat("Gems:",BNTest.App.storage.Mon));this.current<System.Int32.parse(BNTest.App.storage.Mon)&&(this.current=System.Int32.parse(BNTest.App.storage.Mon))},update:function(){this.menu.update();this.purchase.checkClick();this.exit.checkClick()},render:function(){var LC=this.current,target=System.Int32.parse(BNTest.App.storage.Mon),whyyy;this.current>target&&(whyyy=BNTest.MathHelper.incrementTowards(this.current,target,1+(this.current-target)/20),this.current=Bridge.Int.clip32(whyyy));LC!==this.current&&this.moneyDisplay.setText(System.String.concat("Gems:",this.current));this.spriteGraphics.clearRect(0,0,1024,1024);this.spriteGraphics.fillStyle="#000000";this.spriteGraphics.globalAlpha=.55;this.spriteGraphics.fillRect(0,0,1024,1024);this.spriteGraphics.globalAlpha=1;this.menu.draw(this.spriteGraphics);this.purchase.draw(this.spriteGraphics);this.moneyDisplay.draw(this.spriteGraphics);this.messageDisplay.draw(this.spriteGraphics);this.exit.draw(this.spriteGraphics)},draw:function(g){this.render();BNTest.Sprite.prototype.draw.call(this,g)}});Bridge.ns("BNTest.ShopScreen",$_);Bridge.apply($_.BNTest.ShopScreen,{f1:function(){var F=this.menu.getSelectedData(),mon=System.Int32.parse(BNTest.App.storage.Mon);mon>=F.cost?this.purchase.unlock():this.purchase.lock()},f2:function(J){return!J.getPurchased()},f3:function(J){return J.getBuyable()}});Bridge.define("BNTest.SpawnIllusions",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:240,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){for(var D={},S=System.Array.init(0,null),ms=70,ms2=ms+ms,O=this.entity.getPosition().clone(),V=O.clone(),i=4;i>0;)V.x=O.x+(-ms+ms2*Math.random()),V.z=O.z+(-ms+ms2*Math.random()),S.push(V.toVec3()),i=i-1|0;D.S=S;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var S,PC;this.entity.model.rotation.y=6.28*Math.random();S=evt.S;this.entity.setPosition(new BNTest.GLVec3.$ctor1(S[0]));this.entity.model.alpha=.1;for(var i=1,ln=S.length,EP=this.entity;i<ln;)PC=new BNTest.PlayerCharacter(this.entity.world,new BNTest.Player(!0,!0,EP.me.minion),this.entity.char,this.entity.team),PC.setPosition(new BNTest.GLVec3.$ctor1(S[i])),PC.model.rotation.y=6.28*Math.random(),PC.canShoot=!1,PC.defense=EP.defense*.75,PC.knockbackResistLevel=EP.knockbackResistLevel,PC.canRespawn=!1,PC.addBehavior(new BNTest.LifeSpan(PC,900)),PC.reward=!1,PC.model.alpha=0,this.entity.world.add(PC),i=i+1|0},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.SpreadShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:9,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:7,bulletLifeSpan:45,bulletGraphic:null,minCoolDown:40,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var i,ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally())))for(i=2;i>0;){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.6,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D);i=i-1|0}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(24);P.knockbackPower=.25;P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;HSZ=BNTest.GLVec3.createUniform(10);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.SwordSwing",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:3,_shotDelay:0,_maxShotDelay:3,_angle:0,bulletSpeed:24,bulletGraphic:null,active:!1,speed:null,forcedAngle:0,minCoolDown:45,attackDamage:120,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this._ammo>0){if(this.active&&(this.entity.speed=this.speed.clone()),this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally())){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.entity.forcedAngle=this._angle;this.entity.frictionActive=!1;this.active||this.customEvent(D)}}else this.active&&(this.entity.forcedAngle=null,this.entity.frictionActive=!0,this.entity.speed=new BNTest.GLVec3.ctor,this.active=!1);BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,size,HSZ,lifespan;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;P.multiHit=!0;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(this.attackDamage);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,new BNTest.Vector2(evt.SX,evt.SY));M.rotation.y=evt.A;size=30;HSZ=new BNTest.GLVec3.ctor(size,size,size);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.setScale(BNTest.GLVec3.createUniform(2));lifespan=this._maxShotDelay*this._maxAmmo|0;this.entity.invincibilityFrames=this.entity.invincibilityFrames+lifespan|0;P.addBehavior(new BNTest.LifeSpan(P,lifespan));this.entity.world.add(P);this.active=!0;this.speed=P.speed.clone();this.entity.speed=this.speed.clone();P.setPosition(BNTest.GLVec3.op_Addition(P.getPosition(),BNTest.GLVec3.op_Multiply$1(this.speed,.5)))},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.TextSprite",{inherits:[BNTest.Sprite],_Text:null,textInvallidated:!1,imageInvallidated:!1,textImage:null,textGraphic:null,_TextColor:null,_FontWeight:"normal",_FontFamily:"sans-serif",_FontSize:10,_shadowBlur:0,_shadowOffset:null,_shadowColor:"#000000",alpha:1,config:{init:function(){this._shadowOffset=new BNTest.Vector2}},ctor:function(){this.$initialize();BNTest.Sprite.ctor.call(this);this.textImage=document.createElement("canvas");this.textGraphic=this.textImage.getContext("2d");this.textGraphic.fillStyle="#FFFFFF"},getText:function(){return this._Text},setText:function(value){Bridge.referenceEquals(this._Text,value)||(this._Text=value,this.textInvallidated=!0)},getTextColor:function(){return this._TextColor},setTextColor:function(value){Bridge.referenceEquals(this._TextColor,value)||(this._TextColor=value,this.textInvallidated=!0)},getFontWeight:function(){return this._FontWeight},setFontWeight:function(value){Bridge.referenceEquals(this._FontWeight,value)||(this._FontWeight=value,this.updateFont())},getFontFamily:function(){return this._FontFamily},setFontFamily:function(value){Bridge.referenceEquals(this._FontFamily,value)||(this._FontFamily=value,this.updateFont())},getFontSize:function(){return this._FontSize},setFontSize:function(value){this._FontSize!==value&&(this._FontSize=value,this.updateFont())},getShadowBlur:function(){return this._shadowBlur},setShadowBlur:function(value){this._shadowBlur!==value&&(this._shadowBlur=value,this.imageInvallidated=!0)},getShadowOffset:function(){return this._shadowOffset.clone()},setShadowOffset:function(value){BNTest.Vector2.op_Inequality(this._shadowOffset,value)&&value.x!==this._shadowOffset.x&&value.y!==this._shadowOffset.y&&(this._shadowOffset=value.clone(),this.imageInvallidated=!0)},getShadowColor:function(){return this._shadowColor},setShadowColor:function(value){Bridge.referenceEquals(this._shadowColor,value)||(this._shadowColor=value,this.imageInvallidated=!0)},updateFont:function(){this.textGraphic.font=System.String.concat(System.String.concat(System.String.concat(System.String.concat(this._FontWeight," "),this._FontSize),"px "),this._FontFamily);this.textInvallidated=!0;this.imageInvallidated=!0;this.textGraphic.fillStyle=this._TextColor},redrawBaseTextImage:function(){var TM,Y;this.updateFont();for(var lines=this._Text.split(String.fromCharCode(10)),H=this.getFontSize()*1,W=0,i=0;i<lines.length;)TM=this.textGraphic.measureText(lines[i]),W=Math.max(W,Bridge.Int.clip32(Math.ceil(TM.width))),i=i+1|0;for(this.textImage.height=Bridge.Int.clip32(H*(lines.length+.25)),this.textImage.width=W,this.updateFont(),Y=0,i=0;i<lines.length;)this.textGraphic.fillText(lines[i],0,this.getFontSize()+Y),Y+=H,i=i+1|0;this.textInvallidated=!1;this.imageInvallidated=!0},renderTextImage:function(){if(this._shadowBlur<=0)this.spriteBuffer.width=this.textImage.width,this.spriteBuffer.height=this.textImage.height;else{var S=Bridge.Int.clip32(Math.ceil(this._shadowBlur+this._shadowBlur));this.spriteBuffer.width=this.textImage.width+S|0;this.spriteBuffer.height=this.textImage.height+S|0}this.spriteGraphics.shadowBlur=0;this.spriteGraphics.globalCompositeOperation="source-over";this._shadowBlur<=0?this.spriteGraphics.drawImage(this.textImage,0,0):this.spriteGraphics.drawImage(this.textImage,this._shadowBlur,this._shadowBlur);this._shadowBlur>0&&(this.spriteGraphics.shadowBlur=this._shadowBlur,this.spriteGraphics.shadowColor=this._shadowColor,this.spriteGraphics.shadowOffsetX=this._shadowOffset.x,this.spriteGraphics.shadowOffsetY=this._shadowOffset.y,this.spriteGraphics.drawImage(this.spriteBuffer,0,0));this.imageInvallidated=!1},draw:function(g){if(this.textInvallidated&&this.redrawBaseTextImage(),this.imageInvallidated&&this.renderTextImage(),this.alpha>=1)BNTest.Sprite.prototype.draw.call(this,g);else{var A=g.globalAlpha;g.globalAlpha=this.alpha;BNTest.Sprite.prototype.draw.call(this,g);g.globalAlpha=A}}});Bridge.define("BNTest.Tree",{inherits:[BNTest.Entity],size:110,ctor:function(world){var smooth,VM,M,width;this.$initialize();BNTest.Entity.ctor.call(this,world);this.game=world.game;this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.solid=!0;var brightness=.65,Char="tree",tmdl=BNTest.ModelCache.get_this().get(Char,!1);tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',Char),'" model from cache.')),this.model.copyFrom(tmdl)):(VM=BNTest.VoxelMap.generateTree(this.size,new BNTest.GLColor(brightness,brightness*.65,0),1),VM.addNoise(.03),VM.addStripes(.075,1,8),M=new BNTest.Mesh(this.game),M.addVoxelMap(VM,smooth),this.model.meshes.add(M),this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,3),tmdl==null&&BNTest.ModelCache.get_this().set$1(Char,this.model));this.model.rotation.y=360*Math.random();this.setScale(BNTest.GLVec3.op_Multiply$1(this.getScale(),.8+Math.random()*.4));width=.5+Math.random()*.9;this.getPosition().y=-(this.size*this.model.scale.y*.5)+10;this.cacheBoundingBox()},update:function(){BNTest.Entity.prototype.update.call(this);this.getPosition().y=-(this.size*this.model.scale.x*.5)+10},draw:function(gl){BNTest.Entity.prototype.draw.call(this,gl)}});Bridge.define("BNTest.WanderAI",{inherits:[BNTest.EntityBehavior],chance:1,range:60,ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},update:function(){var N;if(!(this.chance<1)||!(this.chance<Math.random())){if(N=this.entity.getBehavior(BNTest.NavigatorAI),N==null&&(N=new BNTest.NavigatorAI(this.entity),N.framesPerTick=Bridge.Int.div(this.framesPerTick,3)|0,this.entity.addBehavior(N)),N.getMoveTo()==null){var maxrange=this.range,mr2=maxrange+maxrange,V=BNTest.GLVec3.op_Addition(new BNTest.GLVec3.ctor(-maxrange+Math.random()*mr2,0,-maxrange+Math.random()*mr2),this.entity.getPosition());N.requestMoveTo(V,.4)}BNTest.EntityBehavior.prototype.update.call(this)}}});Bridge.define("BNTest.WideShot",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:12,bulletLifeSpan:35,bulletGraphic:null,minCoolDown:50,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 1},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var P,M,spd,HSZ;this.entity.playSound("pew");P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(35);spd=new BNTest.Vector2(evt.SX,evt.SY);P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd);M.rotation.y=evt.A;HSZ=new BNTest.GLVec3.ctor(7,7,7);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));this.entity.world.add(P);for(var sep=spd.normalize(15),up=sep.rotate(-2.35619),down=sep.rotate(2.35619),number=2,scale=1;number>0;)P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(35),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd),M.rotation.y=evt.A,M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X+up.x*scale),P.sety(evt.Y+2),P.setz(evt.Z+up.y*scale),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),P=new BNTest.Projectile(this.entity.world,this.entity),P.solid=!1,M=new BNTest.Model(this.entity.game),M.meshes.add(this.bulletGraphic),P.model=M,P.settouchDamage(35),P.speed=BNTest.GLVec3.op_Addition$1(new BNTest.GLVec3.ctor,spd),M.rotation.y=evt.A,M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ),P.customBoundingBox=M.customBoundingBox,P.setx(evt.X+down.x*scale),P.sety(evt.Y+2),P.setz(evt.Z+down.y*scale),P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan)),this.entity.world.add(P),number=number-1|0,scale=scale+1|0},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.YinYangOrbGun",{inherits:[BNTest.EntityBehavior,BNTest.IWeaponBehavior],_ammo:0,_maxAmmo:1,_shotDelay:0,_maxShotDelay:4,_angle:0,bulletSpeed:3.5,bulletLifeSpan:160,bulletGraphic:null,minCoolDown:100,config:{alias:["getEnergyCost","BNTest$IWeaponBehavior$getEnergyCost","getMaxCooldown","BNTest$IWeaponBehavior$getMaxCooldown","setFiringAngle","BNTest$IWeaponBehavior$setFiringAngle","getWeaponType","BNTest$IWeaponBehavior$getWeaponType","fire","BNTest$IWeaponBehavior$fire"]},ctor:function(entity){this.$initialize();BNTest.EntityBehavior.ctor.call(this,entity)},getEnergyCost:function(){return 3.5},getMaxCooldown:function(){return(this._maxAmmo*this._maxShotDelay|0)+this.minCoolDown},setFiringAngle:function(value){this._angle=value},getWeaponType:function(){return 2},update:function(){var ang,D,P;if(this._ammo>0&&(this._shotDelay=this._shotDelay-1|0,this._shotDelay<=0&&(this._shotDelay=this._maxShotDelay,this._ammo=this._ammo-1|0,this.entity.getHandledLocally()))){ang=BNTest.MathHelper.degreesToRadians(this._angle+90);D={};D.A=this._angle;var inaccuracy=.13,V=BNTest.Vector2.fromRadian(-inaccuracy+Math.random()*(inaccuracy+inaccuracy)+ang),V1=BNTest.Vector2.op_Multiply(V,this.bulletSpeed);D.SX=V1.x;D.SY=-.7;D.SZ=V1.y;P=BNTest.GLVec3.op_Addition$1(this.entity.getCenter(),V);D.X=P.x;D.Y=P.y-5;D.Z=P.z;this.customEvent(D)}BNTest.EntityBehavior.prototype.update.call(this)},customEvent:function(evt){var spd,P,M,sz,HSZ,sep,up;this.entity.playSound("pew");spd=new BNTest.Vector2(evt.SX,evt.SZ);P=new BNTest.Projectile(this.entity.world,this.entity);P.solid=!1;M=new BNTest.Model(this.entity.game);M.meshes.add(this.bulletGraphic);P.model=M;P.settouchDamage(80);P.speed=new BNTest.GLVec3.ctor(evt.SX,evt.SY,evt.SZ);P.obstruction=!0;P.gravity=new BNTest.GLVec3.ctor(0,.12,0);P.rotationSpeed=new BNTest.GLVec3.ctor(0,3.5,0);P.ifriction=.98;P.bounces=!0;P.multiHit=!0;P.knockbackPower=6;M.rotation.y=evt.A;M.rotation.x=60;sz=11*P.getScale().x;HSZ=BNTest.GLVec3.createUniform(sz);M.customBoundingBox=new BNTest.BoundingBox.$ctor1(BNTest.GLVec3.op_Multiply$1(HSZ,-1),HSZ);P.customBoundingBox=M.customBoundingBox;P.setx(evt.X);P.sety(evt.Y+2);P.setz(evt.Z);P.addBehavior(new BNTest.LifeSpan(P,this.bulletLifeSpan));sep=spd.normalize(22);up=sep.rotate(-1.57);P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),up));this.entity.world.add(P);P=P.clone();P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),BNTest.Vector2.op_Multiply(up,-1)));this.entity.world.add(P);P=P.clone();P.setPosition(BNTest.GLVec3.op_Addition$1(P.getPosition(),BNTest.Vector2.op_Multiply(up,-1)));this.entity.world.add(P)},fire:function(angle){this._angle=angle;this._ammo=this._maxAmmo}});Bridge.define("BNTest.PlatformerEntity",{inherits:[BNTest.ControllableEntity],onGround:!1,friction:.05,floor:null,ceiling:null,lastGround:null,cantstep:!1,frictionActive:!0,stepheight:10,FSC:null,config:{init:function(){this.FSC=System.Array.init(0,null)}},ctor:function(world){this.$initialize();BNTest.ControllableEntity.ctor.call(this,world)},applyFriction:function(){if(this.onGround){var rate=.8,min=.15;this.floor!=null&&(rate=1-this.floor.groundFriction*.2,min*=this.floor.groundFriction,this.lastGround=this.getPosition().clone());this.setHspeed(this.getHspeed()*rate);this.setZspeed(this.getZspeed()*rate);Math.abs(this.getHspeed())+Math.abs(this.getZspeed())<min&&this.setHspeed((this.setZspeed(0),0))}else this.setHspeed(this.getHspeed()*.98),this.setZspeed(this.getZspeed()*.98)},updateCollisions:function(){var clear=this.FSC.length>0,Y=this.lastBB.min.y,Y2=this.lastBB.max.y-this.stepheight,step2=this.stepheight+this.stepheight,sz=this.lastBB.getRoughLength()*.75+this.speed.getRoughLength()+10,TB,STY,L,B,P,spacing,speed,up,down,spacing1,speed1,up1,down1,PB,CL,stuck,BB,C;sz*=2;TB=new BNTest.BoundingBox.$ctor2(sz);TB.add(this.getPosition());STY=(this.lastBB.max.y-this.lastBB.min.y)/2+3;this.FSC.length===0&&this.game.world.findSolidCollision(TB,this,this.FSC);L=this.FSC;TB.copyFrom(this.lastBB);TB.add$1(0,STY/2,0);for(var ground=System.Array.init(0,null),i=0,ln=L.length;i<ln;){var E=L[i],EB=E.lastBB,TY=EB.min.y-STY;TY-Y2<=step2&&EB.intersection$2(TB)&&ground.push(E);i=i+1|0}ground.sort($_.BNTest.PlatformerEntity.f1);B=null;ground.length>0&&(B=ground[0].lastBB,this.floor=ground[0]);this.cantstep=!1;B==null?(this.onGround=!1,this.speed.y=Math.min(this.speed.y+.1,5),this.model.rotation.x=-16):this.speed.y>=0?(this.onGround=!0,this.model.rotation.x=0,Y=B.min.y-STY,Math.abs(this.gety()-Y)<=this.stepheight?(this.speed.y=Math.min(this.speed.y,0),P=BNTest.GLVec3.op_Multiply$1(ground[0].speed,ground[0].groundFriction),this.model.offset.x+=P.x,this.model.offset.y+=P.y,this.model.offset.z+=P.z,this.sety(Y)):(spacing=10,speed=.2,TB.copyFrom(this.lastBB),TB.add$1(0,-spacing|0,0),up=TB.intersection(L),TB.copyFrom(this.lastBB),TB.add$1(0,spacing,0),down=TB.intersection(L),up.length<=0&&down.length>0?(this.speed.y=Math.min(0,this.speed.y-speed),this.onGround=!1):up.length>0&&down.length<=0&&(this.speed.y=Math.max(0,this.speed.y+speed),this.onGround=!1),TB.copyFrom(this.lastBB),TB.add$1(this.speed.x,this.speed.y,0),B.intersection$2(TB)&&(this.speed.x=0),TB.copyFrom(this.lastBB),TB.add$1(0,this.speed.y,this.speed.z),B.intersection$2(TB)&&(this.speed.z=0))):(spacing1=10,speed1=.2,TB.copyFrom(this.lastBB),TB.add$1(0,-spacing1|0,0),up1=TB.intersection(L),TB.copyFrom(this.lastBB),TB.add$1(0,spacing1,0),down1=TB.intersection(L),up1.length<=0&&down1.length>0?(this.speed.y=Math.min(0,this.speed.y-speed1),this.onGround=!1):up1.length>0&&down1.length<=0&&(this.speed.y=Math.max(0,this.speed.y+speed1),this.onGround=!1));TB.copyFrom(this.lastBB);PB=BNTest.BoundingBox.op_Addition(TB,this.speed);CL=PB.intersection(L);L.length>0&&CL.length>0?(stuck=0,TB.max.y-=this.stepheight*.75,PB.copyFrom(TB),PB.add$1(this.speed.x,0,0),PB.intersection(L).length<=0?(this.model.offset.x+=this.speed.x,TB.add$1(this.speed.x,0,0)):(this.cantstep=!0,stuck=stuck+1|0),PB.copyFrom(TB),PB.add$1(0,0,this.speed.z),PB.intersection(L).length<=0?(this.model.offset.z+=this.speed.z,TB.add$1(0,0,this.speed.z)):(this.cantstep=!0,stuck=stuck+1|0),PB.copyFrom(TB),PB.add$1(0,this.speed.y,0),PB.intersection(L).length<=0||(stuck=stuck+1|0),this.model.offset.y+=this.speed.y,stuck>1&&(BB=CL[0].lastBB,C=BNTest.GLVec3.op_Subtraction(this.lastBB.getCenter(),BB.getCenter()),C.getRoughLength()<100&&(C=BNTest.GLVec3.op_Multiply$1(C,.001),BB.intersection$2(BNTest.BoundingBox.op_Addition(this.lastBB,C))&&(C.add(C),C.add(C)),this.getPosition().x+=C.x,this.getPosition().z+=C.z,C.y<0&&(this.getPosition().y+=C.y),this.lastBB.add(C)))):(this.model.offset.x+=this.speed.x,this.model.offset.y+=this.speed.y,this.model.offset.z+=this.speed.z);clear&&BNTest.HelperExtensions.clear$1(BNTest.Entity,this.FSC)},update:function(){this.updateBehaviors();this.frictionActive&&this.applyFriction();var ospd=this.speed;this.speed=new BNTest.GLVec3.ctor;BNTest.ControllableEntity.prototype.update.call(this);this.speed=ospd;this.updateCollisions()}});Bridge.ns("BNTest.PlatformerEntity",$_);Bridge.apply($_.BNTest.PlatformerEntity,{f1:function(TA,TTB){return Bridge.compare(TA.lastBB.min.y,TTB.lastBB.min.y)}});Bridge.define("BNTest.PlayerCharacter",{inherits:[BNTest.PlatformerEntity,BNTest.ICombatant],animation:"idle",me:null,char:"reimu",canShoot:!0,started:!1,zpos:0,maxAlpha:1,infiniteAmmo:!1,forcedAngle:null,canRespawn:!0,reward:!0,useSwingAnimation:!1,flickerColor:null,defaultColor:null,maxHPDrops:3,dropsChance:1,combo:0,lastKill:0,maxComboTime:120,_HP:100,_PointsForKilling:10,pmesh:null,invincibilityFrames:0,maxInvincibilityFrames:150,defense:1,maxRespawnTime:0,respawnTime:0,respawnPosition:null,HB:null,ammo:0,maxAmmo:90,ammoRechargeRate:.7,ammoRechargeCooldown:0,ammoMaxRechargeCooldown:45,manaburnout:!1,shootTime:0,maxShootTime:8,restTime:0,knockbackResistLevel:1,config:{properties:{Coins:0},alias:["getHP","BNTest$ICombatant$getHP","setHP","BNTest$ICombatant$setHP","getPointsForKilling","BNTest$ICombatant$getPointsForKilling","getTargetPriority","BNTest$ICombatant$getTargetPriority","onDamaged","BNTest$ICombatant$onDamaged","onDeath","BNTest$ICombatant$onDeath","onKill","BNTest$ICombatant$onKill"],init:function(){this.defaultColor=new BNTest.GLColor(1,1,1)}},ctor:function(world,me,character,team){var $t,smooth,weapons,tmdl,Ppal,secondaryWeaponGraphic,O,speedrate,minion,T,spd,T2,T1,TimeToRespawn,T3,TimeToRespawn1,TimeToRespawn2,T4,mod,T5,TimeToRespawn3,W,TimeToRespawn4,sr2,T21,T6,TB,T7,T8,effects;team===void 0&&(team=-1e3);this.$initialize();BNTest.PlatformerEntity.ctor.call(this,world);this.game=world.game;this.controller=System.Array.init(6,!1);this.model=new BNTest.Model(this.game);smooth=this.game.smooth;this.groundFriction=.7;this.me=me;var csz=8,hsz=csz/2,Sh=new BNTest.Shadow(world,this);world.add(Sh);this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz));this.setHitboxSize(hsz);this.char=character;var weaponGraphic="object/basicshot",scsmooth=!1,scsnoise=!1;this.team=team;this.team===-1e3&&(this.team=me.CPU?1:0);me.CPU?(!1&&Math.random()<.3&&(this.char="rumia"),this.maxInvincibilityFrames=0,this.canShoot=!1):this.infiniteAmmo=!0;weapons=new(System.Collections.Generic.Dictionary$2(String,String));weapons.set("reimu",(weapons.set("sanae","object/amulet"),"object/amulet"));weapons.set("sakuya","object/knife");weapons.set("cirno","object/ice");weapons.set("marisa","object/star");weapons.set("reisen","object/bullet");weapons.set("flandre","object/yinyangorb");weapons.set("koishi",(weapons.set("satori","object/heart"),"object/heart"));weapons.set("aya",($t=(weapons.set("tenshi","object/wind"),"object/wind"),weapons.set("youmu",$t),$t));weapons.containsKey(this.char)&&(weaponGraphic=weapons.get(this.char));tmdl=BNTest.ModelCache.get_this().get(this.char,!1);Ppal=!0;tmdl!=null?(console.log(System.String.concat(System.String.concat('loading "',this.char),'" model from cache.')),this.model.copyFrom(tmdl),me.CPU&&this.initCPU(),this.initModel()):BNTest.AnimationLoader.get_this().asyncGet$1(["head/base","head/rahmoo","head/rahmooacc","head/rahmoobow","head/hairclip","head/suikahorns","head/suikabow","head/ponytailbow","body/rahmoo","body/top","arm/base","arm/dSleeve","arm/bracelet","foot/base","foot/shoe","head/maidheadband","head/medium","body/apron","body/icewings","head/witchhat","arm/shortsleeve","head/hatbow","head/wideRim","head/mediumRim","head/cap","body/thirdeye","foot/anklet","foot/lanklet","foot/socks","head/tokin","body/shortskirt","body/tie","head/headband","head/sideribbon","object/katana","arm/sleeve","body/shortskirtfrill","body/sidependant","head/reisenears","body/bunnytail","body/rainbowmidfrill","head/peaches","head/mouseEars","body/Lsidependant","body/mouseTail","foot/shortsocks","body/capelet","arm/capelet","head/sideponytail","head/smallRim","body/flandrewings"],Bridge.fn.bind(this,function(){var $t1,$t2,$t3,$t4,armrotation,off,body,M,arm,itm,mitem,foot,head,hat;if(tmdl=BNTest.ModelCache.get_this().get(this.char,!1),tmdl!=null){console.log(System.String.concat(System.String.concat('loading "',this.char),'" model from cache.'));this.model.copyFrom(tmdl);me.CPU&&this.initCPU();this.initModel();return}this.model!=null&&(this.model.unloadBuffers(),world.remove$1(this.model));var hd=["head/base","head/rahmoo","head/rahmooacc"],ht=["head/rahmoobow"],ar=["arm/base","arm/dSleeve"],ft=["foot/base","foot/socks","foot/shoe"],mult=3,bdy=["body/rahmoo"],item=[],hatflip=!1,pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Headpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Hatpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Bodypal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Footpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Armpal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),Itempal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor));Bridge.referenceEquals(this.char,"sanae")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(0,1,.3)),hd=["head/base","head/rahmoo","head/rahmooacc"],ht=["head/hairclip"],bdy.push("body/top"));Bridge.referenceEquals(this.char,"suika")&&(this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,.65),csz*=this.model.scale.x,hsz=csz/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz)),pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.6,0,.8)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,.85,.35)),ar=["arm/base","arm/bracelet"],hd=["head/base","head/rahmoo","head/ponytailbow"],ht=["head/suikabow","head/suikahorns"],bdy.push("body/top"));Bridge.referenceEquals(this.char,"sakuya")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.5,0,.9)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.8,.8,.8)),hd=["head/base","head/medium"],ht=["head/maidheadband"],bdy.push("body/apron"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"cirno")&&(pal.set(new BNTest.GLColor(1,0,0),($t1=new BNTest.GLColor(.3,.6,1),Hatpal.set(new BNTest.GLColor(1,1,1),$t1),$t1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.1,.75,1)),hd=["head/base","head/medium"],ht=["head/rahmoobow"],bdy.push("body/icewings"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"marisa")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.1,.1,.1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,.85,.35)),hd=["head/base","head/rahmoo"],ht=["head/witchhat","head/hatbow","head/mediumRim"],bdy.push("body/apron"),ar=["arm/base","arm/shortsleeve"]);Bridge.referenceEquals(this.char,"koishi")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,.7,.2)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,.7,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.35,1,.45)),hd=["head/base","head/rahmoo"],ht=["head/cap","head/hatbow","head/mediumRim"],Hatpal.set(new BNTest.GLColor(.698,0,1),($t2=new BNTest.GLColor(1,.85,.35),Hatpal.set(new BNTest.GLColor(1,1,1),$t2),$t2)),bdy.push("body/top","body/thirdeye"),pal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,.9,.4)),pal.set(new BNTest.GLColor(1,.5,.5),($t3=new BNTest.GLColor(.8,0,.9),Footpal.set(new BNTest.GLColor(.5,.5,.5),$t3),$t3)),ar=["arm/base","arm/shortsleeve"],ft.push("foot/lanklet"));Bridge.referenceEquals(this.char,"aya")&&(pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,0)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(0,0,0)),pal.set(new BNTest.GLColor(.5,.25,0),BNTest.GLColor.createShade(.15)),hd=["head/base","head/medium"],ht=["head/tokin"],bdy=["body/shortskirt","body/shortskirtfrill","body/top","body/tie"],ar=["arm/base","arm/shortsleeve"],Hatpal.set(new BNTest.GLColor(0,0,0),new BNTest.GLColor(.85,0,0)));Bridge.referenceEquals(this.char,"youmu")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,.7,.2)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,1,1)),hd=["head/base","head/medium"],ht=["head/headband","head/sideribbon"],bdy=["body/shortskirt","body/shortskirtfrill","body/top","body/tie"],ar=["arm/base","arm/shortsleeve"],Hatpal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,0)),item=["object/katana"]);Bridge.referenceEquals(this.char,"reisen")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(1,.45,.45)),Bodypal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.9,.55,.85)),hd=["head/base","head/rahmoo"],ht=["head/reisenears"],bdy=["body/shortskirt","body/top","body/sidependant","body/tie","body/bunnytail"],ar=["arm/base","arm/sleeve"],Bodypal.set(new BNTest.GLColor(1,1,1),($t4=BNTest.GLColor.createShade(.15),Armpal.set(new BNTest.GLColor(1,1,1),$t4),$t4)));Bridge.referenceEquals(this.char,"tenshi")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.3,.3,.85)),Bodypal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,0,0)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.3,.3,.85)),Hatpal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor),hd=["head/base","head/rahmoo"],ht=["head/cap","head/mediumRim","head/peaches"],bdy=["body/rahmoo","body/top","body/tie","body/rainbowmidfrill"],ar=["arm/base","arm/shortsleeve"],item=["object/katana"],Itempal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,.4,.4)));Bridge.referenceEquals(this.char,"nazrin")&&(Bodypal.set(new BNTest.GLColor(1,0,0),BNTest.GLColor.createShade(.4)),pal.set(new BNTest.GLColor(.5,.25,0),BNTest.GLColor.createShade(.8)),hd=["head/base","head/medium"],ht=["head/mouseEars"],bdy=["body/shortskirt","body/mouseTail","body/Lsidependant","body/capelet","body/tie"],ar=["arm/base","arm/sleeve","arm/capelet"],ft=["foot/base","foot/shortsocks","foot/shoe"],Armpal.set(BNTest.GLColor.createShade(.5),BNTest.GLColor.createShade(.75)),this.model.scale=BNTest.GLVec3.op_Multiply$1(this.model.scale,.85));Bridge.referenceEquals(this.char,"rumia")&&(Bodypal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(.1,.1,.1)),pal.set(new BNTest.GLColor(1,1,0),new BNTest.GLColor(1,1,1)),pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(1,.85,.35)),hd=["head/base","head/medium"],ht=["head/sideribbon"],ar=["arm/base","arm/sleeve"]);Bridge.referenceEquals(this.char,"flandre")&&(pal.set(new BNTest.GLColor(.5,.25,0),new BNTest.GLColor(.95,.95,.3)),hd=["head/base","head/medium","head/sideponytail"],ht=["head/cap","head/smallRim","head/sideribbon"],bdy=["body/shortskirt","body/shortskirtfrill","body/flandrewings"],ar=["arm/base","arm/shortsleeve"],Hatpal.set(new BNTest.GLColor(1,1,1),new BNTest.GLColor(1,0,0)),Hatpal.set(new BNTest.GLColor(0,0,0),new BNTest.GLColor(1,1,1)),hatflip=!0);this.team===1&&this.initCPU();armrotation=45;Bridge.referenceEquals(this.char,"rumia")&&(armrotation=67);off=this.model.offset;this.model.offset=off;world.add$1(this.model);this.model.Dir=1;this.model.Max=2.25;this.model.Spd=.075*mult;body=BNTest.VoxelMap.fromAnimationCombo(bdy);body.applyPalette(pal);body.applyPalette(Bodypal);M=new BNTest.Mesh(this.game);M.Dir=1;M.Max=2.25;M.Spd=.075*mult;M.addVoxelMap(body,smooth);this.model.meshes.add(M);arm=BNTest.VoxelMap.fromAnimationCombo(ar);arm.applyPalette(pal);arm.applyPalette(Armpal);M=new BNTest.Mesh(this.game);M.Dir=1;M.Spd=1.5*mult;M.addVoxelMap(arm,smooth);M.offset.x=1.25;M.offset.y=2.5;M.rotation.z=armrotation;M.scale.z=.75;item.length>0&&(itm=BNTest.VoxelMap.fromAnimationCombo(item),itm.applyPalette(Itempal),mitem=new BNTest.Mesh(this.game),mitem.addVoxelMap(itm,smooth),mitem.rotation.x=-90,mitem.offset.x=-1,mitem.offset.y=3,mitem.offset.z=9,mitem.updateTranformation(),mitem.morphGeometry(mitem.transformation),M.combine(mitem));this.model.meshes.add(M);M=new BNTest.Mesh(this.game);M.Dir=-1;M.Spd=1.5*mult;M.addVoxelMap(arm,smooth);M.offset.x=-1.25;M.offset.y=2.5;M.rotation.z=-armrotation|0;M.scale.z=.75;this.model.meshes.add(M);foot=BNTest.VoxelMap.fromAnimationCombo(ft);foot.applyPalette(pal);foot.applyPalette(Footpal);M=new BNTest.Mesh(this.game);M.Dir=-1;M.Spd=1.5*mult;M.addVoxelMap(foot,smooth);M.offset.x=1.5;M.offset.y=7;this.model.meshes.add(M);M=new BNTest.Mesh(this.game);M.Dir=1;M.Spd=1.5*mult;M.addVoxelMap(foot,smooth);M.offset.x=-1.5;M.offset.y=7;this.model.meshes.add(M);head=BNTest.VoxelMap.fromAnimationCombo(hd);head.applyPalette(pal);head.applyPalette(Headpal);hat=BNTest.VoxelMap.fromAnimationCombo(ht);hatflip&&hat.flipX();hat.applyPalette(pal);hat.applyPalette(Hatpal);head.combine(hat);M=new BNTest.Mesh(this.game);M.Dir=1;M.Max=4.5;M.Spd=.15*mult;M.addVoxelMap(head,smooth);this.model.meshes.add(M);smooth&&this.model.smoothen(.7);tmdl==null&&BNTest.ModelCache.get_this().set$1(this.char,this.model)}));this.addBehavior(new BNTest.PlatformerControls(this));me.minion||this.addBehavior(new BNTest.AirDash(this));secondaryWeaponGraphic="";Bridge.referenceEquals(this.char,"koishi")?(this.addBehavior(new BNTest.RingShot(this)),this.game.localplayer==null||Bridge.referenceEquals(this.game.localplayer.character,this)||this.game.localplayer.character==null||(this.maxAlpha=.05,this.zpos=1)):Bridge.referenceEquals(this.char,"youmu")?(this.addBehavior(new BNTest.BasicSword(this)),this.addBehavior(new BNTest.SwordSwing(this)),O=new BNTest.Orb(world,this),world.add(O)):Bridge.referenceEquals(this.char,"sakuya")?this.addBehavior(new BNTest.WideShot(this)):Bridge.referenceEquals(this.char,"tenshi")?this.addBehavior(new BNTest.BasicSword(this)):Bridge.referenceEquals(this.char,"cirno")?this.addBehavior(new BNTest.RapidWideGun(this)):Bridge.referenceEquals(this.char,"sanae")?this.addBehavior(new BNTest.RapidSniper(this)):Bridge.referenceEquals(this.char,"marisa")?this.addBehavior(new BNTest.SpreadShot(this)):Bridge.referenceEquals(this.char,"flandre")?this.addBehavior(new BNTest.HeavyShot(this)):this.addBehavior(new BNTest.RapidFireGun(this));Bridge.referenceEquals(this.char,"reisen")&&this.addBehavior(new BNTest.SpawnIllusions(this));Bridge.referenceEquals(this.char,"reimu")&&(this.addBehavior(new BNTest.YinYangOrbGun(this)),secondaryWeaponGraphic="object/yinyangorb",scsmooth=!0);Bridge.referenceEquals(this.char,"cirno")&&(this.addBehavior(new BNTest.IceBall(this)),secondaryWeaponGraphic="object/yinyangorb",scsmooth=!0);Bridge.referenceEquals(this.char,"sanae")&&(this.addBehavior(new BNTest.FivePointShot(this)),secondaryWeaponGraphic="object/starB",scsmooth=!0);Bridge.referenceEquals(this.char,"marisa")&&this.addBehavior(new BNTest.LargeLaser(this));Bridge.referenceEquals(this.char,"flandre")&&(this.addBehavior(new BNTest.Laevatein(this)),secondaryWeaponGraphic="object/basicshot",Ppal=!1);Bridge.referenceEquals(this.char,"tenshi")&&(this.addBehavior(new BNTest.RockDrop(this)),secondaryWeaponGraphic="object/keystone",scsmooth=!0,scsnoise=!0);speedrate=this.game.bulletSpeedRate;minion=me.minion;me.CPU&&minion&&(this.maxHPDrops=1,this.dropsChance=.1,Bridge.referenceEquals(this.char,"rumia")&&(T=new BNTest.LightMuffler(this),this.addBehavior(T)),spd=.4,T2=this.getBehavior(BNTest.IWeaponBehavior),Bridge.referenceEquals(this.char,"aya")?(this.canShoot=!0,T1=new BNTest.EnemyStrafer(this),T1.framesPerTick=10,T1.predict=!1,this.addBehavior(T1),T2._maxAmmo=1,T2.bulletSpeed=2.5,T2.bulletLifeSpan=450,T2._maxShotDelay=40,TimeToRespawn=15,this.maxRespawnTime=60*TimeToRespawn|0,this.defense=1.4,spd=.75):Bridge.referenceEquals(this.char,"youmu")&&(this.canShoot=!0,T3=new BNTest.EnemyStrafer(this),T3.framesPerTick=10,T3.predict=!1,T3.attackType=6,this.addBehavior(T3),T3.attackrange=150,T3=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f1),T3.minCoolDown=120,T3.attackDamage*=.5,TimeToRespawn1=18,this.maxRespawnTime=60*TimeToRespawn1|0,this.defense=3.4,spd=.6),Bridge.referenceEquals(this.char,"reisen")&&(TimeToRespawn2=6,T4=new BNTest.ProximityAttacker(this),T4.framesPerTick=20,this.defense=1.4,this.canShoot=!0,this.addBehavior(T4),this.maxRespawnTime=60*TimeToRespawn2|0,mod=5,T2.bulletSpeed/=mod,T2.bulletLifeSpan=T2.bulletLifeSpan*mod|0,T2.minCoolDown+=30,spd=.5,T2._maxAmmo=1),(Bridge.referenceEquals(this.char,"sanae")||Bridge.referenceEquals(this.char,"sakuya")||Bridge.referenceEquals(this.char,"cirno")||Bridge.referenceEquals(this.char,"marisa"))&&(this.canShoot=!0,T5=new BNTest.EnemyEngager(this),T5.framesPerTick=40,T5.predict=!1,this.addBehavior(T5),T2._maxAmmo=1,T2.bulletSpeed=3,T2.bulletLifeSpan=450,T2._maxShotDelay=30,Bridge.referenceEquals(this.char,"sanae"),TimeToRespawn3=6,Bridge.referenceEquals(this.char,"sakuya")&&(T2.bulletSpeed=2.5,T2.bulletLifeSpan=600,T2._maxShotDelay=100,T5.predict=!0,T5.framesPerTick=20,TimeToRespawn3=13,this.defense=1.4),Bridge.referenceEquals(this.char,"cirno")&&(T2.bulletLifeSpan=30,T2._maxShotDelay=12,spd*=1.5,T5.framesPerTick=15,this.defense=2,T5.passive=!0,TimeToRespawn3=3),this.maxRespawnTime=60*TimeToRespawn3|0),Bridge.referenceEquals(this.char,"nazrin")&&(W=this.getBehavior(BNTest.AimedWandering),W.focus=1,W.framesPerTick=W.framesPerTick-15|0,TimeToRespawn4=2,spd*=2,this.defense=1.4,this.maxRespawnTime=60*TimeToRespawn4|0),T2!=null&&(T2._maxShotDelay=Bridge.Int.clip32(Bridge.Math.round(T2._maxShotDelay/speedrate,0,6)),T2.bulletSpeed*=speedrate,T2.bulletLifeSpan=Bridge.Int.clip32(T2.bulletLifeSpan/speedrate),sr2=Math.pow(speedrate,1.5),this.maxAmmo*=sr2,this.ammoRechargeRate*=sr2),this.getBehavior(BNTest.PlatformerControls).maxSpeed*=spd*speedrate);me.CPU&&!minion&&(T21=this.getBehavior(BNTest.IWeaponBehavior),Bridge.referenceEquals(this.char,"flandre")?(T6=new BNTest.EnemyEngager(this),T6.framesPerTick=20,T6.weapon=6,this.addBehavior(T6),TB=new BNTest.SecondaryResponder(this),TB.weapon=5,this.addBehavior(TB)):Bridge.referenceEquals(this.char,"tenshi")?(T8=new BNTest.EnemyEngager(this),T8.framesPerTick=20,this.addBehavior(T8),this.addBehavior(new BNTest.SecondaryResponder(this))):(T7=new BNTest.ProximityAttacker(this),T7.framesPerTick=20,T7.predict=!0,Bridge.referenceEquals(this.char,"koishi")?T7.aggroRange=100:(this.maxAmmo=1,this.ammoRechargeRate=.00333333341),this.addBehavior(T7)),this.canShoot=!0,this.maxRespawnTime=999999999,T21!=null&&(T21._maxShotDelay=Bridge.Int.clip32(Bridge.Math.round(T21._maxShotDelay/speedrate,0,6)),T21.bulletSpeed*=this.game.bulletSpeedRate,T21.bulletLifeSpan=Bridge.Int.clip32(T21.bulletLifeSpan/this.game.bulletSpeedRate)));me.CPU&&Bridge.referenceEquals(this.char,"reisen")&&this.addBehavior(new BNTest.SecondaryResponder(this));this.pmesh==null&&(effects=[],effects.push(weaponGraphic),Bridge.referenceEquals(secondaryWeaponGraphic,"")||effects.push(secondaryWeaponGraphic),BNTest.AnimationLoader.get_this().asyncGet$1(effects,Bridge.fn.bind(this,function(){var pal=new(System.Collections.Generic.Dictionary$2(BNTest.GLColor,BNTest.GLColor)),TPM,VM,weapon,weapon2,w2msh;me.CPU&&pal.set(new BNTest.GLColor(1,0,0),new BNTest.GLColor(0,0,1));TPM=BNTest.ModelCache.get_this().get(System.String.concat("W1:",weaponGraphic));TPM!=null?this.pmesh=TPM.meshes.getItem(0):(this.pmesh=new BNTest.Mesh(this.game),VM=BNTest.VoxelMap.fromImages$1(weaponGraphic),VM.swapYZ(),this.pmesh.addVoxelMap(VM,!0),BNTest.ModelCache.get_this().set(System.String.concat("W1:",weaponGraphic),this.pmesh));Ppal&&this.pmesh.applyPalette(pal);this.pmesh.update();this.pmesh.clonedBuffer=!0;this.pmesh.doNotUnload=!0;weapon=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f2);weapon2=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f3);weapon.bulletGraphic=this.pmesh;weapon2==null||Bridge.referenceEquals(secondaryWeaponGraphic,"")?weapon2!=null&&(weapon2.bulletGraphic=this.pmesh):(w2msh=null,TPM=BNTest.ModelCache.get_this().get(System.String.concat("W2:",secondaryWeaponGraphic)),TPM!=null?w2msh=TPM.meshes.getItem(0):(w2msh=new BNTest.Mesh(this.game),VM=BNTest.VoxelMap.fromImages$1(secondaryWeaponGraphic),scsnoise&&VM.addNoise(.05),VM.swapYZ(),w2msh.addVoxelMap(VM,!0),scsmooth&&w2msh.smoothenB(.5),BNTest.ModelCache.get_this().set(System.String.concat("W2:",secondaryWeaponGraphic),w2msh)),Ppal&&w2msh.applyPalette(pal),weapon2.bulletGraphic=w2msh,w2msh.update(),w2msh.clonedBuffer=!0,w2msh.doNotUnload=!0)})))},getHP:function(){return this._HP},setHP:function(value){this._HP=value},getPointsForKilling:function(){return this._PointsForKilling},getTargetPriority:function(){return 10},getHitboxSize:function(){return this.HB.getSize().x},setHitboxSize:function(value){this.HB=new BNTest.BoundingBox.$ctor2(value);this.getHitbox()},getHitbox:function(){return this.HB.setPosition(this.model.offset),this.HB},initModel:function(){var armrotation=45,mult,i,M,csz,hsz;Bridge.referenceEquals(this.char,"rumia")&&(armrotation=67);mult=3.9;i=0;this.model.Dir=1;this.model.Max=2.25;this.model.Spd=.075*mult;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Max=2.25;M.Spd=.075*mult;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Spd=1.5*mult;M.offset.x=1.25;M.offset.y=2.5;M.rotation=new BNTest.GLVec3.ctor;M.rotation.z=armrotation;M.scale.z=.75;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=-1;M.Spd=1.5*mult;M.offset.x=-1.25;M.offset.y=2.5;M.rotation=new BNTest.GLVec3.ctor;M.rotation.z=-armrotation|0;M.scale.z=.75;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=-1;M.Spd=1.5*mult;M.offset.x=1.5;M.offset.y=7;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Spd=1.5*mult;M.offset.x=-1.5;M.offset.y=7;M.rotation=new BNTest.GLVec3.ctor;M=this.model.meshes.getItem(Bridge.identity(i,i=i+1|0));M.Dir=1;M.Max=4.5;M.Spd=.15*mult;M.rotation=new BNTest.GLVec3.ctor;Bridge.referenceEquals(this.char,"suika")&&(csz=8,csz*=this.model.scale.x,hsz=csz/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz)))},initCPU:function(){var T=new BNTest.NavigatorAI(this),NS;T.framesPerTick=0;this.addBehavior(T);T=new BNTest.WanderAI(this);T.framesPerTick=25;Bridge.cast(T,BNTest.WanderAI).range=20;this.addBehavior(T);T=new BNTest.EntityFollower(this,System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.PlayerCharacter).toArray()[0]);T.framesPerTick=10;T=new BNTest.AimedWandering(this);Bridge.cast(T,BNTest.AimedWandering).target=System.Linq.Enumerable.from(this.world.entities).ofType(BNTest.DonationBox).toArray()[0];T.framesPerTick=50;this.addBehavior(T);NS=new BNTest.NetworkSync(this);this.me.CPU&&(NS.framesPerTick=45);NS.forcesFlush=!0;NS.updateOnSync=!0;this.addBehavior(NS);this.me.CPU&&Bridge.referenceEquals(this.char,this.game.localplayer.character.char)&&(this.defaultColor=BNTest.GLColor.createShade(.5))},updateShoot:function(){var weapon=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f2),weapon2=this.getBehavior$1(BNTest.IWeaponBehavior,$_.BNTest.PlayerCharacter.f3),ang=this.model.rotation.y,resting,rate;weapon.BNTest$IWeaponBehavior$setFiringAngle(ang);this.shootTime-=1;this.shootTime<=0?(resting=!0,this.controller[5]&&!this.manaburnout&&(resting=!1,this.restTime=0,weapon!=null&&(this.shootTime+=weapon.BNTest$IWeaponBehavior$getMaxCooldown(),weapon.BNTest$IWeaponBehavior$fire(ang),this.ammo-=weapon.BNTest$IWeaponBehavior$getEnergyCost()),this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown),this.model.alpha=1),this.controller[6]&&!this.manaburnout&&(resting=!1,this.restTime=0,weapon2!=null&&(this.shootTime+=weapon2.BNTest$IWeaponBehavior$getMaxCooldown(),weapon2.BNTest$IWeaponBehavior$fire(ang),this.ammo-=weapon2.BNTest$IWeaponBehavior$getEnergyCost()),this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown),this.model.alpha=1),resting&&(this.shootTime=0,this.restTime=this.restTime+1|0)):this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown);this.ammoRechargeCooldown-=1;this.ammoRechargeCooldown<=0&&(rate=this.ammoRechargeRate,this.manaburnout,this.ammo=Math.min(this.ammo+rate,this.maxAmmo))},update:function(){var $t,Dist,D2,H;if(this.lastKill=this.lastKill+1|0,this.lastKill>=this.maxComboTime&&(this.combo=0),this.respawnPosition==null&&(this.respawnPosition=this.getPosition().clone()),this.respawnTime>0){this.model.setVisible(!1);this.lastBB.getEmpty()||(this.lastBB==null?this.lastBB=new BNTest.BoundingBox.ctor:this.lastBB.max.copyFrom(this.lastBB.min));this.respawnTime=this.respawnTime-1|0;this.me.CPU||(this.setPosition(BNTest.GLVec3.lerp(this.getPosition(),this.respawnPosition,.015)),Dist=BNTest.GLVec3.op_Subtraction(this.respawnPosition,this.getPosition()),this.respawnTime<=0||Dist.getLength()<=.5?this.getPosition().copyFrom(this.respawnPosition):(D2=Dist.normalize(.5),this.getPosition().add(D2)));return}BNTest.PlatformerEntity.prototype.update.call(this);this.canShoot&&this.pmesh!=null&&(this.updateShoot(),this.infiniteAmmo||(this.ammo<0?(this.ammo=0,this.manaburnout=!0,this.ammoRechargeCooldown=Math.max(this.ammoRechargeCooldown,this.ammoMaxRechargeCooldown)):this.ammo>=this.maxAmmo&&(this.manaburnout=!1)));this.onGround||(this.gety()>200||this.gety()<-500&&this.speed.y<0)&&(this.setx(0),this.sety(-120),this.setz(0),this.speed.set(),this.model.rotation.x=0,this.me.CPU&&(H=this.getHP(),this.game.setNPC(this),this.setHP(H)));this.model.inView&&this.animate();$t=this.controller;System.Array.copy($t,0,this.lController,0,$t.length)},animate:function(){var meshcount,swing;(this.model.color=this.flickerColor!=null&&(this.game.frame&2)>0?this.flickerColor:this.defaultColor,meshcount=this.model.meshes.getCount(),meshcount<5)||(this.model.drawOrder=this.zpos,this.invincibilityFrames>0?(this.model.setVisible(!this.model.getVisible()),this.invincibilityFrames=this.invincibilityFrames-1|0):(this.model.setVisible(!0),this.model.alpha>this.maxAlpha?this.model.alpha=Math.max(this.maxAlpha,this.model.alpha-.007):this.model.alpha<this.maxAlpha&&(this.model.alpha=Math.min(this.maxAlpha,this.model.alpha+.01))),this.onGround&&!this.me.CPU&&(this.model.rotation.y=BNTest.MathHelper.radiansToDegrees(this.game.mouseAngle)-90),swing=!1,this.useSwingAnimation&&this.controller[5]&&!this.manaburnout?(Bridge.referenceEquals(this.animation,"attackswing")||(this.model.meshes.getItem(1).rotation.x=0),this.animation="attackswing",swing=!0):Bridge.referenceEquals(this.animation,"attackswing")&&this.initModel(),this.speed.y===0&&Bridge.referenceEquals(this.animation,"attackswing")&&(this.rotateTest(this.model.meshes.getItem(1),"y",3,1.25),this.rotateTest(this.model.meshes.getItem(1),"x",1.2,1.25)),Bridge.referenceEquals(this.animation,"pushing")&&(this.model.meshes.getItem(1).rotation.x=-95,this.model.meshes.getItem(2).rotation.x=-95,this.model.meshes.getItem(1).rotation.z=-35,this.model.meshes.getItem(2).rotation.z=-this.model.meshes.getItem(1).rotation.z,this.model.meshes.getItem(1).rotation.y=-50,this.model.meshes.getItem(2).rotation.y=-this.model.meshes.getItem(1).rotation.y),this.speed.y===0&&(this.speed.x!==0||this.speed.z!==0)?(Bridge.referenceEquals(this.animation,"jump")&&(this.model.meshes.getItem(3).offset.z=0,this.model.meshes.getItem(4).offset.z=0,this.model.meshes.getItem(3).rotation.x=0,this.model.meshes.getItem(4).rotation.x=0),swing||Bridge.referenceEquals(this.animation,"pushing")||(this.animation="walk"),this.me.CPU,this.rotateTest(this.model.meshes.getItem(0)),Bridge.referenceEquals(this.animation,"attackswing")||Bridge.referenceEquals(this.animation,"pushing")||(this.rotateTest(this.model.meshes.getItem(1)),this.rotateTest(this.model.meshes.getItem(2))),this.rotateTest(this.model.meshes.getItem(3)),this.rotateTest(this.model.meshes.getItem(4)),this.model.meshes.getItem(3).offset.z=-(this.model.meshes.getItem(3).rotation.x*.025),this.model.meshes.getItem(4).offset.z=-(this.model.meshes.getItem(4).rotation.x*.025),this.rotateTest(this.model.meshes.getItem(5),"y")):this.onGround?(this.animation="idle",this.model.meshes.getItem(3).rotation.x=0,this.model.meshes.getItem(4).rotation.x=0,this.model.meshes.getItem(3).offset.z=0,this.model.meshes.getItem(4).offset.z=0):(this.animation="jump",this.model.meshes.getItem(3).rotation.x=25,this.model.meshes.getItem(4).rotation.x=25,this.model.meshes.getItem(3).offset.z=1.5,this.model.meshes.getItem(4).offset.z=1.5),System.Nullable.hasValue(this.forcedAngle)&&(this.model.rotation.y=System.Nullable.getValue(this.forcedAngle)))},onDamaged:function(source,amount){var i,D,src;if(!(this.invincibilityFrames>0)&&!(this.respawnTime>0)){for(this.model.alpha=1,i=0;i<this._behaviors.getCount();){if(D=this._behaviors.getItem(i),D.onAttacked)D.onAttacked(source);i=i+1|0}if(src=source,this.setHP(this.getHP()-amount/this.defense),!this.me.CPU){this.dropCoins(5+(5*Bridge.Int.clip32(Math.floor(this.game.wave/1.25))|0)|0,4,1);this.invincibilityFrames=this.maxInvincibilityFrames;src.multiHit||(src.alive=!1);return}this.speed=BNTest.GLVec3.op_Addition(this.speed,BNTest.GLVec3.op_Division$1(BNTest.GLVec3.op_Multiply$1(BNTest.GLVec3.op_Multiply$1(src.speed,.8),src.knockbackPower),this.knockbackResistLevel));src.multiHit||(src.alive=!1);this.speed.y-=2*(1+src.knockbackPower)*.5/this.knockbackResistLevel;this.invincibilityFrames=this.maxInvincibilityFrames}},dropCoins:function(MaxValue,number,permaloss,lifespan){var i,c,m,m2,Value;for(permaloss===void 0&&(permaloss=0),lifespan===void 0&&(lifespan=900),i=number;i>0;){if(c=new BNTest.Coin(this.world,lifespan),c.setPosition(BNTest.GLVec3.op_Addition(this.getPosition(),new BNTest.GLVec3.ctor(0,-20,0))),c.solid=!1,m=3,m2=m+m|0,c.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),c.speed.y=-1+(-m|0)*Math.random(),c.pickupDelay=90,Value=10,this.getCoins()>MaxValue?Value=MaxValue:(Value=Bridge.Int.div(MaxValue,10)|0,Value<1&&(Value=1)),Value>=this.getCoins())return;c.setValue(Value);this.setCoins(this.getCoins()-c.value|0);i>permaloss&&this.world.add(c);i=i-1|0}},onDeath:function(source){var i,hp,m,m2,N,c,cval,PC,combo,csz,hsz,csz1,hsz1;if(this.me!=null&&(this.me.lives=this.me.lives-1|0),this.model.setVisible(!1),this.me.CPU||(this.dropCoins(Bridge.Int.clip32(this.getCoins()*.1),3,1,1500),this.dropCoins(15*this.game.wave|0,1,0,1500),this.respawnTime=120,this.setHP(100)),this.maxHPDrops>0&&this.dropsChance>Math.random())for(i=Bridge.Int.clip32((this.maxHPDrops-1|0)*Math.random()),i<0&&(i=0),i=i+1|0;i>0;)hp=new BNTest.HPOrb(this.world),hp.setPosition(new BNTest.GLVec3.ctor(0,-20,0)),hp.getPosition().add(this.getPosition()),hp.solid=!1,m=2,m2=m+m|0,hp.speed=new BNTest.GLVec3.ctor((-m|0)+Math.random()*m2,0,(-m|0)+Math.random()*m2),hp.speed.y=-1+(-m|0)*Math.random(),hp.pickupDelay=15,this.world.add(hp),i=i-1|0;if(N=new(System.Collections.Generic.Dictionary$2(String,System.Int32)),N.set("sakuya",40),N.set("sanae",30),N.set("cirno",20),N.set("aya",80),N.set("youmu",50),N.set("reisen",60),N.set("nazrin",20),c=new BNTest.Coin(this.world),cval=10,cval=this.me.minion?this.model.scale.x>1?200:N.containsKey(this.char)?N.get(this.char):10:(100*this.game.wave|0)+500|0,source!=null&&source.BNTest$IHarmfulEntity$getAttacker()!=null&&Bridge.is(source.BNTest$IHarmfulEntity$getAttacker(),BNTest.PlayerCharacter)&&(PC=source.BNTest$IHarmfulEntity$getAttacker(),combo=PC.combo+1|0,combo>1)){for(var bonus=0,nb=3,cmb=combo;cmb>=nb;)bonus=bonus+1|0,cmb=cmb-nb|0,nb=nb+1|0;cval=cval+(bonus*5|0)|0}c.setValue(cval);c.solid=!1;c.getPosition().copyFrom(this.getPosition());c.getPosition().add$1(0,-2,0);c.speed.copyFrom(this.speed);c.speed.multiply$1(.35);c.speed.add$1(0,-1,0);this.reward&&this.world.add(c);this.me.CPU&&(this.respawnTime=this.maxRespawnTime,this.alive=!0,this.game.setNPC(this),this.controller[4]=!1,this.controller[5]=!1,Bridge.referenceEquals(this.char,"suika")&&(Math.random()<.1?(this.model.scale=BNTest.GLVec3.createUniform(5),csz=10*this.model.scale.x,hsz=csz/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz,-csz,-hsz),new BNTest.GLVec3.ctor(hsz,csz,hsz)),this.setHitboxSize(hsz),this.stepheight=5*this.model.scale.x,this.defense=6,this.knockbackResistLevel=3):(this.model.scale=BNTest.GLVec3.createUniform(.65),csz1=8,csz1*=this.model.scale.x,hsz1=csz1/2,this.customBoundingBox=new BNTest.BoundingBox.$ctor1(new BNTest.GLVec3.ctor(-hsz1,-csz1,-hsz1),new BNTest.GLVec3.ctor(hsz1,csz1,hsz1)),this.setHitboxSize(hsz1),this.stepheight=5,this.defense=1,this.knockbackResistLevel=1)));this.canRespawn||(this.alive=!1)},onKill:function(){this.combo=this.combo+1|0;this.lastKill=0}});Bridge.ns("BNTest.PlayerCharacter",$_);Bridge.apply($_.BNTest.PlayerCharacter,{f1:function(W){return W.BNTest$IWeaponBehavior$getWeaponType()===2},f2:function(WB){return WB.BNTest$IWeaponBehavior$getWeaponType()===1},f3:function(WB){return WB.BNTest$IWeaponBehavior$getWeaponType()===2}})});